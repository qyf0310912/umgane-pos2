<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS (ì‹¤ë¬´ ìµœì¢…)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  button{border:0;border-radius:14px;cursor:pointer}
  .app{height:100%;display:grid;grid-template-columns: 1.25fr .75fr;gap:12px;padding:12px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden}
  .left,.right{display:flex;flex-direction:column;min-width:0}

  /* Top controls */
  .topbar{padding:12px;display:flex;flex-direction:column;gap:10px;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line); font-weight:800}
  .tab.active{outline:2px solid rgba(255,159,0,.55); background:rgba(255,159,0,.10)}
  .row{display:flex;gap:10px;align-items:center}
  .search{flex:1;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);
    border:1px solid var(--line); border-radius:16px; padding:10px 12px; min-width:0}
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px;min-width:0}
  .sortBtn{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:800}
  .keys{display:flex;gap:8px;flex-wrap:wrap}
  .kbtn{width:44px;height:38px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:12px; font-weight:900}
  .kbtn.clear{background:rgba(255,59,48,.15);border-color:rgba(255,59,48,.25)}
  .hint{color:var(--muted);font-size:12px}

  /* Pinned strip */
  .pinned{padding:10px 12px;border-bottom:1px solid var(--line)}
  .pinnedTitle{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:8px}
  .pinnedGrid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px}
  .emptyPinned{color:var(--muted);font-size:13px}

  /* Items grid */
  .itemsWrap{flex:1;min-height:0;overflow:auto;padding:12px}

  /* âœ… ê¸°ë³¸ 4ì—´, í™”ë©´ ë„“ìœ¼ë©´ 5ì—´, ì¢ìœ¼ë©´ 3/2ì—´ */
  .grid{display:grid;gap:12px;grid-template-columns:repeat(4, minmax(0,1fr))}
  @media (min-width: 1240px){
    .grid{grid-template-columns:repeat(5, minmax(0,1fr))}
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:repeat(3, minmax(0,1fr))}
  }
  @media (max-width: 520px){
    .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
  }

  .card{position:relative; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:18px;
    padding:12px; min-height:92px; display:flex; flex-direction:column; gap:8px}
  .name{font-size:19px;font-weight:850;letter-spacing:-.3px;line-height:1.05}
  .price{font-size:13px;color:var(--muted);font-weight:750}
  .chip{align-self:flex-start;padding:6px 10px;border-radius:999px;font-size:12px;
    background:rgba(255,255,255,.04);border:1px solid var(--line); color:var(--text)}
  /* âœ… ë¹¨ê°„ê³ ì •í•€ "ì•ˆì“°ëŠ”ê±°(=ë¯¸ê³ ì •)" íë¦¬ê²Œ */
  .pinIcon{position:absolute; right:10px; bottom:10px; width:34px;height:34px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,59,48,.16); border:1px solid rgba(255,59,48,.28); color:#ff6b66; font-weight:900}
  .pinIcon.off{opacity:.20; background:rgba(255,255,255,.04); border:1px solid var(--line); color:var(--muted)}
  .card:active{transform:scale(.99)}
  .card.pinnedCard{outline:2px solid rgba(255,59,48,.25)}
  .meta{display:none} /* âœ… ì‚¬ìš© ì¹´ìš´íŠ¸ ê¸°ë³¸ ìˆ¨ê¹€(ì›í•˜ë©´ trueë¡œ ë°”ê¿”ì¤„ê²Œ) */

  /* Right panel */
  .rTop{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .topBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .btnMini{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:800}
  .btnMini.accent{background:rgba(255,159,0,.14);border-color:rgba(255,159,0,.22);color:var(--text)}
  .cartWrap{flex:1;min-height:0;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}

  /* âœ… ì¥ë°”êµ¬ë‹ˆ í•œ ì¤„: í’ˆëª©ëª… â€¦ / ê¸ˆì•¡ í­ ì •ë ¬ / ìˆ˜ëŸ‰ - ìˆ«ì + */
  .cartItem{
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px 10px;
    display:grid;
    grid-template-columns: 1fr 110px 150px;
    gap:10px;
    align-items:center;
  }
  .ciNameLine{
    min-width:0;
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:850;
    font-size:16px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ciQtyTag{
    flex:0 0 auto;
    font-size:12px;
    font-weight:900;
    color:rgba(245,247,255,.75);
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    padding:4px 8px;
    border-radius:999px;
  }
  .ciPrice{
    text-align:right;
    font-weight:900;
    font-size:15px;
    letter-spacing:-.2px;
    white-space:nowrap;
  }
  .ciRight{display:flex;justify-content:flex-end;align-items:center;gap:8px}
  .qtyBtn{width:40px;height:32px;border-radius:12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-size:18px;font-weight:900}
  .qtyNum{
    min-width:38px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    font-weight:900;
    font-size:14px;
  }
  .delBtn{width:40px;height:32px;border-radius:12px;background:rgba(255,59,48,.16);color:var(--text);border:1px solid rgba(255,59,48,.28);font-size:18px;font-weight:900}

  .sumRow{padding:10px 12px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:10px}
  .moneyLine{display:flex;justify-content:space-between;align-items:center}
  .moneyLine .lbl{color:var(--muted);font-size:13px}
  .moneyLine .val{font-size:28px;font-weight:900}

  .btnGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
  .moneyBtn{height:48px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:16px;font-size:16px;font-weight:900}
  .moneyBtn.reset{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}
  .bottom{padding:12px;border-top:1px solid var(--line);display:flex;gap:10px}
  .checkout{flex:1;height:62px;border-radius:18px;background:linear-gradient(180deg, rgba(255,159,0,1), rgba(255,159,0,.85));
    color:#101116;font-size:22px;font-weight:900}
  .hold{width:140px;height:62px;border-radius:18px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-size:18px;font-weight:900}
  .hold small{display:block;font-size:12px;color:var(--muted);font-weight:700}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:12px}
  .modal.show{display:flex}
  .sheet{width:min(860px, 100%);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow)}
  .sheetHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sheetHead .title{font-weight:900;font-size:18px}
  .sheetBody{padding:12px;display:flex;flex-direction:column;gap:10px}
  .holdRow{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .holdLeft{min-width:0}
  .holdTitle{font-weight:900}
  .holdSub{color:var(--muted);font-weight:800;font-size:12px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px}
  .holdAmt{color:var(--text);font-weight:900;margin-top:6px}
  .holdBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .hBtn{padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:900}
  .hBtn.del{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}
  .hBtn.done{background:rgba(41,209,126,.14);border-color:rgba(41,209,126,.22)}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,17,22,.95);
    border:1px solid var(--line);border-radius:999px;padding:10px 14px;color:var(--text);font-weight:800;display:none}
  .toast.show{display:block}

  /* Responsive main layout */
  @media (max-width: 980px){
    .app{grid-template-columns:1fr;grid-template-rows:1.1fr .9fr}
    .pinnedGrid{grid-template-columns:repeat(3, minmax(0,1fr))}
    .cartItem{grid-template-columns:1fr 110px 150px}
  }
  @media (max-width: 520px){
    .pinnedGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
    .moneyLine .val{font-size:24px}
    .cartItem{grid-template-columns:1fr 96px 140px}
    .ciNameLine{font-size:15px}
    .ciPrice{font-size:14px}
  }
</style>
</head>
<body>
<div class="app">
  <section class="panel left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="row">
        <div class="search">
          <span style="opacity:.8">ğŸ”</span>
          <input id="q" placeholder="ì „í’ˆëª© ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="keys" id="chosungKeys"></div>
      <div class="hint">â€¢ ìƒí’ˆ í´ë¦­=ë‹´ê¸°  â€¢ ìƒí’ˆ ê¸¸ê²Œ(0.45ì´ˆ)=ê³ ì •/í•´ì œ  â€¢ ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ â€œì „í’ˆëª©(íƒ­ ë¬´ì‹œ)â€</div>
    </div>

    <div class="pinned" id="pinnedBox">
      <div class="pinnedTitle">
        <span>ê³ ì • Â· ìƒë‹¨</span>
        <span class="hint">ê³ ì •ì€ â€œê¸¸ê²Œ ëˆŒëŸ¬â€ í† ê¸€</span>
      </div>
      <div class="pinnedGrid" id="pinnedGrid"></div>
    </div>

    <div class="itemsWrap">
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rTop">
      <div class="topBtns">
        <button class="btnMini accent" id="holdsBtn">ë¯¸ìˆ˜(0)</button>
      </div>
    </div>

    <div class="cartWrap" id="cartWrap"></div>

    <div class="sumRow">
      <div class="moneyLine">
        <span class="lbl">ë°›ì€ëˆ</span>
        <span class="val" id="receivedVal">0ì›</span>
      </div>
      <div class="moneyLine">
        <span class="lbl">ê±°ìŠ¤ë¦„ëˆ</span>
        <span class="val" id="changeVal">0ì›</span>
      </div>

      <div class="btnGrid">
        <button class="moneyBtn" data-add="500">+500</button>
        <button class="moneyBtn" data-add="1000">+1ì²œ</button>
        <button class="moneyBtn" data-add="5000">+5ì²œ</button>
        <button class="moneyBtn" data-add="10000">+1ë§Œ</button>
        <button class="moneyBtn" data-add="50000">+5ë§Œ</button>
        <button class="moneyBtn reset" id="receivedReset">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="bottom">
      <button class="hold" id="holdNow">
        ë¯¸ìˆ˜
        <small>í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</small>
      </button>
      <button class="checkout" id="checkout">ê²°ì œì™„ë£Œ</button>
    </div>
  </section>
</div>

<!-- Holds modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="hBtn" id="closeModal">ë‹«ê¸°</button>
    </div>
    <div class="sheetBody" id="holdsList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =============================
   âœ… ì„¤ì • (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
============================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";
const APP_VER = "umgane_pos_v20251224_final_2";

/* =============================
   ì €ì¥ í‚¤
============================= */
const LS_VER   = "umgane_app_ver";
const LS_ITEMS = "umgane_items_v1";
const LS_PINS  = "umgane_pins_v1";
const LS_CART  = "umgane_cart_v1";
const LS_REC   = "umgane_received_v1";
const LS_USED  = "umgane_used_v1";
const LS_HOLDS = "umgane_holds_v1";

/* =============================
   ìœ í‹¸
============================= */
const $ = (s)=>document.querySelector(s);
const el = (tag, props={})=>{
  const n=document.createElement(tag);
  Object.assign(n, props);
  return n;
};
function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"), 1100);
}
function krw(n){
  n = Math.max(0, Math.round(Number(n||0)));
  return n.toLocaleString("ko-KR") + "ì›";
}
function parsePrice(v){
  if(v==null) return 0;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/[^\d.]/g,"");
  if(!cleaned) return 0;
  const num = Number(cleaned);
  if(!isFinite(num)) return 0;
  return Math.round(num);
}
function normCat(c){
  c = (c||"").trim();
  if(c==="ë´‰ì±„ì†Œ") c="ë´‰ì§€ì±„ì†Œ";
  return c || "ê¸°íƒ€";
}

/* =============================
   âœ… ì´ˆì„± ìœ í‹¸
============================= */
const CHO = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO_SET = new Set(CHO);
function getChoChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / (21*28));
  return CHO[idx] || ch;
}
function toChosung(str){
  return Array.from(String(str||"")).map(getChoChar).join("");
}
function isAllCho(q){
  const arr = Array.from(String(q||"").trim());
  if(!arr.length) return false;
  return arr.every(ch => CHO_SET.has(ch));
}

/* =============================
   ë²„ì „ ì •ë¦¬ (ê¼¬ì„ ë°©ì§€)
============================= */
(function ensureVersion(){
  const prev = localStorage.getItem(LS_VER);
  if(prev !== APP_VER){
    localStorage.setItem(LS_VER, APP_VER);
    localStorage.removeItem(LS_PINS);
    localStorage.removeItem(LS_CART);
    localStorage.removeItem(LS_REC);
    localStorage.removeItem(LS_USED);
    localStorage.removeItem(LS_HOLDS);
  }
})();

/* =============================
   ìƒíƒœ
============================= */
const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
let activeCat = "ê³¼ì¼";
let items = [];
let pins = new Set(JSON.parse(localStorage.getItem(LS_PINS)||"[]"));
let cart = JSON.parse(localStorage.getItem(LS_CART)||"{}");
let used = JSON.parse(localStorage.getItem(LS_USED)||"{}");
let received = Number(localStorage.getItem(LS_REC)||"0") || 0;
let holds = JSON.parse(localStorage.getItem(LS_HOLDS)||"[]");

/* =============================
   CSV íŒŒì„œ (ë”°ì˜´í‘œ/ì½¤ë§ˆ ì•ˆì „)
============================= */
function parseCSV(text){
  const rows=[];
  let cur="", inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch === ',' && !inQ){
      pushCell();
    }else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    }else{
      cur+=ch;
    }
  }
  if(cur.length || row.length){ pushCell(); pushRow(); }
  return rows;
}

/* =============================
   ë¡œë“œ: Google Sheet CSV
============================= */
async function loadItems(){
  const cached = localStorage.getItem(LS_ITEMS);
  if(cached){
    try{
      const arr = JSON.parse(cached);
      if(Array.isArray(arr) && arr.length){
        items = arr;
        renderAll();
      }
    }catch(e){}
  }

  try{
    const res = await fetch(CSV_URL + "&_ts=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨");
    const csv = await res.text();
    const rows = parseCSV(csv).filter(r=>r.some(x=>String(x||"").trim()!==""));
    if(rows.length < 2) throw new Error("CSV ë‚´ìš© ì—†ìŒ");

    const header = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = (k)=>header.indexOf(k);
    const iId = idx("id");
    const iCat = idx("cat");
    const iName = idx("name");
    const iPrice = idx("price");
    const iActive = idx("active");
    const iOrd = idx("ord");

    const out=[];
    for(let r=1;r<rows.length;r++){
      const line = rows[r];
      const id = String(line[iId]??"").trim();
      const cat = normCat(String(line[iCat]??"").trim());
      const name = String(line[iName]??"").trim();
      const price = parsePrice(line[iPrice]);
      const active = String(line[iActive]??"1").trim();
      const ordRaw = String(line[iOrd]??"").trim();
      const ord = ordRaw==="" ? null : ordRaw;
      if(!id || !name) continue;
      if(active==="0" || active.toLowerCase()==="false") continue;

      out.push({
        id, cat, name, price,
        ord,
        ordNum: ordRaw==="" ? 1e15 : Number(ordRaw)
      });
    }

    out.forEach(x=>{ if(!CATS.includes(x.cat)) x.cat="ê¸°íƒ€"; });
    items = out;
    localStorage.setItem(LS_ITEMS, JSON.stringify(items));
    renderAll();
    toast("ìƒí’ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  }catch(e){
    if(!items.length) toast("CSV ë¡œë“œ ì‹¤íŒ¨(ì‹œíŠ¸ ê³µìœ /ê²Œì‹œ í™•ì¸)");
  }
}

/* =============================
   ë Œë”
============================= */
function buildTabs(){
  const box = $("#tabs");
  box.innerHTML="";
  CATS.forEach(c=>{
    const b = el("button",{className:"tab"+(c===activeCat?" active":""), textContent:c});
    b.onclick=()=>{ activeCat=c; buildTabs(); renderAll(); };
    box.appendChild(b);
  });
}
function buildChosungKeys(){
  const box = $("#chosungKeys");
  box.innerHTML="";
  CHO.forEach(ch=>{
    const b=el("button",{className:"kbtn", textContent:ch});
    b.onclick=()=>{ $("#q").value += ch; renderAll(); };
    box.appendChild(b);
  });
  const clr=el("button",{className:"kbtn clear", textContent:"X"});
  clr.onclick=()=>{ $("#q").value=""; renderAll(); };
  box.appendChild(clr);
}

function getFiltered(){
  const q = $("#q").value.trim();
  const qLow = q.toLowerCase();
  const qCho = toChosung(q);
  const onlyCho = isAllCho(q);

  // âœ… ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ â€œì „í’ˆëª©(íƒ­ ë¬´ì‹œ)â€, ì—†ìœ¼ë©´ íƒ­ ê¸°ì¤€
  let list = items.slice();
  if(!q){
    list = list.filter(x=>x.cat===activeCat);
  }else{
    list = list.filter(x=>{
      const name = x.name.toLowerCase();
      const nameCho = toChosung(x.name);
      if(onlyCho) return nameCho.includes(q);              // ì˜ˆ: ã……ã„± â†’ ì‚¬ê³¼
      return name.includes(qLow) || nameCho.includes(qCho); // ì˜ˆ: ê°ì / ã„±ã…ˆ
    });
  }

  // ì •ë ¬: í•€ ìš°ì„  -> ord -> ì´ë¦„
  list.sort((a,b)=>{
    const ap = pins.has(a.id) ? 0 : 1;
    const bp = pins.has(b.id) ? 0 : 1;
    if(ap!==bp) return ap-bp;
    if(a.ordNum!==b.ordNum) return a.ordNum-b.ordNum;
    return a.name.localeCompare(b.name,"ko");
  });

  return list;
}

function renderPinned(){
  const box = $("#pinnedGrid");
  box.innerHTML="";
  const pinnedItems = items
    .filter(x=>pins.has(x.id))
    .sort((a,b)=>a.ordNum-b.ordNum || a.name.localeCompare(b.name,"ko"));

  if(!pinnedItems.length){
    box.innerHTML = `<div class="emptyPinned">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ìƒí’ˆì„ ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •)</div>`;
    return;
  }
  pinnedItems.slice(0,12).forEach(x=> box.appendChild(makeCard(x)));
}

function makeCard(x){
  const c = el("div",{className:"card"+(pins.has(x.id)?" pinnedCard":"")});
  const n = el("div",{className:"name", textContent:x.name});
  const p = el("div",{className:"price", textContent:krw(x.price)});
  const chip = el("div",{className:"chip", textContent:x.cat});
  const pin = el("div",{className:"pinIcon "+(pins.has(x.id)?"":"off"), textContent:"ğŸ“Œ"});
  c.append(n,p,chip,pin);

  c.addEventListener("click", ()=>{
    if(c._longFired) { c._longFired=false; return; }
    addToCart(x.id, 1);
  });

  let tmr=null;
  c.addEventListener("pointerdown", ()=>{
    c._longFired=false;
    tmr=setTimeout(()=>{
      c._longFired=true;
      togglePin(x.id);
    }, 450);
  });
  ["pointerup","pointerleave","pointercancel"].forEach(ev=>{
    c.addEventListener(ev, ()=>{ if(tmr) clearTimeout(tmr); });
  });

  return c;
}

function renderGrid(){
  const grid=$("#grid");
  grid.innerHTML="";
  const list=getFiltered();
  list.forEach(x=>grid.appendChild(makeCard(x)));
}

function savePins(){ localStorage.setItem(LS_PINS, JSON.stringify(Array.from(pins))); }
function togglePin(id){
  if(pins.has(id)) pins.delete(id);
  else pins.add(id);
  savePins();
  renderAll();
  toast(pins.has(id) ? "ê³ ì •ë¨" : "ê³ ì •í•´ì œ");
}

function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
function saveUsed(){ localStorage.setItem(LS_USED, JSON.stringify(used)); }
function saveReceived(){ localStorage.setItem(LS_REC, String(received)); }
function saveHolds(){ localStorage.setItem(LS_HOLDS, JSON.stringify(holds)); }

function addToCart(id, d){
  cart[id] = (cart[id]||0) + d;
  if(cart[id] <= 0) delete cart[id];
  used[id] = (used[id]||0) + 1;
  saveCart(); saveUsed();
  renderCart();
}

function setQty(id, qty){
  if(qty<=0) delete cart[id];
  else cart[id]=qty;
  saveCart();
  renderCart();
}

function cartStats(){
  let total=0, cnt=0;
  for(const [id,qty] of Object.entries(cart)){
    const it = items.find(x=>x.id===id);
    if(!it) continue;
    total += it.price * qty;
    cnt += qty;
  }
  return {total, cnt};
}

function renderCart(){
  const wrap=$("#cartWrap");
  wrap.innerHTML="";

  const entries = Object.entries(cart);
  entries.sort((a,b)=>{
    const ia = items.find(x=>x.id===a[0]); const ib = items.find(x=>x.id===b[0]);
    if(!ia && !ib) return 0;
    if(!ia) return 1; if(!ib) return -1;
    const ap = pins.has(ia.id)?0:1, bp=pins.has(ib.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(ia.ordNum!==ib.ordNum) return ia.ordNum-ib.ordNum;
    return ia.name.localeCompare(ib.name,"ko");
  });

  entries.forEach(([id,qty])=>{
    const it = items.find(x=>x.id===id);
    if(!it) return;

    const row = el("div",{className:"cartItem"});
    const nameLine = el("div",{className:"ciNameLine"});
    const nameText = el("span",{textContent:it.name});
    const qtyTag = el("span",{className:"ciQtyTag", textContent:`x${qty}`});
    nameLine.append(nameText, qtyTag);

    const price = el("div",{className:"ciPrice", textContent:krw(it.price*qty)});

    const right = el("div",{className:"ciRight"});
    const minus = el("button",{className:"qtyBtn", textContent:"â€“"});
    const qn    = el("div",{className:"qtyNum", textContent:String(qty)});
    const plus  = el("button",{className:"qtyBtn", textContent:"+"});
    const del   = el("button",{className:"delBtn", textContent:"Ã—"});

    // âœ… ë²„íŠ¼ë§Œ í´ë¦­ë˜ê²Œ(í–‰ ì „ì²´ í´ë¦­ ëŠë‚Œ ì œê±°)
    minus.onclick=(e)=>{ e.stopPropagation(); setQty(id, qty-1); };
    plus.onclick =(e)=>{ e.stopPropagation(); setQty(id, qty+1); };
    del.onclick  =(e)=>{ e.stopPropagation(); setQty(id, 0); };

    right.append(minus, qn, plus, del);
    row.append(nameLine, price, right);
    wrap.appendChild(row);
  });

  // ìµœì†Œ 8ì¤„ ëŠë‚Œ ìœ ì§€(ë¹ˆì¤„)
  const minRows = 8;
  const need = Math.max(0, minRows - entries.length);
  for(let i=0;i<need;i++){
    const dummy = el("div",{className:"cartItem"});
    dummy.style.opacity = .18;
    dummy.innerHTML = `<div></div><div></div><div></div>`;
    wrap.appendChild(dummy);
  }

  const {total,cnt}=cartStats();
  $("#receivedVal").textContent = krw(received);
  $("#changeVal").textContent = krw(Math.max(0, received - total));
  $("#holdsBtn").textContent = `ë¯¸ìˆ˜(${holds.length})`;
}

function renderAll(){
  buildTabs();
  renderPinned();
  renderGrid();
  renderCart();
}

/* =============================
   ë¯¸ìˆ˜ ê¸°ëŠ¥
============================= */
function summarizeHoldCart(h){
  const names = [];
  for(const [id,qty] of Object.entries(h.cart||{})){
    const it = items.find(x=>x.id===id);
    if(!it) continue;
    names.push(qty>1 ? `${it.name}x${qty}` : it.name);
  }
  return names.join(" Â· ");
}

function pushHold(){
  const {total,cnt} = cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }

  holds.unshift({
    id: "H"+Date.now(),
    ts: Date.now(),
    cart: {...cart},
    total, cnt
  });
  saveHolds();

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  renderCart();
  toast("ë¯¸ìˆ˜ë¡œ ì €ì¥ë¨");
}

function openHolds(){
  $("#modal").classList.add("show");
  renderHoldsList();
}
function closeHolds(){ $("#modal").classList.remove("show"); }

function renderHoldsList(){
  const box=$("#holdsList");
  box.innerHTML="";
  if(!holds.length){
    box.innerHTML = `<div class="hint">ë¯¸ìˆ˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  holds.forEach((h,idx)=>{
    const row = el("div",{className:"holdRow"});
    const left = el("div",{className:"holdLeft"});
    const t = new Date(h.ts);
    const time = `${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;

    const title = el("div",{className:"holdTitle", textContent:`ë¯¸ìˆ˜ ${idx+1} (${time})`});
    const amt = el("div",{className:"holdAmt", textContent:`${krw(h.total)} Â· ${h.cnt}ê°œ`});
    const sub = el("div",{className:"holdSub", textContent:summarizeHoldCart(h) || "-"});
    left.append(title, amt, sub);

    const btns = el("div",{className:"holdBtns"});
    const load = el("button",{className:"hBtn", textContent:"ë¶ˆëŸ¬ì˜¤ê¸°"});
    const done = el("button",{className:"hBtn done", textContent:"ë¯¸ìˆ˜ì™„ë£Œ"});
    const del  = el("button",{className:"hBtn del", textContent:"ì‚­ì œ"});

    load.onclick=()=>{
      cart = {...h.cart};
      received = 0;
      saveCart(); saveReceived();
      closeHolds();
      renderCart();
      toast("ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜´");
    };
    done.onclick=()=>{
      // âœ… ë¯¸ìˆ˜ì™„ë£Œ = ëª©ë¡ì—ì„œ ì œê±°(ì •ì‚° ì™„ë£Œ ì²˜ë¦¬)
      holds = holds.filter(x=>x.id!==h.id);
      saveHolds();
      renderCart();
      renderHoldsList();
      toast("ë¯¸ìˆ˜ì™„ë£Œ ì²˜ë¦¬");
    };
    del.onclick=()=>{
      holds = holds.filter(x=>x.id!==h.id);
      saveHolds();
      renderCart();
      renderHoldsList();
      toast("ì‚­ì œë¨");
    };

    btns.append(load, done, del);
    row.append(left, btns);
    box.appendChild(row);
  });
}

/* =============================
   ì´ë²¤íŠ¸
============================= */
$("#q").addEventListener("input", ()=>renderAll());
$("#sortBtn").onclick=()=>toast("ì •ë ¬: ê³ ì • + ord (ê³ ì •)");
document.querySelectorAll("[data-add]").forEach(b=>{
  b.onclick=()=>{
    received += Number(b.dataset.add);
    saveReceived();
    renderCart();
  };
});
$("#receivedReset").onclick=()=>{
  received = 0;
  saveReceived();
  renderCart();
  toast("ë°›ì€ëˆë§Œ ì´ˆê¸°í™”");
};

$("#checkout").onclick=()=>{
  const {cnt,total}=cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }
  if(!confirm(`ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?\n\nì´í•©ê³„: ${krw(total)} (${cnt}ê°œ)`)) return;

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  renderCart();
  toast("ê²°ì œì™„ë£Œ");
};

$("#holdNow").onclick=pushHold;
$("#holdsBtn").onclick=openHolds;
$("#closeModal").onclick=closeHolds;
$("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeHolds(); });

/* =============================
   ì‹œì‘
============================= */
buildTabs();
buildChosungKeys();
renderAll();
loadItems();
</script>
</body>
</html>
