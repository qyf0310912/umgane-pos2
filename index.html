<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<link rel="icon" href="data:,">

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:18px;

    --fs-12:12px;
    --fs-13:13px;
    --fs-14:14px;
    --fs-16:16px;
    --fs-18:18px;
    --fs-24:24px;
    --fs-32:32px;

    --w-400:400;
    --w-500:500;
    --w-600:600;

    --right-w: 420px;

    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    --card-min: 210px;
  }

  @media (min-width:1024px) and (max-width:1400px){
    :root{ --right-w:420px; --card-min:210px; }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }

  .tabsRow{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .syncWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .syncInfo{font-size:12px; color:rgba(245,247,255,.65); white-space:nowrap;}

  .searchRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
  }

  .chosungRow{
    display:flex;
    flex-direction:row !important;
    gap:6px;
    flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{ opacity:.35; filter:grayscale(.55); }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    display:flex;
    gap:8px;
    align-items:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.92);
    flex-wrap:wrap;
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    white-space:nowrap;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{
    flex:1;
    overflow:auto;
    padding:10px 10px 6px;
  }

  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }

  .qtyBox{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:700;
  }

  .summary{
    border-top:1px solid var(--line);
    padding:10px 12px;
  }
  .sumTitle{
    font-size:var(--fs-13);
    color:rgba(245,247,255,.7);
    font-weight:var(--w-600);
  }
  .sumMoney{
    margin-top:4px;
    font-size:var(--fs-32);
    font-weight:700;
    letter-spacing:-.6px;
    line-height:1.05;
  }
  .twoCol{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:8px;
  }
  .moneyBox{
    border-radius:16px;
    padding:8px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .moneyLabel{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
  }
  .moneyValue{
    margin-top:3px;
    font-size:22px;
    font-weight:800;
    line-height:1.05;
  }

  .cashGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .cashBtn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-600);
    font-size:var(--fs-14);
  }
  .cashBtn.reset{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.28);
  }

  .bottomRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 2fr;
    gap:10px;
    align-items:stretch;
  }

  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:9px 10px;
    text-align:left;
    color:var(--text);
  }
  .misuBtn .t{
    font-weight:800;
    font-size:var(--fs-16);
    color:var(--text);
    line-height:1.05;
  }
  .misuBtn .s{
    margin-top:3px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
    line-height:1.1;
  }

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:900;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
    padding:12px 10px;
  }

  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(900px, 96vw);
    max-height:84vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{
    margin:0;
    font-size:var(--fs-18);
    font-weight:700;
  }
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:700;
  }

  .misuItem{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: minmax(0,1fr) auto;
    gap:10px;
    align-items:center;
  }
  .misuInfo{ min-width:0; }
  .misuInfo .t{
    font-size:var(--fs-14);
    font-weight:700;
    display:flex;
    gap:8px;
    align-items:baseline;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuInfo .amt{ font-weight:800; color:rgba(245,247,255,.95); }
  .misuInfo .time{ color:rgba(245,247,255,.55); font-weight:600; font-size:var(--fs-12); }
  .misuInfo .d{
    margin-top:6px;
    font-size:var(--fs-13);
    font-weight:600;
    color:rgba(245,247,255,.8);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuBtns{ display:flex; gap:8px; }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    white-space:nowrap;
  }
  .btn2.danger{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }
  .btn2.good{ background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30); }

  /* âœ… ë¦¬í¬íŠ¸(ì˜¤ëŠ˜ ë°ì´í„°) */
  .repGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:12px;
  }
  .repBox{
    border-radius:16px;
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .repLabel{ font-size:12px; color:rgba(245,247,255,.65); font-weight:700; }
  .repValue{ margin-top:4px; font-size:20px; font-weight:900; }
  .repValue.small{ font-size:16px; font-weight:800; }

  .repList{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    overflow:hidden;
    margin-bottom:10px;
  }
  .repListHead{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .repListHead .t{ font-weight:900; }
  .repRow{
    padding:10px 12px;
    display:grid;
    grid-template-columns: 1fr auto auto;
    gap:10px;
    border-bottom:1px solid rgba(255,255,255,.06);
    align-items:center;
  }
  .repRow:last-child{ border-bottom:0; }
  .repName{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-weight:700;
  }
  .repQty{ color:rgba(245,247,255,.8); font-weight:800; }
  .repAmt{ font-weight:900; }
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
    .repGrid{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>
<div class="app">
  <section class="panel left">
    <div class="top">

      <div class="tabsRow">
        <div class="tabs" id="tabs"></div>

        <div class="syncWrap">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ğŸ“… ì˜¤ëŠ˜: - Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· ê¸¸ê²Œ=ê³ ì •/í•´ì œ(PC ìš°í´ë¦­) Â· í´ë¦­=ë‹´ê¸°
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rightTop">
      <div class="rightTitle">
        <span class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</span>
        <span class="pill" id="salesPill">ğŸ“Š ì˜¤ëŠ˜(0ì›)</span>
      </div>
      <div class="rightTitle"><span class="pill" id="cartPill">ë¦¬ì…‹</span></div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>
</div>

<!-- ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">ë¯¸ìˆ˜ ëª©ë¡</h3>
      <button class="mClose" id="mClose">ë‹«ê¸°</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* ===============================
   ì €ì¥ í‚¤
================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

/* âœ… ì˜¤ëŠ˜ ë§¤ì¶œ/ì‹œê°„ëŒ€/ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ */
const LS_SALES_TODAY = "umgane_sales_today_v1"; // {date, events:[]}

/* ===============================
   âœ… êµ¬ê¸€ì‹œíŠ¸(CSV) â†’ ìƒí’ˆë§ˆìŠ¤í„° ë™ê¸°í™”
================================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZMLZiCqXn-YKsOwR_RR1nZudB1VqAKI652Aje2p3Ytjqfzx5YhcLtEHyuiCSFKPqZ8e1xvbF3JCU4/pub?output=csv";
const LS_LASTSYNC = "umgane_items_lastSync_v1";

/* âœ… ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „ CSV íŒŒì„œ */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      pushCell();
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    } else {
      cur += ch;
    }
  }
  if (cur.length > 0 || row.length > 0) { pushCell(); pushRow(); }
  return rows.filter(r => r.some(c => (c || "").trim() !== ""));
}

function toNumber(v) {
  const s = String(v ?? "").replace(/[^\d.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v, def=0){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : def;
}
function normalizeActive(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "1" || s === "true" || s === "y" || s === "yes" || s === "on") ? 1 : 0;
}
function nowISO(){ return new Date().toISOString(); }

function saveItemsToLS(items){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_LASTSYNC, nowISO());
}
function loadItemsFromLS(){
  try {
    const raw = localStorage.getItem(LS_ITEMS);
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}
function isSameDay(isoA, isoB){
  try{
    const a = new Date(isoA), b = new Date(isoB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }catch{ return false; }
}

async function syncItemsFromSheet({force=false} = {}) {
  const last = localStorage.getItem(LS_LASTSYNC);
  if (!force && last && isSameDay(last, nowISO())) {
    return { ok:true, skipped:true, count: (loadItemsFromLS()||[]).length };
  }

  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);

  const csv = await res.text();
  const rows = parseCSV(csv);

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  if (iId < 0 || iCat < 0 || iName < 0 || iPrice < 0) {
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ ë¶€ì¡±í•¨: id/cat/name/price í•„ìˆ˜");
  }

  const items = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r];

    const id = String(row[iId] ?? "").trim();

    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,"");
    if (cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ";

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if (!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    items.push({ id, cat, name, price, active, ord });
  }

  if (items.length < 3) {
    throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ(ì €ì¥ ì¤‘ë‹¨) - ì‹œíŠ¸/ê²Œì‹œ í™•ì¸ í•„ìš”");
  }

  saveItemsToLS(items);
  try { renderAll(); } catch {}
  return { ok:true, skipped:false, count: items.length };
}

window.umganeSyncFromSheet = syncItemsFromSheet;

// í˜ì´ì§€ ì—´ë¦´ ë•Œ 1íšŒ ìë™ ë™ê¸°í™”(ì˜¤ëŠ˜ í–ˆìœ¼ë©´ ìŠ¤í‚µ)
(async () => {
  try { await syncItemsFromSheet({ force:false }); }
  catch (e) { console.warn("[SHEET SYNC FAIL]", e?.message || e); }
})();

/* ===============================
   ì¹´í…Œê³ ë¦¬ / ì´ˆì„±
================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

/* ===============================
   ë¡œë“œ/ì„¸ì´ë¸Œ + ì•ˆì •í™”
================================= */
function loadRaw(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function normalizeCart(v){
  if (!v) return {};
  if (Array.isArray(v)){
    const out = {};
    v.forEach(x=>{
      if(!x) return;
      const id = String(x.id ?? x.name ?? "");
      if(!id) return;
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    });
    return out;
  }
  if (typeof v === "object"){
    const out = {};
    for(const k of Object.keys(v)){
      const x = v[k];
      if(!x) continue;
      if(Array.isArray(x)) continue;
      const id = String(x.id ?? k);
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    }
    return out;
  }
  return {};
}
function normalizePins(v){
  if (!v) return {};
  if (typeof v === "object" && !Array.isArray(v)) return v;
  return {};
}

/* ===============================
   ì˜¤ëŠ˜ë§¤ì¶œ(ì´ë²¤íŠ¸ ê¸°ë°˜) ì €ì¥/ì§‘ê³„
================================= */
function todayKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function loadSalesToday(){
  const obj = loadRaw(LS_SALES_TODAY, null);
  const tk = todayKey();
  if(!obj || obj.date !== tk){
    const fresh = { date: tk, events: [] };
    save(LS_SALES_TODAY, fresh);
    return fresh;
  }
  if(!Array.isArray(obj.events)) obj.events = [];
  return obj;
}
function saveSalesToday(obj){
  save(LS_SALES_TODAY, obj);
}
function recordSaleEvent({ts, total, entries}){
  const s = loadSalesToday();
  s.events.push({
    ts,
    total: Math.round(Number(total)||0),
    items: entries.map(x=>({
      id: String(x.id||""),
      name: String(x.name||""),
      qty: Math.round(Number(x.qty)||0),
      price: Math.round(Number(x.price)||0)
    }))
  });
  // ë„ˆë¬´ ì»¤ì§€ë©´ ë°©ì–´(í•˜ë£¨ì¹˜ë§Œ)
  if(s.events.length > 2000) s.events = s.events.slice(-2000);
  saveSalesToday(s);
}

function sumMisuAmount(list){
  return (list||[]).reduce((a,m)=>a+Math.round(Number(m.amount||0)),0);
}

/* 12/2/4/6 ëˆ„ì : 12:00,14:00,16:00,18:00 ê¸°ì¤€ */
function salesCheckpoints(events){
  const cps = [
    { label:"12ì‹œ", h:12 },
    { label:"2ì‹œ",  h:14 },
    { label:"4ì‹œ",  h:16 },
    { label:"6ì‹œ",  h:18 }
  ];
  const out = {};
  cps.forEach(c=> out[c.label]=0);

  for(const e of events){
    const d = new Date(e.ts);
    const t = d.getHours() + d.getMinutes()/60;
    // ëˆ„ì  ê¸°ì¤€: í•´ë‹¹ ì‹œê° "ì´ì „"ê¹Œì§€ í•©ì‚°
    if(t < 12) out["12ì‹œ"] += e.total;
    if(t < 14) out["2ì‹œ"]  += e.total;
    if(t < 16) out["4ì‹œ"]  += e.total;
    if(t < 18) out["6ì‹œ"]  += e.total;
    if(t >= 18){
      // 18ì‹œ ì´í›„ëŠ” ëˆ„ì ì— í¬í•¨ë˜ì§€ ì•Šê²Œ í–ˆìŒ(ì›í•˜ë©´ í¬í•¨í•˜ê²Œ ë°”ê¿€ ìˆ˜ ìˆìŒ)
    }
  }
  // ëˆ„ì ê°’ì´ ì´ìƒí•´ ë³´ì¼ ìˆ˜ ìˆì–´ì„œ "ì§„ì§œ ëˆ„ì "ìœ¼ë¡œ ë³€í™˜:
  // out["2ì‹œ"]ëŠ” 14ì‹œ ì´ì „ ëˆ„ì ì´ ë§ê³ , out["4ì‹œ"], out["6ì‹œ"]ë„ ë™ì¼.
  return out;
}

function aggregateItems(events){
  const map = {};
  for(const e of events){
    for(const it of (e.items||[])){
      const id = it.id || it.name;
      if(!id) continue;
      if(!map[id]) map[id] = { id, name: it.name || id, qty:0, amount:0 };
      map[id].qty += Math.round(Number(it.qty)||0);
      map[id].amount += Math.round(Number(it.qty)||0) * Math.round(Number(it.price)||0);
      // (ë‹¨, ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆ ê°€ê²©ì„ ë°”ê¾¸ëŠ” ê¸°ëŠ¥ì´ ì—†ìœ¼ë‹ˆ priceëŠ” ì‹œì  ê°€ê²© ê·¸ëŒ€ë¡œ)
    }
  }
  return Object.values(map).filter(x=>x.qty>0);
}

function bestWorst15(agg){
  const sorted = [...agg].sort((a,b)=> b.amount - a.amount);
  const best = sorted.slice(0,15);
  const worst = sorted.slice(-15).reverse(); // ê°€ì¥ ì‘ì€ 15ê°œ
  return { best, worst };
}

/* ===============================
   ìƒ˜í”Œ seed
================================= */
function seedItemsIfEmpty(){
  const existing = loadRaw(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
    {id:"S04", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:1},
    {id:"S05", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* ===============================
   ìƒíƒœ
================================= */
let items = loadRaw(LS_ITEMS, []);
let pins  = normalizePins(loadRaw(LS_PINS, {}));
let cart  = normalizeCart(loadRaw(LS_CART, {}));
let paid  = loadRaw(LS_PAID, 0);
let misu  = loadRaw(LS_MISU, []);
let activeCat = "ì „ì²´";
let query = "";

/* ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ë³µ ë°©ì§€ */
let loadedMisuIndex = null;

/* ===============================
   ì—˜ë¦¬ë¨¼íŠ¸
================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elMisuPill = document.getElementById("misuPill");
const elSalesPill = document.getElementById("salesPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

/* ëª¨ë‹¬(ê³µìš©) */
const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elModalTitle = document.getElementById("modalTitle");
const elModalBody = document.getElementById("modalBody");

/* ë™ê¸°í™” ë²„íŠ¼/í‘œì‹œ */
const syncBtn = document.getElementById("syncBtn");
const syncInfo = document.getElementById("syncInfo");

/* ===============================
   ìœ í‹¸
================================= */
function won(n){ const x = Math.round(Number(n)||0); return x.toLocaleString("ko-KR") + "ì›"; }

function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){ (pins[it.id] ? pinned : normal).push(it); }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd); normal.sort(byOrd);
  return [...pinned, ...normal];
}

function matchItem(it, q){
  if(!q) return true;
  const name = normalize(it.name);
  const qn = normalize(q);
  if(name.includes(qn)) return true;

  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;

  return false;
}

function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);

  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* ===============================
   íƒ­/í‚¤íŒ¨ë“œ
================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    elTabs.appendChild(b);
  });
}

function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });

  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* ===============================
   ê³ ì •
================================= */
function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ
================================= */
function persistCart(){
  cart = normalizeCart(cart);
  save(LS_CART, cart);
}

function addToCart(it){
  if(Number(it.active)!==1) return;
  const id = it.id;
  if(!cart[id]){
    cart[id] = {id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[id].qty += 1;
  }
  persistCart();
  renderAll();
}

function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  persistCart();
  renderAll();
}

function removeCart(id){
  delete cart[id];
  persistCart();
  renderAll();
}

function resetCartAll(){
  const ok = confirm("ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆì„ ë¦¬ì…‹í• ê¹Œìš”?");
  if(!ok) return;
  cart = {};
  paid = 0;
  loadedMisuIndex = null;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function cartEntries(){ return Object.values(normalizeCart(cart)); }
function cartCount(){ return cartEntries().reduce((a,x)=>a+(x.qty||0),0); }
function cartTotal(){ return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0); }

/* ì‚‘ */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* ===============================
   ëª¨ë‹¬(ê³µìš©)
================================= */
function openModal(title, htmlOrNode){
  elModalTitle.textContent = title;
  elModalBody.innerHTML = "";
  if(typeof htmlOrNode === "string"){
    elModalBody.innerHTML = htmlOrNode;
  }else{
    elModalBody.appendChild(htmlOrNode);
  }
  elModalBack.style.display = "flex";
}
function closeModal(){ elModalBack.style.display = "none"; }

/* ===============================
   ê²°ì œì™„ë£Œ (âœ… ì˜¤ëŠ˜ë§¤ì¶œ ê¸°ë¡ ì¶”ê°€)
================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  beep();

  // âœ… ì˜¤ëŠ˜ë§¤ì¶œ ì´ë²¤íŠ¸ ê¸°ë¡(ê²°ì œ ì§ì „ cart snapshot)
  const entries = cartEntries();
  recordSaleEvent({ ts: Date.now(), total, entries });

  // âœ… ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¨ ê±´ ê²°ì œí•˜ë©´ ë¯¸ìˆ˜ì—ì„œ ì œê±°
  if(loadedMisuIndex !== null){
    misu = loadRaw(LS_MISU, misu);
    if(misu[loadedMisuIndex]){
      misu.splice(loadedMisuIndex, 1);
      save(LS_MISU, misu);
    }
    loadedMisuIndex = null;
  }

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* ===============================
   ë¯¸ìˆ˜
================================= */
function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (loadRaw(LS_MISU, misu).length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu = loadRaw(LS_MISU, misu);
  misu.unshift({ id, at: now.toISOString(), items: names, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;
  loadedMisuIndex = null;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}

function openMisu(){
  renderMisuList();
  openModal("ë¯¸ìˆ˜ ëª©ë¡", elMisuListWrap());
}
function elMisuListWrap(){
  const wrap = document.createElement("div");
  const total = sumMisuAmount(misu);
  const head = document.createElement("div");
  head.className = "repBox";
  head.style.marginBottom = "10px";
  head.innerHTML = `
    <div class="repLabel">ë¯¸ìˆ˜ ëˆ„ì </div>
    <div class="repValue">${won(total)}</div>
    <div class="repLabel" style="margin-top:6px;">ê±´ìˆ˜</div>
    <div class="repValue small">${misu.length}ê±´</div>
  `;
  wrap.appendChild(head);
  wrap.appendChild(elMisuList);
  return wrap;
}

function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  const next = {};
  for(const it of m.items){
    const found = items.find(x=>x.name===it.name);
    if(found){
      next[found.id] = {id:found.id, name:found.name, price:Number(found.price||0), qty:Number(it.qty||1)};
    }else{
      const tmpId = "TMP_"+it.name;
      next[tmpId] = {id:tmpId, name:it.name, price:0, qty:Number(it.qty||1)};
    }
  }
  cart = next;
  paid = 0;
  loadedMisuIndex = idx;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  closeModal();
  renderAll();
}

function settleMisu(idx){
  const m = misu[idx];
  if(!m) return;
  const ok = confirm(`${m.id} (${won(m.amount||0)}) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`);
  if(!ok) return;
  beep();
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function deleteMisu(idx){
  const ok = confirm("ì´ ë¯¸ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?");
  if(!ok) return;
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

/* ë¯¸ìˆ˜ ë¦¬ìŠ¤íŠ¸ DOM(ì¬ì‚¬ìš©) */
const elMisuList = document.createElement("div");
function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;">ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");

    const all = (m.items||[]).map(x=>`${x.name}x${x.qty}`);
    const itemsText = all.slice(0,4).join(" Â· ") + (all.length>4 ? ` Â· â€¦(+${all.length-4})` : "");

    const wrap = document.createElement("div");
    wrap.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuInfo";
    left.innerHTML = `
      <div class="t">
        <span>${m.id}</span>
        <span class="amt mono">Â· ${won(m.amount||0)}</span>
        <span class="time">(${hh}:${mm})</span>
      </div>
      <div class="d">${itemsText}</div>
    `;

    const right = document.createElement("div");
    right.className = "misuBtns";

    const bPay = document.createElement("button");
    bPay.className = "btn2 good";
    bPay.textContent = "ê²°ì œì™„ë£Œ";
    bPay.onclick = ()=>settleMisu(idx);

    const bLoad = document.createElement("button");
    bLoad.className = "btn2";
    bLoad.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    bLoad.onclick = ()=>restoreMisu(idx);

    const bDel = document.createElement("button");
    bDel.className = "btn2 danger";
    bDel.textContent = "ì‚­ì œ";
    bDel.onclick = ()=>deleteMisu(idx);

    right.appendChild(bPay);
    right.appendChild(bLoad);
    right.appendChild(bDel);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

/* ===============================
   ì˜¤ëŠ˜ ë°ì´í„°(ì „ì²´/12/2/4/6 + ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸)
================================= */
function openSales(){
  const sales = loadSalesToday();
  const events = sales.events || [];
  const total = events.reduce((a,e)=>a + Math.round(Number(e.total||0)), 0);

  const cps = salesCheckpoints(events);
  const agg = aggregateItems(events);
  const {best, worst} = bestWorst15(agg);

  const root = document.createElement("div");

  const grid = document.createElement("div");
  grid.className = "repGrid";

  const b1 = document.createElement("div");
  b1.className = "repBox";
  b1.innerHTML = `<div class="repLabel">ì˜¤ëŠ˜ ì´ë§¤ì¶œ</div><div class="repValue">${won(total)}</div>`;

  const b2 = document.createElement("div");
  b2.className = "repBox";
  b2.innerHTML = `
    <div class="repLabel">12ì‹œ/2ì‹œ/4ì‹œ/6ì‹œ ëˆ„ì (ì´ì „)</div>
    <div class="repValue small">12ì‹œ: ${won(cps["12ì‹œ"]||0)}</div>
    <div class="repValue small">2ì‹œ: ${won(cps["2ì‹œ"]||0)}</div>
    <div class="repValue small">4ì‹œ: ${won(cps["4ì‹œ"]||0)}</div>
    <div class="repValue small">6ì‹œ: ${won(cps["6ì‹œ"]||0)}</div>
  `;

  grid.appendChild(b1);
  grid.appendChild(b2);
  root.appendChild(grid);

  // ë² ìŠ¤íŠ¸
  root.appendChild(makeRankList("ë² ìŠ¤íŠ¸ 15 (ì˜¤ëŠ˜, ë§¤ì¶œ ê¸°ì¤€)", best));
  // ì›ŒìŠ¤íŠ¸
  root.appendChild(makeRankList("ì›ŒìŠ¤íŠ¸ 15 (ì˜¤ëŠ˜, ë§¤ì¶œ ê¸°ì¤€)", worst));

  openModal("ì˜¤ëŠ˜ ë°ì´í„°", root);
}

function makeRankList(title, list){
  const wrap = document.createElement("div");
  wrap.className = "repList";

  const head = document.createElement("div");
  head.className = "repListHead";
  head.innerHTML = `<div class="t">${title}</div><div class="muted">${list.length}ê°œ</div>`;
  wrap.appendChild(head);

  if(!list.length){
    const row = document.createElement("div");
    row.className = "repRow";
    row.innerHTML = `<div class="muted">ì•„ì§ íŒë§¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div><div></div><div></div>`;
    wrap.appendChild(row);
    return wrap;
  }

  list.forEach((x, i)=>{
    const row = document.createElement("div");
    row.className = "repRow";
    row.innerHTML = `
      <div class="repName">${i+1}. ${x.name}</div>
      <div class="repQty mono">x${x.qty}</div>
      <div class="repAmt mono">${won(x.amount)}</div>
    `;
    wrap.appendChild(row);
  });

  return wrap;
}

/* ===============================
   ìƒí’ˆ ì¹´ë“œ ë Œë”
================================= */
let pressTimer=null;
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "ê³ ì •";
    pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

    card.onclick = ()=>addToCart(it);
    card.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(it.id); return false; };

    card.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 450);
    }, {passive:true});
    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    elGrid.appendChild(card);
  });
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ ë Œë”
================================= */
function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">â€”</div>`;
    return;
  }

  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);

  // ë¯¸ìˆ˜ pill: ê±´ìˆ˜ + ì´ì•¡
  const misuAmt = sumMisuAmount(misu);
  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length})Â·${won(misuAmt)}`;

  // ì˜¤ëŠ˜ pill: ì´ë§¤ì¶œ
  const s = loadSalesToday();
  const todayTotal = (s.events||[]).reduce((a,e)=>a+Math.round(Number(e.total||0)),0);
  elSalesPill.textContent = `ğŸ“Š ì˜¤ëŠ˜(${won(todayTotal)})`;
}

function renderAll(){
  seedItemsIfEmpty();

  items = loadRaw(LS_ITEMS, items);
  pins  = normalizePins(loadRaw(LS_PINS, pins));
  cart  = normalizeCart(loadRaw(LS_CART, cart));
  paid  = loadRaw(LS_PAID, paid);
  misu  = loadRaw(LS_MISU, misu);

  save(LS_CART, cart);
  save(LS_PINS, pins);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* ===============================
   ì´ë²¤íŠ¸
================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  renderAll();
});

document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});

elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});

elPayBtn.addEventListener("click", doPay);

elSaveMisu.addEventListener("click", saveMisuNow);
elMisuPill.addEventListener("click", openMisu);

elSalesPill.addEventListener("click", openSales);

elCartPill.addEventListener("click", resetCartAll);

elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeModal();
});
elMClose.addEventListener("click", closeModal);

/* ===============================
   ë™ê¸°í™” UI
================================= */
const LS_LASTSYNC_UI = "umgane_lastSync_ui_v1";
let syncing = false;
let lastSyncTryAt = 0;

function fmtKST(ts){
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function todayKST(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setSyncInfo(){
  const t = Number(localStorage.getItem(LS_LASTSYNC_UI) || 0);
  syncInfo.textContent = t
    ? `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: ${fmtKST(t)}`
    : `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -`;
}

async function runSync({force=true, silent=false} = {}){
  if (syncing) return;

  const now = Date.now();
  if (now - lastSyncTryAt < 10_000) {
    if(!silent) alert("âš ï¸ ì ê¹ë§Œìš”. 10ì´ˆ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  lastSyncTryAt = now;

  syncing = true;
  syncBtn.disabled = true;
  syncBtn.textContent = "â³ ë™ê¸°í™”ì¤‘...";

  try{
    await umganeSyncFromSheet({ force });
    localStorage.setItem(LS_LASTSYNC_UI, String(Date.now()));
    setSyncInfo();
    if(!silent) alert("âœ… ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
  }catch(e){
    if(!silent) alert("âŒ ë™ê¸°í™” ì‹¤íŒ¨ (ì¸í„°ë„·/ì‹œíŠ¸ í™•ì¸)");
  }finally{
    syncing = false;
    syncBtn.disabled = false;
    syncBtn.textContent = "ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨";
  }
}

syncBtn.addEventListener("click", ()=> runSync({force:true, silent:false}));

setInterval(()=>{
  try{
    const cnt = cartCount();
    if(cnt === 0){
      runSync({force:false, silent:true});
    }
  }catch(e){}
}, 120_000);

setSyncInfo();
renderAll();

/* âœ… ì°¸ê³ : ì•„ë˜ëŠ” ë„¤ê°€ ë„£ì–´ë‘” Apps Script items API í…ŒìŠ¤íŠ¸ ì½”ë“œ(ê·¸ëŒ€ë¡œ ë‘ ) */
const ITEMS_API =
  "https://script.google.com/macros/s/AKfycbyiOcWFHx0nsFt-5P-aJ07HgeDGuZIuZLxiw_jiHGYJVsvud99DnfT9nxQTvkRcrF2m/exec?action=items";

async function loadItems(){
  try{
    const res = await fetch(ITEMS_API);
    const data = await res.json();
    if(!data.ok) return;
    console.log("ìƒí’ˆ(API)", data.items);
  }catch(e){}
}
loadItems();
</script>
</body>
</html>
