<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS (ì‹¤ë¬´ ìµœì¢…)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 12px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  button{border:0;border-radius:14px;cursor:pointer}
  .app{height:100%;display:grid;grid-template-columns: 1.35fr .65fr;gap:10px;padding:10px}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden
  }
  .left,.right{display:flex;flex-direction:column;min-width:0}

  /* ===== Left Top ===== */
  .topbar{padding:10px;display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:9px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line)}
  .tab.active{outline:2px solid rgba(255,159,0,.55); background:rgba(255,159,0,.10)}
  .row{display:flex;gap:8px;align-items:center}
  .search{
    flex:1;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);
    border:1px solid var(--line); border-radius:16px; padding:10px 12px; min-width:0
  }
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px;min-width:0}
  .sortBtn{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line)}
  .keys{display:flex;gap:8px;flex-wrap:wrap}
  .kbtn{
    width:44px;height:36px;background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid var(--line);border-radius:12px;font-weight:900
  }
  .kbtn.clear{background:rgba(255,59,48,.15);border-color:rgba(255,59,48,.25)}
  .hint{color:var(--muted);font-size:12px}

  /* ===== Pinned strip ===== */
  .pinned{padding:8px 10px;border-bottom:1px solid var(--line)}
  .pinnedTitle{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:6px}
  .pinnedGrid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}
  .emptyPinned{color:var(--muted);font-size:13px}

  /* ===== Items grid ===== */
  .itemsWrap{flex:1;min-height:0;overflow:auto;padding:10px}
  .grid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}

  .card{
    position:relative; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:18px;
    padding:10px; min-height:78px; display:flex; flex-direction:column; gap:6px
  }
  .name{font-size:18px;font-weight:900;letter-spacing:-.3px;line-height:1.06}
  .price{font-size:13px;color:var(--muted);font-weight:800}

  /* ì¹´í…Œê³ ë¦¬ ì¹©: ê¸°ë³¸ ìˆ¨ê¹€ / ê²€ìƒ‰ì¤‘ë§Œ í‘œì‹œ */
  .chip{
    display:none;
    align-self:flex-start;padding:5px 9px;border-radius:999px;font-size:11px;
    background:rgba(255,255,255,.04);border:1px solid var(--line); color:rgba(245,247,255,.8)
  }
  .chip.show{display:inline-flex}

  .pinIcon{
    position:absolute; right:10px; bottom:10px; width:32px;height:32px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,159,0,.10); border:1px solid rgba(255,159,0,.20); color:var(--accent); font-weight:900
  }
  .pinIcon.off{opacity:.12; filter:saturate(.3); background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); color:rgba(245,247,255,.45)}
  .card:active{transform:scale(.99)}
  .card.pinnedCard{outline:2px solid rgba(255,159,0,.40)}
  .meta{position:absolute; left:10px; bottom:10px; font-size:10.5px; color:rgba(245,247,255,.40)}

  /* ===== Right ===== */
  .rTop{
    padding:10px;border-bottom:1px solid var(--line);
    display:flex;justify-content:space-between;align-items:center;gap:8px
  }
  .totalBox{display:flex;flex-direction:column;gap:4px;min-width:0}
  .sub{color:var(--muted);font-size:12px}
  .tot{font-size:42px;font-weight:1000;letter-spacing:-.8px;white-space:nowrap}
  .btnMini{
    padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid var(--line);border-radius:14px;font-weight:900
  }
  .btnMini.accent{background:rgba(255,159,0,.14);border-color:rgba(255,159,0,.22)}
  .rightBtns{display:flex;gap:8px;align-items:center}

  /* ì¥ë°”êµ¬ë‹ˆ ìµœëŒ€ ë…¸ì¶œ */
  .cartWrap{
    flex:1;min-height:0;overflow:auto;
    padding:10px;display:flex;flex-direction:column;gap:8px
  }
  .cartItem{
    background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:9px 10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px
  }
  .ciLeft{min-width:0;display:flex;flex-direction:column;gap:3px}
  .ciName{
    font-weight:1000;font-size:18px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width: 320px;
  }
  .ciSub{color:var(--muted);font-size:12px;font-weight:800}
  .ciRight{display:flex;align-items:center;gap:8px}
  .qtyBtn{
    width:40px;height:34px;border-radius:12px;background:rgba(255,255,255,.04);
    color:var(--text);border:1px solid var(--line);font-size:18px;font-weight:1000
  }
  .delBtn{
    width:40px;height:34px;border-radius:12px;background:rgba(255,59,48,.16);
    color:var(--text);border:1px solid rgba(255,59,48,.28);font-size:18px;font-weight:1000
  }

  .sumRow{padding:10px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:8px}

  /* ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ â€œí•œì¤„ ì™¼ìª½ì •ë ¬â€ */
  .moneyLine{display:flex;align-items:baseline;justify-content:flex-start;gap:10px}
  .moneyLine .lbl{color:var(--muted);font-size:12px;min-width:64px}
  .moneyLine .val{font-size:30px;font-weight:1000}

  .btnGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:8px}
  .moneyBtn{
    height:46px;background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid var(--line);border-radius:16px;font-size:16px;font-weight:1000
  }
  .moneyBtn.reset{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}

  /* í•˜ë‹¨ ë²„íŠ¼ */
  .bottom{
    padding:10px;border-top:1px solid var(--line);
    display:grid;grid-template-columns: 1fr 2.2fr;gap:10px;align-items:stretch
  }
  .sideBtns{display:grid;grid-template-rows:1fr 1fr;gap:10px}
  .staffBtn{
    border-radius:18px;background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid var(--line);font-size:18px;font-weight:1000
  }
  .staffBtn.ok{background:rgba(41,209,126,.14);border-color:rgba(41,209,126,.22)}
  .staffBtn small{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-top:2px}
  .checkout{
    border-radius:18px;background:linear-gradient(180deg, rgba(255,159,0,1), rgba(255,159,0,.85));
    color:#101116;font-size:30px;font-weight:1000
  }
  .checkout small{display:block;font-size:13px;opacity:.75;font-weight:1000}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:12px}
  .modal.show{display:flex}
  .sheet{width:min(860px, 100%);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow)}
  .sheetHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sheetHead .title{font-weight:1000;font-size:18px}
  .sheetBody{padding:12px;display:flex;flex-direction:column;gap:10px}
  .holdRow{
    background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;
    padding:10px;display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .holdLeft{min-width:0;display:flex;flex-direction:column;gap:6px}
  .holdLeft .hName{font-weight:1000}
  .holdLeft .hItems{
    color:rgba(245,247,255,.82);
    font-weight:900;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width: 520px;
  }
  .holdRight{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .holdRight .hAmt{color:var(--muted);font-weight:900}
  .holdRight .hBtns{display:flex;gap:8px;flex-wrap:wrap}
  .hBtn{padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:1000}
  .hBtn.del{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,17,22,.95);
    border:1px solid var(--line);border-radius:999px;padding:10px 14px;color:var(--text);font-weight:1000;display:none}
  .toast.show{display:block}

  /* Responsive */
  @media (max-width: 1180px){
    .app{grid-template-columns:1fr;grid-template-rows:1.05fr .95fr}
    .grid,.pinnedGrid{grid-template-columns:repeat(4, minmax(0,1fr))}
    .bottom{grid-template-columns: 1fr 1.6fr}
    .checkout{font-size:24px}
    .holdLeft .hItems{max-width: 420px}
  }
  @media (max-width: 520px){
    .grid,.pinnedGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
    .tot{font-size:36px}
    .moneyLine .val{font-size:26px}
    .bottom{grid-template-columns:1fr}
    .sideBtns{grid-template-rows:1fr;grid-template-columns:1fr 1fr}
    .checkout{height:72px}
    .holdLeft .hItems{max-width: 250px}
  }
</style>
</head>
<body>
<div class="app">
  <section class="panel left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="row">
        <div class="search">
          <span style="opacity:.8">ğŸ”</span>
          <input id="q" placeholder="ì „í’ˆëª© ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="keys" id="chosungKeys"></div>
      <div class="hint">â€¢ ìƒí’ˆ í´ë¦­=ë‹´ê¸°  â€¢ ê¸¸ê²Œ(0.45ì´ˆ)=ê³ ì •/í•´ì œ  â€¢ ğŸ“Œ í´ë¦­=ê³ ì •/í•´ì œ  â€¢ ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€ â€œì „í’ˆëª©â€</div>
    </div>

    <div class="pinned" id="pinnedBox">
      <div class="pinnedTitle">
        <span>ê³ ì • Â· ìƒë‹¨</span>
        <span class="hint">ê³ ì •ì€ â€œê¸¸ê²Œâ€ ë˜ëŠ” ğŸ“Œ</span>
      </div>
      <div class="pinnedGrid" id="pinnedGrid"></div>
    </div>

    <div class="itemsWrap">
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rTop">
      <div class="totalBox">
        <div class="sub" id="totalLabel"><b>ì´í•©ê³„ (0ê°œ)</b></div>
        <div class="tot" id="grandTotal">0ì›</div>
      </div>

      <div class="rightBtns">
        <button class="btnMini" id="cartCountBtn">ì¥ë°”êµ¬ë‹ˆ(0)</button>
        <button class="btnMini accent" id="holdsBtn">ë¯¸ìˆ˜(0)</button>
      </div>
    </div>

    <div class="cartWrap" id="cartWrap"></div>

    <div class="sumRow">
      <div class="moneyLine">
        <span class="lbl">ë°›ì€ëˆ</span>
        <span class="val" id="receivedVal">0ì›</span>
      </div>
      <div class="moneyLine">
        <span class="lbl">ê±°ìŠ¤ë¦„ëˆ</span>
        <span class="val" id="changeVal">0ì›</span>
      </div>

      <div class="btnGrid">
        <button class="moneyBtn" data-add="500">+500</button>
        <button class="moneyBtn" data-add="1000">+1ì²œ</button>
        <button class="moneyBtn" data-add="5000">+5ì²œ</button>
        <button class="moneyBtn" data-add="10000">+1ë§Œ</button>
        <button class="moneyBtn" data-add="50000">+5ë§Œ</button>
        <button class="moneyBtn reset" id="receivedReset">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="bottom">
      <div class="sideBtns">
        <button class="staffBtn" id="holdNow">ë¯¸ìˆ˜<small>ëŒ€ê¸° ì €ì¥</small></button>
        <button class="staffBtn ok" id="holdDone">ë¯¸ìˆ˜ì™„ë£Œ<small>ë¶ˆëŸ¬ì˜¨ ê±´ ì™„ë£Œ</small></button>
      </div>
      <button class="checkout" id="checkout">ê²°ì œì™„ë£Œ<small id="modeHint">ì¼ë°˜ ê²°ì œ</small></button>
    </div>
  </section>
</div>

<!-- Holds modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="hBtn" id="closeModal">ë‹«ê¸°</button>
    </div>
    <div class="sheetBody" id="holdsList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== ì„¤ì • ===== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";
const APP_VER = "umgane_pos_v20251224_hold_items_confirm_1";

/* ===== ì €ì¥ í‚¤ ===== */
const LS_VER="umgane_app_ver";
const LS_ITEMS="umgane_items_v1";
const LS_PINS="umgane_pins_v1";
const LS_CART="umgane_cart_v1";
const LS_REC="umgane_received_v1";
const LS_USED="umgane_used_v1";
const LS_HOLDS="umgane_holds_v1";
const LS_CURH="umgane_current_hold_id";

/* ===== util ===== */
const $ = (s)=>document.querySelector(s);
const el = (tag, props={})=>Object.assign(document.createElement(tag), props);

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"), 1100);
}
function krw(n){ n=Math.max(0,Math.round(Number(n||0))); return n.toLocaleString("ko-KR")+"ì›"; }
function parsePrice(v){
  if(v==null) return 0;
  const s=String(v).trim(); if(!s) return 0;
  const cleaned=s.replace(/[^\d.]/g,""); if(!cleaned) return 0;
  const num=Number(cleaned); if(!isFinite(num)) return 0;
  return Math.round(num);
}

/* ===== ì¹´í…Œê³ ë¦¬ í†µì¼ ===== */
function normCat(c){
  c=(c||"").trim();
  if(c==="ë´‰ì±„ì†Œ"||c==="ë´‰ì§€ì•¼ì±„"||c==="ë´‰ì§€ì±„ì†Œ") c="ë´‰ì§€ì±„ì†Œ";
  return c||"ê¸°íƒ€";
}

/* ===== ì´ˆì„± ===== */
const CHO=["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChoChar(ch){
  const code=ch.charCodeAt(0);
  if(code<0xAC00||code>0xD7A3) return ch;
  const idx=Math.floor((code-0xAC00)/(21*28));
  return CHO[idx]||ch;
}
function toChosung(str){
  return Array.from(String(str||"")).map(getChoChar).join("");
}
function normQ(q){ return String(q||"").trim().replace(/\s+/g,""); }
function matchQuery(item, q){
  const qq = normQ(q);
  if(!qq) return true;

  const name = String(item.name||"");
  const cat  = String(item.cat||"");

  const low = qq.toLowerCase();
  if(name.toLowerCase().includes(low)) return true;
  if(cat.toLowerCase().includes(low)) return true;

  const nameCho = toChosung(name);
  if(nameCho.includes(qq)) return true;               // ã„±ã…ˆ
  if(nameCho.includes(toChosung(qq))) return true;    // í˜¹ì‹œ ì„ì—¬ë„
  return false;
}

/* ===== ë²„ì „ ì •ë¦¬ ===== */
(function ensureVersion(){
  const prev=localStorage.getItem(LS_VER);
  if(prev!==APP_VER){
    localStorage.setItem(LS_VER, APP_VER);
    localStorage.removeItem(LS_PINS);
    localStorage.removeItem(LS_CART);
    localStorage.removeItem(LS_REC);
    localStorage.removeItem(LS_USED);
    localStorage.removeItem(LS_HOLDS);
    localStorage.removeItem(LS_CURH);
  }
})();

/* ===== ìƒíƒœ ===== */
const CATS=["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
let activeCat="ê³¼ì¼";
let items=[];
let pins=new Set(JSON.parse(localStorage.getItem(LS_PINS)||"[]"));
let cart=JSON.parse(localStorage.getItem(LS_CART)||"{}");
let used=JSON.parse(localStorage.getItem(LS_USED)||"{}");
let received=Number(localStorage.getItem(LS_REC)||"0")||0;
let holds=JSON.parse(localStorage.getItem(LS_HOLDS)||"[]");
let currentHoldId=localStorage.getItem(LS_CURH)||"";

function setCurrentHold(id){
  currentHoldId=id||"";
  if(currentHoldId) localStorage.setItem(LS_CURH,currentHoldId);
  else localStorage.removeItem(LS_CURH);
  $("#modeHint").textContent = currentHoldId ? "ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¨ ìƒíƒœ" : "ì¼ë°˜ ê²°ì œ";
}

/* ===== CSV íŒŒì„œ ===== */
function parseCSV(text){
  const rows=[];
  let cur="", inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch === ',' && !inQ){
      pushCell();
    }else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    }else{
      cur+=ch;
    }
  }
  if(cur.length || row.length){ pushCell(); pushRow(); }
  return rows;
}

/* ===== load items ===== */
async function loadItems(){
  const cached=localStorage.getItem(LS_ITEMS);
  if(cached){
    try{
      const arr=JSON.parse(cached);
      if(Array.isArray(arr)&&arr.length){ items=arr; renderAll(); }
    }catch(e){}
  }

  try{
    const res=await fetch(CSV_URL+"&_ts="+Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨");
    const csv=await res.text();
    const rows=parseCSV(csv).filter(r=>r.some(x=>String(x||"").trim()!==""));
    if(rows.length<2) throw new Error("CSV ë‚´ìš© ì—†ìŒ");

    const header=rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx=(k)=>header.indexOf(k);
    const iId=idx("id"), iCat=idx("cat"), iName=idx("name"), iPrice=idx("price"), iActive=idx("active"), iOrd=idx("ord");

    const out=[];
    for(let r=1;r<rows.length;r++){
      const line=rows[r];
      const id=String(line[iId]??"").trim();
      const cat=normCat(String(line[iCat]??"").trim());
      const name=String(line[iName]??"").trim();
      const price=parsePrice(line[iPrice]);
      const active=String(line[iActive]??"1").trim();
      const ordRaw=String(line[iOrd]??"").trim();
      if(!id||!name) continue;
      if(active==="0"||active.toLowerCase()==="false") continue;
      out.push({ id, cat, name, price, ordNum: ordRaw===""?1e15:Number(ordRaw) });
    }

    out.forEach(x=>{ if(!CATS.includes(x.cat)) x.cat="ê¸°íƒ€"; });
    items=out;
    localStorage.setItem(LS_ITEMS, JSON.stringify(items));
    renderAll();
    toast("ìƒí’ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  }catch(e){
    if(!items.length) toast("CSV ë¡œë“œ ì‹¤íŒ¨(ì‹œíŠ¸ ê³µìœ /ê²Œì‹œ í™•ì¸)");
  }
}

/* ===== render ===== */
function buildTabs(){
  const box=$("#tabs"); box.innerHTML="";
  CATS.forEach(c=>{
    const b=el("button",{className:"tab"+(c===activeCat?" active":""), textContent:c});
    b.onclick=()=>{ activeCat=c; buildTabs(); renderAll(); };
    box.appendChild(b);
  });
}
function buildChosungKeys(){
  const box=$("#chosungKeys"); box.innerHTML="";
  CHO.forEach(ch=>{
    const b=el("button",{className:"kbtn", textContent:ch});
    b.onclick=()=>{ $("#q").value += ch; renderAll(); };
    box.appendChild(b);
  });
  const clr=el("button",{className:"kbtn clear", textContent:"X"});
  clr.onclick=()=>{ $("#q").value=""; renderAll(); };
  box.appendChild(clr);
}

function getFiltered(){
  const q=$("#q").value;
  const hasQ=normQ(q).length>0;

  let list=items.slice();

  // ê²€ìƒ‰ ì¤‘: ì „í’ˆëª© / ì•„ë‹ˆë©´ íƒ­
  if(hasQ) list=list.filter(x=>matchQuery(x,q));
  else list=list.filter(x=>x.cat===activeCat);

  // ì •ë ¬
  list.sort((a,b)=>{
    const ap=pins.has(a.id)?0:1, bp=pins.has(b.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(a.ordNum!==b.ordNum) return a.ordNum-b.ordNum;
    const au=-(used[a.id]||0), bu=-(used[b.id]||0);
    if(au!==bu) return au-bu;
    return a.name.localeCompare(b.name,"ko");
  });

  return { list, hasQ };
}

function savePins(){ localStorage.setItem(LS_PINS, JSON.stringify(Array.from(pins))); }
function togglePin(id){
  if(pins.has(id)) pins.delete(id); else pins.add(id);
  savePins(); renderAll(); toast(pins.has(id)?"ê³ ì •ë¨":"ê³ ì •í•´ì œ");
}

function renderPinned(){
  const box=$("#pinnedGrid"); box.innerHTML="";
  const pinnedItems=items.filter(x=>pins.has(x.id))
    .sort((a,b)=>a.ordNum-b.ordNum || a.name.localeCompare(b.name,"ko"));
  if(!pinnedItems.length){
    box.innerHTML=`<div class="emptyPinned">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ê¸¸ê²Œ ë˜ëŠ” ğŸ“Œ)</div>`;
    return;
  }
  pinnedItems.slice(0,15).forEach(x=>box.appendChild(makeCard(x,true)));
}

function makeCard(x){
  const {hasQ}=getFiltered();
  const c=el("div",{className:"card"+(pins.has(x.id)?" pinnedCard":"")});
  const n=el("div",{className:"name", textContent:x.name});
  const p=el("div",{className:"price", textContent:krw(x.price)});
  const chip=el("div",{className:"chip"+(hasQ?" show":""), textContent:x.cat});
  const pin=el("div",{className:"pinIcon "+(pins.has(x.id)?"":"off"), textContent:"ğŸ“Œ"});
  const meta=el("div",{className:"meta", textContent:"ì‚¬ìš© "+(used[x.id]||0)});
  c.append(n,p,chip,pin,meta);

  pin.addEventListener("click",(e)=>{ e.stopPropagation(); togglePin(x.id); });

  c.addEventListener("click",()=>{
    if(c._longFired){ c._longFired=false; return; }
    addToCart(x.id,1);
  });

  let tmr=null;
  c.addEventListener("pointerdown",()=>{
    c._longFired=false;
    tmr=setTimeout(()=>{ c._longFired=true; togglePin(x.id); }, 450);
  });
  ["pointerup","pointerleave","pointercancel"].forEach(ev=>{
    c.addEventListener(ev,()=>{ if(tmr) clearTimeout(tmr); });
  });

  return c;
}

function renderGrid(){
  const grid=$("#grid"); grid.innerHTML="";
  const {list}=getFiltered();
  list.forEach(x=>grid.appendChild(makeCard(x)));
}

/* ===== cart ===== */
function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
function saveUsed(){ localStorage.setItem(LS_USED, JSON.stringify(used)); }
function saveReceived(){ localStorage.setItem(LS_REC, String(received)); }
function saveHolds(){ localStorage.setItem(LS_HOLDS, JSON.stringify(holds)); }

function addToCart(id,d){
  cart[id]=(cart[id]||0)+d;
  if(cart[id]<=0) delete cart[id];
  used[id]=(used[id]||0)+1;
  saveCart(); saveUsed();
  renderCart();
}
function setQty(id,qty){
  if(qty<=0) delete cart[id]; else cart[id]=qty;
  saveCart(); renderCart();
}
function cartStats(){
  let total=0,cnt=0;
  for(const [id,qty] of Object.entries(cart)){
    const it=items.find(x=>x.id===id);
    if(!it) continue;
    total += it.price*qty;
    cnt += qty;
  }
  return {total,cnt};
}

function renderCart(){
  const wrap=$("#cartWrap"); wrap.innerHTML="";
  const entries=Object.entries(cart);

  entries.sort((a,b)=>{
    const ia=items.find(x=>x.id===a[0]); const ib=items.find(x=>x.id===b[0]);
    if(!ia&&!ib) return 0;
    if(!ia) return 1; if(!ib) return -1;
    const ap=pins.has(ia.id)?0:1, bp=pins.has(ib.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(ia.ordNum!==ib.ordNum) return ia.ordNum-ib.ordNum;
    return ia.name.localeCompare(ib.name,"ko");
  });

  entries.forEach(([id,qty])=>{
    const it=items.find(x=>x.id===id);
    if(!it) return;
    const row=el("div",{className:"cartItem"});
    const left=el("div",{className:"ciLeft"});
    const nm=el("div",{className:"ciName", textContent:`${it.name} x${qty}`});
    const sub=el("div",{className:"ciSub", textContent:`${krw(it.price)} Â· ${krw(it.price*qty)}`});
    left.append(nm,sub);

    const right=el("div",{className:"ciRight"});
    const minus=el("button",{className:"qtyBtn", textContent:"â€“"});
    const plus =el("button",{className:"qtyBtn", textContent:"+"});
    const del  =el("button",{className:"delBtn", textContent:"Ã—"});
    minus.onclick=()=>setQty(id,qty-1);
    plus.onclick =()=>setQty(id,qty+1);
    del.onclick  =()=>setQty(id,0);
    right.append(minus,plus,del);

    row.append(left,right);
    wrap.appendChild(row);
  });

  // ìµœì†Œ 7ì¤„
  const minRows=7;
  const need=Math.max(0, minRows-entries.length);
  for(let i=0;i<need;i++){
    const dummy=el("div",{className:"cartItem"});
    dummy.style.opacity=.20;
    dummy.innerHTML=`<div class="ciLeft"><div class="ciName"> </div><div class="ciSub"> </div></div>`;
    wrap.appendChild(dummy);
  }

  const {total,cnt}=cartStats();
  $("#grandTotal").textContent=krw(total);
  $("#totalLabel").innerHTML = `<b>ì´í•©ê³„ (${cnt.toLocaleString("ko-KR")}ê°œ)</b>`;
  $("#receivedVal").textContent=krw(received);
  $("#changeVal").textContent=krw(Math.max(0, received-total));

  $("#holdsBtn").textContent=`ë¯¸ìˆ˜(${holds.length})`;
  $("#cartCountBtn").textContent=`ì¥ë°”êµ¬ë‹ˆ(${cnt})`;
  setCurrentHold(currentHoldId);
}

function renderAll(){
  buildTabs();
  renderPinned();
  renderGrid();
  renderCart();
}

/* ===== ë¯¸ìˆ˜ ===== */
function pushHold(){
  const {total,cnt}=cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }
  holds.unshift({ id:"H"+Date.now(), ts:Date.now(), cart:{...cart}, total, cnt });
  saveHolds();

  cart={}; received=0;
  saveCart(); saveReceived();
  setCurrentHold("");
  renderCart();
  toast("ë¯¸ìˆ˜ ì €ì¥ë¨");
}

function completeCurrentHold(){
  if(!currentHoldId){ toast("ë¶ˆëŸ¬ì˜¨ ë¯¸ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤"); return; }
  holds = holds.filter(h=>h.id!==currentHoldId);
  saveHolds();

  cart={}; received=0;
  saveCart(); saveReceived();
  setCurrentHold("");
  renderCart();
  toast("ë¯¸ìˆ˜ì™„ë£Œ");
}

/* ===== ë¯¸ìˆ˜ ëª©ë¡ì— â€œìƒí’ˆëª… ìš”ì•½(â€¦ì²˜ë¦¬)â€ ===== */
function holdItemsSummary(h){
  // h.cart = {id:qty}
  const parts=[];
  for(const [id,qty] of Object.entries(h.cart||{})){
    const it=items.find(x=>x.id===id);
    if(!it) continue;
    parts.push(qty>1 ? `${it.name}x${qty}` : `${it.name}`);
  }
  // ë³´ê¸° ì¢‹ì€ ìˆœì„œë¡œ
  parts.sort((a,b)=>a.localeCompare(b,"ko"));

  let text = parts.join(" Â· ");
  const maxLen = 46; // ê¸¸ë©´ â€¦ ì²˜ë¦¬
  if(text.length > maxLen) text = text.slice(0, maxLen-1) + "â€¦";
  return text || "(ìƒí’ˆ ì—†ìŒ)";
}

/* ===== ëª¨ë‹¬ ===== */
function openHolds(){ $("#modal").classList.add("show"); renderHoldsList(); }
function closeHolds(){ $("#modal").classList.remove("show"); }

function renderHoldsList(){
  const box=$("#holdsList"); box.innerHTML="";
  if(!holds.length){ box.innerHTML=`<div class="hint">ë¯¸ìˆ˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

  holds.forEach((h,idx)=>{
    const row=el("div",{className:"holdRow"});

    const left=el("div",{className:"holdLeft"});
    const t=new Date(h.ts);
    const time=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;
    const mark=(h.id===currentHoldId) ? " <span class='hint'>(ë¶ˆëŸ¬ì˜´)</span>" : "";
    const nameLine=el("div",{className:"hName"});
    nameLine.innerHTML = `ë¯¸ìˆ˜ ${idx+1}${mark} <span class="hint">(${time})</span>`;

    // âœ… ê¸ˆì•¡ ëŒ€ì‹  ìƒí’ˆëª… ìš”ì•½
    const itemsLine=el("div",{className:"hItems", textContent: holdItemsSummary(h)});

    left.append(nameLine, itemsLine);

    const right=el("div",{className:"holdRight"});
    // ê¸ˆì•¡ì€ â€œì‘ê²Œâ€ ì˜¤ë¥¸ìª½ì— (ì›í•˜ë©´ ì•„ì˜ˆ ì‚­ì œë„ ê°€ëŠ¥)
    const amt=el("div",{className:"hAmt", textContent: `${krw(h.total)} Â· ${h.cnt}ê°œ`});

    const btns=el("div",{className:"hBtns"});
    const load=el("button",{className:"hBtn", textContent:"ë¶ˆëŸ¬ì˜¤ê¸°"});
    const del =el("button",{className:"hBtn del", textContent:"ì‚­ì œ"});

    load.onclick=()=>{
      cart={...h.cart}; received=0;
      saveCart(); saveReceived();
      setCurrentHold(h.id);
      closeHolds(); renderCart();
      toast("ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜´");
    };
    del.onclick=()=>{
      holds=holds.filter(x=>x.id!==h.id);
      if(h.id===currentHoldId) setCurrentHold("");
      saveHolds(); renderCart(); renderHoldsList();
    };

    btns.append(load,del);
    right.append(amt,btns);

    row.append(left,right);
    box.appendChild(row);
  });
}

/* ===== ì´ë²¤íŠ¸ ===== */
$("#q").addEventListener("input", ()=>renderAll());
$("#sortBtn").onclick=()=>toast("ì •ë ¬: ê³ ì • + ord");

document.querySelectorAll("[data-add]").forEach(b=>{
  b.onclick=()=>{ received += Number(b.dataset.add); saveReceived(); renderCart(); };
});
$("#receivedReset").onclick=()=>{
  received=0; saveReceived(); renderCart(); toast("ë°›ì€ëˆë§Œ ì´ˆê¸°í™”");
};

/* âœ… ê²°ì œì™„ë£Œ: í™•ì¸ì°½(ì†Œë¦¬ ì—†ìŒ) */
$("#checkout").onclick=()=>{
  const {cnt}=cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }

  const ok = window.confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  cart={}; received=0;
  saveCart(); saveReceived();
  setCurrentHold("");
  renderCart();
  toast("ê²°ì œì™„ë£Œ");
};

$("#holdNow").onclick=pushHold;
$("#holdDone").onclick=completeCurrentHold;

$("#holdsBtn").onclick=openHolds;
$("#closeModal").onclick=closeHolds;
$("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeHolds(); });

/* ===== ì‹œì‘ ===== */
buildTabs();
buildChosungKeys();
setCurrentHold(currentHoldId);
renderAll();
loadItems();
</script>
</body>
</html>
