<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>
<link rel="icon" href="data:,">

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:18px;

    --fs-12:12px;
    --fs-13:13px;
    --fs-14:14px;
    --fs-16:16px;
    --fs-18:18px;
    --fs-24:24px;
    --fs-32:32px;

    --w-400:400;
    --w-500:500;
    --w-600:600;

    --right-w: 420px;

    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    --card-min: 210px;
  }

  @media (min-width:1024px) and (max-width:1400px){
    :root{ --right-w:420px; --card-min:210px; }
  }

  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    overscroll-behavior:contain;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }

  .tabsRow{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .syncWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .syncInfo{font-size:12px; color:rgba(245,247,255,.65); white-space:nowrap;}

  .searchRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    user-select:text;
    -webkit-user-select:text;
    touch-action:manipulation;
  }

  .chosungRow{
    display:flex;
    flex-direction:row !important;
    gap:6px;
    flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
    user-select:none;
    -webkit-user-select:none;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{ opacity:.35; filter:grayscale(.55); }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    display:flex;
    align-items:center;
    gap:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.92);
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    user-select:none;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{
    flex:1;
    overflow:auto;
    padding:10px 10px 6px;
  }

  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }

  .qtyBox{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:700;
  }

  .summary{
    border-top:1px solid var(--line);
    padding:10px 12px;
  }
  .sumTitle{
    font-size:var(--fs-13);
    color:rgba(245,247,255,.7);
    font-weight:var(--w-600);
  }
  .sumMoney{
    margin-top:4px;
    font-size:var(--fs-32);
    font-weight:700;
    letter-spacing:-.6px;
    line-height:1.05;
  }
  .twoCol{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:8px;
  }
  .moneyBox{
    border-radius:16px;
    padding:8px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .moneyLabel{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
  }
  .moneyValue{
    margin-top:3px;
    font-size:22px;
    font-weight:800;
    line-height:1.05;
  }

  .cashGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .cashBtn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-600);
    font-size:var(--fs-14);
  }
  .cashBtn.reset{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.28);
  }

  .bottomRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 2fr;
    gap:10px;
    align-items:stretch;
  }

  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:9px 10px;
    text-align:left;
    color:var(--text);
  }
  .misuBtn .t{
    font-weight:800;
    font-size:var(--fs-16);
    color:var(--text);
    line-height:1.05;
  }
  .misuBtn .s{
    margin-top:3px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
    line-height:1.1;
  }

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:900;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
    padding:12px 10px;
  }

  /* ===== modal ===== */
  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:999;
  }
  .modal{
    width:min(980px, 96vw);
    max-height:84vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{
    margin:0;
    font-size:var(--fs-18);
    font-weight:800;
  }
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:800;
  }

  .misuItem{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: minmax(0,1fr) auto;
    gap:10px;
    align-items:center;
  }
  .misuInfo{ min-width:0; }
  .misuInfo .t{
    font-size:var(--fs-14);
    font-weight:800;
    display:flex;
    gap:8px;
    align-items:baseline;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuInfo .amt{ font-weight:900; color:rgba(245,247,255,.95); }
  .misuInfo .time{ color:rgba(245,247,255,.55); font-weight:700; font-size:var(--fs-12); }
  .misuInfo .d{
    margin-top:6px;
    font-size:var(--fs-13);
    font-weight:700;
    color:rgba(245,247,255,.8);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuBtns{ display:flex; gap:8px; }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:900;
    white-space:nowrap;
  }
  .btn2.danger{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }
  .btn2.good{ background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30); }

  /* ===== admin ===== */
  .adminTop{
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    margin-bottom:10px;
  }
  .adminTabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .adminTab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:14px;
  }
  .adminTab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }
  .adminPills{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .kpiGrid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
    margin-top:10px;
  }
  .kpi{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:10px 12px;
  }
  .kpi .l{ font-size:12px; color:rgba(245,247,255,.65); font-weight:900; }
  .kpi .v{ margin-top:4px; font-size:22px; font-weight:1000; letter-spacing:-.3px; }
  .kpi .s{ margin-top:4px; font-size:12px; color:rgba(245,247,255,.6); font-weight:800; }

  .segRow, .catRow{
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    margin-top:10px;
  }
  .segBtn, .catBtn{
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    font-weight:900;
    font-size:13px;
  }
  .segBtn.active, .catBtn.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .box{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-top:10px;
  }
  .box h4{
    margin:0 0 10px;
    font-size:14px;
    font-weight:1000;
    letter-spacing:-.2px;
  }
  .twoBox{
    display:grid;grid-template-columns:1fr 1fr;gap:10px;
    margin-top:10px;
  }
  .listRow{
    display:grid;
    grid-template-columns:minmax(0,1fr) auto;
    gap:10px;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(255,255,255,.02);
    margin-bottom:8px;
    align-items:center;
  }
  .listRow .n{
    min-width:0;
    font-weight:1000;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-weight:1000;
    font-size:12px;
    white-space:nowrap;
  }
  .tinyBtn{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:1000;
    font-size:13px;
    white-space:nowrap;
  }
  .tinyBtn.good{ background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30); }
  .tinyBtn.danger{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }

  .adminSearch{
    display:grid;
    grid-template-columns:1fr auto auto;
    gap:8px;
    align-items:center;
  }
  .adminSearch input{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    color:var(--text);
    outline:none;
    font-weight:900;
    user-select:text;
    -webkit-user-select:text;
    touch-action:manipulation;
  }

  .editForm{
    display:grid;
    grid-template-columns: minmax(0,1fr) 120px 120px 110px;
    gap:8px;
    align-items:center;
  }
  .editForm input, .editForm select{
    width:100%;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    color:var(--text);
    outline:none;
    font-weight:900;
  }
  .editForm select{
    appearance:none;
    -webkit-appearance:none;
  }

  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
    .kpiGrid{ grid-template-columns:1fr; }
    .twoBox{ grid-template-columns:1fr; }
    .editForm{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>

<body>
<div class="app">
  <section class="panel left">
    <div class="top">
      <div class="tabsRow">
        <div class="tabs" id="tabs"></div>

        <div class="syncWrap">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ğŸ“… ì˜¤ëŠ˜: - Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· í•€(ğŸ“Œ)=1.2ì´ˆ ê¾¹ ëˆŒëŸ¬ ê³ ì •/í•´ì œ Â· í´ë¦­=ë‹´ê¸°
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <!-- âœ… ë©”ì¸ ìƒë‹¨: ë¯¸ìˆ˜(ì™¼ìª½) / ê´€ë¦¬ì+ë¦¬ì…‹(ì˜¤ë¥¸ìª½) -->
    <div class="rightTop">
      <div class="rightTitle">
        <span class="pill" id="misuPill">ë¯¸ìˆ˜(0)</span>
      </div>
      <div class="rightTitle" style="justify-content:flex-end;">
        <span class="pill accent" id="adminPill">ê´€ë¦¬ì</span>
        <span class="pill" id="cartPill">ë¦¬ì…‹</span>
      </div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>
</div>

<!-- ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ë¯¸ìˆ˜ ëª©ë¡</h3>
      <button class="mClose" id="mClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>
    <div id="misuList"></div>
  </div>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div class="modalBack" id="adminBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ê´€ë¦¬ì</h3>
      <button class="mClose" id="adminClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>

    <div class="adminTop">
      <div class="adminTabs" id="adminTabs"></div>
      <div class="adminPills">
        <span class="badge mono" id="adminSalesBadge">ê²°ì œ 0ê±´</span>
        <span class="badge mono" id="adminRevenueBadge">ë§¤ì¶œ 0ì›</span>
      </div>
    </div>

    <!-- ë°ì´í„°ë¶„ì„ -->
    <div id="admin-ana">
      <div class="kpiGrid">
        <div class="kpi">
          <div class="l">ê²°ì œê±´ìˆ˜(ì˜¤ëŠ˜ ëˆ„ì )</div>
          <div class="v mono" id="kpiPayCnt">0</div>
          <div class="s">í˜„ì¥ íŒë‹¨ 1ë²ˆ</div>
        </div>
        <div class="kpi">
          <div class="l">ê°ë‹¨ê°€</div>
          <div class="v mono" id="kpiAOV">0ì›</div>
          <div class="s">ì´ë§¤ì¶œ Ã· ê²°ì œê±´ìˆ˜</div>
        </div>
        <div class="kpi">
          <div class="l">í”¼í¬ ì‹œê°„ëŒ€ + ë¹„ì¤‘</div>
          <div class="v mono" id="kpiPeak">-</div>
          <div class="s">í•´ë‹¹ ì‹œê°„ëŒ€ ë§¤ì¶œ ë¹„ì¤‘</div>
        </div>
      </div>

      <!-- âœ… ì‹œê°„ëŒ€(ì•ìœ¼ë¡œ) -->
      <div class="segRow" id="segRow"></div>
      <!-- âœ… ì¹´í…Œê³ ë¦¬(ì•ìœ¼ë¡œ) -->
      <div class="catRow" id="catRow"></div>

      <div class="twoBox">
        <div class="box">
          <h4>ë² ìŠ¤íŠ¸ 15 (ë‚˜ê°„ ìˆ˜ëŸ‰ ê¸°ì¤€)</h4>
          <div id="bestList"></div>
        </div>
        <div class="box">
          <h4>ì›ŒìŠ¤íŠ¸ 15 (ë‚˜ê°„ ìˆ˜ëŸ‰ ê¸°ì¤€)</h4>
          <div id="worstList"></div>
        </div>
      </div>
    </div>

    <!-- í’ˆì ˆìƒí’ˆ -->
    <div id="admin-soldout" class="hide">
      <div class="adminSearch">
        <input id="soldQ" placeholder="ì´ˆì„±ê²€ìƒ‰ (ì˜ˆ: ã„·ã„± = ë‹¨ê°)" autocomplete="off" />
        <button class="tinyBtn" id="soldClear">X</button>
        <button class="tinyBtn" id="soldShowAll">ì „ì²´</button>
      </div>

      <div class="muted" style="margin-top:8px;font-weight:1000;">
        ê²€ìƒ‰í•´ì„œ â€œí’ˆì ˆâ€ ëˆ„ë¥´ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ë©ë‹ˆë‹¤. (í’ˆì ˆ ì‹œê°„ + í˜„ì¬ê¹Œì§€ íŒë§¤ìˆ˜ëŸ‰ í‘œì‹œ)
      </div>

      <div class="box">
        <h4>ìƒí’ˆ ê²€ìƒ‰ ê²°ê³¼ (í’ˆì ˆ ì²˜ë¦¬)</h4>
        <div id="soldSearchList"></div>
      </div>

      <div class="box">
        <h4>í’ˆì ˆ ëª©ë¡ (ìˆ¨ê¹€ì¤‘)</h4>
        <div id="soldList"></div>
      </div>
    </div>

    <!-- ìƒí’ˆìˆ˜ì • -->
    <div id="admin-edit" class="hide">

      <!-- âœ… ìƒˆ ìƒí’ˆì¶”ê°€ (ìƒë‹¨) -->
      <div class="box">
        <h4>ìƒˆ ìƒí’ˆ ì¶”ê°€</h4>
        <div class="editForm" style="margin-bottom:8px;">
          <select id="newCat">
            <option value="ê³¼ì¼">ê³¼ì¼</option>
            <option value="ì•¼ì±„">ì•¼ì±„</option>
            <option value="ë´‰ì§€ì±„ì†Œ">ë´‰ì§€ì±„ì†Œ</option>
            <option value="ìƒì„ ">ìƒì„ </option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <input id="newName" placeholder="ìƒí’ˆëª… (ì˜ˆ: ë‹¨ê°/15ê°œ)" />
          <input id="newPrice" placeholder="ê°€ê²© (ì˜ˆ: 5000)" inputmode="numeric" />
          <button class="tinyBtn good" id="newAddBtn">ì¶”ê°€</button>
        </div>
        <div class="muted" style="font-weight:900;">IDëŠ” ìë™ ìƒì„±(S01, S02...) Â· ordëŠ” ìë™(ë§ˆì§€ë§‰+1)</div>
      </div>

      <div class="adminSearch" style="margin-top:10px;">
        <input id="editQ" placeholder="ê²€ìƒ‰/ì´ˆì„± (ì˜ˆ: ê°ì, ã„±ã…ˆ)" autocomplete="off" />
        <button class="tinyBtn" id="editClear">X</button>
        <button class="tinyBtn good" id="reorderBtn">ì •ë ¬ëª¨ë“œ OFF</button>
      </div>

      <div class="muted" style="margin-top:8px;font-weight:1000;">
        ì •ë ¬ëª¨ë“œ: ìƒí’ˆ 1ë²ˆ íƒ­(ì„ íƒ) â†’ ì˜®ê¸¸ ìë¦¬ ìƒí’ˆ 1ë²ˆ íƒ­(êµì²´) = í† ìŠ¤ ë°©ì‹
      </div>

      <div class="box">
        <h4>ìƒí’ˆëª©ë¡ ìˆ˜ì •</h4>
        <div id="editList"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===============================
   ì €ì¥ í‚¤
================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

const LS_LASTSYNC = "umgane_items_lastSync_v1";
const LS_LASTSYNC_UI = "umgane_lastSync_ui_v1";

/* âœ… ë¡œì»¬ ì˜¤ë²„ë¼ì´ë“œ(ê°€ê²©/ì´ë¦„/ì¹´í…Œê³ ë¦¬/í™œì„±/ì •ë ¬/í’ˆì ˆì‹œê°„) */
const LS_OVR = "umgane_overrides_v1";     // { [id]: {name,price,cat,active,ord,soldAt?} }
const LS_SALES = "umgane_sales_v1";       // ê²°ì œ ë¡œê·¸(ì˜¤ëŠ˜ ë¶„ì„ìš©)

/* ===============================
   ê´€ë¦¬ì ë¹„ë²ˆ (ì›í•˜ë©´ ë°”ê¿”)
================================= */
const ADMIN_PASS = "1234";

/* ===============================
   âœ… êµ¬ê¸€ì‹œíŠ¸(CSV) â†’ ìƒí’ˆë§ˆìŠ¤í„° ë™ê¸°í™”
================================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZMLZiCqXn-YKsOwR_RR1nZudB1VqAKI652Aje2p3Ytjqfzx5YhcLtEHyuiCSFKPqZ8e1xvbF3JCU4/pub?output=csv";

/* âœ… ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „ CSV íŒŒì„œ */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      pushCell();
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    } else {
      cur += ch;
    }
  }
  if (cur.length > 0 || row.length > 0) { pushCell(); pushRow(); }
  return rows.filter(r => r.some(c => (c || "").trim() !== ""));
}

function toNumber(v) {
  const s = String(v ?? "").replace(/[^\d.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v, def=0){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : def;
}
function normalizeActive(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "1" || s === "true" || s === "y" || s === "yes" || s === "on") ? 1 : 0;
}
function nowISO(){ return new Date().toISOString(); }
function isSameDay(isoA, isoB){
  try{
    const a = new Date(isoA), b = new Date(isoB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }catch{ return false; }
}

function loadRaw(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function loadOverrides(){ return loadRaw(LS_OVR, {}); }
function saveOverrides(ovr){ save(LS_OVR, ovr); }

function applyOverrides(baseItems){
  const ovr = loadOverrides();
  const map = new Map(baseItems.map(x=>[x.id, {...x}]));
  for(const id of Object.keys(ovr)){
    const patch = ovr[id] || {};
    if(map.has(id)){
      const it = map.get(id);
      map.set(id, {
        ...it,
        name: patch.name ?? it.name,
        price: (patch.price ?? it.price),
        cat: patch.cat ?? it.cat,
        active: (patch.active ?? it.active),
        ord: (patch.ord ?? it.ord),
      });
    }else{
      // ì‹œíŠ¸ì— ì—†ì§€ë§Œ ë¡œì»¬ì—ì„œ ë§Œë“  ìƒˆ ìƒí’ˆ
      if(patch && patch.name){
        map.set(id, {
          id,
          cat: patch.cat || "ê¸°íƒ€",
          name: patch.name,
          price: Number(patch.price||0),
          active: Number(patch.active ?? 1),
          ord: Number(patch.ord||0)
        });
      }
    }
  }
  return [...map.values()];
}

function upsertOverride(id, patch){
  const ovr = loadOverrides();
  ovr[id] = { ...(ovr[id]||{}), ...patch };
  saveOverrides(ovr);
}

function removeOverride(id){
  const ovr = loadOverrides();
  delete ovr[id];
  saveOverrides(ovr);
}

/* ===============================
   CSV ë™ê¸°í™”
================================= */
function saveItemsToLS(items){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_LASTSYNC, nowISO());
}

async function syncItemsFromSheet({force=false} = {}) {
  const last = localStorage.getItem(LS_LASTSYNC);
  if (!force && last && isSameDay(last, nowISO())) {
    return { ok:true, skipped:true, count: (loadRaw(LS_ITEMS,[])||[]).length };
  }

  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);

  const csv = await res.text();
  const rows = parseCSV(csv);

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  if (iId < 0 || iCat < 0 || iName < 0 || iPrice < 0) {
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ ë¶€ì¡±í•¨: id/cat/name/price í•„ìˆ˜");
  }

  const items = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r];

    const id = String(row[iId] ?? "").trim();
    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,"");
    if (cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ"; // ì¹´í…Œê³ ë¦¬ í†µì¼

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if (!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    items.push({ id, cat, name, price, active, ord });
  }

  if (items.length < 3) {
    throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ(ì €ì¥ ì¤‘ë‹¨) - ì‹œíŠ¸/ê²Œì‹œ í™•ì¸ í•„ìš”");
  }

  saveItemsToLS(items);
  try { renderAll(); } catch {}
  return { ok:true, skipped:false, count: items.length };
}

window.umganeSyncFromSheet = syncItemsFromSheet;

// í˜ì´ì§€ ì—´ë¦´ ë•Œ 1íšŒ ìë™ ë™ê¸°í™”(ì˜¤ëŠ˜ í–ˆìœ¼ë©´ ìŠ¤í‚µ)
(async () => {
  try { await syncItemsFromSheet({ force:false }); }
  catch (e) { console.warn("[SHEET SYNC FAIL]", e?.message || e); }
})();

/* ===============================
   ì¹´í…Œê³ ë¦¬ / ì´ˆì„±
================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

/* ===============================
   âœ… ì•ˆì •í™”(í˜•íƒœ ì„ì„ ë°©ì§€)
================================= */
function normalizeCart(v){
  if (!v) return {};
  if (Array.isArray(v)){
    const out = {};
    v.forEach(x=>{
      if(!x) return;
      const id = String(x.id ?? x.name ?? "");
      if(!id) return;
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    });
    return out;
  }
  if (typeof v === "object"){
    const out = {};
    for(const k of Object.keys(v)){
      const x = v[k];
      if(!x) continue;
      if(Array.isArray(x)) continue;
      const id = String(x.id ?? k);
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    }
    return out;
  }
  return {};
}
function normalizePins(v){
  if (!v) return {};
  if (typeof v === "object" && !Array.isArray(v)) return v;
  return {};
}

/* ===============================
   ìƒ˜í”Œ ì‹œë“œ
================================= */
function seedItemsIfEmpty(){
  const existing = loadRaw(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
    {id:"S04", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:1},
    {id:"S05", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* ===============================
   ìƒíƒœ
================================= */
let items = applyOverrides(loadRaw(LS_ITEMS, []));
let pins  = normalizePins(loadRaw(LS_PINS, {}));
let cart  = normalizeCart(loadRaw(LS_CART, {}));
let paid  = loadRaw(LS_PAID, 0);
let misu  = loadRaw(LS_MISU, []);
let sales = loadRaw(LS_SALES, []);
let activeCat = "ì „ì²´";
let query = "";

let loadedMisuIndex = null;

/* ===============================
   ì—˜ë¦¬ë¨¼íŠ¸
================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elMisuPill = document.getElementById("misuPill");
const elAdminPill = document.getElementById("adminPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elMisuList = document.getElementById("misuList");

/* ë™ê¸°í™” ë²„íŠ¼/í‘œì‹œ */
const syncBtn = document.getElementById("syncBtn");
const syncInfo = document.getElementById("syncInfo");

/* ê´€ë¦¬ì ëª¨ë‹¬ */
const adminBack = document.getElementById("adminBack");
const adminClose = document.getElementById("adminClose");
const adminTabs = document.getElementById("adminTabs");
const adminSalesBadge = document.getElementById("adminSalesBadge");
const adminRevenueBadge = document.getElementById("adminRevenueBadge");

const adminAna = document.getElementById("admin-ana");
const adminSoldout = document.getElementById("admin-soldout");
const adminEdit = document.getElementById("admin-edit");

/* ë¶„ì„ UI */
const kpiPayCnt = document.getElementById("kpiPayCnt");
const kpiAOV = document.getElementById("kpiAOV");
const kpiPeak = document.getElementById("kpiPeak");
const segRow = document.getElementById("segRow");
const catRow = document.getElementById("catRow");
const bestList = document.getElementById("bestList");
const worstList = document.getElementById("worstList");

/* í’ˆì ˆ UI */
const soldQ = document.getElementById("soldQ");
const soldClear = document.getElementById("soldClear");
const soldShowAll = document.getElementById("soldShowAll");
const soldSearchList = document.getElementById("soldSearchList");
const soldList = document.getElementById("soldList");

/* ìˆ˜ì • UI */
const editQ = document.getElementById("editQ");
const editClear = document.getElementById("editClear");
const reorderBtn = document.getElementById("reorderBtn");
const editList = document.getElementById("editList");

/* ìƒˆ ìƒí’ˆì¶”ê°€ */
const newCat = document.getElementById("newCat");
const newName = document.getElementById("newName");
const newPrice = document.getElementById("newPrice");
const newAddBtn = document.getElementById("newAddBtn");

/* ===============================
   ìœ í‹¸
================================= */
function won(n){ const x = Math.round(Number(n)||0); return x.toLocaleString("ko-KR") + "ì›"; }
function todayKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtHM(iso){
  const d = new Date(iso);
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mi}`;
}
function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){ (pins[it.id] ? pinned : normal).push(it); }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd); normal.sort(byOrd);
  return [...pinned, ...normal];
}
function matchItem(it, q){
  if(!q) return true;
  const name = normalize(it.name);
  const qn = normalize(q);
  if(name.includes(qn)) return true;

  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;

  return false;
}

/* ===============================
   íŒë§¤ ë¡œê·¸(ì˜¤ëŠ˜)
================================= */
function loadSales(){
  sales = loadRaw(LS_SALES, []);
  // ì˜¤ëŠ˜ë§Œ ìœ ì§€(ê°€ë³ê²Œ) â€” ì›í•˜ë©´ 7ì¼ì¹˜ë¡œ ë°”ê¿”ë„ ë¨
  const t = todayKey();
  sales = sales.filter(x => (x.day === t));
  save(LS_SALES, sales);
}
loadSales();

function pushSale({itemsLine, total, cnt}){
  const now = new Date();
  const day = todayKey();
  sales = loadRaw(LS_SALES, []);
  sales.push({
    day,
    at: now.toISOString(),
    total: Number(total||0),
    cnt: Number(cnt||0),
    lines: itemsLine.map(x=>({id:x.id, name:x.name, cat:x.cat, qty:x.qty, price:x.price}))
  });
  // ì˜¤ëŠ˜ë§Œ ìœ ì§€
  sales = sales.filter(x => x.day === day);
  save(LS_SALES, sales);
}

/* ===============================
   âœ… ê²€ìƒ‰/ì´ˆì„±ì€ í•­ìƒ ì „ì¹´í…Œê³ ë¦¬
================================= */
function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);

  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* ===============================
   íƒ­/í‚¤íŒ¨ë“œ
================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    elTabs.appendChild(b);
  });
}

function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });

  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* ===============================
   ê³ ì •(ğŸ“Œ): 1.2ì´ˆ ê¾¹ ëˆŒëŸ¬ í† ê¸€
================================= */
let pinHoldTimer = null;
const PIN_HOLD_MS = 1200;

function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}

function attachHoldToPin(pinEl, id){
  const start = (e)=>{
    e.preventDefault();
    if(pinHoldTimer) clearTimeout(pinHoldTimer);
    pinHoldTimer = setTimeout(()=>{ togglePin(id); }, PIN_HOLD_MS);
  };
  const end = ()=>{
    if(pinHoldTimer) clearTimeout(pinHoldTimer);
    pinHoldTimer = null;
  };

  pinEl.addEventListener("mousedown", start);
  pinEl.addEventListener("mouseup", end);
  pinEl.addEventListener("mouseleave", end);

  pinEl.addEventListener("touchstart", start, {passive:false});
  pinEl.addEventListener("touchend", end, {passive:true});
  pinEl.addEventListener("touchcancel", end, {passive:true});
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ
================================= */
function persistCart(){
  cart = normalizeCart(cart);
  save(LS_CART, cart);
}
function addToCart(it){
  if(Number(it.active)!==1) return;
  const id = it.id;
  if(!cart[id]){
    cart[id] = {id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[id].qty += 1;
  }
  persistCart();
  renderAll();
}
function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  persistCart();
  renderAll();
}
function removeCart(id){
  delete cart[id];
  persistCart();
  renderAll();
}
function resetCartAll(){
  const ok = confirm("ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆì„ ë¦¬ì…‹í• ê¹Œìš”?");
  if(!ok) return;
  cart = {};
  paid = 0;
  loadedMisuIndex = null;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function cartEntries(){ return Object.values(normalizeCart(cart)); }
function cartCount(){ return cartEntries().reduce((a,x)=>a+(x.qty||0),0); }
function cartTotal(){ return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0); }

/* ì‚‘ */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* ===============================
   ê²°ì œì™„ë£Œ
================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  beep();

  // âœ… íŒë§¤ë¡œê·¸ ê¸°ë¡(ê´€ë¦¬ì ë¶„ì„ìš©)
  const lines = cartEntries().map(x=>{
    const found = items.find(it=>it.id===x.id) || {cat:"ê¸°íƒ€", name:x.name, price:x.price};
    return { id:x.id, name:found.name, cat:found.cat, qty:Number(x.qty||0), price:Number(found.price||x.price||0) };
  });
  pushSale({ itemsLine: lines, total, cnt: 1 });
  loadSales();

  if(loadedMisuIndex !== null){
    misu = loadRaw(LS_MISU, misu);
    if(misu[loadedMisuIndex]){
      misu.splice(loadedMisuIndex, 1);
      save(LS_MISU, misu);
    }
    loadedMisuIndex = null;
  }

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* ===============================
   ë¯¸ìˆ˜
================================= */
function openMisu(){
  elModalBack.style.display = "flex";
  renderMisuList();
}
function closeMisu(){ elModalBack.style.display = "none"; }

function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (loadRaw(LS_MISU, misu).length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu = loadRaw(LS_MISU, misu);
  misu.unshift({ id, at: now.toISOString(), items: names, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;
  loadedMisuIndex = null;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}

function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  const next = {};
  for(const it of m.items){
    const found = items.find(x=>x.name===it.name);
    if(found){
      next[found.id] = {id:found.id, name:found.name, price:Number(found.price||0), qty:Number(it.qty||1)};
    }else{
      const tmpId = "TMP_"+it.name;
      next[tmpId] = {id:tmpId, name:it.name, price:0, qty:Number(it.qty||1)};
    }
  }
  cart = next;
  paid = 0;
  loadedMisuIndex = idx;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  closeMisu();
  renderAll();
}

function settleMisu(idx){
  const m = misu[idx];
  if(!m) return;
  const ok = confirm(`${m.id} (${won(m.amount||0)}) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`);
  if(!ok) return;
  beep();
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function deleteMisu(idx){
  const ok = confirm("ì´ ë¯¸ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?");
  if(!ok) return;
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");

    const all = (m.items||[]).map(x=>`${x.name}x${x.qty}`);
    const itemsText = all.slice(0,4).join(" Â· ") + (all.length>4 ? ` Â· â€¦(+${all.length-4})` : "");

    const wrap = document.createElement("div");
    wrap.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuInfo";
    left.innerHTML = `
      <div class="t">
        <span>${m.id}</span>
        <span class="amt mono">Â· ${won(m.amount||0)}</span>
        <span class="time">(${hh}:${mm})</span>
      </div>
      <div class="d">${itemsText}</div>
    `;

    const right = document.createElement("div");
    right.className = "misuBtns";

    const bPay = document.createElement("button");
    bPay.className = "btn2 good";
    bPay.textContent = "ê²°ì œì™„ë£Œ";
    bPay.onclick = ()=>settleMisu(idx);

    const bLoad = document.createElement("button");
    bLoad.className = "btn2";
    bLoad.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    bLoad.onclick = ()=>restoreMisu(idx);

    const bDel = document.createElement("button");
    bDel.className = "btn2 danger";
    bDel.textContent = "ì‚­ì œ";
    bDel.onclick = ()=>deleteMisu(idx);

    right.appendChild(bPay);
    right.appendChild(bLoad);
    right.appendChild(bDel);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

/* ===============================
   ìƒí’ˆ ì¹´ë“œ ë Œë”
================================= */
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "1.2ì´ˆ ê¾¹ ëˆŒëŸ¬ ê³ ì •/í•´ì œ";
    attachHoldToPin(pin, it.id);

    card.onclick = ()=>addToCart(it);
    card.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(it.id); return false; }; // PC ìš°í´ë¦­

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    elGrid.appendChild(card);
  });
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ ë Œë”
================================= */
function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;font-weight:1000;">â€”</div>`;
    return;
  }

  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);

  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length})`;
}

/* ===============================
   ê´€ë¦¬ì: ë°ì´í„°ë¶„ì„
================================= */
const ADMIN_MAIN_TABS = ["ë°ì´í„°ë¶„ì„","í’ˆì ˆìƒí’ˆ","ìƒí’ˆìˆ˜ì •"];
let adminTab = "ë°ì´í„°ë¶„ì„";

/* âœ… ì‹œê°„ëŒ€: ì „ì²´, ~12, 12~2, 2~4, 4~6, 6~ë§ˆê° */
const SEGMENTS = [
  {key:"ALL", label:"ì „ì²´", from:0, to:24},
  {key:"T12", label:"~12", from:0, to:12},
  {key:"12_2", label:"12~2", from:12, to:14},
  {key:"2_4", label:"2~4", from:14, to:16},
  {key:"4_6", label:"4~6", from:16, to:18},
  {key:"6_END", label:"6~ë§ˆê°", from:18, to:24},
];
let adminSeg = "ALL";
let adminCat = "ì „ì²´";
let soldShowAllMode = false;

function inSeg(iso, seg){
  const d = new Date(iso);
  const h = d.getHours() + d.getMinutes()/60;
  if(seg.key==="ALL") return true;
  return (h >= seg.from && h < seg.to);
}

function getTodaySales(){
  loadSales();
  return sales;
}

function getRevenueFor(segKey="ALL"){
  const seg = SEGMENTS.find(x=>x.key===segKey) || SEGMENTS[0];
  return getTodaySales().filter(x=>inSeg(x.at, seg)).reduce((a,x)=>a+(x.total||0),0);
}
function getCountsFor(segKey="ALL"){
  const seg = SEGMENTS.find(x=>x.key===segKey) || SEGMENTS[0];
  return getTodaySales().filter(x=>inSeg(x.at, seg)).reduce((a,x)=>a+(x.cnt||0),0);
}

function aggregateQty({segKey="ALL", cat="ì „ì²´"}){
  const seg = SEGMENTS.find(x=>x.key===segKey) || SEGMENTS[0];
  const out = new Map(); // id -> {id,name,cat,qty}
  for(const s of getTodaySales()){
    if(!inSeg(s.at, seg)) continue;
    for(const ln of (s.lines||[])){
      if(cat !== "ì „ì²´" && ln.cat !== cat) continue;
      const cur = out.get(ln.id) || {id:ln.id, name:ln.name, cat:ln.cat, qty:0};
      cur.qty += Number(ln.qty||0);
      out.set(ln.id, cur);
    }
  }
  return [...out.values()].sort((a,b)=>b.qty-a.qty);
}

function renderAdminTabs(){
  adminTabs.innerHTML = "";
  ADMIN_MAIN_TABS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "adminTab" + (t===adminTab ? " active":"");
    b.textContent = t;
    b.onclick = ()=>{
      adminTab = t;
      renderAdmin();
    };
    adminTabs.appendChild(b);
  });
}

function renderAdminSegments(){
  segRow.innerHTML = "";
  SEGMENTS.map(x=>x.label).forEach((label, idx)=>{
    const seg = SEGMENTS[idx];
    const b = document.createElement("button");
    b.className = "segBtn" + (seg.key===adminSeg ? " active":"");
    b.textContent = label;
    b.onclick = ()=>{
      adminSeg = seg.key;
      renderAdmin(); // âœ… active ê°±ì‹  í¬í•¨
    };
    segRow.appendChild(b);
  });
}

function renderAdminCats(){
  catRow.innerHTML = "";
  const cats = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "catBtn" + (c===adminCat ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{
      adminCat = c;
      renderAdmin(); // âœ… active ê°±ì‹  í¬í•¨
    };
    catRow.appendChild(b);
  });
}

function renderAdminKPIs(){
  const payCnt = getCountsFor("ALL");
  const revAll = getRevenueFor("ALL");
  const aov = payCnt>0 ? Math.round(revAll/payCnt) : 0;

  kpiPayCnt.textContent = String(payCnt);
  kpiAOV.textContent = won(aov);

  // í”¼í¬(êµ¬ê°„ë“¤ ì¤‘ ë§¤ì¶œ ìµœëŒ€)
  let peak = {label:"-", rev:0};
  for(const seg of SEGMENTS){
    if(seg.key==="ALL") continue;
    const r = getRevenueFor(seg.key);
    if(r > peak.rev){
      peak = {label:seg.label, rev:r};
    }
  }
  const share = revAll>0 ? Math.round((peak.rev/revAll)*100) : 0;
  kpiPeak.textContent = (peak.label==="-" ? "-" : `${peak.label} (${share}%)`);

  adminSalesBadge.textContent = `ê²°ì œ ${payCnt}ê±´`;
  adminRevenueBadge.textContent = `ë§¤ì¶œ ${won(revAll)}`;
}

function renderBestWorst(){
  const agg = aggregateQty({segKey: adminSeg, cat: adminCat}); // âœ… ìˆ˜ëŸ‰ ê¸°ì¤€
  const best = agg.slice(0, 15);
  const worst = agg.slice(-15).sort((a,b)=>a.qty-b.qty);

  const renderList = (el, arr, emptyText)=>{
    el.innerHTML = "";
    if(!arr.length){
      el.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">${emptyText}</div>`;
      return;
    }
    arr.forEach((x, i)=>{
      const row = document.createElement("div");
      row.className = "listRow";
      row.innerHTML = `
        <div class="n">${i+1}. ${x.name} <span class="muted" style="font-weight:900;">(${x.cat})</span></div>
        <div class="r"><span class="badge mono">${x.qty}ê°œ</span></div>
      `;
      el.appendChild(row);
    });
  };

  renderList(bestList, best, "ë°ì´í„° ì—†ìŒ(ì˜¤ëŠ˜ ê²°ì œ í›„ í‘œì‹œ)");
  renderList(worstList, worst, "ë°ì´í„° ì—†ìŒ(ì˜¤ëŠ˜ ê²°ì œ í›„ í‘œì‹œ)");
}

/* ===============================
   ê´€ë¦¬ì: í’ˆì ˆ
================================= */
function getSoldAt(id){
  const ovr = loadOverrides();
  return (ovr[id] && ovr[id].soldAt) ? ovr[id].soldAt : null;
}
function setSoldout(id){
  const now = nowISO();
  upsertOverride(id, {active:0, soldAt: now});
  items = applyOverrides(loadRaw(LS_ITEMS, []));
  renderAll();
  renderAdmin();
}
function restoreSoldout(id){
  upsertOverride(id, {active:1, soldAt: null});
  items = applyOverrides(loadRaw(LS_ITEMS, []));
  renderAll();
  renderAdmin();
}
function soldQtySoFarById(){
  const map = new Map();
  for(const s of getTodaySales()){
    for(const ln of (s.lines||[])){
      map.set(ln.id, (map.get(ln.id)||0) + Number(ln.qty||0));
    }
  }
  return map;
}
function renderSoldoutSearch(){
  const q = (soldQ?.value||"").trim();
  const listAll = items.slice().sort((a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko"));
  let list = listAll;

  if(!soldShowAllMode){
    if(!q){
      soldSearchList.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>`;
      return;
    }
    list = list.filter(it => matchItem(it, q));
  }

  soldSearchList.innerHTML = "";
  if(!list.length){
    soldSearchList.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
    return;
  }

  const qtyMap = soldQtySoFarById();

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "listRow";
    const soldAt = getSoldAt(it.id);
    const soldBadge = soldAt ? `<span class="badge mono" style="border-color:rgba(255,159,0,.35);">í’ˆì ˆ ${fmtHM(soldAt)}</span>` : "";
    row.innerHTML = `
      <div class="n">${it.name} <span class="muted" style="font-weight:900;">(${it.cat})</span></div>
      <div class="r" style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
        <span class="badge mono">${won(it.price||0)}</span>
        <span class="badge mono">${qtyMap.get(it.id)||0}ê°œ</span>
        ${soldBadge}
        <button class="tinyBtn danger" style="padding:8px 10px;">í’ˆì ˆ</button>
      </div>
    `;
    row.querySelector("button").onclick = ()=> setSoldout(it.id);
    soldSearchList.appendChild(row);
  });
}

function renderSoldoutList(){
  soldList.innerHTML = "";
  const ovr = loadOverrides();
  const qtyMap = soldQtySoFarById();

  const soldIds = Object.keys(ovr).filter(id => ovr[id] && ovr[id].active === 0 && ovr[id].soldAt);
  if(!soldIds.length){
    soldList.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">í’ˆì ˆ ì—†ìŒ</div>`;
    return;
  }

  // soldAt ìµœì‹ ìˆœ
  soldIds.sort((a,b)=> (new Date(ovr[b].soldAt).getTime() - new Date(ovr[a].soldAt).getTime()));

  soldIds.forEach(id=>{
    const it = items.find(x=>x.id===id) || {id, name:(ovr[id].name||id), cat:(ovr[id].cat||"ê¸°íƒ€"), price:(ovr[id].price||0)};
    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div class="n">${it.name} <span class="muted" style="font-weight:900;">(${it.cat})</span></div>
      <div class="r" style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
        <span class="badge mono">${qtyMap.get(id)||0}ê°œ</span>
        <span class="badge mono">í’ˆì ˆ ${fmtHM(ovr[id].soldAt)}</span>
        <button class="tinyBtn good">ë³µêµ¬</button>
      </div>
    `;
    row.querySelector("button").onclick = ()=> restoreSoldout(id);
    soldList.appendChild(row);
  });
}

/* ===============================
   ê´€ë¦¬ì: ìƒí’ˆìˆ˜ì • + í† ìŠ¤ì‹ ì •ë ¬
================================= */
let reorderMode = false;
let pickedId = null;

function swapOrd(idA, idB){
  const a = items.find(x=>x.id===idA);
  const b = items.find(x=>x.id===idB);
  if(!a || !b) return;

  const oa = Number(a.ord||0);
  const ob = Number(b.ord||0);

  upsertOverride(idA, {ord: ob});
  upsertOverride(idB, {ord: oa});

  items = applyOverrides(loadRaw(LS_ITEMS, []));
}

function nextIdAuto(){
  // S01..S99.. í˜•íƒœ ìë™
  const allIds = items.map(x=>x.id).filter(id=>/^S\d+$/i.test(id));
  let mx = 0;
  for(const id of allIds){
    const n = parseInt(id.slice(1), 10);
    if(Number.isFinite(n)) mx = Math.max(mx, n);
  }
  const nxt = mx + 1;
  return "S" + String(nxt).padStart(2,"0");
}
function nextOrdAuto(){
  let mx = 0;
  for(const it of items){
    mx = Math.max(mx, Number(it.ord||0));
  }
  return mx + 1;
}

function renderEditList(){
  const q = (editQ?.value||"").trim();
  let list = items.slice();

  if(q) list = list.filter(it => matchItem(it, q));

  list.sort((a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko"));
  editList.innerHTML = "";

  if(!list.length){
    editList.innerHTML = `<div class="muted" style="padding:8px 6px;font-weight:1000;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
    return;
  }

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "listRow";
    if(reorderMode && pickedId === it.id){
      row.style.border = "1px solid rgba(255,159,0,.55)";
      row.style.boxShadow = "0 0 0 2px rgba(255,159,0,.14) inset";
    }

    // inline edit
    row.innerHTML = `
      <div class="n">${it.name} <span class="muted" style="font-weight:900;">(${it.cat} Â· ord ${Number(it.ord||0)})</span></div>
      <div class="r" style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
        <input data-k="price" value="${Number(it.price||0)}" inputmode="numeric"
               style="width:110px;padding:10px 10px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--text);font-weight:1000;outline:none;" />
        <button class="tinyBtn" data-act="rename">ì´ë¦„</button>
        <button class="tinyBtn danger" data-act="${Number(it.active)===1 ? "hide":"show"}">${Number(it.active)===1 ? "ìˆ¨ê¹€":"ë³µêµ¬"}</button>
      </div>
    `;

    // ì •ë ¬ëª¨ë“œ: row í´ë¦­ìœ¼ë¡œ êµì²´
    row.addEventListener("click", (e)=>{
      // ì…ë ¥ì¹¸ í´ë¦­ì€ ì œì™¸
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag==="input" || tag==="button") return;
      if(!reorderMode) return;

      if(!pickedId){
        pickedId = it.id;
        renderEditList();
        return;
      }
      if(pickedId === it.id){
        pickedId = null;
        renderEditList();
        return;
      }
      swapOrd(pickedId, it.id);
      pickedId = null;
      renderAll();
      renderEditList();
    });

    const priceInput = row.querySelector('input[data-k="price"]');
    priceInput.addEventListener("change", ()=>{
      const v = toNumber(priceInput.value);
      upsertOverride(it.id, {price:v});
      items = applyOverrides(loadRaw(LS_ITEMS, []));
      renderAll();
      renderEditList();
    });

    row.querySelector('button[data-act="rename"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      const nn = prompt("ìƒí’ˆëª… ë³€ê²½", it.name);
      if(nn===null) return;
      upsertOverride(it.id, {name: String(nn).trim()});
      items = applyOverrides(loadRaw(LS_ITEMS, []));
      renderAll();
      renderEditList();
    });

    row.querySelector('button[data-act="hide"],button[data-act="show"]').addEventListener("click", (e)=>{
      e.stopPropagation();
      const isOn = Number(it.active)===1;
      if(isOn){
        upsertOverride(it.id, {active:0});
      }else{
        upsertOverride(it.id, {active:1});
      }
      items = applyOverrides(loadRaw(LS_ITEMS, []));
      renderAll();
      renderEditList();
      renderSoldoutList();
    });

    editList.appendChild(row);
  });
}

/* ìƒˆ ìƒí’ˆ ì¶”ê°€ */
function addNewItem(){
  const cat = String(newCat.value||"ê¸°íƒ€").trim();
  const name = String(newName.value||"").trim();
  const price = toNumber(newPrice.value||0);
  if(!name) { alert("ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }

  const id = nextIdAuto();
  const ord = nextOrdAuto();

  // ì˜¤ë²„ë¼ì´ë“œë¡œ ì‹ ê·œ ë“±ë¡
  upsertOverride(id, {cat, name, price, active:1, ord});
  items = applyOverrides(loadRaw(LS_ITEMS, []));
  renderAll();
  renderAdmin();

  newName.value = "";
  newPrice.value = "";
  alert(`âœ… ì¶”ê°€ë¨: ${id}`);
}

/* ===============================
   ê´€ë¦¬ì: í™”ë©´
================================= */
function showAdminSection(){
  adminAna.classList.add("hide");
  adminSoldout.classList.add("hide");
  adminEdit.classList.add("hide");
  if(adminTab==="ë°ì´í„°ë¶„ì„") adminAna.classList.remove("hide");
  if(adminTab==="í’ˆì ˆìƒí’ˆ") adminSoldout.classList.remove("hide");
  if(adminTab==="ìƒí’ˆìˆ˜ì •") adminEdit.classList.remove("hide");
}

function renderAdmin(){
  // âœ… ë²„íŠ¼ active ì¦‰ì‹œ ê°±ì‹ (ë„¤ê°€ ë§í•œ ë²„ê·¸ í•´ê²° í•µì‹¬)
  renderAdminSegments();
  renderAdminCats();

  // ìµœì‹  items ë°˜ì˜
  items = applyOverrides(loadRaw(LS_ITEMS, []));
  loadSales();

  renderAdminTabs();
  showAdminSection();
  renderAdminKPIs();
  renderBestWorst();
  renderSoldoutSearch();
  renderSoldoutList();
  renderEditList();
}

function openAdmin(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if(pw===null) return;
  if(String(pw) !== ADMIN_PASS){
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¦…ë‹ˆë‹¤.");
    return;
  }
  adminBack.style.display = "flex";
  renderAdmin();
}
function closeAdmin(){
  adminBack.style.display = "none";
}

/* ===============================
   ì „ì²´ ë Œë”
================================= */
function renderAll(){
  seedItemsIfEmpty();

  // base items + overrides
  items = applyOverrides(loadRaw(LS_ITEMS, []));
  pins  = normalizePins(loadRaw(LS_PINS, pins));
  cart  = normalizeCart(loadRaw(LS_CART, cart));
  paid  = loadRaw(LS_PAID, paid);
  misu  = loadRaw(LS_MISU, misu);
  loadSales();

  save(LS_CART, cart);
  save(LS_PINS, pins);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* ===============================
   ì´ë²¤íŠ¸
================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  renderAll();
});

document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});

elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});

elPayBtn.addEventListener("click", doPay);

elSaveMisu.addEventListener("click", saveMisuNow);
elMisuPill.addEventListener("click", openMisu);

elCartPill.addEventListener("click", resetCartAll);

elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeMisu();
});
elMClose.addEventListener("click", closeMisu);

/* ê´€ë¦¬ì */
elAdminPill.addEventListener("click", openAdmin);
adminClose.addEventListener("click", closeAdmin);
adminBack.addEventListener("click", (e)=>{
  if(e.target === adminBack) closeAdmin();
});

/* í’ˆì ˆ ê²€ìƒ‰ */
soldQ.addEventListener("input", ()=>{
  soldShowAllMode = false;
  renderSoldoutSearch();
  renderSoldoutList();
});
soldClear.addEventListener("click", ()=>{
  soldQ.value="";
  soldShowAllMode = false;
  renderSoldoutSearch();
  renderSoldoutList();
});
soldShowAll.addEventListener("click", ()=>{
  soldShowAllMode = !soldShowAllMode;
  soldShowAll.textContent = soldShowAllMode ? "ê²€ìƒ‰" : "ì „ì²´";
  renderSoldoutSearch();
});

/* ìˆ˜ì • ê²€ìƒ‰ */
editQ.addEventListener("input", ()=> renderEditList());
editClear.addEventListener("click", ()=>{ editQ.value=""; renderEditList(); });

/* ì •ë ¬ëª¨ë“œ */
reorderBtn.addEventListener("click", ()=>{
  reorderMode = !reorderMode;
  pickedId = null;
  reorderBtn.textContent = reorderMode ? "ì •ë ¬ëª¨ë“œ ON" : "ì •ë ¬ëª¨ë“œ OFF";
  renderEditList();
});

/* ìƒˆ ìƒí’ˆì¶”ê°€ */
newAddBtn.addEventListener("click", addNewItem);

/* ===============================
   ë™ê¸°í™” UI
================================= */
let syncing = false;
let lastSyncTryAt = 0;

function fmtKST(ts){
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function todayKST(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setSyncInfo(){
  const t = Number(localStorage.getItem(LS_LASTSYNC_UI) || 0);
  syncInfo.textContent = t
    ? `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: ${fmtKST(t)}`
    : `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -`;
}

async function runSync({force=true, silent=false} = {}){
  if (syncing) return;

  const now = Date.now();
  if (now - lastSyncTryAt < 10_000) {
    if(!silent) alert("âš ï¸ ì ê¹ë§Œìš”. 10ì´ˆ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  lastSyncTryAt = now;

  syncing = true;
  syncBtn.disabled = true;
  syncBtn.textContent = "â³ ë™ê¸°í™”ì¤‘...";

  try{
    await umganeSyncFromSheet({ force });
    localStorage.setItem(LS_LASTSYNC_UI, String(Date.now()));
    setSyncInfo();
    if(!silent) alert("âœ… ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
  }catch(e){
    if(!silent) alert("âŒ ë™ê¸°í™” ì‹¤íŒ¨ (ì¸í„°ë„·/ì‹œíŠ¸ í™•ì¸)");
  }finally{
    syncing = false;
    syncBtn.disabled = false;
    syncBtn.textContent = "ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨";
  }
}

syncBtn.addEventListener("click", ()=> runSync({force:true, silent:false}));

setInterval(()=>{
  try{
    const cnt = cartCount();
    if(cnt === 0){
      runSync({force:false, silent:true});
    }
  }catch(e){}
}, 120_000);

/* â€œìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œâ€ë¥˜ ì´íƒˆ ê²½ê³  ë°©ì§€ */
window.onbeforeunload = null;
window.addEventListener("beforeunload", (e)=>{ e.stopImmediatePropagation(); }, true);

setSyncInfo();
renderAll();
</script>
</body>
</html>
