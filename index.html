<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ÏóÑÍ∞ÄÎÑ§ POS</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:18px;

    --fs-12:12px;
    --fs-13:13px;
    --fs-14:14px;
    --fs-16:16px;
    --fs-18:18px;
    --fs-24:24px;
    --fs-32:32px;

    --w-400:400;
    --w-500:500;
    --w-600:600;

    --right-w: 420px;

    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    --card-min: 210px;
  }

  @media (min-width:1024px) and (max-width:1400px){
    :root{
      --right-w:420px;
      --card-min:210px;
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    margin-bottom:10px;
  }
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .searchRow{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
  }
  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .chosungRow{
    display:flex; gap:6px; flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  .cardBadge{ display:none !important; }

  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{
    opacity:.35;
    filter:grayscale(.55);
  }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.92);
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{
    flex:1;
    overflow:auto;
    padding:10px 10px 6px;
  }

  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }

  .qtyBox{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:700;
  }

  .summary{
    border-top:1px solid var(--line);
    padding:10px 12px;
  }
  .sumTitle{
    font-size:var(--fs-13);
    color:rgba(245,247,255,.7);
    font-weight:var(--w-600);
  }
  .sumMoney{
    margin-top:4px;
    font-size:var(--fs-32);
    font-weight:700;
    letter-spacing:-.6px;
    line-height:1.05;
  }
  .twoCol{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:8px;
  }
  .moneyBox{
    border-radius:16px;
    padding:8px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .moneyLabel{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
  }
  .moneyValue{
    margin-top:3px;
    font-size:22px;
    font-weight:800;
    line-height:1.05;
  }

  .cashGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .cashBtn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-600);
    font-size:var(--fs-14);
  }
  .cashBtn.reset{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.28);
  }

  .bottomRow{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 2fr;
    gap:10px;
    align-items:stretch;
  }

  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:9px 10px;
    text-align:left;
    color:var(--text);
  }
  .misuBtn .t{
    font-weight:800;
    font-size:var(--fs-16);
    color:var(--text);
    line-height:1.05;
  }
  .misuBtn .s{
    margin-top:3px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
    line-height:1.1;
  }

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:900;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
    padding:12px 10px;
  }

  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(900px, 96vw);
    max-height:84vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{
    margin:0;
    font-size:var(--fs-18);
    font-weight:700;
  }
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:700;
  }
  .misuItem{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }

  .misuInfo .t{
    font-size:var(--fs-14);
    font-weight:700;
    display:flex;
    gap:8px;
    align-items:baseline;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuInfo .amt{
    font-weight:800;
    color:rgba(245,247,255,.95);
  }
  .misuInfo .time{
    color:rgba(245,247,255,.55);
    font-weight:600;
    font-size:var(--fs-12);
  }
  .misuInfo .d{
    margin-top:6px;
    font-size:var(--fs-13);
    font-weight:600;
    color:rgba(245,247,255,.8);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .misuBtns{
    display:flex; gap:8px;
  }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    white-space:nowrap;
  }
  .btn2.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.30);
  }
  .btn2.good{
    background:rgba(41,209,126,.12);
    border-color:rgba(41,209,126,.30);
  }

  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
  }
</style>
</head>

<body>
<div class="app">

  <section class="panel left">
    <div class="top">
      <div class="tabs" id="tabs"></div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">üîé</span>
          <input id="q" placeholder="Ï†ÑÏπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ (Ïòà: Í∞êÏûê, „Ñ±„Öà, „Ñ±„Ñ¥„Ñ∑)" autocomplete="off" />
        </div>
        <button class="chipBtn" id="sortBtn">Ï†ïÎ†¨: Í≥†Ï†ï + ord</button>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        Í≤ÄÏÉâ=Ï†ÑÌíàÎ™©(Ï¥àÏÑ± Í∞ÄÎä•) ¬∑ Í∏∏Í≤å=Í≥†Ï†ï/Ìï¥Ï†ú(PC Ïö∞ÌÅ¥Î¶≠) ¬∑ ÌÅ¥Î¶≠=Îã¥Í∏∞
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">Í≥†Ï†ï(Ï†ÑÏ≤¥) ¬∑ ÏÉÅÎã® 1Ï§Ñ</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rightTop">
      <div class="rightTitle"><span class="pill accent" id="misuPill">ÎØ∏Ïàò(0)</span></div>
      <div class="rightTitle"><span class="pill" id="cartPill">Î¶¨ÏÖã</span></div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">Ï¥ùÌï©Í≥Ñ(<span id="sumCnt">0</span>Í∞ú)</div>
      <div class="sumMoney mono" id="sumMoney">0Ïõê</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">Î∞õÏùÄÎèà</div>
          <div class="moneyValue mono" id="paidMoney">0Ïõê</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">Í±∞Ïä§Î¶ÑÎèà</div>
          <div class="moneyValue mono" id="changeMoney">0Ïõê</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1Ï≤ú</button>
        <button class="cashBtn" data-add="5000">5Ï≤ú</button>
        <button class="cashBtn" data-add="10000">1Îßå</button>
        <button class="cashBtn" data-add="50000">5Îßå</button>
        <button class="cashBtn reset" id="paidReset">Ï¥àÍ∏∞Ìôî</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ÎØ∏Ïàò</div>
          <div class="s">ÌòÑÏû¨Ïû•Î∞îÍµ¨Îãà Ï†ÄÏû•</div>
        </button>

        <button class="payBtn" id="payBtn">Í≤∞Ï†úÏôÑÎ£å</button>
      </div>
    </div>
  </section>
</div>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ÎØ∏Ïàò Î™©Î°ù</h3>
      <button class="mClose" id="mClose">Îã´Í∏∞</button>
    </div>
    <div id="misuList"></div>
  </div>
</div>

<script>
/* =========================================================
   Ï†ÄÏû• ÌÇ§
========================================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

const CATS = ["Ï†ÑÏ≤¥","Í≥ºÏùº","ÏïºÏ±Ñ","Î¥âÏßÄÏ±ÑÏÜå","ÏÉùÏÑ†","Í∏∞ÌÉÄ"];
const CHO_KEYS = ["„Ñ±","„Ñ¥","„Ñ∑","„Ñπ","„ÖÅ","„ÖÇ","„ÖÖ","„Öá","„Öà","„Öä","„Öã","„Öå","„Öç","„Öé"];

const CHO = ["„Ñ±","„Ñ≤","„Ñ¥","„Ñ∑","„Ñ∏","„Ñπ","„ÖÅ","„ÖÇ","„ÖÉ","„ÖÖ","„ÖÜ","„Öá","„Öà","„Öâ","„Öä","„Öã","„Öå","„Öç","„Öé"];
function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){
  return (str||"").toString().trim().toLowerCase();
}

function load(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch(e){ return fallback; }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function seedItemsIfEmpty(){
  const existing = load(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"Í≥ºÏùº", name:"Î∞îÎÇòÎÇò", price:2500, active:1, ord:1},
    {id:"S02", cat:"Í≥ºÏùº", name:"Îã®Í∞ê/3Í∞ú", price:5000, active:1, ord:2},
    {id:"S03", cat:"ÏïºÏ±Ñ", name:"Í∞êÏûê", price:3000, active:1, ord:1},
    {id:"S04", cat:"Î¥âÏßÄÏ±ÑÏÜå", name:"ÏãúÍ∏àÏπò/1Î¥âÏßÄ", price:2000, active:1, ord:1},
    {id:"S05", cat:"ÏÉùÏÑ†", name:"ÎèôÌÉú/1ÎßàÎ¶¨", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

let items = load(LS_ITEMS, []);
let pins  = load(LS_PINS, {});
let cart  = load(LS_CART, {});
let paid  = load(LS_PAID, 0);
let misu  = load(LS_MISU, []);

let activeCat = "Ï†ÑÏ≤¥";
let query = "";

const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");
const elSortBtn = document.getElementById("sortBtn");

const elCartList = document.getElementById("cartList");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elMisuList = document.getElementById("misuList");

function won(n){
  const x = Math.round(Number(n)||0);
  return x.toLocaleString("ko-KR") + "Ïõê";
}

function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){
    (pins[it.id] ? pinned : normal).push(it);
  }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd);
  normal.sort(byOrd);
  return [...pinned, ...normal];
}

function matchItem(it, q){
  if(!q) return true;

  const name = normalize(it.name);
  const qn = normalize(q);

  if(name.includes(qn)) return true;

  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;

  return false;
}
function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);

  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "Ï†ÑÏ≤¥"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCat = cat;
      renderAll();
    };
    elTabs.appendChild(b);
  });
}
function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });
  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}

function addToCart(it){
  if(Number(it.active)!==1) return;
  if(!cart[it.id]){
    cart[it.id] = {id:it.id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[it.id].qty += 1;
  }
  save(LS_CART, cart);
  renderAll();
}
function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  save(LS_CART, cart);
  renderAll();
}
function removeCart(id){
  delete cart[id];
  save(LS_CART, cart);
  renderAll();
}
function resetCartAll(){
  const ok = confirm("Ïû•Î∞îÍµ¨Îãà/Î∞õÏùÄÎèàÏùÑ Î¶¨ÏÖãÌï†ÍπåÏöî?");
  if(!ok) return;
  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}
function cartEntries(){
  return Object.values(cart);
}
function cartCount(){
  return cartEntries().reduce((a,x)=>a+(x.qty||0),0);
}
function cartTotal(){
  return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0);
}

let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square";
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("Í≤∞Ï†úÏôÑÎ£å ÌïòÍ≤†ÏäµÎãàÍπå?");
  if(!ok) return;

  beep();
  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* =========================
   ÎØ∏Ïàò
========================= */
function openMisu(){
  elModalBack.style.display = "flex";
  renderMisuList();
}
function closeMisu(){
  elModalBack.style.display = "none";
}

/* ‚úÖ Ï†ÄÏû• Íµ¨Ï°∞ ÏóÖÍ∑∏Î†àÏù¥Îìú: id/name/qty/price Ï†ÄÏû• */
function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ÎØ∏Ïàò " + (misu.length + 1);

  const savedItems = entries.map(x=>({
    id: x.id,
    name: x.name,
    qty: x.qty,
    price: x.price
  }));

  misu.unshift({ id, at: now.toISOString(), items: savedItems, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}

/* ‚úÖ Î∂àÎü¨Ïò§Í∏∞ Î∞©ÌÉÑ: ÏòõÎÇ†(name/qtyÎßå) ÎØ∏ÏàòÎèÑ Î≥µÏõê Í∞ÄÎä• */
function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  const next = {};

  for(const it of (m.items||[])){
    // Ïã†Î≤ÑÏ†Ñ(idÍ∞Ä ÏûàÏúºÎ©¥) Ïö∞ÏÑ†
    if(it.id && items.find(x=>x.id===it.id)){
      const found = items.find(x=>x.id===it.id);
      next[found.id] = {
        id: found.id,
        name: found.name,
        price: Number(found.price||0),
        qty: Number(it.qty||1)
      };
      continue;
    }

    // Íµ¨Î≤ÑÏ†Ñ(name/qtyÎßå) Îß§Ïπ≠
    const foundByName = items.find(x=>x.name===it.name) || items.find(x=>normalize(x.name)===normalize(it.name));
    if(foundByName){
      next[foundByName.id] = {
        id: foundByName.id,
        name: foundByName.name,
        price: Number(foundByName.price||0),
        qty: Number(it.qty||1)
      };
    }else{
      const tmpId = "TMP_" + (it.name||"ÎØ∏ÌôïÏù∏");
      next[tmpId] = { id: tmpId, name: it.name||"ÎØ∏ÌôïÏù∏", price: Number(it.price||0), qty: Number(it.qty||1) };
    }
  }

  cart = next;
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  closeMisu();
}

function settleMisu(idx){
  const m = misu[idx];
  if(!m) return;
  const ok = confirm(`${m.id} (${won(m.amount||0)}) Í≤∞Ï†úÏôÑÎ£å Ï≤òÎ¶¨Ìï†ÍπåÏöî?`);
  if(!ok) return;
  beep();
  misu.splice(idx,1);
  save(LS_MISU, misu);
  renderMisuList();
  renderAll();
}
function deleteMisu(idx){
  const ok = confirm("Ïù¥ ÎØ∏ÏàòÎ•º ÏÇ≠Ï†úÌï†ÍπåÏöî?");
  if(!ok) return;
  misu.splice(idx,1);
  save(LS_MISU, misu);
  renderMisuList();
  renderAll();
}
function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;">ÎØ∏Ïàò ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");

    const itemsText = (m.items||[]).map(x=>{
      const nm = x.name || "ÎØ∏ÌôïÏù∏";
      const q = x.qty || 1;
      return `${nm}x${q}`;
    }).join(" ¬∑ ");

    const wrap = document.createElement("div");
    wrap.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuInfo";
    left.innerHTML = `
      <div class="t">
        <span>${m.id}</span>
        <span class="amt mono">¬∑ ${won(m.amount||0)}</span>
        <span class="time">(${hh}:${mm})</span>
      </div>
      <div class="d">${itemsText}</div>
    `;

    const right = document.createElement("div");
    right.className = "misuBtns";

    const bPay = document.createElement("button");
    bPay.className = "btn2 good";
    bPay.textContent = "Í≤∞Ï†úÏôÑÎ£å";
    bPay.onclick = ()=>settleMisu(idx);

    const bLoad = document.createElement("button");
    bLoad.className = "btn2";
    bLoad.textContent = "Î∂àÎü¨Ïò§Í∏∞";
    bLoad.onclick = ()=>restoreMisu(idx);

    const bDel = document.createElement("button");
    bDel.className = "btn2 danger";
    bDel.textContent = "ÏÇ≠Ï†ú";
    bDel.onclick = ()=>deleteMisu(idx);

    right.appendChild(bPay);
    right.appendChild(bLoad);
    right.appendChild(bDel);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

let pressTimer=null;
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "üìå";
    pin.title = "Í≥†Ï†ï";
    pin.onclick = (e)=>{
      e.stopPropagation();
      togglePin(it.id);
    };

    card.onclick = ()=>addToCart(it);

    card.oncontextmenu = (e)=>{
      e.preventDefault();
      togglePin(it.id);
      return false;
    };
    card.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 450);
    }, {passive:true});
    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    elGrid.appendChild(card);
  });
}

function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">‚Äî</div>`;
    return;
  }

  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "‚àí";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "√ó";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  document.getElementById("sumCnt").textContent = String(cnt);
  document.getElementById("sumMoney").textContent = won(total);
  document.getElementById("paidMoney").textContent = won(paid||0);
  document.getElementById("changeMoney").textContent = won(change);

  document.getElementById("misuPill").textContent = `ÎØ∏Ïàò(${misu.length})`;
}

function renderAll(){
  items = load(LS_ITEMS, items);
  pins  = load(LS_PINS, pins);
  cart  = load(LS_CART, cart);
  paid  = load(LS_PAID, paid);
  misu  = load(LS_MISU, misu);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* ===== Ïù¥Î≤§Ìä∏: Î∞©ÌÉÑ Î∞îÏù∏Îî© ===== */
function on(id, ev, fn){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener(ev, fn);
}
function onAll(sel, ev, fn){
  document.querySelectorAll(sel).forEach(el=>{
    el.addEventListener(ev, fn);
  });
}

on("q", "input", ()=>{
  const qEl = document.getElementById("q");
  query = qEl ? qEl.value : "";
  renderAll();
});

onAll(".cashBtn[data-add]", "click", (e)=>{
  const btn = e.currentTarget;
  addPaid(Number(btn.dataset.add||0));
});

on("paidReset", "click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});

on("payBtn", "click", doPay);
on("saveMisu", "click", saveMisuNow);
on("misuPill", "click", openMisu);
on("cartPill", "click", resetCartAll);

on("modalBack", "click", (e)=>{
  const back = document.getElementById("modalBack");
  if(e.target === back) closeMisu();
});
on("mClose", "click", closeMisu);

on("sortBtn", "click", ()=>{
  alert("ÌòÑÏû¨ Ï†ïÎ†¨ÏùÄ 'Í≥†Ï†ï + ord' Í≥†Ï†ïÏûÖÎãàÎã§.");
});

/* ÏãúÏûë */
renderAll();
</script>
</body>
</html>
