<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>
<link rel="icon" href="data:,">

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;

    --r:18px;
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-16:16px; --fs-18:18px; --fs-24:24px; --fs-32:32px;
    --w-400:400; --w-500:500; --w-600:600;

    --right-w: 420px;
    --cart-price-w: 92px;
    --cart-qty-w: 120px;
    --cart-x-w: 44px;

    --card-min: 210px;
  }

  @media (min-width:1024px) and (max-width:1400px){
    :root{ --right-w:420px; --card-min:210px; }
  }

  *{box-sizing:border-box}
  html,body{
    height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    overscroll-behavior: contain; /* âœ… iPad íŠ ë°©ì§€ */
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }

  /* âœ… íƒ­ ì™¼ìª½ / ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥¸ìª½ */
  .tabsRow{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .syncWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .syncInfo{font-size:12px; color:rgba(245,247,255,.65); white-space:nowrap;}

  .searchRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    touch-action: manipulation; /* âœ… iPad ì„ íƒ íŠ ì™„í™” */
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    -webkit-user-select:text;
    user-select:text;
  }

  /* âœ… ì´ˆì„±í‚¤: ê°€ë¡œ ê³ ì • */
  .chosungRow{
    display:flex;
    flex-direction:row !important;
    gap:6px;
    flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{ opacity:.35; filter:grayscale(.55); }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.92);
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    user-select:none;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{
    flex:1;
    overflow:auto;
    padding:10px 10px 6px;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }

  .qtyBox{display:flex; justify-content:flex-end; align-items:center; gap:8px;}
  .qBtn{
    width:34px;height:32px;border-radius:10px;border:1px solid var(--line);
    background:rgba(255,255,255,.03);color:rgba(245,247,255,.95);font-weight:700;font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{width:26px;text-align:center;font-size:var(--fs-14);font-weight:var(--w-600);color:rgba(245,247,255,.95);}
  .xBtn{
    width:40px;height:32px;border-radius:10px;border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);color:rgba(255,245,245,.95);font-weight:700;
  }

  .summary{border-top:1px solid var(--line);padding:10px 12px;}
  .sumTitle{font-size:var(--fs-13);color:rgba(245,247,255,.7);font-weight:var(--w-600);}
  .sumMoney{margin-top:4px;font-size:var(--fs-32);font-weight:700;letter-spacing:-.6px;line-height:1.05;}
  .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;}
  .moneyBox{border-radius:16px;padding:8px 12px;border:1px solid var(--line);background:rgba(255,255,255,.02);}
  .moneyLabel{font-size:var(--fs-12);color:rgba(245,247,255,.65);font-weight:var(--w-600);}
  .moneyValue{margin-top:3px;font-size:22px;font-weight:800;line-height:1.05;}

  .cashGrid{margin-top:10px;display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;}
  .cashBtn{
    padding:10px 10px;border-radius:14px;border:1px solid var(--line);
    background:rgba(255,255,255,.03);color:rgba(245,247,255,.95);font-weight:var(--w-600);font-size:var(--fs-14);
  }
  .cashBtn.reset{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.28);}

  .bottomRow{margin-top:10px;display:grid;grid-template-columns: 1fr 2fr;gap:10px;align-items:stretch;}
  .misuBtn{
    border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);
    padding:9px 10px;text-align:left;color:var(--text);
  }
  .misuBtn .t{font-weight:800;font-size:var(--fs-16);color:var(--text);line-height:1.05;}
  .misuBtn .s{margin-top:3px;font-size:var(--fs-12);color:rgba(245,247,255,.65);font-weight:var(--w-600);line-height:1.1;}

  .payBtn{border-radius:16px;background:var(--accent);color:#111;font-weight:900;font-size:var(--fs-24);letter-spacing:-.6px;padding:12px 10px;}

  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(980px, 96vw);
    max-height:88vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .modalHead{
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:6px 6px 12px;border-bottom:1px solid var(--line);margin-bottom:12px;
  }
  .modalHead h3{margin:0;font-size:var(--fs-18);font-weight:700;}
  .mClose{
    padding:10px 12px;border:1px solid var(--line);background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);border-radius:14px;font-weight:700;
  }

  .misuItem{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: minmax(0,1fr) auto;
    gap:10px;
    align-items:center;
  }
  .misuInfo{ min-width:0; }
  .misuInfo .t{
    font-size:var(--fs-14);
    font-weight:700;
    display:flex;
    gap:8px;
    align-items:baseline;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuInfo .amt{ font-weight:800; color:rgba(245,247,255,.95); }
  .misuInfo .time{ color:rgba(245,247,255,.55); font-weight:600; font-size:var(--fs-12); }
  .misuInfo .d{
    margin-top:6px;
    font-size:var(--fs-13);
    font-weight:600;
    color:rgba(245,247,255,.8);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuBtns{ display:flex; gap:8px; }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    white-space:nowrap;
  }
  .btn2.danger{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }
  .btn2.good{ background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30); }

  /* âœ… ê´€ë¦¬ì íƒ­ */
  .adminTabs{ display:flex; flex-wrap:wrap; gap:8px; padding:6px 6px 10px; }
  .adminTabs .tab{ padding:8px 12px; }
  .adminBox{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
  }
  .adminTop3{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-bottom:10px;
  }
  .kpi{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
  }
  .kpi .k{ font-size:12px; color:rgba(245,247,255,.65); font-weight:700; }
  .kpi .v{ margin-top:6px; font-size:28px; font-weight:900; letter-spacing:-.6px; }
  .kpi .s{ margin-top:4px; font-size:12px; color:rgba(245,247,255,.65); font-weight:700; }

  .rankCols{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .rankItem{
    display:flex; justify-content:space-between; gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(255,255,255,.02);
    margin-bottom:8px;
  }
  .rankItem .n{ min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:800; }
  .rankItem .q{ font-weight:900; }
  .rankItem .c{ font-size:12px; color:rgba(245,247,255,.65); font-weight:700; }

  .soldOutRow{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(255,255,255,.02);
    margin-bottom:8px;
  }
  .soldOutRow .left{min-width:0;}
  .soldOutRow .t{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .soldOutRow .d{margin-top:4px; font-size:12px; color:rgba(245,247,255,.65); font-weight:700;}
  .soldOutRow .right{display:flex; gap:8px; align-items:center;}
  .tinyBtn{
    padding:8px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:800;
    font-size:12px;
    white-space:nowrap;
  }
  .tinyBtn.bad{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }
  .tinyBtn.good{ background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30); }

  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
    .adminTop3{ grid-template-columns: 1fr; }
    .rankCols{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>
<div class="app">
  <section class="panel left">
    <div class="top">
      <div class="tabsRow">
        <div class="tabs" id="tabs"></div>
        <div class="syncWrap">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ğŸ“… ì˜¤ëŠ˜: - Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <div class="chosungRow" id="keys"></div>
      <div class="hint">
        ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· ê¸¸ê²Œ(1.2ì´ˆ)=ê³ ì •/í•´ì œ Â· í´ë¦­=ë‹´ê¸°
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rightTop">
      <!-- âœ… ë¯¸ìˆ˜/ê´€ë¦¬ì ë‘˜ ë‹¤ ë³µêµ¬ -->
      <div class="rightTitle">
        <span class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</span>
      </div>
      <div class="rightTitle" style="display:flex; gap:8px; align-items:center;">
        <span class="pill" id="adminPill">ê´€ë¦¬ì</span>
        <span class="pill" id="cartPill">ë¦¬ì…‹</span>
      </div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>
</div>

<!-- âœ… ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ë¯¸ìˆ˜ ëª©ë¡</h3>
      <button class="mClose" id="mClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>
    <div id="misuList"></div>
  </div>
</div>

<!-- âœ… ê´€ë¦¬ì ëª¨ë‹¬ -->
<div class="modalBack" id="adminBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ê´€ë¦¬ì</h3>
      <button class="mClose" id="aClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>

    <!-- âœ… ì‹œê°„íƒ­ (ìš”ì²­ ìˆœì„œëŒ€ë¡œ + ì „ì²´ ë§¨ì•) -->
    <div class="adminTabs" id="timeTabs"></div>

    <!-- âœ… ì¹´í…Œê³ ë¦¬íƒ­ (ìš”ì²­ ìˆœì„œëŒ€ë¡œ) -->
    <div class="adminTabs" id="catTabs"></div>

    <!-- âœ… ìƒë‹¨ 3ê°œ KPI -->
    <div class="adminTop3">
      <div class="kpi">
        <div class="k">ê²°ì œê±´ìˆ˜(ì„ íƒì‹œê°„/ì¹´í…Œê³ ë¦¬)</div>
        <div class="v mono" id="kpiCnt">0</div>
        <div class="s" id="kpiCntS">â€”</div>
      </div>
      <div class="kpi">
        <div class="k">ê°ë‹¨ê°€</div>
        <div class="v mono" id="kpiAov">0ì›</div>
        <div class="s" id="kpiAovS">â€”</div>
      </div>
      <div class="kpi">
        <div class="k">í”¼í¬ ì‹œê°„ëŒ€ + ë¹„ì¤‘</div>
        <div class="v" id="kpiPeak">â€”</div>
        <div class="s" id="kpiPeakS">â€”</div>
      </div>
    </div>

    <!-- âœ… ì´ë§¤ì¶œ(ì „ì²´/ì‹œê°„ë³„ ë³´ê¸°) -->
    <div class="adminBox">
      <div class="muted" style="font-weight:900; margin-bottom:8px;">ì´ë§¤ì¶œ</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <div class="pill accent">ì„ íƒêµ¬ê°„: <span class="mono" id="revSel">0ì›</span></div>
        <div class="pill">ì „ì²´(ì˜¤ëŠ˜): <span class="mono" id="revAll">0ì›</span></div>
      </div>
      <div class="muted" style="margin-top:8px; font-size:12px;">* â€˜ì„ íƒêµ¬ê°„â€™ì€ ìœ„ ì‹œê°„íƒ­ì— ë”°ë¼ ë°”ë€œ</div>
    </div>

    <!-- âœ… ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ 15 (ìˆ˜ëŸ‰ ê¸°ì¤€) -->
    <div class="adminBox">
      <div class="muted" style="font-weight:900; margin-bottom:8px;">ë² ìŠ¤íŠ¸15 / ì›ŒìŠ¤íŠ¸15 (ìˆ˜ëŸ‰ ê¸°ì¤€)</div>
      <div class="rankCols">
        <div>
          <div class="muted" style="margin-bottom:6px;">ë² ìŠ¤íŠ¸15</div>
          <div id="bestList"></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">ì›ŒìŠ¤íŠ¸15</div>
          <div id="worstList"></div>
        </div>
      </div>
    </div>

    <!-- âœ… í’ˆì ˆê´€ë¦¬ -->
    <div class="adminBox">
      <div class="muted" style="font-weight:900; margin-bottom:8px;">í’ˆì ˆê´€ë¦¬ (íŒ”ë¦°ê°¯ìˆ˜ í¬í•¨ + í’ˆì ˆì‹œê°„)</div>
      <div id="soldOutList"></div>
    </div>

  </div>
</div>

<script>
/* ===============================
   ì €ì¥ í‚¤
================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

const LS_SALES = "umgane_sales_v1";           // âœ… íŒë§¤ ë¡œê·¸
const LS_SOLDOUT = "umgane_soldout_v1";       // âœ… í’ˆì ˆ ë§µ {id: isoTime}

/* ===============================
   âœ… êµ¬ê¸€ì‹œíŠ¸(CSV) â†’ ìƒí’ˆë§ˆìŠ¤í„° ë™ê¸°í™”
================================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZMLZiCqXn-YKsOwR_RR1nZudB1VqAKI652Aje2p3Ytjqfzx5YhcLtEHyuiCSFKPqZ8e1xvbF3JCU4/pub?output=csv";
const LS_LASTSYNC = "umgane_items_lastSync_v1";

/* âœ… ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „ CSV íŒŒì„œ */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      pushCell();
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    } else {
      cur += ch;
    }
  }
  if (cur.length > 0 || row.length > 0) { pushCell(); pushRow(); }
  return rows.filter(r => r.some(c => (c || "").trim() !== ""));
}

function toNumber(v) {
  const s = String(v ?? "").replace(/[^\d.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v, def=0){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : def;
}
function normalizeActive(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "1" || s === "true" || s === "y" || s === "yes" || s === "on") ? 1 : 0;
}
function nowISO(){ return new Date().toISOString(); }

function saveItemsToLS(items){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_LASTSYNC, nowISO());
}
function loadItemsFromLS(){
  try {
    const raw = localStorage.getItem(LS_ITEMS);
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}
function isSameDay(isoA, isoB){
  try{
    const a = new Date(isoA), b = new Date(isoB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }catch{ return false; }
}

async function syncItemsFromSheet({force=false} = {}) {
  const last = localStorage.getItem(LS_LASTSYNC);
  if (!force && last && isSameDay(last, nowISO())) {
    return { ok:true, skipped:true, count: (loadItemsFromLS()||[]).length };
  }

  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);

  const csv = await res.text();
  const rows = parseCSV(csv);

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  if (iId < 0 || iCat < 0 || iName < 0 || iPrice < 0) {
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ ë¶€ì¡±í•¨: id/cat/name/price í•„ìˆ˜");
  }

  const items = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r];

    const id = String(row[iId] ?? "").trim();

    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,"");
    if (cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ";

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if (!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    items.push({ id, cat, name, price, active, ord });
  }

  if (items.length < 3) {
    throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ(ì €ì¥ ì¤‘ë‹¨) - ì‹œíŠ¸/ê²Œì‹œ í™•ì¸ í•„ìš”");
  }

  saveItemsToLS(items);
  try { renderAll(); } catch {}
  return { ok:true, skipped:false, count: items.length };
}
window.umganeSyncFromSheet = syncItemsFromSheet;

// í˜ì´ì§€ ì—´ë¦´ ë•Œ 1íšŒ ìë™ ë™ê¸°í™”(ì˜¤ëŠ˜ í–ˆìœ¼ë©´ ìŠ¤í‚µ)
(async () => {
  try { await syncItemsFromSheet({ force:false }); }
  catch (e) { console.warn("[SHEET SYNC FAIL]", e?.message || e); }
})();

/* ===============================
   ì¹´í…Œê³ ë¦¬ / ì´ˆì„±
================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

/* ===============================
   ë¡œë“œ/ì„¸ì´ë¸Œ + âœ… ì•ˆì •í™”
================================= */
function loadRaw(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function normalizeCart(v){
  if (!v) return {};
  if (Array.isArray(v)){
    const out = {};
    v.forEach(x=>{
      if(!x) return;
      const id = String(x.id ?? x.name ?? "");
      if(!id) return;
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    });
    return out;
  }
  if (typeof v === "object"){
    const out = {};
    for(const k of Object.keys(v)){
      const x = v[k];
      if(!x) continue;
      if(Array.isArray(x)) continue;
      const id = String(x.id ?? k);
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    }
    return out;
  }
  return {};
}
function normalizePins(v){
  if (!v) return {};
  if (typeof v === "object" && !Array.isArray(v)) return v;
  return {};
}

function seedItemsIfEmpty(){
  const existing = loadRaw(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
    {id:"S04", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:1},
    {id:"S05", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* ===============================
   ìƒíƒœ
================================= */
let items = loadRaw(LS_ITEMS, []);
let pins  = normalizePins(loadRaw(LS_PINS, {}));
let cart  = normalizeCart(loadRaw(LS_CART, {}));
let paid  = loadRaw(LS_PAID, 0);
let misu  = loadRaw(LS_MISU, []);
let soldOutMap = loadRaw(LS_SOLDOUT, {}); // {id: isoTime}

let activeCat = "ì „ì²´";
let query = "";

/* ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ë³µ ë°©ì§€ */
let loadedMisuIndex = null;

/* ===============================
   ì—˜ë¦¬ë¨¼íŠ¸
================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elMisuPill = document.getElementById("misuPill");
const elAdminPill = document.getElementById("adminPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elMisuList = document.getElementById("misuList");

/* ê´€ë¦¬ì */
const adminBack = document.getElementById("adminBack");
const aClose = document.getElementById("aClose");
const timeTabs = document.getElementById("timeTabs");
const catTabs  = document.getElementById("catTabs");
const kpiCnt   = document.getElementById("kpiCnt");
const kpiCntS  = document.getElementById("kpiCntS");
const kpiAov   = document.getElementById("kpiAov");
const kpiAovS  = document.getElementById("kpiAovS");
const kpiPeak  = document.getElementById("kpiPeak");
const kpiPeakS = document.getElementById("kpiPeakS");

const revSel = document.getElementById("revSel");
const revAll = document.getElementById("revAll");
const bestList = document.getElementById("bestList");
const worstList = document.getElementById("worstList");
const soldOutList = document.getElementById("soldOutList");

/* ë™ê¸°í™” ë²„íŠ¼/í‘œì‹œ */
const syncBtn = document.getElementById("syncBtn");
const syncInfo = document.getElementById("syncInfo");

/* ===============================
   ìœ í‹¸
================================= */
function won(n){ const x = Math.round(Number(n)||0); return x.toLocaleString("ko-KR") + "ì›"; }
function hhmm(iso){
  const d = new Date(iso);
  const h = String(d.getHours()).padStart(2,"0");
  const m = String(d.getMinutes()).padStart(2,"0");
  return `${h}:${m}`;
}
function todayKey(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* ===============================
   ì •ë ¬/í•„í„°
================================= */
function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){ (pins[it.id] ? pinned : normal).push(it); }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd); normal.sort(byOrd);
  return [...pinned, ...normal];
}
function matchItem(it, q){
  if(!q) return true;
  const name = normalize(it.name);
  const qn = normalize(q);
  if(name.includes(qn)) return true;

  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;
  return false;
}

/* âœ… ê²€ìƒ‰/ì´ˆì„±ì€ í•­ìƒ ì „ì¹´í…Œê³ ë¦¬ */
function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);

  // âœ… í’ˆì ˆì´ë©´ POSì—ì„œ ìˆ¨ê¹€
  list = list.filter(it => !soldOutMap[it.id]);

  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* ===============================
   íƒ­/í‚¤íŒ¨ë“œ
================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCat = cat;
      // âœ… íƒ­ í´ë¦­í•˜ë©´ í™œì„±ë ê°€ ì´ë™ (ìš”ì²­)
      renderAll();
    };
    elTabs.appendChild(b);
  });
}

function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });

  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* ===============================
   ê³ ì •
================================= */
function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ
================================= */
function persistCart(){
  cart = normalizeCart(cart);
  save(LS_CART, cart);
}

function addToCart(it){
  if(Number(it.active)!==1) return;
  if (soldOutMap[it.id]) return; // âœ… í’ˆì ˆì´ë©´ ë‹´ê¸° ë°©ì§€
  const id = it.id;
  if(!cart[id]){
    cart[id] = {id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[id].qty += 1;
  }
  persistCart();
  renderAll();
}

function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  persistCart();
  renderAll();
}
function removeCart(id){
  delete cart[id];
  persistCart();
  renderAll();
}
function resetCartAll(){
  const ok = confirm("ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆì„ ë¦¬ì…‹í• ê¹Œìš”?");
  if(!ok) return;
  cart = {};
  paid = 0;
  loadedMisuIndex = null;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}
function cartEntries(){ return Object.values(normalizeCart(cart)); }
function cartCount(){ return cartEntries().reduce((a,x)=>a+(x.qty||0),0); }
function cartTotal(){ return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0); }

/* ì‚‘ */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* ===============================
   âœ… íŒë§¤ ë¡œê·¸(ì´ë§¤ì¶œ/ë­í‚¹/ì‹œê°„ëŒ€)
================================= */
function loadSales(){ return loadRaw(LS_SALES, []); }
function saveSales(list){ save(LS_SALES, list); }

function logSaleFromCart(){
  const entries = cartEntries();
  const total = cartTotal();
  if(total<=0 || entries.length===0) return;

  const now = new Date();
  const sales = loadSales();
  sales.push({
    at: now.toISOString(),
    total,
    items: entries.map(x=>({id:x.id, name:x.name, cat:(items.find(i=>i.id===x.id)?.cat || "ê¸°íƒ€"), qty:Number(x.qty||0), price:Number(x.price||0)}))
  });
  saveSales(sales);
}

/* ===============================
   ê²°ì œì™„ë£Œ
================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  // âœ… ê²°ì œ ì‹œ íŒë§¤ë¡œê·¸ ì €ì¥(ì´ë§¤ì¶œ/ë­í‚¹ìš©)
  logSaleFromCart();

  beep();

  if(loadedMisuIndex !== null){
    misu = loadRaw(LS_MISU, misu);
    if(misu[loadedMisuIndex]){
      misu.splice(loadedMisuIndex, 1);
      save(LS_MISU, misu);
    }
    loadedMisuIndex = null;
  }

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* ===============================
   ë¯¸ìˆ˜
================================= */
function openMisu(){
  elModalBack.style.display = "flex";
  renderMisuList();
}
function closeMisu(){ elModalBack.style.display = "none"; }

function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (loadRaw(LS_MISU, misu).length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu = loadRaw(LS_MISU, misu);
  misu.unshift({ id, at: now.toISOString(), items: names, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;
  loadedMisuIndex = null;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}

function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  const next = {};
  for(const it of m.items){
    const found = items.find(x=>x.name===it.name);
    if(found){
      next[found.id] = {id:found.id, name:found.name, price:Number(found.price||0), qty:Number(it.qty||1)};
    }else{
      const tmpId = "TMP_"+it.name;
      next[tmpId] = {id:tmpId, name:it.name, price:0, qty:Number(it.qty||1)};
    }
  }
  cart = next;
  paid = 0;
  loadedMisuIndex = idx;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  closeMisu();
  renderAll();
}

function settleMisu(idx){
  const m = misu[idx];
  if(!m) return;
  const ok = confirm(`${m.id} (${won(m.amount||0)}) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`);
  if(!ok) return;
  beep();
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function deleteMisu(idx){
  const ok = confirm("ì´ ë¯¸ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?");
  if(!ok) return;
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;">ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");

    const all = (m.items||[]).map(x=>`${x.name}x${x.qty}`);
    const itemsText = all.slice(0,4).join(" Â· ") + (all.length>4 ? ` Â· â€¦(+${all.length-4})` : "");

    const wrap = document.createElement("div");
    wrap.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuInfo";
    left.innerHTML = `
      <div class="t">
        <span>${m.id}</span>
        <span class="amt mono">Â· ${won(m.amount||0)}</span>
        <span class="time">(${hh}:${mm})</span>
      </div>
      <div class="d">${itemsText}</div>
    `;

    const right = document.createElement("div");
    right.className = "misuBtns";

    const bPay = document.createElement("button");
    bPay.className = "btn2 good";
    bPay.textContent = "ê²°ì œì™„ë£Œ";
    bPay.onclick = ()=>settleMisu(idx);

    const bLoad = document.createElement("button");
    bLoad.className = "btn2";
    bLoad.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    bLoad.onclick = ()=>restoreMisu(idx);

    const bDel = document.createElement("button");
    bDel.className = "btn2 danger";
    bDel.textContent = "ì‚­ì œ";
    bDel.onclick = ()=>deleteMisu(idx);

    right.appendChild(bPay);
    right.appendChild(bLoad);
    right.appendChild(bDel);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

/* ===============================
   ìƒí’ˆ ì¹´ë“œ ë Œë”
================================= */
let pressTimer=null;
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "ê³ ì •";
    pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

    card.onclick = ()=>addToCart(it);
    card.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(it.id); return false; };

    // âœ… iPad: 1.2ì´ˆ ê¸¸ê²Œ ëˆ„ë¥´ë©´ ê³ ì •
    card.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 1200);
    }, {passive:true});
    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    elGrid.appendChild(card);
  });
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ ë Œë”
================================= */
function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">â€”</div>`;
    return;
  }

  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);

  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length})`;
}

/* ===============================
   âœ… ê´€ë¦¬ì: ì‹œê°„/ì¹´í…Œê³ ë¦¬ íƒ­ + ê³„ì‚°
================================= */
const TIME_TABS = [
  { key:"ALL", label:"ì „ì²´" },
  { key:"T0_12", label:"~12" },
  { key:"T12_14", label:"12~2" },
  { key:"T14_16", label:"2~4" },
  { key:"T16_18", label:"4~6" },
  { key:"T18_X", label:"6~" }, // âœ… 6ì‹œë¶€í„° ë§ˆê°ê¹Œì§€(ë¬´í•œ)
];

let adminTimeKey = "ALL";
let adminCatKey = "ì „ì²´";

function isInTimeBucket(date, key){
  const h = date.getHours();
  if(key==="ALL") return true;
  if(key==="T0_12") return h < 12;
  if(key==="T12_14") return h >= 12 && h < 14;
  if(key==="T14_16") return h >= 14 && h < 16;
  if(key==="T16_18") return h >= 16 && h < 18;
  if(key==="T18_X") return h >= 18;
  return true;
}

function renderAdminTabs(){
  timeTabs.innerHTML = "";
  TIME_TABS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (t.key===adminTimeKey ? " active":"");
    b.textContent = t.label;
    b.onclick = ()=>{ adminTimeKey = t.key; renderAdmin(); };
    timeTabs.appendChild(b);
  });

  catTabs.innerHTML = "";
  CATS.forEach(c=>{
    const b = document.createElement("button");
    b.className = "tab" + (c===adminCatKey ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{ adminCatKey = c; renderAdmin(); };
    catTabs.appendChild(b);
  });
}

function getTodaySales(){
  const tk = todayKey();
  return loadSales().filter(s=>{
    const d = new Date(s.at);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    return k===tk;
  });
}

function filterSalesByAdmin(sales){
  return sales.filter(s=>{
    const d = new Date(s.at);
    if(!isInTimeBucket(d, adminTimeKey)) return false;
    if(adminCatKey==="ì „ì²´") return true;
    // ì¹´í…Œê³ ë¦¬ í•„í„°: í•´ë‹¹ ê²°ì œì— ê·¸ ì¹´í…Œê³ ë¦¬ í’ˆëª©ì´ 1ê°œë¼ë„ ìˆìœ¼ë©´ í¬í•¨
    return (s.items||[]).some(it => (it.cat||"ê¸°íƒ€") === adminCatKey);
  });
}

function aggregateQty(sales){
  const map = new Map(); // name -> {name, qty, cat}
  for(const s of sales){
    for(const it of (s.items||[])){
      // âœ… ì„ íƒ ì¹´í…Œê³ ë¦¬ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë§Œ ì§‘ê³„
      if(adminCatKey!=="ì „ì²´" && (it.cat||"ê¸°íƒ€") !== adminCatKey) continue;
      const key = it.name; // ì´ë¦„ ê¸°ì¤€
      const cur = map.get(key) || { name: it.name, cat: it.cat||"ê¸°íƒ€", qty:0 };
      cur.qty += Number(it.qty||0);
      map.set(key, cur);
    }
  }
  return Array.from(map.values()).sort((a,b)=>b.qty-a.qty);
}

function calcRevenue(sales){
  // ì„ íƒ ì¹´í…Œê³ ë¦¬ë©´ ê·¸ ì¹´í…Œê³ ë¦¬ í’ˆëª© ê°€ê²©ë§Œ í•©ì‚°(ëŒ€ëµ)
  if(adminCatKey==="ì „ì²´"){
    return sales.reduce((a,s)=>a+Number(s.total||0),0);
  }
  let sum=0;
  for(const s of sales){
    for(const it of (s.items||[])){
      if((it.cat||"ê¸°íƒ€")!==adminCatKey) continue;
      sum += Number(it.qty||0) * Number(it.price||0);
    }
  }
  return sum;
}

function renderRank(el, arr){
  el.innerHTML = "";
  if(!arr.length){
    el.innerHTML = `<div class="muted" style="padding:6px 4px;">â€”</div>`;
    return;
  }
  arr.slice(0,15).forEach((x,i)=>{
    const row = document.createElement("div");
    row.className = "rankItem";
    row.innerHTML = `
      <div class="n">${i+1}. ${x.name}</div>
      <div style="text-align:right;">
        <div class="q mono">${x.qty}</div>
        <div class="c">${x.cat}</div>
      </div>
    `;
    el.appendChild(row);
  });
}

function renderSoldOut(){
  soldOutList.innerHTML = "";
  soldOutMap = loadRaw(LS_SOLDOUT, soldOutMap) || {};
  const todaySales = getTodaySales();

  // ì˜¤ëŠ˜ íŒë§¤ìˆ˜ëŸ‰ ë§µ(ì „ì²´ ê¸°ì¤€)
  const qtyMap = new Map(); // id->qty
  for(const s of todaySales){
    for(const it of (s.items||[])){
      if(!it.id) continue;
      qtyMap.set(it.id, (qtyMap.get(it.id)||0) + Number(it.qty||0));
    }
  }

  // í’ˆì ˆëœ ê²ƒ ë¨¼ì €, ê·¸ ë‹¤ìŒ ì •ìƒ ìƒí’ˆ
  const list = items
    .filter(it => Number(it.active)===1)
    .sort((a,b)=>{
      const ao = soldOutMap[a.id] ? 0 : 1;
      const bo = soldOutMap[b.id] ? 0 : 1;
      if(ao!==bo) return ao-bo;
      return (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
    });

  list.forEach(it=>{
    const isOut = !!soldOutMap[it.id];
    const soldQty = qtyMap.get(it.id)||0;
    const outTime = isOut ? hhmm(soldOutMap[it.id]) : "-";

    const row = document.createElement("div");
    row.className = "soldOutRow";

    const left = document.createElement("div");
    left.className = "left";
    left.innerHTML = `
      <div class="t">${it.name}</div>
      <div class="d">íŒë§¤ìˆ˜ëŸ‰: <span class="mono">${soldQty}</span> Â· í’ˆì ˆì‹œê°„: <span class="mono">${outTime}</span></div>
    `;

    const right = document.createElement("div");
    right.className = "right";

    const btn = document.createElement("button");
    btn.className = "tinyBtn " + (isOut ? "good":"bad");
    btn.textContent = isOut ? "í’ˆì ˆí•´ì œ" : "í’ˆì ˆ";
    btn.onclick = ()=>{
      soldOutMap = loadRaw(LS_SOLDOUT, {}) || {};
      if(soldOutMap[it.id]) delete soldOutMap[it.id];
      else soldOutMap[it.id] = new Date().toISOString();
      save(LS_SOLDOUT, soldOutMap);
      renderAll();     // POS ë°˜ì˜
      renderSoldOut(); // ê´€ë¦¬ì ë°˜ì˜
    };

    right.appendChild(btn);

    row.appendChild(left);
    row.appendChild(right);
    soldOutList.appendChild(row);
  });
}

function renderAdmin(){
  renderAdminTabs();

  const todaySales = getTodaySales();
  const salesAll = todaySales;
  const salesSel = filterSalesByAdmin(todaySales);

  // KPI: ê²°ì œê±´ìˆ˜, ê°ë‹¨ê°€, í”¼í¬ì‹œê°„ëŒ€
  const cnt = salesSel.length;
  const rev = calcRevenue(salesSel);
  const aov = cnt>0 ? Math.round(rev/cnt) : 0;

  kpiCnt.textContent = String(cnt);
  kpiCntS.textContent = `ì˜¤ëŠ˜(${todayKey()})`;

  kpiAov.textContent = won(aov);
  kpiAovS.textContent = adminCatKey==="ì „ì²´" ? "ì „ì²´í’ˆëª© ê¸°ì¤€" : `${adminCatKey}ë§Œ ê¸°ì¤€`;

  // í”¼í¬ ì‹œê°„ëŒ€(ì „ì²´ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°: ì‹œê°„íƒ­ ALLì¼ ë•Œ ë” ì˜ë¯¸)
  const buckets = new Map(); // label->count
  for(const s of todaySales){
    const d = new Date(s.at);
    let label="6~";
    const h=d.getHours();
    if(h<12) label="~12";
    else if(h<14) label="12~2";
    else if(h<16) label="2~4";
    else if(h<18) label="4~6";
    else label="6~";
    buckets.set(label,(buckets.get(label)||0)+1);
  }
  let peakLabel="â€”", peakCnt=0;
  for(const [k,v] of buckets.entries()){
    if(v>peakCnt){ peakCnt=v; peakLabel=k; }
  }
  const totalCnt = todaySales.length || 0;
  const pct = totalCnt ? Math.round((peakCnt/totalCnt)*100) : 0;
  kpiPeak.textContent = totalCnt ? `${peakLabel}` : "â€”";
  kpiPeakS.textContent = totalCnt ? `${pct}% (${peakCnt}/${totalCnt})` : "â€”";

  // ì´ë§¤ì¶œ(ì„ íƒ/ì „ì²´)
  revSel.textContent = won(rev);
  revAll.textContent = won(calcRevenue(salesAll));

  // ë­í‚¹(ìˆ˜ëŸ‰ ê¸°ì¤€)
  const agg = aggregateQty(salesSel);
  const best = agg.slice(0,15);
  const worst = agg.slice().reverse().slice(0,15); // íŒë§¤ëœ ê²ƒ ì¤‘ ìµœì €

  renderRank(bestList, best);
  renderRank(worstList, worst);

  // í’ˆì ˆê´€ë¦¬
  renderSoldOut();
}

/* ê´€ë¦¬ì ì—´ê¸°(íŒ¨ìŠ¤ì›Œë“œ) */
const ADMIN_PASS = "1234"; // âœ… ì—¬ê¸° ì›í•˜ëŠ” ë¹„ë²ˆìœ¼ë¡œ ë°”ê¾¸ë©´ ë¨
function openAdmin(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if(pw !== ADMIN_PASS) return;
  adminBack.style.display = "flex";
  renderAdmin();
}
function closeAdmin(){ adminBack.style.display = "none"; }

/* ===============================
   renderAll
================================= */
function renderAll(){
  seedItemsIfEmpty();

  items = loadRaw(LS_ITEMS, items);
  pins  = normalizePins(loadRaw(LS_PINS, pins));
  cart  = normalizeCart(loadRaw(LS_CART, cart));
  paid  = loadRaw(LS_PAID, paid);
  misu  = loadRaw(LS_MISU, misu);
  soldOutMap = loadRaw(LS_SOLDOUT, soldOutMap) || {};

  save(LS_CART, cart);
  save(LS_PINS, pins);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* ===============================
   ì´ë²¤íŠ¸
================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  renderAll();
});

document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});

elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});

elPayBtn.addEventListener("click", doPay);

elSaveMisu.addEventListener("click", saveMisuNow);
elMisuPill.addEventListener("click", openMisu);

elCartPill.addEventListener("click", resetCartAll);

elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeMisu();
});
elMClose.addEventListener("click", closeMisu);

/* ê´€ë¦¬ì */
elAdminPill.addEventListener("click", openAdmin);
aClose.addEventListener("click", closeAdmin);
adminBack.addEventListener("click", (e)=>{
  if(e.target === adminBack) closeAdmin();
});

/* ===============================
   ë™ê¸°í™” UI
================================= */
const LS_LASTSYNC_UI = "umgane_lastSync_ui_v1";
let syncing = false;
let lastSyncTryAt = 0;

function fmtKST(ts){
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function todayKST(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setSyncInfo(){
  const t = Number(localStorage.getItem(LS_LASTSYNC_UI) || 0);
  syncInfo.textContent = t
    ? `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: ${fmtKST(t)}`
    : `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -`;
}

async function runSync({force=true, silent=false} = {}){
  if (syncing) return;

  const now = Date.now();
  if (now - lastSyncTryAt < 10_000) {
    if(!silent) alert("âš ï¸ ì ê¹ë§Œìš”. 10ì´ˆ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  lastSyncTryAt = now;

  syncing = true;
  syncBtn.disabled = true;
  syncBtn.textContent = "â³ ë™ê¸°í™”ì¤‘...";

  try{
    await umganeSyncFromSheet({ force });
    localStorage.setItem(LS_LASTSYNC_UI, String(Date.now()));
    setSyncInfo();
    if(!silent) alert("âœ… ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
  }catch(e){
    if(!silent) alert("âŒ ë™ê¸°í™” ì‹¤íŒ¨ (ì¸í„°ë„·/ì‹œíŠ¸ í™•ì¸)");
  }finally{
    syncing = false;
    syncBtn.disabled = false;
    syncBtn.textContent = "ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨";
  }
}
syncBtn.addEventListener("click", ()=> runSync({force:true, silent:false}));

setInterval(()=>{
  try{
    const cnt = cartCount();
    if(cnt === 0){
      runSync({force:false, silent:true});
    }
  }catch(e){}
}, 120_000);

setSyncInfo();
renderAll();
</script>
</body>
</html>
