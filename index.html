<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:16px;
    --shadow:0 12px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  button{cursor:pointer;border:0}
  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1.25fr .9fr;
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));
    border:1px solid var(--line);
    border-radius:20px;
    box-shadow:var(--shadow);
    overflow:hidden;
    min-height:0;
  }
  .left{display:flex;flex-direction:column;min-height:0}
  .right{display:flex;flex-direction:column;min-height:0}

  /* ===== TOP BAR ===== */
  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.18);
  }
  .topRow{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between; /* âœ… ì¹´í…Œê³ ë¦¬ ì™¼ìª½ / ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥¸ìª½ */
    flex-wrap:wrap;
  }

  /* tabs */
  .tabs{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .tab{
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    font-weight:700;
    letter-spacing:.2px;
  }
  .tab.active{
    border-color:rgba(255,159,0,.55);
    box-shadow:0 0 0 1px rgba(255,159,0,.2) inset;
  }

  /* sync button (right aligned area) */
  .syncBox{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .chipBtn{
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:8px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    font-weight:700;
  }
  .syncInfo{
    color:var(--muted);
    font-size:12px;
    display:flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
  }

  /* search */
  .searchRow{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .search{
    flex:1;
    display:flex;
    gap:8px;
    align-items:center;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
  }
  .search input{
    flex:1;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:14px;
  }
  .muted{color:var(--muted)}
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:12px;
  }

  /* ===== ì´ˆì„± í‚¤íŒ¨ë“œ (ê°€ë¡œ ê³ ì •) ===== */
  .chosungRow{
    margin-top:10px;
    display:flex;              /* âœ… ë¬´ì¡°ê±´ ê°€ë¡œ */
    flex-direction:row;        /* âœ… ì„¸ë¡œ ë°©ì§€ */
    flex-wrap:wrap;            /* âœ… ì¤„ë°”ê¿ˆìœ¼ë¡œ ê°€ë¡œ ìœ ì§€ */
    gap:8px;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    min-width:40px;
    height:36px;
    padding:0 10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    color:var(--text);
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
  }
  .key.danger{
    border-color:rgba(255,59,48,.35);
    background:rgba(255,59,48,.12);
  }

  /* ===== grid ===== */
  .gridWrap{
    padding:12px;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:hidden;
  }
  .pinBarTitle{
    color:var(--muted);
    font-size:12px;
    margin-top:2px;
  }
  .grid{
    min-height:0;
    overflow:auto;
    padding-right:6px;
  }
  .grid::-webkit-scrollbar{width:10px}
  .grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:10px}
  .cards{
    display:grid;
    grid-template-columns:repeat(6, minmax(160px, 1fr));
    gap:10px;
    padding-bottom:12px;
  }
  .card{
    border:1px solid var(--line);
    background:rgba(0,0,0,.20);
    border-radius:16px;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:72px;
  }
  .cardName{font-weight:900;font-size:16px;line-height:1.1}
  .cardPrice{font-weight:900;color:var(--text)}
  .cardMeta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}

  /* ===== right ===== */
  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    font-weight:900;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.55);
  }
  .cart{
    padding:12px;
    min-height:0;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:hidden;
  }
  .cartList{
    min-height:0;
    overflow:auto;
    padding-right:6px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(0,0,0,.18);
    padding:10px;
  }
  .cartItem{
    display:grid;
    grid-template-columns: 1fr 70px 32px 32px 32px;
    gap:8px;
    align-items:center;
    padding:8px 6px;
    border-bottom:1px dashed rgba(255,255,255,.08);
  }
  .cartItem:last-child{border-bottom:0}
  .cartItem .nm{font-weight:900}
  .cartItem .pr{font-weight:900;text-align:right}
  .miniBtn{
    width:32px;height:32px;border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    font-weight:900;
  }
  .miniBtn.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35)}
  .sumBox{
    border-top:1px solid var(--line);
    padding-top:10px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .sumBig{
    font-size:38px;
    font-weight:1000;
    letter-spacing:.5px;
  }
  .twoCols{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .field{
    border:1px solid var(--line);
    border-radius:16px;
    padding:10px;
    background:rgba(0,0,0,.18);
  }
  .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px;font-weight:800}
  .field .val{font-size:24px;font-weight:1000}
  .cashBtns{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .cashBtns button{
    height:44px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    font-weight:1000;
  }
  .cashBtns button.danger{background:rgba(255,59,48,.14);border-color:rgba(255,59,48,.35)}
  .payRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    margin-top:auto;
  }
  .payBtn{
    height:64px;
    border-radius:18px;
    background:var(--accent);
    color:#111;
    font-weight:1000;
    font-size:22px;
  }
  .misuSave{
    height:46px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.06);
    color:var(--text);
    font-weight:900;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }

  @media (max-width: 1300px){
    .app{grid-template-columns:1fr}
    .cards{grid-template-columns:repeat(4, minmax(150px, 1fr))}
  }
</style>
</head>

<body>
<div class="app">

  <!-- LEFT -->
  <section class="panel left">
    <div class="top">
      <div class="topRow">
        <div class="tabs" id="tabs"></div>

        <!-- âœ… ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥¸ìª½ -->
        <div class="syncBox">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ì˜¤ëŠ˜: - Â· ğŸ•’ ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã…ˆã……, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <!-- âœ… ì´ˆì„±í‚¤ ê°€ë¡œ -->
      <div class="chosungRow" id="keys"></div>

      <div class="hint">ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· í´ë¦­=ë‹´ê¸°</div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="panel right">
    <div class="rightTop">
      <div class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</div>
      <button class="chipBtn" id="resetAllBtn">ë¦¬ì…‹</button>
    </div>

    <div class="cart">
      <div class="cartList" id="cartList"></div>

      <div class="sumBox">
        <div>
          <div class="muted" id="sumCaption">ì´í•©ê³„(0ê°œ)</div>
          <div class="sumBig" id="sumBig">0ì›</div>
        </div>

        <div class="twoCols">
          <div class="field">
            <label>ë°›ì€ëˆ</label>
            <div class="val" id="paidVal">0ì›</div>
          </div>
          <div class="field">
            <label>ê±°ìŠ¤ë¦„ëˆ</label>
            <div class="val" id="changeVal">0ì›</div>
          </div>
        </div>

        <div class="cashBtns">
          <button data-add="500">500</button>
          <button data-add="1000">1ì²œ</button>
          <button data-add="5000">5ì²œ</button>
          <button data-add="10000">1ë§Œ</button>
          <button data-add="50000">5ë§Œ</button>
          <button class="danger" id="resetPaidBtn">ì´ˆê¸°í™”</button>
        </div>

        <button class="misuSave" id="misuSaveBtn">ë¯¸ìˆ˜ <span class="muted">í˜„ì œì¥ë°”êµ¬ë‹ˆ ì €ì¥</span></button>

        <div class="payRow">
          <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
/* =========================================================
   âœ… ì„¤ì •: êµ¬ê¸€ì‹œíŠ¸ CSV(ê²Œì‹œ/í¼ë¸”ë¦¬ì‹œ) ì£¼ì†Œ ë„£ëŠ” ê³³
   - ì˜ˆ) https://docs.google.com/spreadsheets/d/e/....../pub?output=csv
========================================================= */
const SHEET_CSV_URL = ""; // â¬…ï¸ ì—¬ê¸°ë§Œ ë„¤ CSV ì£¼ì†Œë¡œ ë„£ìœ¼ë©´ ë¨ (ë¹„ì›Œë‘ë©´ ë¡œì»¬ ë°ì´í„°ë§Œ ì‚¬ìš©)

/* =========================================================
   ê¸°ë³¸: ì¹´í…Œê³ ë¦¬/ì´ˆì„±
========================================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…","X"];

const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){ return [...(str||"")].map(getChosungChar).join(""); }
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

function todayStr(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function timeStr(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

/* =========================================================
   ì €ì¥ì†Œ í‚¤
========================================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PIN = "umgane_pins_v2";
const LS_CART = "umgane_cart_v2";
const LS_PAID = "umgane_paid_v2";
const LS_LASTSYNC = "umgane_lastsync_v2";
const LS_MISU = "umgane_misu_v2";

function load(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch(e){ return fallback; }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* =========================================================
   ë°ì´í„° êµ¬ì¡°
   item = { id, cat, name, price, active, ord }
========================================================= */
let items = load(LS_ITEMS, []);
let pins  = load(LS_PIN, {});          // {cat:[id,...]}
let cart  = load(LS_CART, []);         // [{id, qty}]
let paid  = load(LS_PAID, 0);
let misu  = load(LS_MISU, []);         // ë‹¨ìˆœ ì €ì¥ë§Œ
let activeCat = "ì „ì²´";
let query = "";

/* =========================================================
   ê¸°ë³¸ ìƒ˜í”Œ ë°ì´í„° (ì‹œíŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ ìµœì´ˆ ì§„ì… ì‹œ)
========================================================= */
function ensureSeed(){
  if(Array.isArray(items) && items.length >= 3) return;
  items = [
    {id:"A1", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:10},
    {id:"A2", cat:"ì•¼ì±„", name:"ì–‘íŒŒ", price:2500, active:1, ord:20},
    {id:"A3", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:30},
    {id:"A4", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:40},
    {id:"A5", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:50},
  ];
  save(LS_ITEMS, items);
}
ensureSeed();

/* =========================================================
   UI ì—˜ë¦¬ë¨¼íŠ¸
========================================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elQ = document.getElementById("q");
const elGrid = document.getElementById("grid");
const elCartList = document.getElementById("cartList");
const elSumBig = document.getElementById("sumBig");
const elSumCaption = document.getElementById("sumCaption");
const elPaidVal = document.getElementById("paidVal");
const elChangeVal = document.getElementById("changeVal");
const elSyncInfo = document.getElementById("syncInfo");
const elPinTitle = document.getElementById("pinTitle");
const elMisuPill = document.getElementById("misuPill");

/* =========================================================
   ë Œë”: íƒ­ / í‚¤íŒ¨ë“œ
   - âœ… ì •ë ¬ ë²„íŠ¼(ê³ ì •/ord) ìì²´ë¥¼ UIì—ì„œ ì œê±° (ì•„ì˜ˆ ì—†ìŒ)
========================================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    elTabs.appendChild(b);
  });
}

function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key" + (k==="X" ? " danger":"");
    d.textContent = k;
    d.onclick = ()=>{
      if(k==="X"){
        elQ.value = "";
        query = "";
      }else{
        elQ.value = (elQ.value||"") + k;
        query = elQ.value;
      }
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });
}

/* =========================================================
   í•„í„°/ì •ë ¬
   - ê¸°ë³¸ì€ ê³ ì •(í•€) ë¨¼ì €, ê·¸ ë‹¤ìŒ ord, ê·¸ ë‹¤ìŒ ì´ë¦„
========================================================= */
function getActiveItems(){
  const q = normalize(query);
  const qCho = toChosung(query);

  return items
    .filter(x => Number(x.active||1) === 1)
    .filter(x => activeCat==="ì „ì²´" ? true : (x.cat===activeCat))
    .filter(x=>{
      if(!q) return true;
      const name = x.name || "";
      const cat = x.cat || "";
      const merged = `${name} ${cat}`;
      // ì´ˆì„± ê²€ìƒ‰ + ì¼ë°˜ ë¬¸ìì—´ ê²€ìƒ‰ ë‘˜ ë‹¤
      if(normalize(merged).includes(q)) return true;
      if(toChosung(name).includes(qCho)) return true;
      return false;
    });
}

function getPinListForCat(cat){
  const key = cat || "ì „ì²´";
  return (pins && pins[key]) ? pins[key] : [];
}

function sortWithPins(list){
  const pinList = getPinListForCat(activeCat==="ì „ì²´" ? "ì „ì²´" : activeCat);
  const pinSet = new Set(pinList);

  const pinned = [];
  const normal = [];

  list.forEach(it => (pinSet.has(it.id) ? pinned : normal).push(it));

  pinned.sort((a,b)=> (a.ord||0)-(b.ord||0) || (a.name||"").localeCompare(b.name||""));
  normal.sort((a,b)=> (a.ord||0)-(b.ord||0) || (a.name||"").localeCompare(b.name||""));

  return { pinned, normal };
}

/* =========================================================
   ë Œë”: ìƒí’ˆ ì¹´ë“œ
========================================================= */
function fmt(n){ return (Number(n)||0).toLocaleString("ko-KR")+"ì›"; }

function addToCart(id){
  const found = cart.find(x=>x.id===id);
  if(found) found.qty += 1;
  else cart.push({id, qty:1});
  save(LS_CART, cart);
  renderCart();
}

function renderGrid(){
  const list = getActiveItems();

  const {pinned, normal} = sortWithPins(list);
  elPinTitle.textContent = `ê³ ì •(${activeCat}) Â· ìƒë‹¨ 1ì¤„`;

  const all = [...pinned, ...normal];

  const wrap = document.createElement("div");
  wrap.className = "cards";

  all.forEach(it=>{
    const c = document.createElement("div");
    c.className = "card";
    c.onclick = ()=> addToCart(it.id);

    const nm = document.createElement("div");
    nm.className = "cardName";
    nm.textContent = it.name || "-";

    const pr = document.createElement("div");
    pr.className = "cardPrice";
    pr.textContent = fmt(it.price);

    c.appendChild(nm);
    c.appendChild(pr);
    wrap.appendChild(c);
  });

  elGrid.innerHTML = "";
  elGrid.appendChild(wrap);
}

/* =========================================================
   ë Œë”: ì¥ë°”êµ¬ë‹ˆ/í•©ê³„
========================================================= */
function getItemById(id){
  return items.find(x=>x.id===id);
}

function cartTotal(){
  let sum=0, cnt=0;
  cart.forEach(ci=>{
    const it = getItemById(ci.id);
    if(!it) return;
    cnt += ci.qty;
    sum += (Number(it.price)||0) * (Number(ci.qty)||0);
  });
  return {sum, cnt};
}

function renderCart(){
  elCartList.innerHTML = "";
  cart.forEach(ci=>{
    const it = getItemById(ci.id);
    if(!it) return;

    const row = document.createElement("div");
    row.className = "cartItem";

    const nm = document.createElement("div");
    nm.className = "nm";
    nm.textContent = `${it.name} x${ci.qty}`;

    const pr = document.createElement("div");
    pr.className = "pr";
    pr.textContent = fmt((Number(it.price)||0) * (Number(ci.qty)||0));

    const minus = document.createElement("button");
    minus.className = "miniBtn";
    minus.textContent = "â€“";
    minus.onclick = (e)=>{
      e.stopPropagation();
      ci.qty = Math.max(1, ci.qty-1);
      save(LS_CART, cart);
      renderCart();
    };

    const plus = document.createElement("button");
    plus.className = "miniBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{
      e.stopPropagation();
      ci.qty += 1;
      save(LS_CART, cart);
      renderCart();
    };

    const del = document.createElement("button");
    del.className = "miniBtn danger";
    del.textContent = "Ã—";
    del.onclick = (e)=>{
      e.stopPropagation();
      cart = cart.filter(x=>x.id!==ci.id);
      save(LS_CART, cart);
      renderCart();
    };

    row.appendChild(nm);
    row.appendChild(pr);
    row.appendChild(minus);
    row.appendChild(plus);
    row.appendChild(del);
    elCartList.appendChild(row);
  });

  const {sum,cnt} = cartTotal();
  elSumCaption.textContent = `ì´í•©ê³„(${cnt}ê°œ)`;
  elSumBig.textContent = fmt(sum);

  elPaidVal.textContent = fmt(paid);
  const change = Math.max(0, (paid||0) - sum);
  elChangeVal.textContent = fmt(change);

  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length||0})`;
}

/* =========================================================
   ë™ê¸°í™” í‘œì‹œ
========================================================= */
function renderSyncInfo(){
  const last = load(LS_LASTSYNC, null);
  const d = todayStr();
  const t = last ? (last.time || "-") : "-";
  const dt = last ? (last.date || "-") : "-";
  elSyncInfo.textContent = `ì˜¤ëŠ˜: ${d} Â· ğŸ•’ ë§ˆì§€ë§‰ ë™ê¸°í™”: ${dt} ${t}`;
}

/* =========================================================
   CSV íŒŒì„œ (ì½¤ë§ˆ/ë”°ì˜´í‘œ ì•ˆì „)
========================================================= */
function parseCSV(text){
  const rows = [];
  let cur="", inQ=false;
  let row=[];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }
    if(ch === ',' && !inQ){ pushCell(); continue; }
    if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow(); continue;
    }
    cur += ch;
  }
  pushCell(); pushRow();
  // ë¹ˆ ì¤„ ì œê±°
  return rows.filter(r=> r.some(c => (c||"").trim() !== ""));
}

function toNumber(v){
  const s = (v??"").toString().replace(/[^\d.-]/g,"");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function normalizeActive(v){
  const s = (v??"").toString().trim().toLowerCase();
  if(s==="" || s==="1" || s==="y" || s==="yes" || s==="true" || s==="ì‚¬ìš©" || s==="í™œì„±") return 1;
  return 0;
}
function toInt(v, dft){
  const n = parseInt((v??"").toString().trim(), 10);
  return Number.isFinite(n) ? n : (dft||0);
}

/* =========================================================
   êµ¬ê¸€ì‹œíŠ¸ -> items ë™ê¸°í™”
   - âœ… ë´‰ì±„ì†Œ/ë´‰ì§€ì±„ì†Œ ìë™ í†µì¼
========================================================= */
async function syncItemsFromSheet({force=false}={}){
  if(!SHEET_CSV_URL){
    return {ok:false, message:"SHEET_CSV_URL ë¹„ì–´ìˆìŒ(ë¡œì»¬ ë°ì´í„° ì‚¬ìš©)"};
  }
  const res = await fetch(SHEET_CSV_URL, {cache: force ? "reload" : "no-store"});
  if(!res.ok) throw new Error("ì‹œíŠ¸ CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  const csv = await res.text();
  const rows = parseCSV(csv);
  if(rows.length < 2) throw new Error("ì‹œíŠ¸ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ");

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  // í—¤ë” í›„ë³´
  const iId =
    idx("id")>=0 ? idx("id") :
    idx("ID")>=0 ? idx("ID") :
    idx("ìƒí’ˆID")>=0 ? idx("ìƒí’ˆID") :
    idx("ì½”ë“œ");

  const iCat =
    idx("cat")>=0 ? idx("cat") :
    idx("ì¹´í…Œê³ ë¦¬")>=0 ? idx("ì¹´í…Œê³ ë¦¬") :
    idx("ë¶„ë¥˜");

  const iName =
    idx("name")>=0 ? idx("name") :
    idx("í’ˆëª©")>=0 ? idx("í’ˆëª©") :
    idx("í’ˆëª©ëª…")>=0 ? idx("í’ˆëª©ëª…") :
    idx("ìƒí’ˆëª…");

  const iPrice =
    idx("price")>=0 ? idx("price") :
    idx("ê°€ê²©")>=0 ? idx("ê°€ê²©") :
    idx("ë‹¨ê°€");

  const iActive =
    idx("active")>=0 ? idx("active") :
    idx("ì‚¬ìš©")>=0 ? idx("ì‚¬ìš©") :
    idx("í™œì„±")>=0 ? idx("í™œì„±") :
    idx("ë…¸ì¶œ");

  const iOrd =
    idx("ord")>=0 ? idx("ord") :
    idx("ì •ë ¬")>=0 ? idx("ì •ë ¬") :
    idx("ìˆœì„œ");

  if(iId < 0 || iCat < 0 || iName < 0 || iPrice < 0){
    throw new Error("ì‹œíŠ¸ í—¤ë” ë¶€ì¡±: id/cat/name/price í•„ìˆ˜");
  }

  const next = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    const id = String(row[iId] ?? "").trim();
    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,""); // ê³µë°± ì œê±°(ì¼ë°˜/nbsp)
    // âœ… ë´‰ì±„ì†Œ -> ë´‰ì§€ì±„ì†Œ í†µì¼
    if(cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ";

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if(!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    next.push({id, cat, name, price, active, ord});
  }

  if(next.length < 3){
    throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ (ì‹œíŠ¸/ê²Œì‹œ/í—¤ë” í™•ì¸ í•„ìš”)");
  }

  items = next;
  save(LS_ITEMS, items);
  const stamp = {date: todayStr(), time: timeStr()};
  save(LS_LASTSYNC, stamp);

  return {ok:true, count: items.length};
}

// ì½˜ì†”ì—ì„œ ê°•ì œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
window.umganeSyncFromSheet = async (opt={force:true}) => {
  try{
    const r = await syncItemsFromSheet(opt);
    renderAll();
    return r;
  }catch(e){
    console.warn("[SHEET SYNC FAIL]", e?.message || e);
    return {ok:false, error: e?.message || String(e)};
  }
};

/* =========================================================
   ì´ë²¤íŠ¸
========================================================= */
document.getElementById("syncBtn").onclick = async ()=>{
  // ì‹¤ë¬´ìëŠ” "ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ í•œë²ˆ"ë§Œ ëˆ„ë¥´ë©´ ë¨
  await window.umganeSyncFromSheet({force:true});
};

elQ.addEventListener("input", ()=>{
  query = elQ.value || "";
  renderAll();
});

document.querySelectorAll(".cashBtns button[data-add]").forEach(btn=>{
  btn.onclick = ()=>{
    const add = Number(btn.getAttribute("data-add")||0);
    paid = (paid||0) + add;
    save(LS_PAID, paid);
    renderCart();
  };
});

document.getElementById("resetPaidBtn").onclick = ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderCart();
};

document.getElementById("resetAllBtn").onclick = ()=>{
  // ë¦¬ì…‹ì€ "ë°›ì€ëˆë§Œ" ì´ ì•„ë‹ˆë¼, ì—¬ê¸° ë²„íŠ¼ì€ ì „ì²´ ë¦¬ì…‹(ì‹¤ë¬´ìš©)
  // ì›í•˜ë©´ ì´ ë²„íŠ¼ ë™ì‘ë„ ë°”ê¿€ ìˆ˜ ìˆìŒ
  cart = [];
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderCart();
};

document.getElementById("payBtn").onclick = ()=>{
  // ê²°ì œì™„ë£Œ: ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê³  ë°›ì€ëˆì€ ìœ ì§€/ì´ˆê¸°í™” ì¤‘ ì„ íƒ ê°€ëŠ¥
  // ì—¬ê¸°ì„œëŠ” ì¥ë°”êµ¬ë‹ˆë§Œ ë¹„ìš°ê³  ë°›ì€ëˆì€ 0ìœ¼ë¡œ ì´ˆê¸°í™”
  cart = [];
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderCart();
};

document.getElementById("misuSaveBtn").onclick = ()=>{
  // í˜„ì¬ ì¥ë°”êµ¬ë‹ˆë¥¼ ë¯¸ìˆ˜ë¡œ ì €ì¥(ë‹¨ìˆœ ê¸°ë¡)
  if(cart.length === 0) return;
  misu.push({ts: Date.now(), cart: JSON.parse(JSON.stringify(cart))});
  save(LS_MISU, misu);
  renderCart();
};

/* =========================================================
   ì „ì²´ ë Œë”
========================================================= */
function renderAll(){
  // itemsê°€ ê¹¨ì¡Œì„ ë•Œë„ í™”ë©´ì´ ì•ˆ ì‚¬ë¼ì§€ê²Œ ë°©ì–´
  if(!Array.isArray(items)) items = [];
  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSyncInfo();
}

/* =========================================================
   ì´ˆê¸°í™”: ì‹œíŠ¸ ë™ê¸°í™” ì‹œë„(ì¡°ìš©íˆ ì‹¤íŒ¨)
========================================================= */
(async ()=>{
  try{
    await syncItemsFromSheet({force:false});
  }catch(e){
    // ì¡°ìš©íˆ ë¬´ì‹œ(ë¡œì»¬ ë°ì´í„°ë¡œ ê³„ì†)
  }
  renderAll();
})();
</script>
</body>
</html>
