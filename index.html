<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>
<link rel="icon" href="data:,">

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:18px;

    --fs-12:12px;
    --fs-13:13px;
    --fs-14:14px;
    --fs-16:16px;
    --fs-18:18px;
    --fs-24:24px;
    --fs-32:32px;

    --w-400:400;
    --w-500:500;
    --w-600:600;

    --right-w: 420px;

    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    --card-min: 210px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }

  .tabsRow{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:800;
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:900;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .syncWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .syncInfo{font-size:12px; color:rgba(245,247,255,.65); white-space:nowrap;}

  .searchRow{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:800;
  }

  .chosungRow{
    display:flex;
    flex-direction:row !important;
    gap:6px;
    flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:900;
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:900;
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.88);
  }

  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }

  .badge{
    position:absolute;
    left:10px; bottom:10px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:12px;
    font-weight:900;
    color:rgba(245,247,255,.92);
  }
  .badge.soldout{
    background:rgba(255,59,48,.10);
    border-color:rgba(255,59,48,.28);
    color:rgba(255,220,220,.95);
  }

  .card.inactive{ opacity:.35; filter:grayscale(.55); }
  .card.soldoutCard{
    opacity:.35;
    filter:grayscale(.8);
    pointer-events:none; /* ë‹´ê¸° ë§‰ê¸° */
  }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.92);
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:900;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{flex:1; overflow:auto; padding:10px 10px 6px;}
  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }
  .cartName{
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.85);
  }
  .qtyBox{display:flex; justify-content:flex-end; align-items:center; gap:8px;}
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:1000;
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:900;
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:1000;
  }

  .summary{border-top:1px solid var(--line); padding:10px 12px;}
  .sumTitle{font-size:var(--fs-13); color:rgba(245,247,255,.7); font-weight:900;}
  .sumMoney{margin-top:4px; font-size:var(--fs-32); font-weight:1000; letter-spacing:-.6px; line-height:1.05;}
  .twoCol{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;}
  .moneyBox{border-radius:16px; padding:8px 12px; border:1px solid var(--line); background:rgba(255,255,255,.02);}
  .moneyLabel{font-size:var(--fs-12); color:rgba(245,247,255,.65); font-weight:900;}
  .moneyValue{margin-top:3px; font-size:22px; font-weight:1000; line-height:1.05;}

  .cashGrid{margin-top:10px; display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
  .cashBtn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:1000;
    font-size:var(--fs-14);
  }
  .cashBtn.reset{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.28);}

  .bottomRow{margin-top:10px; display:grid; grid-template-columns: 1fr 2fr; gap:10px; align-items:stretch;}
  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:9px 10px;
    text-align:left;
    color:var(--text);
  }
  .misuBtn .t{font-weight:1000; font-size:var(--fs-16); color:var(--text); line-height:1.05;}
  .misuBtn .s{margin-top:3px; font-size:var(--fs-12); color:rgba(245,247,255,.65); font-weight:900; line-height:1.1;}

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:1100;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
    padding:12px 10px;
  }

  /* ===== ëª¨ë‹¬ ===== */
  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(980px, 96vw);
    max-height:86vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{margin:0; font-size:var(--fs-18); font-weight:1100; letter-spacing:-.2px;}
  .mActions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:1100;
  }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:1100;
    white-space:nowrap;
  }
  .btn2.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }
  .btn2.danger{ background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30); }

  /* ===== ê´€ë¦¬ì ë³´ë“œ ===== */
  .todayTabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 6px 12px;}
  .todayTab{
    padding:8px 10px;
    font-size:var(--fs-13);
    font-weight:1100;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:14px;
  }
  .todayTab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .filterRow{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    padding:0 6px 10px;
  }

  .kpi3{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
    padding:0 6px 10px;
  }
  @media (max-width: 860px){
    .kpi3{ grid-template-columns: 1fr; }
  }
  .kpi{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px 12px 10px;
  }
  .kpi .l{
    font-size:var(--fs-12);
    font-weight:1100;
    color:rgba(245,247,255,.65);
  }
  .kpi .v{
    margin-top:6px;
    font-size:30px;
    font-weight:1200;
    letter-spacing:-.6px;
    line-height:1.05;
  }
  .kpi .s{
    margin-top:6px;
    font-size:var(--fs-12);
    font-weight:1100;
    color:rgba(245,247,255,.55);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .bwWrap{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    padding:0 6px 8px;
  }
  @media (max-width: 860px){
    .bwWrap{ grid-template-columns: 1fr; }
  }
  .bwBox{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    overflow:hidden;
  }
  .bwHead{
    padding:10px 12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
  }
  .bwHead .t{font-weight:1200; font-size:var(--fs-14);}
  .bwHead .s{font-weight:1100; font-size:var(--fs-12); color:rgba(245,247,255,.55);}
  .bwList{padding:10px 10px 6px;}
  .bwRow{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(255,255,255,.02);
    margin-bottom:8px;
  }
  .bwName{
    font-weight:1200;
    font-size:var(--fs-14);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .bwVal{font-weight:1200; font-size:var(--fs-14); color:rgba(245,247,255,.9);}
  .bwVal.bad{ color:rgba(255,190,186,.95); }
  .bwVal.good{ color:rgba(200,255,225,.95); }

  .soldWrap{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin:6px;
  }
  .soldTitle{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    margin-bottom:10px;
  }
  .soldTitle .t{font-weight:1200; font-size:14px;}
  .soldTitle .s{font-weight:1100; font-size:12px; color:rgba(245,247,255,.55);}
  .soldSearch{
    display:flex; gap:10px; align-items:center;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .soldSearch input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:13px;
    font-weight:900;
  }
  .soldList{ margin-top:10px; }
  .soldRow{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(255,255,255,.02);
    margin-bottom:8px;
  }
  .soldName{
    font-weight:1200;
    font-size:14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .soldMeta{
    font-size:12px;
    font-weight:1100;
    color:rgba(245,247,255,.55);
    margin-top:4px;
  }
  .soldBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,59,48,.30);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:1200;
    white-space:nowrap;
  }
  .soldBtn.undo{
    border-color:rgba(41,209,126,.30);
    background:rgba(41,209,126,.12);
    color:rgba(230,255,240,.95);
  }

  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
  }
</style>
</head>

<body>
<div class="app">
  <section class="panel left">
    <div class="top">

      <div class="tabsRow">
        <div class="tabs" id="tabs"></div>

        <div class="syncWrap">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ğŸ“… ì˜¤ëŠ˜: - Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· ê¸¸ê²Œ=ê³ ì •/í•´ì œ(PC ìš°í´ë¦­) Â· í´ë¦­=ë‹´ê¸°
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rightTop">
      <!-- âœ… ì˜¤ëŠ˜ â†’ ê´€ë¦¬ì -->
      <div class="rightTitle"><span class="pill accent" id="adminPill">ê´€ë¦¬ì</span></div>
      <div class="rightTitle"><span class="pill" id="cartPill">ë¦¬ì…‹</span></div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <!-- âœ… ë¯¸ìˆ˜ ë²„íŠ¼ ë³µêµ¬ ìœ ì§€ -->
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>
</div>

<!-- âœ… ê´€ë¦¬ì ëª¨ë‹¬(ë¯¸ìˆ˜ëª©ë¡ ì—†ìŒ) -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3 id="modalTitle">ê´€ë¦¬ì</h3>
      <div class="mActions">
        <button class="mClose" id="mClose">ë‹«ê¸°</button>
      </div>
    </div>

    <div id="adminView">
      <div class="todayTabs" id="todayTabs"></div>

      <!-- âœ… ì¹´í…Œê³ ë¦¬ í•„í„°: ì „ì²´ / ê³¼ì¼ / ì•¼ì±„ ... -->
      <div class="filterRow" id="catFilters"></div>

      <!-- âœ… ìƒë‹¨ 3ê°œ í¬ê²Œ -->
      <div class="kpi3">
        <div class="kpi">
          <div class="l">ê²°ì œê±´ìˆ˜</div>
          <div class="v mono" id="kpiCnt">0</div>
          <div class="s" id="kpiCntSub">-</div>
        </div>
        <div class="kpi">
          <div class="l">ê°ë‹¨ê°€</div>
          <div class="v mono" id="kpiAov">0ì›</div>
          <div class="s" id="kpiAovSub">-</div>
        </div>
        <div class="kpi">
          <div class="l">í”¼í¬ ì‹œê°„ëŒ€ + ë¹„ì¤‘</div>
          <div class="v mono" id="kpiPeak">-</div>
          <div class="s" id="kpiPeakSub">-</div>
        </div>
      </div>

      <!-- âœ… ì´ë§¤ì¶œ(êµ¬ê°„) : í¬ê²ŒëŠ” ì•„ë‹ˆê³ , ì‹¤ë¬´ìš©ìœ¼ë¡œ ë°”ë¡œ ì•„ë˜ ì¤„ -->
      <div class="filterRow" style="padding-top:0;">
        <button class="btn2 accent" id="salesStrip">ì´ë§¤ì¶œ: 0ì›</button>
      </div>

      <!-- âœ… ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ 15 : ë‚˜ê°„ìˆ˜ëŸ‰(id ê¸°ì¤€) -->
      <div class="bwWrap">
        <div class="bwBox">
          <div class="bwHead">
            <div class="t">ë² ìŠ¤íŠ¸ 15</div>
            <div class="s">ë‚˜ê°„ìˆ˜ëŸ‰ ê¸°ì¤€</div>
          </div>
          <div class="bwList" id="bestList"></div>
        </div>
        <div class="bwBox">
          <div class="bwHead">
            <div class="t">ì›ŒìŠ¤íŠ¸ 15</div>
            <div class="s">ë‚˜ê°„ìˆ˜ëŸ‰ ê¸°ì¤€</div>
          </div>
          <div class="bwList" id="worstList"></div>
        </div>
      </div>

      <!-- âœ… í’ˆì ˆ ê´€ë¦¬ -->
      <div class="soldWrap">
        <div class="soldTitle">
          <div class="t">í’ˆì ˆ ê´€ë¦¬</div>
          <div class="s">í’ˆì ˆ ëˆ„ë¥´ë©´ ì‹œê°„ ì €ì¥</div>
        </div>
        <div class="soldSearch">
          <span class="muted">ğŸ”</span>
          <input id="soldQ" placeholder="í’ˆì ˆ/í•´ì œ ê²€ìƒ‰ (ì˜ˆ: ë‹¨ê°, ã„·ã„±)" autocomplete="off" />
        </div>
        <div class="soldList" id="soldList"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===============================
   âœ… ì„¤ì •(ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë)
================================= */
const ADMIN_PASS = "1234";   // âœ… ê´€ë¦¬ì ë¹„ë²ˆ
const CLOSE_HOUR = 3;        // âœ… ë§ˆê°ì‹œê°„(0~23). ì˜ˆ: ìƒˆë²½3ì‹œ ë§ˆê°ì´ë©´ 3
// CLOSE_HOURê°€ 0ì´ë©´ "ìì • ë§ˆê°"ì²˜ëŸ¼ ë™ì‘

/* ===============================
   ì €ì¥ í‚¤
================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";
const LS_SALES = "umgane_sales_v2";     // âœ… ë¡œê·¸ ì—…ê·¸ë ˆì´ë“œ(v2: itemId ê¸°ë°˜)
const LS_SOLDOUT = "umgane_soldout_v1"; // âœ… í’ˆì ˆ ê¸°ë¡

/* ===============================
   âœ… êµ¬ê¸€ì‹œíŠ¸(CSV) â†’ ìƒí’ˆë§ˆìŠ¤í„° ë™ê¸°í™”
================================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZMLZiCqXn-YKsOwR_RR1nZudB1VqAKI652Aje2p3Ytjqfzx5YhcLtEHyuiCSFKPqZ8e1xvbF3JCU4/pub?output=csv";
const LS_LASTSYNC = "umgane_items_lastSync_v1";

/* âœ… CSV íŒŒì„œ */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      pushCell();
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    } else {
      cur += ch;
    }
  }
  if (cur.length > 0 || row.length > 0) { pushCell(); pushRow(); }
  return rows.filter(r => r.some(c => (c || "").trim() !== ""));
}

function toNumber(v) {
  const s = String(v ?? "").replace(/[^\d.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v, def=0){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : def;
}
function normalizeActive(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "1" || s === "true" || s === "y" || s === "yes" || s === "on") ? 1 : 0;
}
function nowISO(){ return new Date().toISOString(); }

function saveItemsToLS(items){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_LASTSYNC, nowISO());
}
function loadItemsFromLS(){
  try {
    const raw = localStorage.getItem(LS_ITEMS);
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}
function isSameDay(isoA, isoB){
  try{
    const a = new Date(isoA), b = new Date(isoB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }catch{ return false; }
}

async function syncItemsFromSheet({force=false} = {}) {
  const last = localStorage.getItem(LS_LASTSYNC);
  if (!force && last && isSameDay(last, nowISO())) {
    return { ok:true, skipped:true, count: (loadItemsFromLS()||[]).length };
  }

  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);

  const csv = await res.text();
  const rows = parseCSV(csv);

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  if (iId < 0 || iCat < 0 || iName < 0 || iPrice < 0) {
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ ë¶€ì¡±í•¨: id/cat/name/price í•„ìˆ˜");
  }

  const items = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r];
    const id = String(row[iId] ?? "").trim();

    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,"");
    if (cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ"; // ì¹´í…Œê³ ë¦¬ í†µì¼

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if (!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    items.push({ id, cat, name, price, active, ord });
  }

  if (items.length < 3) throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ(ì €ì¥ ì¤‘ë‹¨)");
  saveItemsToLS(items);
  try { renderAll(); } catch {}
  return { ok:true, skipped:false, count: items.length };
}
window.umganeSyncFromSheet = syncItemsFromSheet;

(async () => {
  try { await syncItemsFromSheet({ force:false }); }
  catch (e) { console.warn("[SHEET SYNC FAIL]", e?.message || e); }
})();

/* ===============================
   ì¹´í…Œê³ ë¦¬ / ì´ˆì„±
================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

/* ===============================
   ë¡œë“œ/ì„¸ì´ë¸Œ
================================= */
function loadRaw(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function normalizeCart(v){
  if (!v) return {};
  if (Array.isArray(v)){
    const out = {};
    v.forEach(x=>{
      if(!x) return;
      const id = String(x.id ?? x.name ?? "");
      if(!id) return;
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    });
    return out;
  }
  if (typeof v === "object"){
    const out = {};
    for(const k of Object.keys(v)){
      const x = v[k];
      if(!x || Array.isArray(x)) continue;
      const id = String(x.id ?? k);
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    }
    return out;
  }
  return {};
}
function normalizePins(v){
  if (!v) return {};
  if (typeof v === "object" && !Array.isArray(v)) return v;
  return {};
}

function seedItemsIfEmpty(){
  const existing = loadRaw(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* ===============================
   ìƒíƒœ
================================= */
let items = loadRaw(LS_ITEMS, []);
let pins  = normalizePins(loadRaw(LS_PINS, {}));
let cart  = normalizeCart(loadRaw(LS_CART, {}));
let paid  = loadRaw(LS_PAID, 0);
let misu  = loadRaw(LS_MISU, []);
let sales = loadRaw(LS_SALES, []);
let soldout = loadRaw(LS_SOLDOUT, {}); // {id: isoString}
let activeCat = "ì „ì²´";
let query = "";

/* ê´€ë¦¬ì í•„í„° */
let adminCat = "ì „ì²´";

/* ===============================
   ì—˜ë¦¬ë¨¼íŠ¸
================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elAdminPill = document.getElementById("adminPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");

const syncBtn = document.getElementById("syncBtn");
const syncInfo = document.getElementById("syncInfo");

/* ê´€ë¦¬ì ë³´ë“œ */
const elTodayTabs = document.getElementById("todayTabs");
const elCatFilters = document.getElementById("catFilters");
const elKpiCnt = document.getElementById("kpiCnt");
const elKpiAov = document.getElementById("kpiAov");
const elKpiPeak = document.getElementById("kpiPeak");
const elKpiCntSub = document.getElementById("kpiCntSub");
const elKpiAovSub = document.getElementById("kpiAovSub");
const elKpiPeakSub = document.getElementById("kpiPeakSub");
const elBestList = document.getElementById("bestList");
const elWorstList = document.getElementById("worstList");
const elSalesStrip = document.getElementById("salesStrip");

const elSoldQ = document.getElementById("soldQ");
const elSoldList = document.getElementById("soldList");

/* ===============================
   ìœ í‹¸
================================= */
function won(n){ const x = Math.round(Number(n)||0); return x.toLocaleString("ko-KR") + "ì›"; }
function todayKey(d=new Date()){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function isTodayISO(iso){
  try{ return todayKey(new Date(iso)) === todayKey(new Date()); }catch{ return false; }
}
function hourOf(iso){
  try{ return new Date(iso).getHours(); }catch{ return 0; }
}
function fmtTime(iso){
  const d = new Date(iso);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

/* âœ… ì˜ì—…ì‹œê°„ ê¸°ì¤€ ì‹œê°„(ë§ˆê° ì´í›„ëŠ” ë‹¤ìŒë‚  ìƒˆë²½ë„ ê°™ì€ í•˜ë£¨ë¡œ ë¬¶ê¸°) */
function bizHour(iso){
  const d = new Date(iso);
  let h = d.getHours();
  // 0~(CLOSE_HOUR-1) ëŠ” "ì „ë‚ ì˜ ì—°ì¥ ì˜ì—…"ìœ¼ë¡œ ë³´ê³  +24 ë¶™ì„
  if (CLOSE_HOUR > 0 && h >= 0 && h < CLOSE_HOUR) h += 24;
  return h;
}

/* ===============================
   ì •ë ¬/í•„í„°
================================= */
function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){ (pins[it.id] ? pinned : normal).push(it); }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd); normal.sort(byOrd);
  return [...pinned, ...normal];
}

function matchItem(it, q){
  if(!q) return true;
  const name = normalize(it.name);
  const qn = normalize(q);
  if(name.includes(qn)) return true;

  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;
  return false;
}

/* âœ… ê²€ìƒ‰/ì´ˆì„±ì€ ì „ì¹´í…Œê³ ë¦¬ */
function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);

  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* ===============================
   ê³ ì • / í’ˆì ˆ
================================= */
function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}
function isSoldout(id){
  return !!soldout?.[id];
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ
================================= */
function persistCart(){
  cart = normalizeCart(cart);
  save(LS_CART, cart);
}
function addToCart(it){
  if(Number(it.active)!==1) return;
  if(isSoldout(it.id)) return;

  const id = it.id;
  if(!cart[id]){
    cart[id] = {id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[id].qty += 1;
  }
  persistCart();
  renderAll();
}
function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  persistCart();
  renderAll();
}
function removeCart(id){
  delete cart[id];
  persistCart();
  renderAll();
}
function resetCartAll(){
  const ok = confirm("ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆì„ ë¦¬ì…‹í• ê¹Œìš”?");
  if(!ok) return;
  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}
function cartEntries(){ return Object.values(normalizeCart(cart)); }
function cartCount(){ return cartEntries().reduce((a,x)=>a+(x.qty||0),0); }
function cartTotal(){ return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0); }

/* ì‚‘ */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* ===============================
   âœ… ê²°ì œ ë¡œê·¸(v2: itemId ê¸°ë°˜)
================================= */
function recordSaleFromCart(){
  const entries = cartEntries();
  const total = cartTotal();
  if(total<=0 || entries.length===0) return;

  const at = new Date().toISOString();
  const payload = {
    at,
    total,
    items: entries.map(x=>({
      id: x.id,          // âœ… í•µì‹¬: idë¡œ ê¸°ë¡
      name: x.name,      // ì°¸ê³ ìš©(ë‚˜ì¤‘ì— ì´ë¦„ ë°”ë€Œì–´ë„ idë¡œ ì§‘ê³„)
      qty: Number(x.qty||0),
      price: Number(x.price||0)
    })),
  };
  sales = loadRaw(LS_SALES, sales) || [];
  sales.push(payload);
  save(LS_SALES, sales);
}

/* ===============================
   ê²°ì œì™„ë£Œ
================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  recordSaleFromCart();
  beep();

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}

function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* ===============================
   ë¯¸ìˆ˜ ì €ì¥(ë©”ì¸ ë²„íŠ¼ ìœ ì§€)
================================= */
function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (loadRaw(LS_MISU, misu).length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu = loadRaw(LS_MISU, misu);
  misu.unshift({ id, at: now.toISOString(), items: names, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
}

/* ===============================
   íƒ­/í‚¤íŒ¨ë“œ
================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{ activeCat = cat; renderAll(); };
    elTabs.appendChild(b);
  });
}
function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });

  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* ===============================
   ìƒí’ˆ ì¹´ë“œ ë Œë”
================================= */
let pressTimer=null;
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const so = isSoldout(it.id);

    const card = document.createElement("div");
    card.className = "card" + (so ? " soldoutCard" : "") + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "ê³ ì •";
    pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

    card.onclick = ()=>addToCart(it);
    card.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(it.id); return false; };

    // (ì•„ì´íŒ¨ë“œ ìŠ¤ì¹˜ë©´ í•€ í‘œì‹œ/1.2ì´ˆ í™•ì •ì€ í…ŒìŠ¤íŠ¸ í›„ ì¶”ê°€)
    card.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 450);
    }, {passive:true});
    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    if(so){
      const b = document.createElement("div");
      b.className = "badge soldout";
      b.textContent = "í’ˆì ˆ";
      card.appendChild(b);
    }

    elGrid.appendChild(card);
  });
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ ë Œë”
================================= */
function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">â€”</div>`;
    return;
  }

  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);
}

/* ===============================
   âœ… ê´€ë¦¬ì ë³´ë“œ(êµ¬ê°„ íƒ­)
   - 6~ë§ˆê° : 18~(24 + CLOSE_HOUR)
================================= */
const TODAY_TABS = [
  {key:"~12",  label:"~12",  from:0,  to:12},
  {key:"12~2", label:"12~2", from:12, to:14},
  {key:"2~4",  label:"2~4",  from:14, to:16},
  {key:"4~6",  label:"4~6",  from:16, to:18},
  {key:"6~",   label:"6~ë§ˆê°", from:18, to:24 + (CLOSE_HOUR>0 ? CLOSE_HOUR : 0)},
  {key:"ì „ì²´", label:"ì „ì²´",  from:0,  to:24 + (CLOSE_HOUR>0 ? CLOSE_HOUR : 0)},
];
let todayTabKey = "ì „ì²´";

function renderTodayTabs(){
  elTodayTabs.innerHTML = "";
  TODAY_TABS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "todayTab" + (t.key===todayTabKey ? " active":"");
    b.textContent = t.label;
    b.onclick = ()=>{
      todayTabKey = t.key;
      renderAdminBoard();
    };
    elTodayTabs.appendChild(b);
  });
}

/* ì¹´í…Œê³ ë¦¬ í•„í„°(ê´€ë¦¬ì) */
function renderAdminCatFilters(){
  elCatFilters.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "btn2" + (adminCat===cat ? " accent":"");
    b.textContent = cat;
    b.onclick = ()=>{
      adminCat = cat;
      renderAdminBoard();
    };
    elCatFilters.appendChild(b);
  });
}

/* ì˜¤ëŠ˜ ë§¤ì¶œ ë¡œê·¸ í•„í„° */
function filterSalesTodayByTab(tabKey){
  sales = loadRaw(LS_SALES, sales) || [];
  const t = TODAY_TABS.find(x=>x.key===tabKey) || TODAY_TABS[TODAY_TABS.length-1];
  const fromH = t.from, toH = t.to;

  const list = sales.filter(s=>{
    if(!s || !s.at) return false;
    if(!isTodayISO(s.at)) return false;
    const h = bizHour(s.at);
    return (h >= fromH && h < toH);
  });
  return list;
}

/* í”¼í¬ êµ¬ê°„(ì˜¤ëŠ˜ ì „ì²´ ê¸°ì¤€) */
function calcPeakSegment(allToday){
  const buckets = new Map(TODAY_TABS.filter(t=>t.key!=="ì „ì²´").map(t=>[t.key,0]));
  allToday.forEach(s=>{
    const h = bizHour(s.at);
    for(const t of TODAY_TABS){
      if(t.key==="ì „ì²´") continue;
      if(h >= t.from && h < t.to){
        buckets.set(t.key, (buckets.get(t.key)||0) + 1);
        break;
      }
    }
  });
  let bestKey="-", bestCnt=0, total=allToday.length||0;
  for(const [k,v] of buckets.entries()){
    if(v > bestCnt){ bestCnt=v; bestKey=k; }
  }
  const share = total ? Math.round((bestCnt/total)*100) : 0;
  return { bestKey, bestCnt, share, total };
}

/* âœ… ë‚˜ê°„ìˆ˜ëŸ‰: id ê¸°ì¤€ìœ¼ë¡œ ë§µ ë§Œë“¤ê¸° */
function buildQtyMapById(salesList){
  const map = new Map(); // id -> qty
  for(const s of salesList){
    for(const it of (s.items||[])){
      const id = String(it.id||"").trim();
      if(!id) continue;
      const q = Number(it.qty||0);
      map.set(id, (map.get(id)||0) + q);
    }
  }
  return map;
}

function itemById(id){
  return items.find(x=>x.id===id);
}
function itemNameById(id){
  const it = itemById(id);
  return it ? it.name : (id || "-");
}

/* ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸ */
function renderBWList(container, rows, type){
  container.innerHTML = "";
  if(!rows.length){
    container.innerHTML = `<div class="muted" style="padding:10px 8px;">ë°ì´í„° ì—†ìŒ</div>`;
    return;
  }
  rows.forEach((r, idx)=>{
    const div = document.createElement("div");
    div.className = "bwRow";
    const nm = document.createElement("div");
    nm.className = "bwName";
    nm.textContent = `${idx+1}. ${r.name}`;

    const val = document.createElement("div");
    val.className = "bwVal " + (type==="best" ? "good":"bad");
    val.textContent = `${r.qty}ê°œ`;

    div.appendChild(nm);
    div.appendChild(val);
    container.appendChild(div);
  });
}

/* ===============================
   âœ… í’ˆì ˆ ê´€ë¦¬(ê´€ë¦¬ì)
================================= */
function soldoutSet(id){
  soldout = loadRaw(LS_SOLDOUT, soldout) || {};
  soldout[id] = new Date().toISOString();
  save(LS_SOLDOUT, soldout);
  renderAll();
  renderSoldoutList();
}
function soldoutUnset(id){
  soldout = loadRaw(LS_SOLDOUT, soldout) || {};
  delete soldout[id];
  save(LS_SOLDOUT, soldout);
  renderAll();
  renderSoldoutList();
}
function renderSoldoutList(){
  soldout = loadRaw(LS_SOLDOUT, soldout) || {};
  const q = (elSoldQ.value||"").trim();
  const qn = normalize(q);
  const qCho = qn.replace(/\s+/g,"");

  // í™œì„±ìƒí’ˆ ì „ì²´(í’ˆì ˆ/ë¹„í’ˆì ˆ)ì—ì„œ ê²€ìƒ‰ í›„ í‘œì‹œ
  let list = items.filter(it=>Number(it.active)===1);

  if(q){
    list = list.filter(it=>{
      if(matchItem(it, q)) return true;
      return false;
    });
  }

  // ê´€ë¦¬ì ì¹´í…Œê³ ë¦¬ í•„í„°ë„ í’ˆì ˆ ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜(ì›í•˜ë©´ ì œê±° ê°€ëŠ¥)
  if(adminCat !== "ì „ì²´"){
    list = list.filter(it=>it.cat===adminCat);
  }

  // í’ˆì ˆ ë¨¼ì € ìƒë‹¨
  list.sort((a,b)=>{
    const as = isSoldout(a.id) ? 0 : 1;
    const bs = isSoldout(b.id) ? 0 : 1;
    if(as!==bs) return as-bs;
    return (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  });

  elSoldList.innerHTML = "";
  if(!list.length){
    elSoldList.innerHTML = `<div class="muted" style="padding:8px 2px;">ì—†ìŒ</div>`;
    return;
  }

  list.slice(0,60).forEach(it=>{
    const soTime = soldout[it.id];
    const row = document.createElement("div");
    row.className = "soldRow";

    const left = document.createElement("div");
    left.style.minWidth = "0";
    left.innerHTML = `
      <div class="soldName">${it.name}</div>
      <div class="soldMeta">${soTime ? ("í’ˆì ˆì‹œê°„: " + fmtTime(soTime)) : "ì •ìƒíŒë§¤"}</div>
    `;

    const btn = document.createElement("button");
    if(soTime){
      btn.className = "soldBtn undo";
      btn.textContent = "í’ˆì ˆí•´ì œ";
      btn.onclick = ()=>soldoutUnset(it.id);
    }else{
      btn.className = "soldBtn";
      btn.textContent = "í’ˆì ˆ";
      btn.onclick = ()=>soldoutSet(it.id);
    }

    row.appendChild(left);
    row.appendChild(btn);
    elSoldList.appendChild(row);
  });
}

/* ===============================
   âœ… ê´€ë¦¬ì ë³´ë“œ ë Œë”
================================= */
function renderAdminBoard(){
  const allToday = filterSalesTodayByTab("ì „ì²´");
  const segToday = filterSalesTodayByTab(todayTabKey);

  // KPI(êµ¬ê°„ ê¸°ì¤€)
  const cnt = segToday.length;
  const total = segToday.reduce((a,s)=>a+Number(s.total||0),0);
  const aov = cnt ? Math.round(total/cnt) : 0;

  elKpiCnt.textContent = String(cnt);
  elKpiAov.textContent = won(aov);

  elKpiCntSub.textContent = (todayTabKey==="ì „ì²´") ? "ì˜¤ëŠ˜ ëˆ„ì " : `${todayTabKey} êµ¬ê°„`;
  elKpiAovSub.textContent = (todayTabKey==="ì „ì²´") ? "ì˜¤ëŠ˜ ëˆ„ì " : `${todayTabKey} êµ¬ê°„`;

  // í”¼í¬ëŠ” ì˜¤ëŠ˜ ì „ì²´ ê¸°ì¤€
  const peak = calcPeakSegment(allToday);
  elKpiPeak.textContent = peak.bestKey==="-" ? "-" : `${peak.bestKey==="6~" ? "6~ë§ˆê°" : peak.bestKey}`;
  elKpiPeakSub.textContent = peak.total ? `ê²°ì œ ${peak.bestCnt}ê±´ Â· ${peak.share}%` : "-";

  // ì´ë§¤ì¶œ ìŠ¤íŠ¸ë¦½(êµ¬ê°„)
  elSalesStrip.textContent = `ì´ë§¤ì¶œ: ${won(total)}`;

  // âœ… ë² ìŠ¤íŠ¸/ì›ŒìŠ¤íŠ¸ 15: id ê¸°ì¤€ + ì¹´í…Œê³ ë¦¬ í•„í„°
  const qtyMap = buildQtyMapById(segToday);

  let activeList = items.filter(it=>Number(it.active)===1);
  if(adminCat !== "ì „ì²´"){
    activeList = activeList.filter(it=>it.cat===adminCat);
  }

  // ëª¨ë“  í™œì„±ìƒí’ˆ idì— ëŒ€í•´ qty ì±„ì›€(ì—†ìœ¼ë©´ 0)
  const allRows = activeList.map(it=>({ id: it.id, name: it.name, qty: qtyMap.get(it.id)||0 }));

  const best = [...allRows].sort((a,b)=>b.qty-a.qty || a.name.localeCompare(b.name,"ko")).slice(0,15);
  const worst = [...allRows].sort((a,b)=>a.qty-b.qty || a.name.localeCompare(b.name,"ko")).slice(0,15);

  renderBWList(elBestList, best, "best");
  renderBWList(elWorstList, worst, "worst");

  // í’ˆì ˆ ë¦¬ìŠ¤íŠ¸
  renderSoldoutList();
}

/* ===============================
   ëª¨ë‹¬(ê´€ë¦¬ì)
================================= */
function openModal(){
  elModalBack.style.display = "flex";
}
function closeModal(){
  elModalBack.style.display = "none";
}
function checkAdminPassEveryTime(){
  const p = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
  if(p === null) return false;
  if(String(p) !== String(ADMIN_PASS)){
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    return false;
  }
  return true;
}
function openAdminWithPassword(){
  if(!checkAdminPassEveryTime()) return;
  openModal();
  renderTodayTabs();
  renderAdminCatFilters();
  renderAdminBoard();
}

/* ===============================
   ë Œë” ì „ì²´
================================= */
function renderAll(){
  seedItemsIfEmpty();

  items = loadRaw(LS_ITEMS, items);
  pins  = normalizePins(loadRaw(LS_PINS, pins));
  cart  = normalizeCart(loadRaw(LS_CART, cart));
  paid  = loadRaw(LS_PAID, paid);
  misu  = loadRaw(LS_MISU, misu);
  sales = loadRaw(LS_SALES, sales);
  soldout = loadRaw(LS_SOLDOUT, soldout) || {};

  save(LS_CART, cart);
  save(LS_PINS, pins);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();

  // ëª¨ë‹¬ ì—´ë ¤ìˆìœ¼ë©´ ê´€ë¦¬ì ë³´ë“œë„ ê°±ì‹ 
  if(elModalBack.style.display === "flex"){
    renderAdminBoard();
  }
}

/* ===============================
   ì´ë²¤íŠ¸
================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  renderAll();
});
document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});
elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});
elPayBtn.addEventListener("click", doPay);
elSaveMisu.addEventListener("click", saveMisuNow);

elCartPill.addEventListener("click", resetCartAll);
elAdminPill.addEventListener("click", openAdminWithPassword);

elMClose.addEventListener("click", closeModal);
elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeModal();
});

elSoldQ.addEventListener("input", renderSoldoutList);

/* ===============================
   ë™ê¸°í™” UI
================================= */
const LS_LASTSYNC_UI = "umgane_lastSync_ui_v1";
let syncing = false;
let lastSyncTryAt = 0;

function fmtKST(ts){
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function todayKST(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setSyncInfo(){
  const t = Number(localStorage.getItem(LS_LASTSYNC_UI) || 0);
  syncInfo.textContent = t
    ? `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: ${fmtKST(t)}`
    : `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -`;
}

async function runSync({force=true, silent=false} = {}){
  if (syncing) return;

  const now = Date.now();
  if (now - lastSyncTryAt < 10_000) {
    if(!silent) alert("âš ï¸ ì ê¹ë§Œìš”. 10ì´ˆ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  lastSyncTryAt = now;

  syncing = true;
  syncBtn.disabled = true;
  syncBtn.textContent = "â³ ë™ê¸°í™”ì¤‘...";

  try{
    await umganeSyncFromSheet({ force });
    localStorage.setItem(LS_LASTSYNC_UI, String(Date.now()));
    setSyncInfo();
    if(!silent) alert("âœ… ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
  }catch(e){
    if(!silent) alert("âŒ ë™ê¸°í™” ì‹¤íŒ¨ (ì¸í„°ë„·/ì‹œíŠ¸ í™•ì¸)");
  }finally{
    syncing = false;
    syncBtn.disabled = false;
    syncBtn.textContent = "ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨";
  }
}

syncBtn.addEventListener("click", ()=> runSync({force:true, silent:false}));

setSyncInfo();
renderAll();
</script>
</body>
</html>
