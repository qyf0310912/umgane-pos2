<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
:root{
  --bg:#0b0c10;
  --panel:#111319;
  --panel2:#0f1116;
  --line:rgba(255,255,255,.08);
  --text:#f5f7ff;
  --muted:rgba(245,247,255,.62);
  --accent:#ff9f00;
  --good:#29d17e;
  --bad:#ff3b30;
  --shadow:0 12px 40px rgba(0,0,0,.35);
  --r:18px;
  --r2:14px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
}

/* base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--ui);
}
button,input{font-family:inherit}
button{cursor:pointer;border:0;border-radius:12px}
a{color:inherit}

/* layout */
.app{
  height:100%;
  padding:12px;
  display:grid;
  grid-template-columns: 1.35fr 0.85fr; /* íƒœë¸”ë¦¿ ê°€ë¡œ ê¸°ì¤€ */
  gap:12px;
}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius:22px;
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.panel-inner{padding:12px; min-height:0; display:flex; flex-direction:column; gap:10px}

/* header row */
.topbar{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.tabs{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.tab{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  padding:8px 12px;
  border-radius:999px;
  font-weight:700;
  font-size:13px;
  letter-spacing:-.2px;
}
.tab.active{
  outline:2px solid rgba(255,159,0,.25);
  border-color: rgba(255,159,0,.6);
  color: #ffe8c2;
}
.right-tools{margin-left:auto; display:flex; gap:8px; align-items:center}
.pill{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  padding:8px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:13px;
}
.pill.accent{ border-color: rgba(255,159,0,.55); color:#ffe8c2; }
.pill.red{ border-color: rgba(255,59,48,.55); color:#ffd7d5; background:rgba(255,59,48,.08); }

/* search */
.searchrow{
  display:flex; gap:10px; align-items:center;
}
.search{
  flex:1;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  background:rgba(0,0,0,.18);
  border:1px solid var(--line);
  border-radius:14px;
}
.search .icon{opacity:.75}
.search input{
  width:100%;
  border:0;
  outline:none;
  background:transparent;
  color:var(--text);
  font-size:14px;
}
.sortbtn{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
  font-size:13px;
}

/* chosung keyboard */
.kb-wrap{
  display:flex;
  align-items:center;
  gap:10px;
}
.kb{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.k{
  min-width:36px;
  height:30px;
  padding:0 10px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  border-radius:10px;
  font-weight:900;
  font-size:13px;
}
.k.clear{
  background:rgba(255,59,48,.12);
  border-color:rgba(255,59,48,.35);
  color:#ffd7d5;
}
.k.help{
  opacity:.65;
}
.hintline{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}
.hintline b{color:#fff}

/* pinned area + product list */
.subline{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  color:var(--muted);
  font-size:12px;
}
.scroll{
  overflow:auto;
  min-height:0;
  padding-right:6px;
}
.grid{
  display:grid;
  gap:10px;
  grid-template-columns: repeat(4, minmax(0,1fr)); /* ê¸°ë³¸ 4ì—´ */
}
@media (min-width: 1240px){
  .grid{ grid-template-columns: repeat(5, minmax(0,1fr)); } /* ë„“ìœ¼ë©´ 5ì—´ */
}

/* product card */
.card{
  position:relative;
  padding:12px 12px 10px;
  border-radius:18px;
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  min-height:88px;
  display:flex;
  flex-direction:column;
  gap:6px;
  user-select:none;
}
.card.inactive{
  opacity:.35;
  filter:saturate(.5);
}
.card .name{
  font-weight:900;
  font-size:18px;
  letter-spacing:-.4px;
  line-height:1.05;
}
.card .price{
  font-weight:800;
  font-size:13px;
  color:rgba(245,247,255,.78);
}
.pinbtn{
  position:absolute;
  right:10px;
  bottom:10px;
  width:32px;
  height:28px;
  border-radius:10px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
}
.pinbtn.off{opacity:.22}
.pinbtn.on{background:rgba(255,159,0,.10); border-color:rgba(255,159,0,.35)}
/* ì¹´ë“œ í´ë¦­ì€ ìƒí’ˆë‹´ê¸°ë§Œ, hover ê°•í•œ íš¨ê³¼ X */
.card:hover{border-color:rgba(255,255,255,.12)}
.card:active{transform:translateY(0.5px)}

/* right panel (cart/pay) */
.cartTop{
  display:flex; align-items:center; gap:8px;
}
.cartTop .pill{margin-left:0}
.cartTop .spacer{margin-left:auto}
.resetBtn{
  background:rgba(255,59,48,.12);
  border:1px solid rgba(255,59,48,.35);
  color:#ffd7d5;
  padding:8px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
}
.cartList{
  overflow:auto;
  min-height:0;
  padding-right:6px;
}
.cartRow{
  display:grid;
  grid-template-columns: 1fr 110px 34px 34px 34px; /* ì´ë¦„ | ê¸ˆì•¡ | - | ìˆ˜ëŸ‰ | + | x(ì‚­ì œëŠ” ë³„ë„ë²„íŠ¼ìœ¼ë¡œ) */
  align-items:center;
  gap:8px;
  padding:10px 10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  margin-bottom:8px;

  /* âœ… â€œí´ë¦­ë˜ëŠ” ëŠë‚Œâ€ ì œê±° */
  cursor:default;
}
.cartRow *{pointer-events:auto}
.cartRow:hover{border-color:rgba(255,255,255,.10)} /* ì•„ì£¼ ì•½í•˜ê²Œë§Œ */
.cartRow .cname{
  font-weight:900;
  font-size:15px;
  letter-spacing:-.3px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  min-width:0;
}
.cartRow .cprice{
  font-family:var(--mono);
  font-weight:800;
  font-size:13px;
  color:rgba(245,247,255,.82);
  text-align:right;
}
.qbtn{
  height:30px;
  border-radius:10px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  font-weight:900;
}
.qnum{
  text-align:center;
  font-weight:900;
  font-size:14px;
  color:rgba(245,247,255,.92);
}
.delbtn{
  height:30px;
  border-radius:10px;
  background:rgba(255,59,48,.12);
  border:1px solid rgba(255,59,48,.35);
  color:#ffd7d5;
  font-weight:900;
}

/* totals */
.totals{
  margin-top:auto;
  border-top:1px solid var(--line);
  padding-top:10px;
}
.totalLabel{
  color:var(--muted);
  font-size:12px;
  font-weight:800;
}
.totalAmt{
  font-size:40px;
  font-weight:950;
  letter-spacing:-1px;
  margin:2px 0 10px;
}
.rcRow{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:end;
  gap:10px;
}
.rcBox .lbl{
  color:var(--muted);
  font-size:12px;
  font-weight:900;
}
.rcBox .amt{
  font-size:24px;
  font-weight:950;
  margin-top:2px;
}
.rcSep{
  color:rgba(245,247,255,.35);
  font-weight:900;
  font-size:18px;
  padding:0 2px;
}

/* cash buttons */
.cashPad{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:8px;
}
.cashBtn{
  height:42px;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  font-weight:950;
}
.cashBtn.reset{
  background:rgba(255,59,48,.12);
  border-color:rgba(255,59,48,.35);
  color:#ffd7d5;
}

/* bottom action */
.actions{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1fr 2fr;
  gap:10px;
  align-items:stretch;
}
.misuBtn{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  border-radius:16px;
  padding:10px 10px;
  font-weight:950;
  display:flex;
  flex-direction:column;
  gap:4px;
  justify-content:center;
  align-items:flex-start;
}
.misuBtn small{color:var(--muted); font-weight:800}
.payBtn{
  background:var(--accent);
  border-radius:18px;
  font-weight:1000;
  font-size:26px;
  letter-spacing:-.6px;
  color:#1b1200;
  box-shadow:0 18px 40px rgba(255,159,0,.22);
}
.payBtn:active{transform:translateY(1px)}
/* remove "(ì¼ë°˜ê²°ì œ)" */
.paySub{display:none}

/* modal */
.modalMask{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center; justify-content:center;
  padding:16px;
  z-index:50;
}
.modal{
  width:min(820px, 100%);
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:22px;
  box-shadow: var(--shadow);
  overflow:hidden;
}
.modalHead{
  padding:12px 14px;
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--line);
}
.modalHead .title{font-weight:1000}
.modalBody{padding:14px}
.misuItem{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
  margin-bottom:10px;
  display:flex;
  gap:12px;
  align-items:center;
}
.misuLeft{min-width:0; flex:1}
.misuTopLine{
  display:flex; gap:10px; align-items:baseline;
  font-weight:950;
}
.misuTopLine .t{color:var(--muted); font-weight:900; font-size:12px}
.misuTopLine .amt{
  margin-left:auto;
  font-family:var(--mono);
  font-weight:950;
  font-size:13px;
  color:rgba(245,247,255,.88);
}
.misuSummary{
  margin-top:6px;
  color:rgba(245,247,255,.85);
  font-weight:900;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.misuBtns{display:flex; gap:8px}
.btn{
  height:36px;
  padding:0 12px;
  border-radius:12px;
  font-weight:950;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
}
.btn.danger{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.35); color:#ffd7d5}
.btn.ok{background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.35); color:#c8ffe4}

/* simple scrollbar */
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08); border-radius:999px}
::-webkit-scrollbar-track{background:transparent}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT: products -->
  <section class="panel">
    <div class="panel-inner">

      <div class="topbar">
        <div class="tabs" id="tabs"></div>
        <div class="right-tools">
          <div class="pill" id="pinInfo">ê³ ì •: 0</div>
        </div>
      </div>

      <div class="searchrow">
        <div class="search">
          <div class="icon">ğŸ”</div>
          <input id="searchInput" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã……ã„±)" autocomplete="off" />
        </div>
        <button class="sortbtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
      </div>

      <div class="kb-wrap">
        <div class="kb" id="kb"></div>
        <div class="hintline" id="hintline">
          <span>ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ <b>ì „í’ˆëª©</b> / ì´ˆì„±(ã„±ã„´ã„·â€¦) ê°€ëŠ¥</span>
        </div>
      </div>

      <div class="subline">
        <div>ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
        <div>ê³ ì •ì€ â€œê¸¸ê²Œ ëˆŒëŸ¬â€ í† ê¸€</div>
      </div>

      <div class="scroll" id="productScroll">
        <div class="grid" id="grid"></div>
      </div>

    </div>
  </section>

  <!-- RIGHT: cart/pay -->
  <section class="panel">
    <div class="panel-inner" style="gap:10px">

      <div class="cartTop">
        <div class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</div>
        <div class="spacer"></div>
        <button class="resetBtn" id="cartResetBtn">ë¦¬ì…‹</button>
      </div>

      <div class="cartList" id="cartList"></div>

      <div class="totals">
        <div class="totalLabel" id="totalLabel">ì´í•©ê³„(0ê°œ)</div>
        <div class="totalAmt" id="totalAmt">0ì›</div>

        <!-- ë°›ì€ëˆ | ê±°ìŠ¤ë¦„ëˆ (ì™¼ìª½ì •ë ¬ ëŠë‚Œ) -->
        <div class="rcRow">
          <div class="rcBox">
            <div class="lbl">ë°›ì€ëˆ</div>
            <div class="amt" id="receivedAmt">0ì›</div>
          </div>
          <div class="rcSep">|</div>
          <div class="rcBox" style="text-align:left">
            <div class="lbl">ê±°ìŠ¤ë¦„ëˆ</div>
            <div class="amt" id="changeAmt">0ì›</div>
          </div>
        </div>

        <div class="cashPad">
          <button class="cashBtn" data-add="500">500</button>
          <button class="cashBtn" data-add="1000">1ì²œ</button>
          <button class="cashBtn" data-add="5000">5ì²œ</button>
          <button class="cashBtn" data-add="10000">1ë§Œ</button>
          <button class="cashBtn" data-add="50000">5ë§Œ</button>
          <button class="cashBtn reset" id="receivedResetBtn">ì´ˆê¸°í™”</button>
        </div>

        <div class="actions">
          <button class="misuBtn" id="saveMisuBtn">
            ë¯¸ìˆ˜
            <small>í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</small>
          </button>
          <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
        </div>

      </div>

    </div>
  </section>

</div>

<!-- ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="modalHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="btn" id="closeModalBtn">ë‹«ê¸°</button>
    </div>
    <div class="modalBody" id="misuList"></div>
  </div>
</div>

<script>
/* =========================
   ë°ì´í„° / ì €ì¥í‚¤
========================= */
const LS_ITEMS = "umgane_items_v1";
const LS_PIN   = "umgane_pins_v1";
const LS_CART  = "umgane_cart_v1";
const LS_REC   = "umgane_received_v1";
const LS_MISU  = "umgane_misu_v1";
const LS_USAGE = "umgane_usage_v1";

const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/* ê¸°ë³¸ ìƒ˜í”Œ (ì—†ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´) */
const defaultItems = [
  {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
  {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
  {id:"S03", cat:"ê³¼ì¼", name:"ë‹¨ê°/7ê°œ", price:10000, active:1, ord:3},
  {id:"S04", cat:"ê³¼ì¼", name:"ì‚¬ê³¼/3ê°œ", price:5000, active:1, ord:4},
  {id:"S05", cat:"ê³¼ì¼", name:"ì‚¬ê³¼/7ê°œ", price:10000, active:1, ord:5},
  {id:"S06", cat:"ì•¼ì±„", name:"ë‹¹ê·¼", price:2500, active:1, ord:10},
  {id:"S07", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:11},
  {id:"S08", cat:"ë´‰ì§€ì±„ì†Œ", name:"ìƒëŸ¬ë¦¬", price:2000, active:1, ord:20},
  {id:"S09", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:30},
  {id:"S10", cat:"ê¸°íƒ€", name:"í‘œê³ ", price:5000, active:1, ord:40},
];

let state = {
  tab: "ì „ì²´",
  q: "",
  items: [],
  pins: new Set(),
  cart: [], // {id,name,price,qty}
  received: 0,
  misu: [], // {id, ts, items, total, summary}
  usage: {}, // id -> count
};

/* =========================
   ìœ í‹¸
========================= */
const fmt = n => (n||0).toLocaleString("ko-KR") + "ì›";
const nowHM = () => {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
};
const uid = () => Math.random().toString(36).slice(2,9);

/* âœ… ì´ˆì„± ë§¤ì¹­ (ã„±ã…ˆ, ã……ã„±, ã„·ã„± ë“± ì •í™•) */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function toChoseong(str){
  let out = "";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code >= 0xAC00 && code <= 0xD7A3){
      const idx = Math.floor((code - 0xAC00) / 588);
      out += CHO[idx] || "";
    }else{
      out += ch;
    }
  }
  return out;
}
function normalizeQ(q){
  return (q||"").replace(/\s+/g,"").trim();
}
function matchItem(name, q){
  q = normalizeQ(q);
  if(!q) return true;

  const n = normalizeQ(name);
  // 1) ì¼ë°˜ í¬í•¨ ê²€ìƒ‰
  if(n.includes(q)) return true;

  // 2) ì´ˆì„± í¬í•¨ ê²€ìƒ‰
  const c = toChoseong(n);
  if(c.includes(q)) return true;

  // 3) í˜¼í•© ì…ë ¥(ã„±ã…ˆ + ê¸€ì) ëŒ€ë¹„: që¥¼ ì´ˆì„±ìœ¼ë¡œë„ ë³€í™˜í•´ì„œ í•œë²ˆ ë”
  const qc = toChoseong(q);
  if(qc !== q && c.includes(qc)) return true;

  return false;
}

/* beep */
function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}

/* =========================
   ì €ì¥/ë¡œë“œ
========================= */
function loadAll(){
  const items = JSON.parse(localStorage.getItem(LS_ITEMS) || "null");
  state.items = Array.isArray(items) && items.length ? items : defaultItems;

  const pins = JSON.parse(localStorage.getItem(LS_PIN) || "[]");
  state.pins = new Set(Array.isArray(pins) ? pins : []);

  const cart = JSON.parse(localStorage.getItem(LS_CART) || "[]");
  state.cart = Array.isArray(cart) ? cart : [];

  const rec = Number(localStorage.getItem(LS_REC) || "0");
  state.received = isFinite(rec) ? rec : 0;

  const misu = JSON.parse(localStorage.getItem(LS_MISU) || "[]");
  state.misu = Array.isArray(misu) ? misu : [];

  const usage = JSON.parse(localStorage.getItem(LS_USAGE) || "{}");
  state.usage = usage && typeof usage === "object" ? usage : {};
}
function saveAll(){
  localStorage.setItem(LS_ITEMS, JSON.stringify(state.items));
  localStorage.setItem(LS_PIN, JSON.stringify([...state.pins]));
  localStorage.setItem(LS_CART, JSON.stringify(state.cart));
  localStorage.setItem(LS_REC, String(state.received||0));
  localStorage.setItem(LS_MISU, JSON.stringify(state.misu));
  localStorage.setItem(LS_USAGE, JSON.stringify(state.usage));
}

/* =========================
   ë Œë”
========================= */
const $tabs = document.getElementById("tabs");
const $grid = document.getElementById("grid");
const $pinInfo = document.getElementById("pinInfo");
const $searchInput = document.getElementById("searchInput");
const $kb = document.getElementById("kb");
const $cartList = document.getElementById("cartList");
const $totalLabel = document.getElementById("totalLabel");
const $totalAmt = document.getElementById("totalAmt");
const $receivedAmt = document.getElementById("receivedAmt");
const $changeAmt = document.getElementById("changeAmt");
const $misuPill = document.getElementById("misuPill");
const $modalMask = document.getElementById("modalMask");
const $misuList = document.getElementById("misuList");

function cartTotal(){
  return state.cart.reduce((s,it)=>s+(it.price*it.qty),0);
}
function cartCount(){
  return state.cart.reduce((s,it)=>s+it.qty,0);
}
function changeMoney(){
  return Math.max(0, (state.received||0) - cartTotal());
}

function renderTabs(){
  $tabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (state.tab===cat ? " active": "");
    b.textContent = cat;
    b.onclick = ()=>{ state.tab = cat; render(); };
    $tabs.appendChild(b);
  });
}

function getVisibleItems(){
  let arr = state.items.filter(it=>it.active!==0);

  // ì¹´í…Œê³ ë¦¬ í•„í„° (ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì ìš©)
  const q = normalizeQ(state.q);
  if(!q && state.tab !== "ì „ì²´"){
    arr = arr.filter(it=>it.cat === state.tab);
  }

  // ê²€ìƒ‰ì€ ì „í’ˆëª©(ì¹´í…Œê³ ë¦¬ ë¬´ê´€)
  if(q){
    arr = state.items.filter(it=>it.active!==0).filter(it=>matchItem(it.name, q));
  }

  // ì •ë ¬: ê³ ì • ë¨¼ì €, ë§ì´ ì°íŒ ìˆœ, ord
  arr.sort((a,b)=>{
    const pa = state.pins.has(a.id) ? 0 : 1;
    const pb = state.pins.has(b.id) ? 0 : 1;
    if(pa!==pb) return pa-pb;
    const ua = Number(state.usage[a.id]||0);
    const ub = Number(state.usage[b.id]||0);
    if(ua!==ub) return ub-ua;
    return (a.ord||0)-(b.ord||0);
  });

  return arr;
}

function renderGrid(){
  const items = getVisibleItems();
  $grid.innerHTML = "";

  const pinCount = [...state.pins].length;
  $pinInfo.textContent = "ê³ ì •: " + pinCount;

  items.forEach(it=>{
    const c = document.createElement("div");
    c.className = "card" + (it.active===0 ? " inactive":"");
    // ì¹´ë“œ ë‚´ìš© (ì¹´í…Œê³ ë¦¬ ë¼ë²¨ í‘œì‹œ âŒ)
    const name = document.createElement("div");
    name.className = "name";
    name.textContent = it.name;

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = fmt(it.price);

    const pin = document.createElement("button");
    const pinned = state.pins.has(it.id);
    pin.className = "pinbtn " + (pinned ? "on":"off");
    pin.textContent = "ğŸ“Œ";
    pin.title = pinned ? "ê³ ì • í•´ì œ" : "ê³ ì •";
    pin.onclick = (e)=>{
      e.stopPropagation();
      togglePin(it.id);
    };

    // ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •(ëª¨ë°”ì¼/íƒœë¸”ë¦¿)
    let pressTimer = null;
    c.addEventListener("pointerdown", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 420);
    });
    c.addEventListener("pointerup", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
    c.addEventListener("pointercancel", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });

    // ì§§ê²Œ í´ë¦­ = ë‹´ê¸°
    c.onclick = ()=>{
      addToCart(it.id);
    };

    c.appendChild(name);
    c.appendChild(price);
    c.appendChild(pin);
    $grid.appendChild(c);
  });
}

function renderCart(){
  $cartList.innerHTML = "";
  state.cart.forEach(row=>{
    const el = document.createElement("div");
    el.className = "cartRow";

    const n = document.createElement("div");
    n.className = "cname";
    n.textContent = row.name;

    const p = document.createElement("div");
    p.className = "cprice";
    p.textContent = (row.price*row.qty).toLocaleString("ko-KR")+"ì›";

    const minus = document.createElement("button");
    minus.className = "qbtn";
    minus.textContent = "âˆ’";
    minus.onclick = ()=>{ setQty(row.id, row.qty-1); };

    const q = document.createElement("div");
    q.className = "qnum";
    q.textContent = row.qty;

    const plus = document.createElement("button");
    plus.className = "qbtn";
    plus.textContent = "+";
    plus.onclick = ()=>{ setQty(row.id, row.qty+1); };

    const del = document.createElement("button");
    del.className = "delbtn";
    del.textContent = "Ã—";
    del.onclick = ()=>{ removeFromCart(row.id); };

    // âœ… í´ë¦­ë˜ëŠ” ëŠë‚Œ ì œê±°: í–‰ ìì²´ í´ë¦­ ì—†ìŒ
    el.onclick = (e)=>{ /* nothing */ };

    el.appendChild(n);
    el.appendChild(p);
    el.appendChild(minus);
    el.appendChild(q);
    el.appendChild(plus);
    // ì‚­ì œ ë²„íŠ¼ì€ ë§¨ ëì— ë†“ê³  ì‹¶ìœ¼ë©´ grid-columns ë³€ê²½í•˜ë©´ ë¨. ì§€ê¸ˆì€ + ë’¤ì— ë¶™ì—¬ë„ OK.
    el.appendChild(del);

    // grid-columnsê°€ 5ì¹¸ì´ë¼ delê¹Œì§€ ë„£ìœ¼ë©´ ë„˜ì¹¨ -> ì•„ë˜ì²˜ëŸ¼ ì¹¸ ëŠ˜ë ¤ì¤Œ
    el.style.gridTemplateColumns = "1fr 110px 34px 34px 34px 34px";

    $cartList.appendChild(el);
  });

  const total = cartTotal();
  const cnt = cartCount();
  $totalLabel.textContent = `ì´í•©ê³„(${cnt}ê°œ)`;
  $totalAmt.textContent = fmt(total);

  $receivedAmt.textContent = fmt(state.received||0);
  $changeAmt.textContent = fmt(changeMoney());

  $misuPill.textContent = `ë¯¸ìˆ˜(${state.misu.length})`;
}

function renderMisu(){
  $misuList.innerHTML = "";
  if(state.misu.length === 0){
    const empty = document.createElement("div");
    empty.style.color = "rgba(245,247,255,.75)";
    empty.style.fontWeight = "900";
    empty.textContent = "ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
    $misuList.appendChild(empty);
    return;
  }

  state.misu.forEach((m, idx)=>{
    const row = document.createElement("div");
    row.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuLeft";

    // âœ… â€œë¯¸ìˆ˜1 ì˜† ê¸ˆì•¡â€ (2~3ì¤„ ì¶•ì†Œ)
    const top = document.createElement("div");
    top.className = "misuTopLine";
    top.innerHTML = `<span>ë¯¸ìˆ˜ ${idx+1}</span><span class="t">(${m.ts})</span><span class="amt">${fmt(m.total)}</span>`;

    const sum = document.createElement("div");
    sum.className = "misuSummary";
    sum.textContent = m.summary;

    left.appendChild(top);
    left.appendChild(sum);

    const btns = document.createElement("div");
    btns.className = "misuBtns";

    const load = document.createElement("button");
    load.className = "btn";
    load.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    load.onclick = ()=>{
      state.cart = m.items.map(x=>({...x}));
      state.received = 0;
      saveAll();
      closeMisuModal();
      renderCart();
    };

    // âœ… ê³„ì¢Œì´ì²´ì²˜ëŸ¼ â€œë°”ë¡œ ê²°ì œì™„ë£Œâ€ ë²„íŠ¼ ì¶”ê°€ (ë¯¸ìˆ˜ì—ì„œ ì œê±°)
    const done = document.createElement("button");
    done.className = "btn ok";
    done.textContent = "ê²°ì œì™„ë£Œ";
    done.onclick = ()=>{
      if(!confirm(`ë¯¸ìˆ˜ ${idx+1}ì„(ë¥¼) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`)) return;
      beep();
      state.misu = state.misu.filter(x=>x.id !== m.id);
      saveAll();
      render();
      openMisuModal(); // ëª©ë¡ ê°±ì‹ 
    };

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "ì‚­ì œ";
    del.onclick = ()=>{
      if(!confirm(`ë¯¸ìˆ˜ ${idx+1}ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)) return;
      state.misu = state.misu.filter(x=>x.id !== m.id);
      saveAll();
      render();
      openMisuModal();
    };

    btns.appendChild(load);
    btns.appendChild(done);
    btns.appendChild(del);

    row.appendChild(left);
    row.appendChild(btns);
    $misuList.appendChild(row);
  });
}

function render(){
  renderTabs();
  renderGrid();
  renderCart();
  saveAll();
}

/* =========================
   ë™ì‘
========================= */
function togglePin(id){
  if(state.pins.has(id)) state.pins.delete(id);
  else state.pins.add(id);
  saveAll();
  render();
}

function addToCart(id){
  const it = state.items.find(x=>x.id===id);
  if(!it || it.active===0) return;

  // usage
  state.usage[id] = Number(state.usage[id]||0) + 1;

  const found = state.cart.find(x=>x.id===id);
  if(found) found.qty += 1;
  else state.cart.push({id:it.id, name:it.name, price:it.price, qty:1});
  saveAll();
  renderCart();
}

function setQty(id, qty){
  const idx = state.cart.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(qty<=0) state.cart.splice(idx,1);
  else state.cart[idx].qty = qty;
  saveAll();
  renderCart();
}

function removeFromCart(id){
  state.cart = state.cart.filter(x=>x.id!==id);
  saveAll();
  renderCart();
}

/* =========================
   ë¯¸ìˆ˜/ê²°ì œ
========================= */
function openMisuModal(){
  $modalMask.style.display = "flex";
  renderMisu();
}
function closeMisuModal(){
  $modalMask.style.display = "none";
}

document.getElementById("saveMisuBtn").onclick = ()=>{
  if(state.cart.length===0){
    alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }
  const total = cartTotal();
  const names = state.cart.map(x=>x.name).join(" Â· ");
  const summary = names.length>40 ? (names.slice(0,40)+"â€¦") : names;

  state.misu.unshift({
    id: uid(),
    ts: nowHM(),
    items: state.cart.map(x=>({...x})),
    total,
    summary
  });

  // ë¯¸ìˆ˜ ì €ì¥ í›„ ì¥ë°”êµ¬ë‹ˆ ìœ ì§€(ì›í•˜ì‹œë©´ ì—¬ê¸°ì„œ ë¹„ìš°ëŠ” ê±¸ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ)
  saveAll();
  renderCart();
  openMisuModal();
};

document.getElementById("misuPill").onclick = openMisuModal;
document.getElementById("closeModalBtn").onclick = closeMisuModal;
document.getElementById("modalMask").addEventListener("click", (e)=>{
  if(e.target === $modalMask) closeMisuModal();
});

/* âœ… ê²°ì œì™„ë£Œ: í™•ì¸ + ì†Œë¦¬ + ì´ˆê¸°í™” */
document.getElementById("payBtn").onclick = ()=>{
  if(state.cart.length===0){
    alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }
  if(!confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?")) return;

  beep();

  // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬: ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆ ì´ˆê¸°í™”
  state.cart = [];
  state.received = 0;
  saveAll();
  renderCart();
};

/* cash add */
document.querySelectorAll(".cashBtn[data-add]").forEach(btn=>{
  btn.onclick = ()=>{
    const v = Number(btn.dataset.add||0);
    state.received = (state.received||0) + v;
    saveAll();
    renderCart();
  };
});

/* ë°›ì€ëˆ ì´ˆê¸°í™”(ì´ˆê¸°í™” ë²„íŠ¼ì€ ë°›ì€ëˆë§Œ ë¦¬ì…‹) */
document.getElementById("receivedResetBtn").onclick = ()=>{
  state.received = 0;
  saveAll();
  renderCart();
};

/* âœ… ì¥ë°”êµ¬ë‹ˆ ë¦¬ì…‹ ë²„íŠ¼(ìƒë‹¨) */
document.getElementById("cartResetBtn").onclick = ()=>{
  if(!confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¦¬ì…‹í• ê¹Œìš”?")) return;
  state.cart = [];
  state.received = 0;
  saveAll();
  renderCart();
};

/* =========================
   ê²€ìƒ‰/í‚¤ë³´ë“œ
========================= */
$searchInput.addEventListener("input", ()=>{
  state.q = $searchInput.value;
  render();
});

/* ì´ˆì„± í‚¤ë³´ë“œ */
const KS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function renderKB(){
  $kb.innerHTML = "";
  KS.forEach(ch=>{
    const b = document.createElement("button");
    b.className = "k";
    b.textContent = ch;
    b.onclick = ()=>{
      $searchInput.value = ($searchInput.value || "") + ch;
      state.q = $searchInput.value;
      render();
      $searchInput.focus();
    };
    $kb.appendChild(b);
  });
  const x = document.createElement("button");
  x.className = "k clear";
  x.textContent = "X";
  x.onclick = ()=>{
    $searchInput.value = "";
    state.q = "";
    render();
    $searchInput.focus();
  };
  $kb.appendChild(x);
}
renderKB();

/* sort button (í‘œì‹œëŠ” ìœ ì§€) */
document.getElementById("sortBtn").onclick = ()=>{
  // ì§€ê¸ˆì€ ê³ ì •+ë§ì´ì°íŒ ìˆœìœ¼ë¡œ ê³ ì •.
  alert("ì •ë ¬ì€ í˜„ì¬: ê³ ì • â†’ ë§ì´ì°íŒ ìˆœ â†’ ord ì…ë‹ˆë‹¤.");
};

/* =========================
   ì‹œì‘
========================= */
loadAll();
render();
</script>
</body>
</html>
