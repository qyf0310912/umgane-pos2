<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --r:18px;

    /* ===== â€œë§ˆì§€ë§‰ ì‚¬ì§„â€ ê¸°ì¤€ í°íŠ¸/êµµê¸° ===== */
    --fs-12:12px;
    --fs-13:13px;
    --fs-14:14px;
    --fs-16:16px;
    --fs-18:18px;
    --fs-24:24px;
    --fs-32:32px;

    --w-400:400;
    --w-500:500;
    --w-600:600;

    /* ì˜¤ë¥¸ìª½ ê²°ì œì°½ í­ (PC ìŠ¤ìƒ· ê¸°ì¤€) */
    --right-w: 420px;

    /* ì¥ë°”êµ¬ë‹ˆ í•œ ì¤„ ì •ë ¬ í­ */
    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    /* ì¹´ë“œ ìµœì†Œ í­ (ì´ ê°’ìœ¼ë¡œ 4â†”5ì—´ ìë™ ì „í™˜ë¨) */
    --card-min: 210px;
  }

  /* iPad ê°€ë¡œ(ëŒ€ë¶€ë¶„ 1024~1366)ì—ì„œë„ PC ìŠ¤ìƒ· ëŠë‚Œ â€œê³ ì •â€ */
  @media (min-width:1024px) and (max-width:1400px){
    :root{
      --right-w:420px;
      --card-min:210px;
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}

  /* ===== ë ˆì´ì•„ì›ƒ ===== */
  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  /* ===== ìƒë‹¨(ì¹´í…Œê³ ë¦¬/ê²€ìƒ‰) ===== */
  .top{
    padding:12px;
    border-bottom:1px solid var(--line);
  }
  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    margin-bottom:10px;
  }
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .searchRow{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
  }
  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }

  .chosungRow{
    display:flex; gap:6px; flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.4;
  }

  /* ===== ìƒí’ˆ ê·¸ë¦¬ë“œ (ìë™ 4â†”5ì—´) ===== */
  .gridWrap{
    padding:12px;
    overflow:auto;
    flex:1;
  }
  .pinBarTitle{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    margin:0 0 8px;
  }
  .grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));
  }

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  /* ì¹´í…Œê³ ë¦¬ ë±ƒì§€(ë´‰ì§€ì±„ì†Œ ë“±) -> ì‚¬ìš© ì•ˆ í•¨ (ì•„ì˜ˆ ìˆ¨ê¹€) */
  .cardBadge{ display:none !important; }

  /* í•€ */
  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{
    opacity:.35;
    filter:grayscale(.55);
  }

  /* ===== ì˜¤ë¥¸ìª½ ì¥ë°”êµ¬ë‹ˆ ===== */
  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.92);
  }
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{
    flex:1;
    overflow:auto;
    padding:10px 10px 6px;
  }

  /* â€œí´ë¦­ë˜ëŠ” ëŠë‚Œâ€ ë°©ì§€: í–‰ ìì²´ëŠ” í´ë¦­ ì´ë²¤íŠ¸ ì—†ìŒ + ì„ íƒ ë¶ˆê°€ */
  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }

  .qtyBox{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
  }
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-700);
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:var(--w-700);
  }

  .summary{
    border-top:1px solid var(--line);
    padding:12px;
  }
  .sumTitle{
    font-size:var(--fs-13);
    color:rgba(245,247,255,.7);
    font-weight:var(--w-600);
  }
  .sumMoney{
    margin-top:6px;
    font-size:var(--fs-32);
    font-weight:var(--w-700);
    letter-spacing:-.6px;
  }
  .twoCol{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .moneyBox{
    border-radius:16px;
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .moneyLabel{
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
  }
  .moneyValue{
    margin-top:4px;
    font-size:var(--fs-24);
    font-weight:var(--w-700);
  }

  .cashGrid{
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  .cashBtn{
    padding:12px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-600);
    font-size:var(--fs-14);
  }
  .cashBtn.reset{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.28);
  }

  .bottomRow{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr 2fr;
    gap:10px;
    align-items:stretch;
  }
  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:10px 10px;
    text-align:left;
  }
  .misuBtn .t{
    font-weight:var(--w-700);
    font-size:var(--fs-16);
  }
  .misuBtn .s{
    margin-top:3px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    font-weight:var(--w-600);
  }

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:900;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
  }
  .payBtn small{
    display:block;
    font-size:var(--fs-12);
    font-weight:800;
    opacity:.8;
    margin-top:2px;
  }

  /* ===== ë¯¸ìˆ˜ ëª¨ë‹¬ ===== */
  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.5);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(900px, 96vw);
    max-height:84vh;
    overflow:auto;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{
    margin:0;
    font-size:var(--fs-18);
    font-weight:var(--w-700);
  }
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:var(--w-700);
  }
  .misuItem{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .misuInfo .t{
    font-size:var(--fs-14);
    font-weight:var(--w-700);
  }
  .misuInfo .d{
    margin-top:6px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.8);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .misuInfo .m{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-800);
    color:rgba(245,247,255,.92);
  }
  .misuBtns{
    display:flex; gap:8px;
  }
  .btn2{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-700);
  }
  .btn2.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.30);
  }

  /* ===== ë°˜ì‘í˜•: í™”ë©´ì´ ì•„ì£¼ ì¢ìœ¼ë©´ (PC ì‘ì—…ìš© ìµœì†Œ) ===== */
  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
  }
</style>
</head>

<body>
<div class="app">

  <!-- ================== LEFT ================== -->
  <section class="panel left">
    <div class="top">
      <div class="tabs" id="tabs"></div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
        <button class="chipBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        â€¢ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ <b>ì¹´í…Œê³ ë¦¬ ë¬´ê´€ ì „í’ˆëª©</b> ê²€ìƒ‰(ì´ˆì„± ê°€ëŠ¥)<br>
        â€¢ ìƒí’ˆì¹´ë“œ <b>ê¸¸ê²Œ</b> ëˆ„ë¥´ë©´ ê³ ì •/í•´ì œ(PCëŠ” ìš°í´ë¦­) / í´ë¦­ì€ ë‹´ê¸°<br>
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <!-- ================== RIGHT ================== -->
  <section class="panel right">
    <div class="rightTop">
      <div class="rightTitle"><span class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</span></div>
      <div class="rightTitle"><span class="pill" id="cartPill">ì¥ë°”êµ¬ë‹ˆ</span></div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">
          ê²°ì œì™„ë£Œ
          <small>ì¼ë°˜ ê²°ì œ</small>
        </button>
      </div>
    </div>
  </section>
</div>

<!-- ================== ë¯¸ìˆ˜ ëª¨ë‹¬ ================== -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ë¯¸ìˆ˜ ëª©ë¡</h3>
      <button class="mClose" id="mClose">ë‹«ê¸°</button>
    </div>
    <div id="misuList"></div>
  </div>
</div>

<script>
/* =========================================================
   ì €ì¥ í‚¤
========================================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

/* =========================================================
   ì¹´í…Œê³ ë¦¬ (ìš”ì²­: ê³¼ì¼/ì•¼ì±„/ë´‰ì§€ì±„ì†Œ/ìƒì„ /ê¸°íƒ€)
========================================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

/* =========================================================
   ì´ˆì„± í‚¤íŒ¨ë“œ
========================================================= */
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

/* =========================================================
   â€œì´ˆì„± ì¶”ì¶œâ€ (ì§„ì§œ ì‘ë™)
========================================================= */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch; // í•œê¸€ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){
  return [...(str||"")].map(getChosungChar).join("");
}
function normalize(str){
  return (str||"").toString().trim().toLowerCase();
}

/* =========================================================
   ë°ì´í„° ë¡œë“œ/ì„¸ì´ë¸Œ
========================================================= */
function load(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  }catch(e){ return fallback; }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* =========================================================
   ì•„ì´í…œ ë°ì´í„°
   - ê¸°ì¡´ì— ì´ë¯¸ êµ¬ê¸€ì‹œíŠ¸/CSV ì—°ë™ ì“°ê³  ìˆì–´ë„, ì´ íŒŒì¼ì€
     localStorage(LS_ITEMS)ì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©í•¨.
========================================================= */
function seedItemsIfEmpty(){
  const existing = load(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  // ìµœì†Œ ìƒ˜í”Œ (ì²˜ìŒ ì‹¤í–‰ ì‹œë§Œ)
  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
    {id:"S04", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:1},
    {id:"S05", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* =========================================================
   ìƒíƒœ
========================================================= */
let items = load(LS_ITEMS, []);
let pins  = load(LS_PINS, {});  // {id:true}
let cart  = load(LS_CART, {});  // {id:{id,name,price,qty}}
let paid  = load(LS_PAID, 0);
let misu  = load(LS_MISU, []);  // [{id, at, items:[{name,qty}], amount}]

let activeCat = "ì „ì²´";
let query = "";
let sortMode = "pin+ord"; // ê³ ì • + ord

/* =========================================================
   UI ì—˜ë¦¬ë¨¼íŠ¸
========================================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");
const elSortBtn = document.getElementById("sortBtn");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elMisuPill = document.getElementById("misuPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elMisuList = document.getElementById("misuList");

/* =========================================================
   ìˆ«ì í¬ë§·
========================================================= */
function won(n){
  const x = Math.round(Number(n)||0);
  return x.toLocaleString("ko-KR") + "ì›";
}

/* =========================================================
   ì •ë ¬
========================================================= */
function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){
    (pins[it.id] ? pinned : normal).push(it);
  }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd);
  normal.sort(byOrd);
  return [...pinned, ...normal];
}

/* =========================================================
   ê²€ìƒ‰ í•„í„° (ì¤‘ìš”: ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ ë¬´ì‹œ + ì´ˆì„± ë§¤ì¹­)
========================================================= */
function matchItem(it, q){
  if(!q) return true;

  const name = normalize(it.name);
  const qn = normalize(q);

  // 1) ì¼ë°˜ í¬í•¨
  if(name.includes(qn)) return true;

  // 2) ì´ˆì„± ë§¤ì¹­: "ã……ã„±" -> "ì‚¬ê³¼" ê°™ì€ ê²ƒ
  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,""); // ê³µë°± ì œê±°
  if(nameCho.includes(qCho)) return true;

  return false;
}
function visibleItems(){
  const q = query.trim();

  let list = items.filter(it => Number(it.active) === 1);

  // ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ "ì „í’ˆëª© ê²€ìƒ‰(ì¹´í…Œê³ ë¦¬ ë¬´ì‹œ)"
  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    // ê²€ìƒ‰ì–´ ì—†ì„ ë•Œë§Œ ì¹´í…Œê³ ë¦¬ í•„í„°
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* =========================================================
   ë Œë”: íƒ­/í‚¤íŒ¨ë“œ
========================================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCat = cat;
      renderAll();
    };
    elTabs.appendChild(b);
  });
}
function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderAll();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });
  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* =========================================================
   ê³ ì •(í•€)
========================================================= */
function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderAll();
}

/* =========================================================
   ì¥ë°”êµ¬ë‹ˆ
========================================================= */
function addToCart(it){
  if(Number(it.active)!==1) return;
  if(!cart[it.id]){
    cart[it.id] = {id:it.id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[it.id].qty += 1;
  }
  save(LS_CART, cart);
  renderAll();
}
function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  save(LS_CART, cart);
  renderAll();
}
function removeCart(id){
  delete cart[id];
  save(LS_CART, cart);
  renderAll();
}
function cartEntries(){
  return Object.values(cart);
}
function cartCount(){
  return cartEntries().reduce((a,x)=>a+(x.qty||0),0);
}
function cartTotal(){
  return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0);
}

/* =========================================================
   â€œì‚‘â€ ì†Œë¦¬ (WebAudio)
========================================================= */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square";
    o.frequency.value=880;
    g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* =========================================================
   ê²°ì œì™„ë£Œ
========================================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  beep();

  // ê²°ì œ ì™„ë£Œ í›„: ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆ ë¦¬ì…‹
  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
}

/* =========================================================
   ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ
========================================================= */
function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderAll();
}

/* =========================================================
   ë¯¸ìˆ˜
========================================================= */
function openMisu(){
  elModalBack.style.display = "flex";
  renderMisuList();
}
function closeMisu(){
  elModalBack.style.display = "none";
}
function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (misu.length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu.unshift({
    id,
    at: now.toISOString(),
    items: names,
    amount
  });
  save(LS_MISU, misu);

  // ë¯¸ìˆ˜ ì €ì¥ í›„ ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆ ë¦¬ì…‹
  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}
function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  // ë³µì›: í˜„ì¬ ì¥ë°”êµ¬ë‹ˆë¥¼ ë®ì–´ì”€(ì‹¤ë¬´ì—ì„œ ë” ë¹ ë¦„)
  const next = {};
  for(const it of m.items){
    // items ë°ì´í„°ì—ì„œ idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ name ê¸°ë°˜ìœ¼ë¡œ ì°¾ìŒ
    const found = items.find(x=>x.name===it.name);
    if(found){
      next[found.id] = {id:found.id, name:found.name, price:Number(found.price||0), qty:Number(it.qty||1)};
    }else{
      // ëª» ì°¾ìœ¼ë©´ ì„ì‹œ id
      const tmpId = "TMP_"+it.name;
      next[tmpId] = {id:tmpId, name:it.name, price:0, qty:Number(it.qty||1)};
    }
  }
  cart = next;
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  closeMisu();
}
function deleteMisu(idx){
  misu.splice(idx,1);
  save(LS_MISU, misu);
  renderMisuList();
  renderAll();
}
function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;">ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");
    const itemsText = (m.items||[]).map(x=>x.name).join(" Â· ");

    const wrap = document.createElement("div");
    wrap.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuInfo";
    left.innerHTML = `
      <div class="t">${m.id} <span class="muted">(${hh}:${mm})</span></div>
      <div class="d">${itemsText}</div>
      <div class="m mono">ê¸ˆì•¡: ${won(m.amount||0)}</div>
    `;

    const right = document.createElement("div");
    right.className = "misuBtns";
    const b1 = document.createElement("button");
    b1.className = "btn2";
    b1.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    b1.onclick = ()=>restoreMisu(idx);

    const b2 = document.createElement("button");
    b2.className = "btn2 danger";
    b2.textContent = "ì‚­ì œ";
    b2.onclick = ()=>deleteMisu(idx);

    right.appendChild(b1);
    right.appendChild(b2);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

/* =========================================================
   ë Œë”: ìƒí’ˆ ì¹´ë“œ
========================================================= */
let pressTimer=null;
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    // ì´ë¦„/ê°€ê²© (ì¹´í…Œê³ ë¦¬ ë±ƒì§€ëŠ” ì•„ì˜ˆ ì—†ìŒ)
    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    // í•€(ì‚¬ìš© ì•ˆ í•˜ëŠ” í•€ì€ íë¦¬ê²Œ)
    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "ê³ ì •";
    pin.onclick = (e)=>{
      e.stopPropagation();
      togglePin(it.id);
    };

    // í´ë¦­: ë‹´ê¸°
    card.onclick = ()=>addToCart(it);

    // ê¸¸ê²Œ(ëª¨ë°”ì¼)/ìš°í´ë¦­(PC): ê³ ì • í† ê¸€
    card.oncontextmenu = (e)=>{
      e.preventDefault();
      togglePin(it.id);
      return false;
    };
    card.addEventListener("touchstart", ()=>{
      pressTimer = setTimeout(()=>togglePin(it.id), 450);
    }, {passive:true});
    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);

    elGrid.appendChild(card);
  });
}

/* =========================================================
   ë Œë”: ì¥ë°”êµ¬ë‹ˆ
========================================================= */
function renderCart(){
  elCartList.innerHTML = "";

  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">â€”</div>`;
    return;
  }

  // ord ìˆœì„œì— ë§ì¶° ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ items ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0)).replace("ì›","ì›");

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

/* =========================================================
   ë Œë”: í•©ê³„/ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ/ë¯¸ìˆ˜ìˆ˜
========================================================= */
function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);

  elCartPill.textContent = `ì¥ë°”êµ¬ë‹ˆ`;
  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length})`;
}

/* =========================================================
   ì „ì²´ ë Œë”
========================================================= */
function renderAll(){
  // ë°ì´í„°ê°€ ì™¸ë¶€ì—ì„œ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìµœì‹  ë¡œë“œ(ì•ˆì „)
  items = load(LS_ITEMS, items);
  pins  = load(LS_PINS, pins);
  cart  = load(LS_CART, cart);
  paid  = load(LS_PAID, paid);
  misu  = load(LS_MISU, misu);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* =========================================================
   ì´ë²¤íŠ¸
========================================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  renderAll();
});

document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});
elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderAll();
});

elPayBtn.addEventListener("click", doPay);

elSaveMisu.addEventListener("click", saveMisuNow);
elMisuPill.addEventListener("click", openMisu);
elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeMisu();
});
elMClose.addEventListener("click", closeMisu);

/* ì •ë ¬ ë²„íŠ¼(í˜„ì¬ëŠ” ê³ ì •+ord ê³ ì •) */
elSortBtn.addEventListener("click", ()=>{
  // ì§€ê¸ˆì€ ìš”êµ¬ëŒ€ë¡œ ê³ ì • + ord ê³ ì • ìœ ì§€
  alert("í˜„ì¬ ì •ë ¬ì€ 'ê³ ì • + ord' ê³ ì •ì…ë‹ˆë‹¤.");
});

/* ì‹œì‘ */
renderAll();
</script>
</body>
</html>
