<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS (ì‹¤ë¬´ ìµœì¢…)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.62);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 12px 40px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    font-weight:400;
  }
  button{border:0;border-radius:14px;cursor:pointer}
  .app{height:100%;display:grid;grid-template-columns: 1.25fr .75fr;gap:12px;padding:12px}

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden
  }
  .left,.right{display:flex;flex-direction:column;min-width:0}

  /* ===== Left Top ===== */
  .topbar{padding:12px;display:flex;flex-direction:column;gap:10px;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:600}
  .tab.active{outline:2px solid rgba(255,159,0,.55); background:rgba(255,159,0,.10)}
  .row{display:flex;gap:10px;align-items:center}
  .search{
    flex:1;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);
    border:1px solid var(--line); border-radius:16px; padding:10px 12px; min-width:0
  }
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px;min-width:0;font-weight:500}
  .sortBtn{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:700}
  .keys{display:flex;gap:8px;flex-wrap:wrap}
  .kbtn{width:44px;height:38px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:12px;font-weight:800}
  .kbtn.clear{background:rgba(255,59,48,.15);border-color:rgba(255,59,48,.25)}
  .hint{color:var(--muted);font-size:12px}

  /* ===== Pinned strip ===== */
  .pinned{padding:10px 12px;border-bottom:1px solid var(--line)}
  .pinnedTitle{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:8px}
  .pinnedGrid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px}
  .emptyPinned{color:var(--muted);font-size:13px}

  /* ===== Items grid ===== */
  .itemsWrap{flex:1;min-height:0;overflow:auto;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:12px}
  .card{
    position:relative; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:18px;
    padding:12px; min-height:88px; display:flex; flex-direction:column; gap:8px
  }
  .name{font-size:20px;font-weight:800;letter-spacing:-.2px;line-height:1.05}
  .price{font-size:13px;color:var(--muted);font-weight:700}
  .pinIcon{
    position:absolute; right:10px; bottom:10px; width:34px;height:34px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,159,0,.10); border:1px solid rgba(255,159,0,.20); color:var(--accent); font-weight:900
  }
  /* âœ… ë¹¨ê°„ê³ ì •í•€ ì‚¬ìš©ì•ˆí•˜ëŠ”ê±° íë¦¬ê²Œ */
  .pinIcon.off{opacity:.18; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); color:rgba(245,247,255,.55)}
  .card:active{transform:scale(.99)}
  .card.pinnedCard{outline:2px solid rgba(255,159,0,.40)}

  /* ===== Right panel (3/1 êµ¬ì¡°) ===== */
  .rHead{
    padding:12px;border-bottom:1px solid var(--line);
    display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .rBtns{display:flex;gap:8px;align-items:center}
  .btnMini{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:800}
  .btnMini.accent{background:rgba(255,159,0,.14);border-color:rgba(255,159,0,.22)}
  .modeTag{
    display:none;
    padding:8px 10px;border-radius:999px;
    background:rgba(41,209,126,.14);border:1px solid rgba(41,209,126,.22);
    color:rgba(245,247,255,.92);font-weight:900;font-size:12px;
  }
  .modeTag.show{display:inline-flex}

  /* ì¥ë°”êµ¬ë‹ˆ(ìµœëŒ€í•œ ë§ì´ ë³´ì´ê²Œ) */
  .cartWrap{flex:1;min-height:0;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .cartItem{
    background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;
    padding:8px 10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px
  }
  /* âœ… í•œ ì¤„ ì••ì¶• */
  .ciLine{
    min-width:0;
    display:flex;
    align-items:center;
    gap:10px;
    font-size:15px;
    font-weight:700;
    line-height:1.2;
  }
  .ciName{
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width: 220px;
    font-weight:800;
  }
  .ciAmt{
    white-space:nowrap;
    color:rgba(245,247,255,.90);
    font-weight:800;
  }
  .ciRight{display:flex;align-items:center;gap:8px;flex:0 0 auto}
  .qtyBtn{width:38px;height:32px;border-radius:12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-size:18px;font-weight:900}
  /* âœ… ì¥ë°”êµ¬ë‹ˆëª©ë¡ì— ì‚­ì œ Xë²„íŠ¼ */
  .delBtn{width:38px;height:32px;border-radius:12px;background:rgba(255,59,48,.16);color:var(--text);border:1px solid rgba(255,59,48,.28);font-size:18px;font-weight:900}

  /* ===== Totals area: ì¥ë°”êµ¬ë‹ˆ ì•„ë˜ë¡œ ===== */
  .sumRow{
    padding:12px;border-top:1px solid var(--line);
    display:flex;flex-direction:column;gap:10px
  }
  .tLabel{color:var(--muted);font-size:12px;font-weight:700}
  .tValue{font-size:38px;font-weight:900;letter-spacing:-.7px}

  /* ë°›ì€ëˆ | ê±°ìŠ¤ë¦„ëˆ (ì™¼ìª½ì •ë ¬, ê°™ì€ ì—´) */
  .rcRow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:14px;
    position:relative;
    padding-top:4px;
  }
  .rcRow:before{
    content:"";
    position:absolute;
    left:50%;
    top:0;
    bottom:0;
    width:1px;
    background:rgba(255,255,255,.10);
  }
  .rcBox{display:flex;flex-direction:column;gap:4px;align-items:flex-start}
  .rcLbl{color:var(--muted);font-size:12px;font-weight:700}
  .rcVal{font-size:28px;font-weight:900;letter-spacing:-.4px}

  .btnGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px;margin-top:4px}
  .moneyBtn{height:48px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:16px;font-size:16px;font-weight:900}
  .moneyBtn.reset{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}

  /* Bottom buttons (ë¯¸ìˆ˜ ì‘ì€, ê²°ì œì™„ë£Œ í°) */
  .bottom{
    padding:12px;border-top:1px solid var(--line);
    display:grid;grid-template-columns: 1fr 2.2fr;gap:10px
  }
  .hold{
    height:62px;border-radius:18px;background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid var(--line);font-size:18px;font-weight:900
  }
  .hold small{display:block;font-size:12px;color:var(--muted);font-weight:700;margin-top:2px}
  .checkout{
    height:62px;border-radius:18px;background:linear-gradient(180deg, rgba(255,159,0,1), rgba(255,159,0,.85));
    color:#101116;font-size:26px;font-weight:1000
  }
  .checkout small{display:block;font-size:12px;opacity:.75;font-weight:900}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:12px}
  .modal.show{display:flex}
  .sheet{width:min(880px, 100%);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow)}
  .sheetHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sheetHead .title{font-weight:900;font-size:18px}
  .sheetBody{padding:12px;display:flex;flex-direction:column;gap:10px}
  .holdRow{
    background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;
    padding:10px;display:flex;justify-content:space-between;align-items:center;gap:10px
  }
  .holdLeft{min-width:0;display:flex;flex-direction:column;gap:6px}
  .holdName{font-weight:900}
  .holdItems{
    color:rgba(245,247,255,.82);
    font-weight:800;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    max-width: 520px;
  }
  .holdRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .hBtn{padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:900}
  .hBtn.del{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,17,22,.95);
    border:1px solid var(--line);border-radius:999px;padding:10px 14px;color:var(--text);font-weight:900;display:none}
  .toast.show{display:block}

  /* Responsive */
  @media (max-width: 980px){
    .app{grid-template-columns:1fr;grid-template-rows:1.1fr .9fr}
    .grid,.pinnedGrid{grid-template-columns:repeat(3, minmax(0,1fr))}
    .holdItems{max-width: 420px}
  }
  @media (max-width: 520px){
    .grid,.pinnedGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
    .tValue{font-size:34px}
    .rcVal{font-size:24px}
    .holdItems{max-width: 260px}
  }
</style>
</head>
<body>
<div class="app">
  <section class="panel left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="row">
        <div class="search">
          <span style="opacity:.8">ğŸ”</span>
          <input id="q" placeholder="ì „í’ˆëª© ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="keys" id="chosungKeys"></div>
      <div class="hint">â€¢ í´ë¦­=ë‹´ê¸° â€¢ ê¸¸ê²Œ(0.45ì´ˆ)=ê³ ì •/í•´ì œ â€¢ ğŸ“Œ í´ë¦­=ê³ ì •/í•´ì œ â€¢ ê²€ìƒ‰ì€ íƒ­ ë¬´ê´€ â€œì „í’ˆëª©â€</div>
    </div>

    <div class="pinned" id="pinnedBox">
      <div class="pinnedTitle">
        <span>ê³ ì • Â· ìƒë‹¨</span>
        <span class="hint">ê³ ì •ì€ â€œê¸¸ê²Œâ€ ë˜ëŠ” ğŸ“Œ</span>
      </div>
      <div class="pinnedGrid" id="pinnedGrid"></div>
    </div>

    <div class="itemsWrap">
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <!-- âœ… 3/1: ì¥ë°”êµ¬ë‹ˆ(00ê°œ) ë¯¸ìˆ˜ ë²„íŠ¼ì´ ìƒë‹¨ -->
    <div class="rHead">
      <div class="rBtns">
        <button class="btnMini" id="cartBtn">ì¥ë°”êµ¬ë‹ˆ(0ê°œ)</button>
        <button class="btnMini accent" id="holdsBtn">ë¯¸ìˆ˜(0)</button>
      </div>
      <div class="modeTag" id="modeTag">ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜´</div>
    </div>

    <!-- ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ -->
    <div class="cartWrap" id="cartWrap"></div>

    <!-- âœ… ì´í•©ê³„ëŠ” ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ì•„ë˜ -->
    <div class="sumRow">
      <div>
        <div class="tLabel" id="totalLabel">ì´í•©ê³„ (0ê°œ)</div>
        <div class="tValue" id="grandTotal">0ì›</div>
      </div>

      <!-- ë°›ì€ëˆ | ê±°ìŠ¤ë¦„ëˆ (ì™¼ìª½ì •ë ¬) -->
      <div class="rcRow">
        <div class="rcBox">
          <div class="rcLbl">ë°›ì€ëˆ</div>
          <div class="rcVal" id="receivedVal">0ì›</div>
        </div>
        <div class="rcBox">
          <div class="rcLbl">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="rcVal" id="changeVal">0ì›</div>
        </div>
      </div>

      <div class="btnGrid">
        <button class="moneyBtn" data-add="500">+500</button>
        <button class="moneyBtn" data-add="1000">+1ì²œ</button>
        <button class="moneyBtn" data-add="5000">+5ì²œ</button>
        <button class="moneyBtn" data-add="10000">+1ë§Œ</button>
        <button class="moneyBtn" data-add="50000">+5ë§Œ</button>
        <button class="moneyBtn reset" id="receivedReset">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="bottom">
      <button class="hold" id="holdNow">
        ë¯¸ìˆ˜
        <small>í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</small>
      </button>
      <button class="checkout" id="checkout">
        ê²°ì œì™„ë£Œ
        <small id="checkoutHint">ì¼ë°˜ ê²°ì œ</small>
      </button>
    </div>
  </section>
</div>

<!-- Holds modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="hBtn" id="closeModal">ë‹«ê¸°</button>
    </div>
    <div class="sheetBody" id="holdsList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =============================
   âœ… ì„¤ì • (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
============================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";
const APP_VER = "umgane_pos_v20251224_final_3by1_fix_1";

/* =============================
   ì €ì¥ í‚¤
============================= */
const LS_VER="umgane_app_ver";
const LS_ITEMS="umgane_items_v1";
const LS_PINS="umgane_pins_v1";
const LS_CART="umgane_cart_v1";
const LS_REC="umgane_received_v1";
const LS_USED="umgane_used_v1";
const LS_HOLDS="umgane_holds_v1";
const LS_CURH="umgane_current_hold_id";

/* =============================
   ìœ í‹¸
============================= */
const $ = (s)=>document.querySelector(s);
const el = (tag, props={})=>Object.assign(document.createElement(tag), props);

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"), 1100);
}
function krw(n){
  n = Math.max(0, Math.round(Number(n||0)));
  return n.toLocaleString("ko-KR") + "ì›";
}
function parsePrice(v){
  if(v==null) return 0;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/[^\d.]/g,"");
  if(!cleaned) return 0;
  const num = Number(cleaned);
  if(!isFinite(num)) return 0;
  return Math.round(num);
}
function normCat(c){
  c=(c||"").trim();
  if(c==="ë´‰ì±„ì†Œ"||c==="ë´‰ì§€ì•¼ì±„"||c==="ë´‰ì§€ì±„ì†Œ") c="ë´‰ì§€ì±„ì†Œ";
  return c||"ê¸°íƒ€";
}

/* =============================
   ì´ˆì„± ê²€ìƒ‰(ì™„ì „ ìˆ˜ì •)
   - ì´ˆì„±ë§Œ ì…ë ¥(ã„±, ã„±ã…ˆ ë“±): ìƒí’ˆëª… ì´ˆì„± "ì•ì—ì„œë¶€í„°" ë§¤ì¹­
   - ì¼ë°˜ í…ìŠ¤íŠ¸(ê°ì): í¬í•¨ ë§¤ì¹­
============================= */
const CHO = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHOSET = new Set(CHO);
function getChoChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / (21*28));
  return CHO[idx] || ch;
}
function toChosung(str){
  return Array.from(String(str||"")).map(getChoChar).join("");
}
function normQ(q){ return String(q||"").trim().replace(/\s+/g,""); }
function isChosungOnly(q){
  if(!q) return false;
  for(const ch of q){
    if(!CHOSET.has(ch)) return false;
  }
  return true;
}
function matchItem(item, q){
  const qq = normQ(q);
  if(!qq) return true;

  const name = String(item.name||"");
  const nameLow = name.toLowerCase();

  // âœ… ì´ˆì„± ì „ìš©: "ì•ì—ì„œë¶€í„°" ë§¤ì¹­(ì—‰ëš±í•œ ê²°ê³¼ ë°©ì§€)
  if(isChosungOnly(qq)){
    const cho = toChosung(name);
    return cho.startsWith(qq);
  }

  // ì¼ë°˜ ê²€ìƒ‰: í¬í•¨ + ì´ˆì„± í¬í•¨(í˜¼í•© ì…ë ¥ë„ ì§€ì›)
  const low = qq.toLowerCase();
  if(nameLow.includes(low)) return true;

  const cho = toChosung(name);
  const qCho = toChosung(qq);
  if(cho.includes(qCho)) return true;

  return false;
}

/* =============================
   ë²„ì „ ì •ë¦¬ (ê¼¬ì„ ë°©ì§€)
============================= */
(function ensureVersion(){
  const prev = localStorage.getItem(LS_VER);
  if(prev !== APP_VER){
    localStorage.setItem(LS_VER, APP_VER);
    localStorage.removeItem(LS_PINS);
    localStorage.removeItem(LS_CART);
    localStorage.removeItem(LS_REC);
    localStorage.removeItem(LS_USED);
    localStorage.removeItem(LS_HOLDS);
    localStorage.removeItem(LS_CURH);
  }
})();

/* =============================
   ìƒíƒœ
============================= */
const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
let activeCat = "ê³¼ì¼";
let items = [];
let pins = new Set(JSON.parse(localStorage.getItem(LS_PINS)||"[]"));
let cart = JSON.parse(localStorage.getItem(LS_CART)||"{}");
let used = JSON.parse(localStorage.getItem(LS_USED)||"{}");
let received = Number(localStorage.getItem(LS_REC)||"0") || 0;
let holds = JSON.parse(localStorage.getItem(LS_HOLDS)||"[]");
let currentHoldId = localStorage.getItem(LS_CURH) || "";

/* =============================
   CSV íŒŒì„œ
============================= */
function parseCSV(text){
  const rows=[];
  let cur="", inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch === ',' && !inQ){
      pushCell();
    }else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    }else{
      cur+=ch;
    }
  }
  if(cur.length || row.length){ pushCell(); pushRow(); }
  return rows;
}

/* =============================
   ë¡œë“œ: Google Sheet CSV
============================= */
async function loadItems(){
  const cached = localStorage.getItem(LS_ITEMS);
  if(cached){
    try{
      const arr = JSON.parse(cached);
      if(Array.isArray(arr) && arr.length){
        items = arr;
        renderAll();
      }
    }catch(e){}
  }

  try{
    const res = await fetch(CSV_URL + "&_ts=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨");
    const csv = await res.text();
    const rows = parseCSV(csv).filter(r=>r.some(x=>String(x||"").trim()!==""));
    if(rows.length < 2) throw new Error("CSV ë‚´ìš© ì—†ìŒ");

    const header = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = (k)=>header.indexOf(k);

    const iId = idx("id");
    const iCat = idx("cat");
    const iName = idx("name");
    const iPrice = idx("price");
    const iActive = idx("active");
    const iOrd = idx("ord");

    const out=[];
    for(let r=1;r<rows.length;r++){
      const line = rows[r];
      const id = String(line[iId]??"").trim();
      const cat = normCat(String(line[iCat]??"").trim());
      const name = String(line[iName]??"").trim();
      const price = parsePrice(line[iPrice]);
      const active = String(line[iActive]??"1").trim();
      const ordRaw = String(line[iOrd]??"").trim();
      if(!id || !name) continue;
      if(active==="0" || active.toLowerCase()==="false") continue;

      out.push({
        id, cat, name, price,
        ordNum: ordRaw==="" ? 1e15 : Number(ordRaw)
      });
    }

    out.forEach(x=>{ if(!CATS.includes(x.cat)) x.cat="ê¸°íƒ€"; });

    items = out;
    localStorage.setItem(LS_ITEMS, JSON.stringify(items));
    renderAll();
    toast("ìƒí’ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  }catch(e){
    if(!items.length) toast("CSV ë¡œë“œ ì‹¤íŒ¨(ì‹œíŠ¸ ê³µìœ /ê²Œì‹œ í™•ì¸)");
  }
}

/* =============================
   íƒ­ / ì´ˆì„±í‚¤
============================= */
function buildTabs(){
  const box = $("#tabs");
  box.innerHTML="";
  CATS.forEach(c=>{
    const b = el("button",{className:"tab"+(c===activeCat?" active":""), textContent:c});
    b.onclick=()=>{ activeCat=c; buildTabs(); renderAll(); };
    box.appendChild(b);
  });
}
function buildChosungKeys(){
  const box = $("#chosungKeys");
  box.innerHTML="";
  CHO.forEach(ch=>{
    const b=el("button",{className:"kbtn", textContent:ch});
    b.onclick=()=>{ $("#q").value += ch; renderAll(); };
    box.appendChild(b);
  });
  const clr=el("button",{className:"kbtn clear", textContent:"X"});
  clr.onclick=()=>{ $("#q").value=""; renderAll(); };
  box.appendChild(clr);
}

/* =============================
   í•„í„°/ì •ë ¬
============================= */
function getList(){
  const q = $("#q").value;
  const qq = normQ(q);
  const searching = qq.length>0;

  let list = items.slice();

  // âœ… ê²€ìƒ‰ ì¤‘ì´ë©´ ì „í’ˆëª©(íƒ­ ë¬´ì‹œ), ì•„ë‹ˆë©´ íƒ­ ê¸°ì¤€
  if(searching) list = list.filter(x=>matchItem(x, q));
  else list = list.filter(x=>x.cat===activeCat);

  list.sort((a,b)=>{
    const ap = pins.has(a.id)?0:1;
    const bp = pins.has(b.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(a.ordNum!==b.ordNum) return a.ordNum-b.ordNum;
    return a.name.localeCompare(b.name,"ko");
  });

  return list;
}

/* =============================
   ê³ ì •
============================= */
function savePins(){ localStorage.setItem(LS_PINS, JSON.stringify(Array.from(pins))); }
function togglePin(id){
  if(pins.has(id)) pins.delete(id);
  else pins.add(id);
  savePins();
  renderAll();
  toast(pins.has(id) ? "ê³ ì •ë¨" : "ê³ ì •í•´ì œ");
}
function renderPinned(){
  const box = $("#pinnedGrid");
  box.innerHTML="";
  const pinnedItems = items
    .filter(x=>pins.has(x.id))
    .sort((a,b)=>a.ordNum-b.ordNum || a.name.localeCompare(b.name,"ko"));

  if(!pinnedItems.length){
    box.innerHTML = `<div class="emptyPinned">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ê¸¸ê²Œ ë˜ëŠ” ğŸ“Œ)</div>`;
    return;
  }
  pinnedItems.slice(0,12).forEach(x=>box.appendChild(makeCard(x,true)));
}

/* =============================
   ì¹´ë“œ
============================= */
function makeCard(x){
  const c = el("div",{className:"card"+(pins.has(x.id)?" pinnedCard":"")});
  const n = el("div",{className:"name", textContent:x.name});
  const p = el("div",{className:"price", textContent:krw(x.price)});
  const pin = el("div",{className:"pinIcon "+(pins.has(x.id)?"":"off"), textContent:"ğŸ“Œ"});
  c.append(n,p,pin);

  // í´ë¦­: ë‹´ê¸°
  c.addEventListener("click", ()=>{
    if(c._longFired){ c._longFired=false; return; }
    addToCart(x.id,1);
  });

  // ğŸ“Œ í´ë¦­: ê³ ì • í† ê¸€
  pin.addEventListener("click",(e)=>{ e.stopPropagation(); togglePin(x.id); });

  // ê¸¸ê²Œ: ê³ ì • í† ê¸€
  let tmr=null;
  c.addEventListener("pointerdown", ()=>{
    c._longFired=false;
    tmr=setTimeout(()=>{ c._longFired=true; togglePin(x.id); }, 450);
  });
  ["pointerup","pointerleave","pointercancel"].forEach(ev=>{
    c.addEventListener(ev, ()=>{ if(tmr) clearTimeout(tmr); });
  });

  return c;
}
function renderGrid(){
  const grid=$("#grid");
  grid.innerHTML="";
  getList().forEach(x=>grid.appendChild(makeCard(x)));
}

/* =============================
   ì¥ë°”êµ¬ë‹ˆ
============================= */
function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
function saveReceived(){ localStorage.setItem(LS_REC, String(received)); }
function saveHolds(){ localStorage.setItem(LS_HOLDS, JSON.stringify(holds)); }
function setCurrentHold(id){
  currentHoldId = id || "";
  if(currentHoldId) localStorage.setItem(LS_CURH, currentHoldId);
  else localStorage.removeItem(LS_CURH);

  $("#modeTag").classList.toggle("show", !!currentHoldId);
  $("#checkoutHint").textContent = currentHoldId ? "ë¯¸ìˆ˜ ê²°ì œ(ì™„ë£Œ ì‹œ ëª©ë¡ì—ì„œ ì œê±°)" : "ì¼ë°˜ ê²°ì œ";
}

function addToCart(id, d){
  cart[id] = (cart[id]||0) + d;
  if(cart[id] <= 0) delete cart[id];
  saveCart();
  renderCart();
}
function setQty(id, qty){
  if(qty<=0) delete cart[id];
  else cart[id]=qty;
  saveCart();
  renderCart();
}
function cartStats(){
  let total=0, cnt=0;
  for(const [id,qty] of Object.entries(cart)){
    const it = items.find(x=>x.id===id);
    if(!it) continue;
    total += it.price * qty;
    cnt += qty;
  }
  return {total, cnt};
}

function renderCart(){
  const wrap=$("#cartWrap");
  wrap.innerHTML="";

  const entries = Object.entries(cart);
  entries.sort((a,b)=>{
    const ia=items.find(x=>x.id===a[0]); const ib=items.find(x=>x.id===b[0]);
    if(!ia&&!ib) return 0;
    if(!ia) return 1; if(!ib) return -1;
    const ap=pins.has(ia.id)?0:1, bp=pins.has(ib.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(ia.ordNum!==ib.ordNum) return ia.ordNum-ib.ordNum;
    return ia.name.localeCompare(ib.name,"ko");
  });

  entries.forEach(([id,qty])=>{
    const it = items.find(x=>x.id===id);
    if(!it) return;

    const row = el("div",{className:"cartItem"});

    // âœ… í•œì¤„ ì••ì¶• (ì¤‘ë³µ ê°€ê²© í‘œì‹œ ì œê±°)
    const left = el("div",{className:"ciLine"});
    const nm = el("div",{className:"ciName", textContent:`${it.name} x${qty}`});
    const amt = el("div",{className:"ciAmt", textContent: krw(it.price*qty)});
    left.append(nm, amt);

    const right = el("div",{className:"ciRight"});
    const minus = el("button",{className:"qtyBtn", textContent:"â€“"});
    const plus  = el("button",{className:"qtyBtn", textContent:"+"});
    const del   = el("button",{className:"delBtn", textContent:"Ã—"});
    minus.onclick=()=>setQty(id, qty-1);
    plus.onclick =()=>setQty(id, qty+1);
    del.onclick  =()=>setQty(id, 0);
    right.append(minus, plus, del);

    row.append(left, right);
    wrap.appendChild(row);
  });

  // ìµœì†Œ 7ì¤„ ë…¸ì¶œ(ë¹ˆì¤„ ì±„ìš°ê¸°)
  const minRows=7;
  const need=Math.max(0, minRows-entries.length);
  for(let i=0;i<need;i++){
    const dummy=el("div",{className:"cartItem"});
    dummy.style.opacity=.18;
    dummy.innerHTML = `<div style="height:18px"></div>`;
    wrap.appendChild(dummy);
  }

  const {total,cnt}=cartStats();
  $("#grandTotal").textContent = krw(total);
  $("#totalLabel").textContent = `ì´í•©ê³„ (${cnt.toLocaleString("ko-KR")}ê°œ)`;

  $("#receivedVal").textContent = krw(received);
  $("#changeVal").textContent = krw(Math.max(0, received - total));

  $("#cartBtn").textContent = `ì¥ë°”êµ¬ë‹ˆ(${cnt}ê°œ)`;
  $("#holdsBtn").textContent = `ë¯¸ìˆ˜(${holds.length})`;
}

/* =============================
   ë¯¸ìˆ˜
============================= */
function pushHold(){
  const {total,cnt} = cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }
  holds.unshift({
    id:"H"+Date.now(),
    ts:Date.now(),
    cart:{...cart},
    total, cnt
  });
  saveHolds();

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  setCurrentHold("");
  renderCart();
  toast("ë¯¸ìˆ˜ ì €ì¥ë¨");
}

function holdItemsSummary(h){
  const parts=[];
  for(const [id,qty] of Object.entries(h.cart||{})){
    const it=items.find(x=>x.id===id);
    if(!it) continue;
    parts.push(qty>1 ? `${it.name}x${qty}` : `${it.name}`);
  }
  parts.sort((a,b)=>a.localeCompare(b,"ko"));
  let text = parts.join(" Â· ");
  const maxLen = 46;
  if(text.length > maxLen) text = text.slice(0, maxLen-1) + "â€¦";
  return text || "(ìƒí’ˆ ì—†ìŒ)";
}

function openHolds(){
  $("#modal").classList.add("show");
  renderHoldsList();
}
function closeHolds(){
  $("#modal").classList.remove("show");
}
function renderHoldsList(){
  const box=$("#holdsList");
  box.innerHTML="";
  if(!holds.length){
    box.innerHTML = `<div class="hint">ë¯¸ìˆ˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  holds.forEach((h,idx)=>{
    const row = el("div",{className:"holdRow"});

    const left = el("div",{className:"holdLeft"});
    const t = new Date(h.ts);
    const time = `${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;
    const name = el("div",{className:"holdName"});
    name.innerHTML = `ë¯¸ìˆ˜ ${idx+1} <span class="hint">(${time})</span>`;
    const itemsLine = el("div",{className:"holdItems", textContent: holdItemsSummary(h)});
    left.append(name, itemsLine);

    const right = el("div",{className:"holdRight"});
    const load = el("button",{className:"hBtn", textContent:"ë¶ˆëŸ¬ì˜¤ê¸°"});
    const del  = el("button",{className:"hBtn del", textContent:"ì‚­ì œ"});

    load.onclick=()=>{
      cart = {...h.cart};
      received = 0;
      saveCart(); saveReceived();
      setCurrentHold(h.id);   // âœ… ë¯¸ìˆ˜ ëª¨ë“œ
      closeHolds();
      renderCart();
      toast("ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜´");
    };
    del.onclick=()=>{
      holds = holds.filter(x=>x.id!==h.id);
      if(currentHoldId===h.id) setCurrentHold("");
      saveHolds();
      renderCart();
      renderHoldsList();
    };

    right.append(load, del);
    row.append(left, right);
    box.appendChild(row);
  });
}

/* =============================
   ì´ë²¤íŠ¸
============================= */
$("#q").addEventListener("input", ()=>renderAll());
$("#sortBtn").onclick=()=>toast("ì •ë ¬: ê³ ì • + ord (ê³ ì •)");

document.querySelectorAll("[data-add]").forEach(b=>{
  b.onclick=()=>{
    received += Number(b.dataset.add);
    saveReceived();
    renderCart();
  };
});
$("#receivedReset").onclick=()=>{
  received = 0;
  saveReceived();
  renderCart();
  toast("ë°›ì€ëˆë§Œ ì´ˆê¸°í™”");
};

$("#checkout").onclick=()=>{
  const {cnt} = cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }

  const ok = window.confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  // âœ… ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¨ ìƒíƒœë©´: ê²°ì œì™„ë£Œ ì‹œ í•´ë‹¹ ë¯¸ìˆ˜ ìë™ ì œê±° = ë¯¸ìˆ˜ì™„ë£Œ
  if(currentHoldId){
    holds = holds.filter(h=>h.id!==currentHoldId);
    saveHolds();
  }

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  setCurrentHold("");
  renderCart();
  toast("ê²°ì œì™„ë£Œ");
};

$("#holdNow").onclick=pushHold;
$("#holdsBtn").onclick=openHolds;
$("#closeModal").onclick=closeHolds;
$("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeHolds(); });

/* =============================
   ë Œë”
============================= */
function renderAll(){
  buildTabs();
  renderPinned();
  renderGrid();
  renderCart();
}
function renderPinned(){
  const box = $("#pinnedGrid");
  box.innerHTML="";
  const pinnedItems = items.filter(x=>pins.has(x.id))
    .sort((a,b)=>a.ordNum-b.ordNum || a.name.localeCompare(b.name,"ko"));

  if(!pinnedItems.length){
    box.innerHTML = `<div class="emptyPinned">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ê¸¸ê²Œ ë˜ëŠ” ğŸ“Œ)</div>`;
    return;
  }
  pinnedItems.slice(0,12).forEach(x=>box.appendChild(makeCard(x,true)));
}

/* ì‹œì‘ */
buildTabs();
buildChosungKeys();
setCurrentHold(currentHoldId);
renderAll();
loadItems();
</script>
</body>
</html>
