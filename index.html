<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS (ì‹¤ë¬´ìš©)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 14px 46px rgba(0,0,0,.45);
    --r:18px;
  }
  *{box-sizing:border-box;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;}
  button,input{font:inherit}
  button{cursor:pointer; border:0; border-radius:14px;}
  .app{height:100%; display:grid; grid-template-columns: 1.35fr .95fr; gap:12px; padding:12px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden;}
  .left{display:flex; flex-direction:column; min-width:0;}
  .right{display:flex; flex-direction:column; min-width:0;}

  /* top bar */
  .topbar{padding:12px; display:flex; flex-direction:column; gap:10px; border-bottom:1px solid var(--line);}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .tab{
    padding:9px 12px; background:rgba(255,255,255,.03); color:var(--text);
    border:1px solid var(--line);
  }
  .tab.active{outline:2px solid rgba(255,159,0,.35); border-color:rgba(255,159,0,.35);}
  .row{display:flex; gap:10px; align-items:center;}
  .search{
    flex:1; display:flex; align-items:center; gap:10px;
    background:rgba(0,0,0,.22); border:1px solid var(--line); border-radius:14px; padding:10px 12px;
  }
  .search .icon{opacity:.8}
  .search input{
    width:100%; border:0; outline:0; background:transparent; color:var(--text);
    font-size:15px;
  }
  .sortBtn{
    white-space:nowrap;
    padding:10px 12px; background:rgba(255,255,255,.04);
    color:var(--text); border:1px solid var(--line);
  }
  .hint{font-size:12px; color:var(--muted); opacity:.9}

  /* chosung keys */
  .keys{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .k{
    padding:8px 10px; border:1px solid var(--line);
    background:rgba(255,255,255,.03); color:var(--text);
    border-radius:12px; font-weight:700; font-size:13px;
    min-width:36px; text-align:center;
  }
  .k.active{outline:2px solid rgba(255,159,0,.35); border-color:rgba(255,159,0,.35);}
  .k.clear{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.35);}

  /* pinned / grid */
  .sectionTitle{
    padding:10px 12px; display:flex; align-items:center; justify-content:space-between;
    color:var(--muted); font-weight:700; font-size:13px;
    border-bottom:1px solid var(--line);
  }
  .scroller{padding:12px; overflow:auto; min-height:0; flex:1;}
  .pinnedWrap{margin-bottom:12px;}
  .empty{color:var(--muted); font-size:13px; padding:10px 0;}
  .grid{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
  .item{
    position:relative;
    padding:12px 12px 10px;
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:16px;
    min-height:84px;
    display:flex; flex-direction:column; gap:6px;
  }
  .item .name{font-weight:900; font-size:18px; line-height:1.15; letter-spacing:-.2px;}
  .item .price{font-weight:800; font-size:13px; color:var(--muted);}
  .item .meta{display:flex; gap:6px; align-items:center; justify-content:space-between; margin-top:auto;}
  .badge{
    font-size:11px; color:var(--muted);
    border:1px solid var(--line); padding:4px 8px; border-radius:999px;
    background:rgba(0,0,0,.18);
  }
  .pinBtn{
    width:30px; height:30px; border-radius:10px;
    display:grid; place-items:center;
    border:1px solid var(--line); background:rgba(0,0,0,.18);
    opacity:.8;
  }
  .pinBtn.pinned{
    border-color:rgba(255,159,0,.45);
    background:rgba(255,159,0,.12);
    opacity:1;
  }
  .pinBtn svg{width:16px; height:16px; display:block}

  /* right header */
  .rTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .rtLeft{display:flex; flex-direction:column; gap:4px;}
  .rtTitle{color:var(--muted); font-size:13px; font-weight:800;}
  .rtTotal{font-size:34px; font-weight:1000; letter-spacing:-.6px;}
  .rtCount{color:var(--muted); font-size:13px; font-weight:800;}
  .rtBtns{display:flex; gap:8px; align-items:center;}
  .smallBtn{
    padding:9px 12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);
    border-radius:14px; font-weight:900; font-size:13px;
  }
  .smallBtn.accent{border-color:rgba(255,159,0,.45); background:rgba(255,159,0,.12);}
  .smallBtn.bad{border-color:rgba(255,59,48,.45); background:rgba(255,59,48,.10);}

  /* cart list */
  .cartBox{flex:1; min-height:0; overflow:auto; padding:10px 12px;}
  .cartEmpty{color:var(--muted); padding:12px 4px; font-size:14px;}
  .cartRow{
    display:grid;
    grid-template-columns: 1fr 42px 42px 42px;
    gap:8px;
    padding:10px 10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:16px;
    margin-bottom:10px;
    align-items:center;
  }
  .cartMain{min-width:0; display:flex; flex-direction:column; gap:3px;}
  .cartName{font-weight:950; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .cartSub{font-size:12px; color:var(--muted); font-weight:800;}
  .cBtn{
    width:42px; height:42px; border-radius:14px;
    border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--text);
    font-weight:1000; font-size:18px;
    display:grid; place-items:center;
  }
  .cBtn.del{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.35);}

  /* received/change + keypad */
  .payArea{
    padding:12px;
    border-top:1px solid var(--line);
    display:flex; flex-direction:column; gap:10px;
  }
  .moneyRow{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:16px;
  }
  .moneyRow .label{color:var(--muted); font-weight:900; font-size:13px;}
  .moneyRow .val{font-weight:1000; font-size:22px; letter-spacing:-.4px;}
  .moneyRow.small .val{font-size:18px;}
  .pads{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
  .pad{
    padding:14px 10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
    font-weight:1000;
    border-radius:16px;
    font-size:16px;
  }
  .pad.reset{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.35);}
  .bottomBar{
    display:flex; gap:10px; align-items:center;
  }
  .dueSave{
    width:120px;
    padding:14px 10px;
    border:1px solid rgba(255,159,0,.35);
    background:rgba(255,159,0,.10);
    color:var(--text);
    font-weight:1000;
    border-radius:16px;
    font-size:14px;
  }
  .payBtn{
    flex:1;
    padding:16px 14px;
    border-radius:16px;
    background:linear-gradient(180deg, rgba(255,159,0,1), rgba(255,140,0,1));
    color:#151515;
    font-weight:1100;
    font-size:18px;
  }

  /* due drawer */
  .drawer{
    position:fixed; inset:0; display:none;
    background:rgba(0,0,0,.55);
    z-index:1000;
  }
  .drawer.open{display:block;}
  .drawerPanel{
    position:absolute; top:0; right:0; height:100%; width:min(520px, 92vw);
    background:linear-gradient(180deg, rgba(17,19,25,.98), rgba(10,11,15,.98));
    border-left:1px solid var(--line);
    box-shadow: -12px 0 40px rgba(0,0,0,.55);
    display:flex; flex-direction:column;
  }
  .drawerHead{
    padding:14px 14px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .drawerHead .title{font-weight:1100; font-size:16px;}
  .drawerHead .sub{color:var(--muted); font-size:12px; font-weight:900;}
  .drawerList{padding:12px 14px; overflow:auto; flex:1; min-height:0;}
  .dueCard{
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    border-radius:16px;
    padding:12px;
    margin-bottom:10px;
    display:flex; flex-direction:column; gap:6px;
  }
  .dueTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .dueId{font-weight:1100;}
  .dueSum{font-weight:1100;}
  .dueMeta{color:var(--muted); font-size:12px; font-weight:900;}
  .dueBtns{display:flex; gap:8px; margin-top:6px;}
  .dueBtns button{flex:1; padding:10px 10px; border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--text); font-weight:1000;}
  .dueBtns .load{border-color:rgba(255,159,0,.35); background:rgba(255,159,0,.10);}
  .dueBtns .del{border-color:rgba(255,59,48,.35); background:rgba(255,59,48,.10);}

  /* responsive */
  @media (max-width: 1100px){
    .app{grid-template-columns: 1fr;}
    .right{order:-1;}
    .grid{grid-template-columns: repeat(3, minmax(0,1fr));}
  }
  @media (max-width: 720px){
    .grid{grid-template-columns: repeat(2, minmax(0,1fr));}
    .rtTotal{font-size:30px;}
  }
</style>
</head>
<body>
<div class="app">

  <!-- LEFT -->
  <div class="card left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="row">
        <div class="search">
          <span class="icon">ğŸ”</span>
          <input id="q" type="text" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="keys" id="keys"></div>

      <div class="hint">
        â€¢ ìƒí’ˆ í´ë¦­=ë‹´ê¸° Â· í•€=ê³ ì •(ìƒë‹¨) Â· ê²€ìƒ‰ì€ <b>íƒ­ê³¼ ë¬´ê´€í•˜ê²Œ ì „í’ˆëª©</b> Â· ê³ ì •ì€ â€œê¸¸ê²Œ ëˆŒëŸ¬â€ë„ ê°€ëŠ¥(PCëŠ” í•€ í´ë¦­)
      </div>
    </div>

    <div class="scroller">
      <div class="pinnedWrap">
        <div class="sectionTitle">
          <span>ê³ ì • Â· ìƒë‹¨</span>
          <span class="hint" id="pinHint">ê³ ì •ì€ â€œí•€â€ ë²„íŠ¼</span>
        </div>
        <div id="pinned" class="grid" style="padding-top:10px;"></div>
        <div id="pinnedEmpty" class="empty" style="display:none;">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ìƒí’ˆ ì¹´ë“œì˜ í•€ì„ ëˆŒëŸ¬ ê³ ì •)</div>
      </div>

      <div class="sectionTitle">
        <span id="listTitle">ì „ì²´ ìƒí’ˆ</span>
        <span class="hint" id="listHint"></span>
      </div>
      <div id="grid" class="grid" style="padding-top:10px;"></div>
      <div id="gridEmpty" class="empty" style="display:none;">í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card right">
    <div class="rTop">
      <div class="rtLeft">
        <div class="rtTitle">ì´í•©ê³„ / ì´ê°¯ìˆ˜</div>
        <div class="rtTotal" id="totalText">0ì›</div>
        <div class="rtCount" id="countText">0ê°œ</div>
      </div>
      <div class="rtBtns">
        <button class="smallBtn" id="btnResetAll">ìƒˆë¡œê³ ì¹¨</button>
        <button class="smallBtn accent" id="btnDue">ë¯¸ìˆ˜(0)</button>
      </div>
    </div>

    <div class="cartBox" id="cartBox">
      <div class="cartEmpty" id="cartEmpty">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.</div>
      <div id="cartList"></div>
      <!-- 7ì¤„ í™•ë³´ìš© (ë¹ˆì¤„ ëŠë‚Œ) -->
      <div id="cartPad" style="height:160px; opacity:.15"></div>
    </div>

    <div class="payArea">
      <div class="moneyRow">
        <div class="label">ë°›ì€ëˆ</div>
        <div class="val" id="receivedText">0ì›</div>
      </div>
      <div class="moneyRow small">
        <div class="label">ê±°ìŠ¤ë¦„ëˆ</div>
        <div class="val" id="changeText">0ì›</div>
      </div>

      <div class="pads">
        <button class="pad" data-add="500">+500</button>
        <button class="pad" data-add="1000">+1ì²œ</button>
        <button class="pad" data-add="5000">+5ì²œ</button>
        <button class="pad" data-add="10000">+1ë§Œ</button>
        <button class="pad" data-add="50000">+5ë§Œ</button>
        <button class="pad reset" id="btnResetReceived">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomBar">
        <button class="dueSave" id="btnParkDue">ë¯¸ìˆ˜<br><span style="font-size:11px; font-weight:900; opacity:.8">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</span></button>
        <button class="payBtn" id="btnPay">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </div>
</div>

<!-- ë¯¸ìˆ˜ Drawer -->
<div class="drawer" id="drawer">
  <div class="drawerPanel">
    <div class="drawerHead">
      <div>
        <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
        <div class="sub" id="dueSub">0ê±´</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="smallBtn" id="btnBackToCurrent">í˜„ì¬ë¡œ</button>
        <button class="smallBtn bad" id="btnCloseDrawer">ë‹«ê¸°</button>
      </div>
    </div>
    <div class="drawerList" id="dueList"></div>
    <div style="padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:10px;">
      <button class="smallBtn" id="btnExport" style="flex:1;">ë°±ì—… ë‚´ë³´ë‚´ê¸°</button>
      <button class="smallBtn" id="btnImport" style="flex:1;">ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </div>
</div>

<script>
/* =========================================================
   âœ… ì—„ê°€ë„¤ POS (ì‹¤ë¬´ ìµœì¢…)
   - ì¹´í…Œê³ ë¦¬ ìˆœì„œ: ê³¼ì¼ â†’ ì•¼ì±„ â†’ ë´‰ì±„ì†Œ â†’ ìƒì„  â†’ ê¸°íƒ€
   - ê²€ìƒ‰: ì „ì¹´í…Œê³ ë¦¬(íƒ­ ë¬´ê´€) + ì´ˆì„±/ë³µí•©ì´ˆì„±(ã„±ã…ˆ, ã„±ã„´ã„·)
   - ê³ ì •í•€: ê³ ì •í•œ ê²ƒë§Œ í•€ í‘œì‹œ(ì „ì²´ê°€ ë¹¨ê°„ í•€ X)
   - ë¯¸ìˆ˜: ì—¬ëŸ¬ê±´ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(1,2,3â€¦)
   - ì´ˆê¸°í™” ë²„íŠ¼: ë°›ì€ëˆë§Œ ë¦¬ì…‹
   - ê²°ì œì™„ë£Œ: í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆ ì´ˆê¸°í™”
   ========================================================= */

(function(){
  // ====== ë²„ì „(ê¼¬ì„ ë°©ì§€) ======
  const APP_VER = "umgane_pos2_v20251224_final_01";
  const LS = {
    VER: "UMG2_VER",
    ITEMS: "UMG2_ITEMS_V1",
    PINS: "UMG2_PINS_V1",
    CARTS: "UMG2_CARTS_V1",     // { current:{id:qty...}, due_1:{...} ... }
    ACTIVE: "UMG2_ACTIVE_CART", // "current" or "due_1"
    DUES: "UMG2_DUES_V1",       // [{key:"due_1", createdAt, note, received, cartSnapshot}] - cartSnapshot optional
    RECEIVED: "UMG2_RECEIVED_V1",
    SORTMODE: "UMG2_SORTMODE_V1",
    TAB: "UMG2_TAB_V1",
    Q: "UMG2_Q_V1",
    CHO: "UMG2_CHO_V1"
  };

  function ensureVersion(){
    const prev = localStorage.getItem(LS.VER);
    if(prev !== APP_VER){
      // ìƒí’ˆ(ITEMS)ì€ ì‚´ë¦¬ê³ , ìƒíƒœë§Œ ì´ˆê¸°í™”
      localStorage.setItem(LS.VER, APP_VER);
      localStorage.removeItem(LS.PINS);
      localStorage.removeItem(LS.CARTS);
      localStorage.removeItem(LS.ACTIVE);
      localStorage.removeItem(LS.DUES);
      localStorage.removeItem(LS.RECEIVED);
      localStorage.removeItem(LS.SORTMODE);
      localStorage.removeItem(LS.TAB);
      localStorage.removeItem(LS.Q);
      localStorage.removeItem(LS.CHO);
    }
  }
  ensureVersion();

  // ====== ìœ í‹¸ ======
  const KRW = n => (n||0).toLocaleString("ko-KR") + "ì›";
  const nowISO = () => new Date().toISOString();
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function parsePrice(v){
    if(v==null) return 0;
    const s = String(v).trim();
    if(!s) return 0;
    // "5,000.00" / "5000.00" / "5000" / "5,000"
    const cleaned = s.replace(/[^\d.]/g,"");
    if(!cleaned) return 0;
    const num = Number(cleaned);
    if(!isFinite(num)) return 0;
    return Math.round(num); // ì› ë‹¨ìœ„
  }

  const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  function getChoChar(ch){
    const code = ch.charCodeAt(0);
    if(code < 0xAC00 || code > 0xD7A3) return ch; // í•œê¸€ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ
    const idx = Math.floor((code - 0xAC00) / (21*28));
    return CHO[idx] || ch;
  }
  function toChosung(str){
    return Array.from(String(str||"")).map(getChoChar).join("");
  }
  // "ã„±ã…ˆ" ê°™ì€ ì…ë ¥ì„ ê·¸ëŒ€ë¡œ í¬í•¨ê²€ìƒ‰ ê°€ëŠ¥í•˜ê²Œ
  function normalizeQuery(q){
    return String(q||"").trim();
  }

  // ====== ì¹´í…Œê³ ë¦¬ ìˆœì„œ ê³ ì • ======
  const CAT_ORDER = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  function normCat(c){
    c = (c||"").trim();
    if(!c) return "ê¸°íƒ€";
    // í”í•œ ì˜¤íƒ€/ë³€í˜• í¡ìˆ˜
    if(c==="ë´‰ì§€ì±„ì†Œ") c="ë´‰ì±„ì†Œ";
    if(c==="ë´‰ì±„ì†Œ") return "ë´‰ì±„ì†Œ";
    if(c==="ì±„ì†Œ") return "ì•¼ì±„";
    if(c==="ì•¼ì±„") return "ì•¼ì±„";
    if(c==="ê³¼ì¼") return "ê³¼ì¼";
    if(c==="ìƒì„ " || c==="ìˆ˜ì‚°" || c==="í•´ì‚°") return "ìƒì„ ";
    return "ê¸°íƒ€";
  }

  // ====== ê¸°ë³¸ ìƒí’ˆ ë°ì´í„°(ë„¤ê°€ ë¶™ì—¬ì¤€ ê²ƒ í¬í•¨) ======
  // (ì›í•˜ë©´ ì—¬ê¸°ë§Œ í†µìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
  const DEFAULT_TSV = `
id\tcat\tname\tprice\tactive\tord
S01\tê³¼ì¼\të‹¨ê°/3ê°œ\t5,000.00\t1\t2
S02\tê³¼ì¼\të‹¨ê°/7ê°œ\t10,000.00\t1\t3
S03\tê³¼ì¼\tì‚¬ê³¼/3ê°œ\t5,000.00\t1\t4
S04\tê³¼ì¼\tì‚¬ê³¼/7ê°œ\t10,000.00\t1\t5
S05\tê³¼ì¼\tëŒ€ë´‰/6ê°œ\t5,000.00\t1\t6
S06\tê³¼ì¼\tëŒ€ë´‰/13ê°œ\t10,000.00\t1\t7
S07\tê³¼ì¼\tê·¤/9ê°œ\t3,000.00\t1\t8
S08\tê³¼ì¼\tê·¤/20ê°œ\t6,000.00\t1\t9
S09\tê³¼ì¼\tìƒ¤ì¸/2ì†¡ì´\t8,000.00\t1\t12
S10\tê³¼ì¼\tí‚¤ìœ„\t10,000.00\t1\t17
S11\tê³¼ì¼\tì„ë¥˜/1ê°œ\t3,500.00\t1\t18
S12\tê³¼ì¼\tì„ë¥˜/3ê°œ\t10,000.00\t1\t19
S13\tê³¼ì¼\të°”ë‚˜ë‚˜\t2,500.00\t1\t1
S14\tê³¼ì¼\tíŒŒì¸ì• í”Œ\t4,000.00\t1\t20
S15\tê³¼ì¼\të”¸ê¸°/1íŒ©\t8,000.00\t1\t10
S16\tê³¼ì¼\të”¸ê¸°/2íŒ©\t15,000.00\t1\t11
S17\tê³¼ì¼\tí† ë§ˆí† \t10,000.00\t1\t13
S18\tê³¼ì¼\të°©ìš¸í† ë§ˆí† /1íŒ©\t6,000.00\t1\t14
S19\tê³¼ì¼\të°©ìš¸í† ë§ˆí† /2íŒ©\t11,000.00\t1\t15
S20\tê³¼ì¼\tì²´ë¦¬\t12,000.00\t1\t16

S21\tì•¼ì±„\të‹¹ê·¼\t2,500.00\t1\t01
S22\tì•¼ì±„\tê°ì\t3,000.00\t1\t02
S23\tì•¼ì±„\tê³ êµ¬ë§ˆ\t3,000.00\t1\t03
S24\tì•¼ì±„\tì–‘íŒŒ\t2,500.00\t1\t04
S25\tì•¼ì±„\tì²­ì–‘\t3,000.00\t1\t05
S26\tì•¼ì±„\tì•„ì‚­ì´\t3,500.00\t1\t06
S27\tì•¼ì±„\tê½ˆë¦¬\t4,000.00\t1\t07
S28\tì•¼ì±„\tí‘œê³ \t5,000.00\t1\t08
S29\tì•¼ì±„\tëŠíƒ€ë¦¬\t2,500.00\t1\t09
S30\tì•¼ì±„\tìƒˆì†¡ì´/1ë´‰\t1,500.00\t1\t010
S31\tì•¼ì±„\tìƒˆì†¡ì´/2ë´‰\t2,500.00\t1\t011
S32\tì•¼ì±„\tíŒ½ì´/3ë´‰\t1,000.00\t1\t012
S33\tì•¼ì±„\tì˜¤ì´/6ê°œ\t3,000.00\t1\t014
S34\tì•¼ì±„\tê°€ì§€/4ê°œ\t3,000.00\t1\t015
S35\tì•¼ì±„\tì• í˜¸ë°•/3ê°œ\t3,500.00\t1\t013
S36\tì•¼ì±„\të¸Œë¡œì½œë¦¬/1ê°œ\t1,300.00\t1\t016
S37\tì•¼ì±„\të¸Œë¡œì½œë¦¬/3ê°œ\t3,000.00\t1\t017
S38\tì•¼ì±„\tìƒëŸ¬ë¦¬\t2,000.00\t1\t018
S39\tì•¼ì±„\të¯¸ë‚˜ë¦¬\t3,000.00\t1\t019
S40\tì•¼ì±„\tìš°ì—‰\t3,000.00\t1\t020
S41\tì•¼ì±„\tì—°ê·¼\t3,000.00\t1\t021
S42\tì•¼ì±„\të”ë•\t6,000.00\t1\t022
S43\tì•¼ì±„\tì•Œë°°ê¸°\t5,000.00\t1\t023
S44\tì•¼ì±„\tì–‘ë°°ì¶”\t2,000.00\t1\t024
S45\tì•¼ì±„\tì–‘ìƒì¶”\t1,500.00\t1\t025
S46\tì•¼ì±„\tëŒ€íŒŒ\t1,000.00\t1\t026
S47\tì•¼ì±„\tìª½íŒŒ\t4,000.00\t1\t027
S48\tì•¼ì±„\të¶€ì¶”\t2,000.00\t1\t028
S49\tì•¼ì±„\të¬´\t1,500.00\t1\t029
S50\tì•¼ì±„\të§ˆëŠ˜/ì‘ì€\t1,500.00\t1\t030
S51\tì•¼ì±„\të§ˆëŠ˜/í°\t5,000.00\t1\t031

S52\të´‰ì±„ì†Œ\tì‹œê¸ˆì¹˜/1ë´‰ì§€\t2,000.00\t1\t001
S53\të´‰ì±„ì†Œ\tì‹œê¸ˆì¹˜/1ë‹¨\t1,500.00\t1\t002
S54\të´‰ì±„ì†Œ\tìƒì¶”\t1,000.00\t1\t003
S55\të´‰ì±„ì†Œ\tê¹»ì\t1,000.00\t1\t004
S56\të´‰ì±„ì†Œ\tì½©ë‚˜ë¬¼\t500.00\t1\t005
S57\të´‰ì±„ì†Œ\tìˆ™ì£¼\t1,000.00\t1\t006
S58\të´‰ì±„ì†Œ\tì²­ê²½ì±„\t1,000.00\t1\t007
S59\të´‰ì±„ì†Œ\tì¼€ì¼\t1,000.00\t1\t008
S60\të´‰ì±„ì†Œ\tì¹˜ì»¤ë¦¬\t1,000.00\t1\t009
S61\të´‰ì±„ì†Œ\tì ê²¨ì\t1,000.00\t1\t0010
S62\të´‰ì±„ì†Œ\tê·¼ëŒ€\t1,000.00\t1\t0011
S63\të´‰ì±„ì†Œ\tì•„ìš±\t1,500.00\t1\t0012
S64\të´‰ì±„ì†Œ\tê³ ì¶”ì\t2,000.00\t1\t0013
S65\të´‰ì±„ì†Œ\tì‘¥ê°“\t1,500.00\t1\t0014
S66\të´‰ì±„ì†Œ\tì°¸ë‚˜ë¬¼\t1,500.00\t1\t0015
S67\të´‰ì±„ì†Œ\tì·¨ë‚˜ë¬¼\t2,000.00\t1\t0016

S68\tìƒì„ \të™íƒœ/1ë§ˆë¦¬\t3,000.00\t1\t0001
S69\tìƒì„ \të™íƒœ/2ë§ˆë¦¬\t5,000.00\t1\t0002
S70\tìƒì„ \tì˜¤ì§•ì–´/1ë§ˆë¦¬\t3,000.00\t1\t0003
S71\tìƒì„ \tì˜¤ì§•ì–´/2ë§ˆë¦¬\t5,000.00\t1\t0004
S72\tìƒì„ \tê¼¬ë§‰/1ë§\t3,000.00\t1\t0005
S73\tìƒì„ \tê¼¬ë§‰/2ë§\t5,000.00\t1\t0006
S74\tìƒì„ \tì½”ë‹¤ë¦¬/1ì½”\t8,000.00\t1\t0007
S75\tìƒì„ \tì½”ë‹¤ë¦¬/2ì½”\t15,000.00\t1\t0008
S76\tìƒì„ \tê°ˆì¹˜\t7,000.00\t1\t0009
S77\tìƒì„ \têµ´ë¹„\t10,000.00\t1\t00010
S78\tìƒì„ \të²ˆë°ê¸°/1ë´‰\t3,000.00\t1\t00011
S79\tìƒì„ \të²ˆë°ê¸°/2ë´‰\t5,000.00\t1\t00012
S80\tìƒì„ \têµ´/1ë´‰\t3,000.00\t1\t00013
S81\tìƒì„ \têµ´/2ë´‰\t5,000.00\t1\t00014
S82\tìƒì„ \të™íƒœí¬/1íŒ©\t3,000.00\t1\t00015
S83\tìƒì„ \të™íƒœí¬/2íŒ©\t5,000.00\t1\t00016
S84\tìƒì„ \të‚€ë”°ë¡œ\t5,000.00\t1\t00017
S85\tìƒì„ \tì‚¼ì¹˜\t5,000.00\t1\t00018
S86\tìƒì„ \tê³ ë“±ì–´/1ë§ˆë¦¬\t3,500.00\t1\t00019
S87\tìƒì„ \tê³ ë“±ì–´/3ë§ˆë¦¬\t10,000.00\t1\t00020
S88\tìƒì„ \tìë°˜\t6,000.00\t1\t00021
`.trim();

  function parseTSV(text){
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length<2) return [];
    const header = lines[0].split("\t").map(s=>s.trim());
    const idx = (k)=>header.indexOf(k);
    const iId=idx("id"), iCat=idx("cat"), iName=idx("name"), iPrice=idx("price"), iActive=idx("active"), iOrd=idx("ord");
    const out=[];
    for(let r=1;r<lines.length;r++){
      const cols = lines[r].split("\t");
      const id = (cols[iId]||"").trim();
      if(!id) continue;
      const cat = normCat(cols[iCat]);
      const name = (cols[iName]||"").trim();
      const price = parsePrice(cols[iPrice]);
      const active = String(cols[iActive]||"1").trim()!=="0";
      const ordRaw = (cols[iOrd]||"").trim();
      const ord = ordRaw==="" ? "" : ordRaw;
      out.push({
        id, cat, name, price, active, ord,
        cho: toChosung(name),
        nameLower: (name||"").toLowerCase()
      });
    }
    return out;
  }

  function loadItems(){
    const raw = localStorage.getItem(LS.ITEMS);
    if(raw){
      try{
        const arr = JSON.parse(raw);
        if(Array.isArray(arr) && arr.length){
          // ë³´ì •
          return arr.map(x=>({
            ...x,
            cat:normCat(x.cat),
            price:parsePrice(x.price),
            active: !!x.active,
            cho: x.cho || toChosung(x.name),
            nameLower: (x.name||"").toLowerCase()
          }));
        }
      }catch(e){}
    }
    const items = parseTSV(DEFAULT_TSV);
    localStorage.setItem(LS.ITEMS, JSON.stringify(items));
    return items;
  }

  function saveItems(items){
    localStorage.setItem(LS.ITEMS, JSON.stringify(items));
  }

  // ====== ìƒíƒœ ======
  let items = loadItems();

  function getPins(){
    const raw = localStorage.getItem(LS.PINS);
    if(!raw) return {};
    try{ return JSON.parse(raw)||{} }catch(e){ return {} }
  }
  function setPins(p){ localStorage.setItem(LS.PINS, JSON.stringify(p||{})); }

  function getCarts(){
    const raw = localStorage.getItem(LS.CARTS);
    if(!raw) return { current:{} };
    try{
      const obj = JSON.parse(raw)||{};
      if(!obj.current) obj.current={};
      return obj;
    }catch(e){
      return { current:{} };
    }
  }
  function setCarts(c){ localStorage.setItem(LS.CARTS, JSON.stringify(c)); }

  function getActiveKey(){
    return localStorage.getItem(LS.ACTIVE) || "current";
  }
  function setActiveKey(k){
    localStorage.setItem(LS.ACTIVE, k);
  }

  function getDues(){
    const raw = localStorage.getItem(LS.DUES);
    if(!raw) return [];
    try{ return JSON.parse(raw)||[] }catch(e){ return [] }
  }
  function setDues(arr){ localStorage.setItem(LS.DUES, JSON.stringify(arr||[])); }

  function getReceived(){
    const raw = localStorage.getItem(LS.RECEIVED);
    const n = raw? Number(raw):0;
    return isFinite(n)? n:0;
  }
  function setReceived(v){
    localStorage.setItem(LS.RECEIVED, String(Math.max(0, Math.round(v||0))));
  }

  function getSortMode(){
    return localStorage.getItem(LS.SORTMODE) || "pin_ord";
  }
  function setSortMode(m){
    localStorage.setItem(LS.SORTMODE, m);
  }

  function getTab(){
    return localStorage.getItem(LS.TAB) || "ê³¼ì¼";
  }
  function setTab(t){ localStorage.setItem(LS.TAB, t); }

  function getQ(){ return localStorage.getItem(LS.Q) || ""; }
  function setQ(v){ localStorage.setItem(LS.Q, v||""); }

  function getChoSel(){ return localStorage.getItem(LS.CHO) || ""; }
  function setChoSel(v){ localStorage.setItem(LS.CHO, v||""); }

  // ====== DOM ======
  const elTabs = document.getElementById("tabs");
  const elKeys = document.getElementById("keys");
  const elQ = document.getElementById("q");
  const elSortBtn = document.getElementById("sortBtn");
  const elPinned = document.getElementById("pinned");
  const elPinnedEmpty = document.getElementById("pinnedEmpty");
  const elGrid = document.getElementById("grid");
  const elGridEmpty = document.getElementById("gridEmpty");
  const elListTitle = document.getElementById("listTitle");
  const elListHint = document.getElementById("listHint");

  const elTotal = document.getElementById("totalText");
  const elCount = document.getElementById("countText");
  const elCartList = document.getElementById("cartList");
  const elCartEmpty = document.getElementById("cartEmpty");
  const elReceived = document.getElementById("receivedText");
  const elChange = document.getElementById("changeText");
  const elBtnResetAll = document.getElementById("btnResetAll");
  const elBtnDue = document.getElementById("btnDue");
  const elBtnParkDue = document.getElementById("btnParkDue");
  const elBtnPay = document.getElementById("btnPay");
  const elBtnResetReceived = document.getElementById("btnResetReceived");

  const drawer = document.getElementById("drawer");
  const dueListEl = document.getElementById("dueList");
  const dueSub = document.getElementById("dueSub");
  const btnCloseDrawer = document.getElementById("btnCloseDrawer");
  const btnBackToCurrent = document.getElementById("btnBackToCurrent");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const importFile = document.getElementById("importFile");

  // ====== ë Œë” ======
  function buildTabs(){
    elTabs.innerHTML = "";
    const cur = getTab();
    for(const c of CAT_ORDER){
      const b = document.createElement("button");
      b.className = "tab" + (c===cur ? " active":"");
      b.textContent = c;
      b.onclick = () => { setTab(c); renderAll(); };
      elTabs.appendChild(b);
    }
  }

  function buildKeys(){
    elKeys.innerHTML = "";
    const sel = getChoSel();
    const choRow = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    for(const k of choRow){
      const b=document.createElement("button");
      b.className="k"+(sel===k?" active":"");
      b.textContent=k;
      b.onclick=()=>{ setChoSel(sel===k?"":k); renderAll(); };
      elKeys.appendChild(b);
    }
    const clear=document.createElement("button");
    clear.className="k clear";
    clear.textContent="X";
    clear.onclick=()=>{ setChoSel(""); renderAll(); };
    elKeys.appendChild(clear);
  }

  function sortItems(list){
    const pins = getPins();
    const mode = getSortMode(); // pin_ord only now
    const toOrdNum = (o)=>{
      if(o==null) return 1e15;
      const s=String(o).trim();
      if(!s) return 1e15;
      const n=Number(s.replace(/[^\d]/g,""));
      return isFinite(n)? n:1e15;
    };
    return list.slice().sort((a,b)=>{
      // pinned first
      const ap = pins[a.id] ? 1:0;
      const bp = pins[b.id] ? 1:0;
      if(bp!==ap) return bp-ap;
      // ord
      const ao = toOrdNum(a.ord);
      const bo = toOrdNum(b.ord);
      if(ao!==bo) return ao-bo;
      // name
      return String(a.name).localeCompare(String(b.name),"ko");
    });
  }

  function matchesSearch(item, q, choSel){
    if(!item.active) return false;

    const nq = normalizeQuery(q);
    const hasQ = !!nq;
    const hasCho = !!choSel;

    if(!hasQ && !hasCho) return true;

    // ì´ˆì„±í‚¤ í•„í„°: "ã„±"ì´ë©´ item.choì— "ã„±" í¬í•¨
    if(hasCho){
      if(!item.cho.includes(choSel)) return false;
    }

    if(hasQ){
      // 1) ì¼ë°˜ í…ìŠ¤íŠ¸ í¬í•¨
      const low = nq.toLowerCase();
      const byName = item.nameLower.includes(low);
      // 2) ì´ˆì„± ë¬¸ìì—´ í¬í•¨ (ì˜ˆ: ã„±ã…ˆ, ã„±ã„´ã„·)
      const byCho = item.cho.includes(nq);
      // 3) ì„ì–´ì„œë„ ê°€ëŠ¥: "ê°ã…ˆ" ê°™ì€ ê±´ ê·¸ëƒ¥ name ê¸°ì¤€ì— ê±¸ë¦¼
      if(!(byName || byCho)) return false;
    }
    return true;
  }

  function itemCard(item){
    const pins = getPins();
    const wrap = document.createElement("div");
    wrap.className = "item";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = item.name;

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = KRW(item.price);

    const meta = document.createElement("div");
    meta.className = "meta";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = item.cat;

    const pin = document.createElement("button");
    pin.className = "pinBtn" + (pins[item.id] ? " pinned":"");
    pin.title = pins[item.id] ? "ê³ ì • í•´ì œ":"ê³ ì •";
    pin.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M14 3l7 7-3 3v3l-4 4v-3L8 11h3l3-3z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
      </svg>
    `;
    pin.onclick = (e)=>{
      e.stopPropagation();
      const p = getPins();
      if(p[item.id]) delete p[item.id];
      else p[item.id]=true;
      setPins(p);
      renderAll();
    };

    meta.appendChild(badge);
    meta.appendChild(pin);

    wrap.appendChild(name);
    wrap.appendChild(price);
    wrap.appendChild(meta);

    // í´ë¦­=ë‹´ê¸°
    wrap.onclick = ()=> addToCart(item.id, 1);

    // ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •(ëª¨ë°”ì¼/ì‹¤ë¬´)
    let pressTimer=null;
    wrap.addEventListener("pointerdown", ()=>{
      pressTimer = setTimeout(()=>{
        const p = getPins();
        if(p[item.id]) delete p[item.id]; else p[item.id]=true;
        setPins(p);
        renderAll();
      }, 450);
    });
    ["pointerup","pointercancel","pointerleave"].forEach(ev=>{
      wrap.addEventListener(ev, ()=>{ if(pressTimer){clearTimeout(pressTimer); pressTimer=null;} });
    });

    return wrap;
  }

  function getActiveCart(){
    const carts = getCarts();
    const key = getActiveKey();
    return carts[key] || {};
  }
  function setActiveCart(obj){
    const carts = getCarts();
    const key = getActiveKey();
    carts[key] = obj || {};
    setCarts(carts);
  }

  function addToCart(id, delta){
    const cart = getActiveCart();
    cart[id] = (cart[id]||0) + delta;
    if(cart[id] <= 0) delete cart[id];
    setActiveCart(cart);
    renderRight();
  }
  function removeFromCart(id){
    const cart = getActiveCart();
    delete cart[id];
    setActiveCart(cart);
    renderRight();
  }

  function cartTotals(cart){
    let sum=0, cnt=0;
    for(const [id,qty] of Object.entries(cart)){
      const it = items.find(x=>x.id===id);
      if(!it) continue;
      const q = qty||0;
      cnt += q;
      sum += it.price * q;
    }
    return {sum, cnt};
  }

  function renderPinnedAndGrid(){
    const tab = getTab();
    const q = elQ.value;
    const choSel = getChoSel();

    // ê²€ìƒ‰ì€ ì „ì¹´í…Œê³ ë¦¬(íƒ­ ë¬´ê´€) ìš”êµ¬ì‚¬í•­
    const filteredAll = items.filter(it => matchesSearch(it, q, choSel));
    const sortedAll = sortItems(filteredAll);

    // ê³ ì • ëª©ë¡
    const pins = getPins();
    const pinnedItems = sortedAll.filter(it => pins[it.id]);
    elPinned.innerHTML = "";
    if(pinnedItems.length){
      elPinnedEmpty.style.display="none";
      pinnedItems.forEach(it=> elPinned.appendChild(itemCard(it)));
    }else{
      elPinnedEmpty.style.display="block";
    }

    // ë©”ì¸ ë¦¬ìŠ¤íŠ¸ëŠ” "íƒ­" ê¸°ì¤€ìœ¼ë¡œ ë³´ì—¬ì£¼ë˜, ê²€ìƒ‰ì¤‘ì´ë©´ ì „í’ˆëª©ì´ë‹ˆê¹Œ íƒ­ í•„í„°ë¥¼ í’€ì–´ë„ ë¨
    const hasSearch = !!normalizeQuery(q) || !!choSel;
    let mainList = sortedAll;
    if(!hasSearch){
      mainList = sortedAll.filter(it => it.cat === tab);
      elListTitle.textContent = tab + " ìƒí’ˆ";
      elListHint.textContent = "íƒ­ ê¸°ì¤€ í‘œì‹œ";
    }else{
      elListTitle.textContent = "ê²€ìƒ‰ ê²°ê³¼ (ì „ì¹´í…Œê³ ë¦¬)";
      elListHint.textContent = "íƒ­ ë¬´ê´€";
    }

    elGrid.innerHTML="";
    if(mainList.length){
      elGridEmpty.style.display="none";
      mainList.forEach(it=> elGrid.appendChild(itemCard(it)));
    }else{
      elGridEmpty.style.display="block";
    }
  }

  function renderRight(){
    const cart = getActiveCart();
    const {sum, cnt} = cartTotals(cart);

    elTotal.textContent = KRW(sum);
    elCount.textContent = cnt + "ê°œ";

    // ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ
    const received = getReceived();
    elReceived.textContent = KRW(received);
    const change = Math.max(0, received - sum);
    elChange.textContent = KRW(change);

    // ì¥ë°”êµ¬ë‹ˆ ë Œë” (í•œ ì¤„)
    const ids = Object.keys(cart);
    elCartList.innerHTML="";
    if(ids.length===0){
      elCartEmpty.style.display="block";
    }else{
      elCartEmpty.style.display="none";
      // ì¥ë°”êµ¬ë‹ˆ ìˆœì„œëŠ” "ì¶”ê°€ ìˆœ"ì´ ì•„ë‹ˆë¼ ì´ë¦„/ord ì„ì´ì§€ ì•Šê²Œ id ê¸°ì¤€ ìœ ì§€
      ids.forEach(id=>{
        const it = items.find(x=>x.id===id);
        if(!it) return;
        const qty = cart[id]||0;
        const row = document.createElement("div");
        row.className="cartRow";

        const main = document.createElement("div");
        main.className="cartMain";
        const nm = document.createElement("div");
        nm.className="cartName";
        nm.textContent = `${it.name} x${qty}`;
        const sub = document.createElement("div");
        sub.className="cartSub";
        sub.textContent = `${KRW(it.price)} Â· ${KRW(it.price*qty)}`;
        main.appendChild(nm); main.appendChild(sub);

        const bMinus=document.createElement("button");
        bMinus.className="cBtn"; bMinus.textContent="â€“";
        bMinus.onclick=()=>addToCart(id,-1);

        const bPlus=document.createElement("button");
        bPlus.className="cBtn"; bPlus.textContent="+";
        bPlus.onclick=()=>addToCart(id, +1);

        const bDel=document.createElement("button");
        bDel.className="cBtn del"; bDel.textContent="Ã—";
        bDel.onclick=()=>removeFromCart(id);

        row.appendChild(main);
        row.appendChild(bMinus);
        row.appendChild(bPlus);
        row.appendChild(bDel);
        elCartList.appendChild(row);
      });
    }

    // ë¯¸ìˆ˜ ë²„íŠ¼ ì¹´ìš´íŠ¸
    const dues = getDues();
    elBtnDue.textContent = `ë¯¸ìˆ˜(${dues.length})`;
  }

  function renderAll(){
    buildTabs();
    buildKeys();
    renderPinnedAndGrid();
    renderRight();
  }

  // ====== ë¯¸ìˆ˜ ë¡œì§ ======
  function nextDueKey(){
    const dues = getDues();
    // due_1, due_2 ...
    let n=1;
    const used = new Set(dues.map(d=>d.key));
    while(used.has("due_"+n)) n++;
    return "due_"+n;
  }

  function parkCurrentAsDue(){
    const carts = getCarts();
    const activeKey = getActiveKey();
    const activeCart = carts[activeKey] || {};
    const ids = Object.keys(activeCart);
    if(ids.length===0){
      alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    // í˜„ì¬ activeê°€ due_* ì´ì–´ë„ "ê·¸ ìƒíƒœ"ë¥¼ ë¯¸ìˆ˜ë¡œ ì €ì¥í•´ë„ ë˜ì§€ë§Œ,
    // ì‹¤ë¬´ì—ì„œëŠ” ë³´í†µ currentë¥¼ ì €ì¥í•˜ê³  currentë¥¼ ë¹„ìš°ëŠ” íë¦„ì´ í¸í•¨.
    // ê·¸ë˜ì„œ: ì§€ê¸ˆ activeê°€ currentê°€ ì•„ë‹ˆë©´, ì¼ë‹¨ currentë¡œ ëŒë¦¬ë„ë¡ ì•ˆë‚´
    // (í•˜ì§€ë§Œ ê°•ì œí•˜ì§€ëŠ” ì•Šê³  í˜„ì¬ active ê·¸ëŒ€ë¡œ ì €ì¥)
    const dueKey = nextDueKey();
    carts[dueKey] = JSON.parse(JSON.stringify(activeCart));
    setCarts(carts);

    const dueArr = getDues();
    const {sum, cnt} = cartTotals(activeCart);
    dueArr.unshift({
      key: dueKey,
      createdAt: nowISO(),
      total: sum,
      count: cnt
    });
    setDues(dueArr);

    // ì €ì¥ í›„: activeë¥¼ currentë¡œ ë‘ê³  currentë¥¼ ë¹„ì›Œì„œ ë‹¤ìŒì†ë‹˜ ë°”ë¡œ ë°›ê²Œ
    setActiveKey("current");
    carts["current"] = {};
    setCarts(carts);

    // ë°›ì€ëˆì€ ê·¸ëŒ€ë¡œ ë‘ë©´ í—·ê°ˆë¦¬ë‹ˆ 0ìœ¼ë¡œ
    setReceived(0);

    renderAll();
  }

  function openDrawer(){
    drawer.classList.add("open");
    renderDueDrawer();
  }
  function closeDrawer(){
    drawer.classList.remove("open");
  }

  function renderDueDrawer(){
    const dues = getDues();
    dueSub.textContent = `${dues.length}ê±´`;
    dueListEl.innerHTML = "";
    if(dues.length===0){
      const d=document.createElement("div");
      d.style.color="rgba(245,247,255,.65)";
      d.style.padding="12px 4px";
      d.textContent="ë¯¸ìˆ˜ ì—†ìŒ";
      dueListEl.appendChild(d);
      return;
    }

    const carts = getCarts();
    dues.forEach(due=>{
      const cart = carts[due.key] || {};
      const {sum,cnt} = cartTotals(cart);

      const card=document.createElement("div");
      card.className="dueCard";

      const top=document.createElement("div");
      top.className="dueTop";

      const id=document.createElement("div");
      id.className="dueId";
      id.textContent = due.key.replace("due_","ë¯¸ìˆ˜ ");

      const sumEl=document.createElement("div");
      sumEl.className="dueSum";
      sumEl.textContent = KRW(sum);

      top.appendChild(id);
      top.appendChild(sumEl);

      const meta=document.createElement("div");
      meta.className="dueMeta";
      const dt = new Date(due.createdAt);
      meta.textContent = `${dt.toLocaleString("ko-KR")} Â· ${cnt}ê°œ`;

      const btns=document.createElement("div");
      btns.className="dueBtns";

      const bLoad=document.createElement("button");
      bLoad.className="load";
      bLoad.textContent="ë¶ˆëŸ¬ì˜¤ê¸°";
      bLoad.onclick=()=>{
        // í˜„ì¬ active cartëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , dueë¥¼ activeë¡œ ì „í™˜
        setActiveKey(due.key);
        // ë°›ì€ëˆì€ ë¯¸ìˆ˜ ê±´ë³„ë¡œ ë”°ë¡œ ì €ì¥í•˜ë©´ ë” ë³µì¡í•´ì ¸ì„œ,
        // ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¬ ë•ŒëŠ” ë°›ì€ëˆ 0ìœ¼ë¡œ ì‹œì‘
        setReceived(0);
        closeDrawer();
        renderAll();
      };

      const bDel=document.createElement("button");
      bDel.className="del";
      bDel.textContent="ì‚­ì œ";
      bDel.onclick=()=>{
        if(!confirm(`${due.key.replace("due_","ë¯¸ìˆ˜ ")} ì‚­ì œ?`)) return;
        // cartsì—ì„œ ì‚­ì œ
        const carts2=getCarts();
        delete carts2[due.key];
        setCarts(carts2);
        // duesì—ì„œ ì‚­ì œ
        const dues2=getDues().filter(x=>x.key!==due.key);
        setDues(dues2);

        // activeê°€ ì§€ì›Œì§„ keyë©´ currentë¡œ
        if(getActiveKey()===due.key){
          setActiveKey("current");
        }
        renderDueDrawer();
        renderRight();
      };

      btns.appendChild(bLoad);
      btns.appendChild(bDel);

      // ë¯¸ìˆ˜ ìƒì„¸(ì§§ê²Œ)
      const sample = Object.keys(cart).slice(0,3).map(id=>{
        const it=items.find(x=>x.id===id);
        const q=cart[id]||0;
        return it? `${it.name} x${q}` : "";
      }).filter(Boolean).join(" / ");
      const meta2=document.createElement("div");
      meta2.className="dueMeta";
      meta2.textContent = sample + (Object.keys(cart).length>3 ? " â€¦" : "");

      card.appendChild(top);
      card.appendChild(meta);
      card.appendChild(meta2);
      card.appendChild(btns);
      dueListEl.appendChild(card);
    });
  }

  // ====== ë°±ì—…/ë³µì› ======
  function exportBackup(){
    const payload = {
      app: "umgane-pos2",
      ver: APP_VER,
      ts: nowISO(),
      items: JSON.parse(localStorage.getItem(LS.ITEMS) || "[]"),
      pins: JSON.parse(localStorage.getItem(LS.PINS) || "{}"),
      carts: JSON.parse(localStorage.getItem(LS.CARTS) || "{}"),
      dues: JSON.parse(localStorage.getItem(LS.DUES) || "[]"),
      active: localStorage.getItem(LS.ACTIVE) || "current",
      received: getReceived(),
      sortMode: getSortMode(),
      tab: getTab(),
      q: elQ.value || "",
      cho: getChoSel()
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a=document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `umgane_pos2_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function importBackupFile(file){
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const data = JSON.parse(fr.result);
        if(!data || typeof data!=="object") throw new Error("invalid");
        if(!Array.isArray(data.items)) throw new Error("items missing");

        saveItems(data.items.map(x=>({
          ...x,
          cat:normCat(x.cat),
          price:parsePrice(x.price),
          active: !!x.active,
          cho: x.cho || toChosung(x.name),
          nameLower: (x.name||"").toLowerCase()
        })));

        localStorage.setItem(LS.PINS, JSON.stringify(data.pins||{}));
        localStorage.setItem(LS.CARTS, JSON.stringify(data.carts||{current:{}}));
        localStorage.setItem(LS.DUES, JSON.stringify(data.dues||[]));
        localStorage.setItem(LS.ACTIVE, data.active || "current");
        setReceived(Number(data.received||0));
        setSortMode(data.sortMode || "pin_ord");
        setTab(data.tab || "ê³¼ì¼");
        setChoSel(data.cho || "");
        setQ(data.q || "");
        elQ.value = data.q || "";

        items = loadItems();
        renderAll();
        alert("ë³µì› ì™„ë£Œ");
      }catch(e){
        alert("ë³µì› ì‹¤íŒ¨: íŒŒì¼ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    };
    fr.readAsText(file);
  }

  // ====== ì´ë²¤íŠ¸ ======
  elQ.value = getQ();
  elQ.addEventListener("input", ()=>{
    setQ(elQ.value);
    renderAll();
  });

  elSortBtn.addEventListener("click", ()=>{
    // í˜„ì¬ëŠ” ê³ ì •+ordë§Œ ì“°ë˜, ë²„íŠ¼ì€ ë‚¨ê²¨ë‘ (ë‚˜ì¤‘ì— í™•ì¥)
    alert("ì •ë ¬ì€ í˜„ì¬ ê³ ì •+ordë¡œ ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
  });

  // ê¸ˆì•¡ ë²„íŠ¼
  document.querySelectorAll("[data-add]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const add = Number(b.getAttribute("data-add"));
      setReceived(getReceived() + add);
      renderRight();
    });
  });

  // ë°›ì€ëˆ ì´ˆê¸°í™”(ë°›ì€ëˆë§Œ!)
  elBtnResetReceived.addEventListener("click", ()=>{
    setReceived(0);
    renderRight();
  });

  // ìƒˆë¡œê³ ì¹¨(ìƒíƒœ ì´ˆê¸°í™”: ì¥ë°”êµ¬ë‹ˆ/ë¯¸ìˆ˜/ë°›ì€ëˆ/í•€)
  elBtnResetAll.addEventListener("click", ()=>{
    if(!confirm("ìƒíƒœ ì´ˆê¸°í™”?\n(ì¥ë°”êµ¬ë‹ˆ/ë¯¸ìˆ˜/ë°›ì€ëˆ/ê³ ì •í•€)\nâ€» ìƒí’ˆëª©ë¡ì€ ìœ ì§€")) return;
    localStorage.removeItem(LS.PINS);
    localStorage.removeItem(LS.CARTS);
    localStorage.removeItem(LS.ACTIVE);
    localStorage.removeItem(LS.DUES);
    localStorage.removeItem(LS.RECEIVED);
    setTab("ê³¼ì¼");
    setChoSel("");
    setQ("");
    elQ.value="";
    renderAll();
  });

  // ë¯¸ìˆ˜ ì—´ê¸°
  elBtnDue.addEventListener("click", openDrawer);
  btnCloseDrawer.addEventListener("click", closeDrawer);
  drawer.addEventListener("click", (e)=>{
    if(e.target===drawer) closeDrawer();
  });

  // í˜„ì¬ë¡œ
  btnBackToCurrent.addEventListener("click", ()=>{
    setActiveKey("current");
    setReceived(0);
    closeDrawer();
    renderAll();
  });

  // ë¯¸ìˆ˜ ì €ì¥
  elBtnParkDue.addEventListener("click", parkCurrentAsDue);

  // ê²°ì œì™„ë£Œ: í˜„ì¬ active cart ë¹„ìš°ê³ (ê²°ì œì™„ë£Œ), ë°›ì€ëˆ 0
  elBtnPay.addEventListener("click", ()=>{
    const cart = getActiveCart();
    if(Object.keys(cart).length===0){
      alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
      return;
    }
    // ê²°ì œì™„ë£ŒëŠ” "í˜„ì¬ í™œì„± ì¥ë°”êµ¬ë‹ˆ"ë§Œ ë¹„ì›€
    const carts = getCarts();
    const key = getActiveKey();
    carts[key] = {};
    setCarts(carts);

    // ë§Œì•½ ë¯¸ìˆ˜(due_*)ë¥¼ ê²°ì œì™„ë£Œí–ˆë‹¤ë©´, ë¯¸ìˆ˜ ëª©ë¡ì—ì„œë„ ì œê±°(ì‹¤ë¬´)
    if(key.startsWith("due_")){
      const dues = getDues().filter(d=>d.key!==key);
      setDues(dues);
      // due cartë„ ì œê±°
      const carts2=getCarts();
      delete carts2[key];
      setCarts(carts2);
      setActiveKey("current");
    }
    setReceived(0);
    renderAll();
  });

  // ë°±ì—…/ë³µì›
  btnExport.addEventListener("click", exportBackup);
  btnImport.addEventListener("click", ()=> importFile.click());
  importFile.addEventListener("change", ()=>{
    const f = importFile.files && importFile.files[0];
    if(f) importBackupFile(f);
    importFile.value="";
  });

  // ====== ìµœì´ˆ ë Œë” ======
  renderAll();

})();
</script>
</body>
</html>
