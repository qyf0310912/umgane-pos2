<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;

    --r:18px;
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-16:16px; --fs-18:18px; --fs-24:24px; --fs-32:32px;
    --w-400:400; --w-500:500; --w-600:600;

    --right-w: 420px;
    --cart-price-w: 92px;
    --cart-qty-w:   120px;
    --cart-x-w:      44px;

    --card-min: 210px;
  }

  @media (min-width:1024px) and (max-width:1400px){
    :root{ --right-w:420px; --card-min:210px; }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  }
  button{cursor:pointer;border:0;border-radius:12px}
  .mono{font-variant-numeric:tabular-nums;}
  .muted{color:var(--muted)}
  .hide{display:none !important;}
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 16px 50px rgba(0,0,0,.38);
    overflow:hidden;
  }

  .app{
    height:100%;
    display:grid;
    grid-template-columns: 1fr var(--right-w);
    gap:12px;
    padding:12px;
  }
  .left{display:flex; flex-direction:column;}
  .right{display:flex; flex-direction:column;}

  .top{padding:12px;border-bottom:1px solid var(--line);}

  .tabsRow{
    display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  .tab{
    padding:8px 12px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.9);
    background:rgba(255,255,255,.03);
    border:1px solid var(--line);
  }
  .tab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }
  .chipBtn{
    padding:10px 12px;
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    white-space:nowrap;
  }
  .syncWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .syncInfo{font-size:12px; color:rgba(245,247,255,.65); white-space:nowrap;}

  .searchRow{display:grid; grid-template-columns: 1fr; gap:10px; align-items:center;}
  .search{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .search input{
    width:100%;
    background:transparent;
    border:0;
    outline:none;
    color:var(--text);
    font-size:var(--fs-14);
    font-weight:var(--w-500);
  }

  .chosungRow{
    display:flex;
    flex-direction:row !important;
    gap:6px;
    flex-wrap:wrap;
    padding:10px 0 0;
    align-items:center;
    justify-content:flex-start;
  }
  .key{
    width:38px;height:34px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    border-radius:10px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    user-select:none;
  }
  .key.danger{
    background:rgba(255,59,48,.12);
    border-color:rgba(255,59,48,.35);
  }

  .hint{
    margin-top:8px;
    font-size:var(--fs-12);
    color:rgba(245,247,255,.65);
    line-height:1.25;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .gridWrap{padding:12px; overflow:auto; flex:1;}
  .pinBarTitle{font-size:var(--fs-12); color:rgba(245,247,255,.65); margin:0 0 8px;}
  .grid{display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(var(--card-min), 1fr));}

  .card{
    position:relative;
    border-radius:18px;
    padding:14px 14px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    min-height:86px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    overflow:hidden;
  }
  .card:hover{ background:rgba(255,255,255,.028); }
  .cardName{
    font-size:var(--fs-18);
    font-weight:var(--w-600);
    letter-spacing:-.2px;
    line-height:1.12;
    margin:0;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardPrice{
    margin-top:6px;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.88);
  }

  /* ğŸ“Œ í•€: ê¸°ë³¸ì€ ìˆ¨ê¹€, ì‚´ì§ ìŠ¤ì¹˜ë©´(ìŠ¤ì™€ì´í”„/í„°ì¹˜ë¬´ë¸Œ) í‘œì‹œ */
  .pin{
    position:absolute;
    right:10px; bottom:10px;
    width:34px;height:34px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.18);
    display:flex;align-items:center;justify-content:center;
    color:rgba(255,159,0,.95);
    font-size:14px;
    opacity:0;
    transform:translateY(6px);
    pointer-events:none;
    transition:opacity .12s ease, transform .12s ease;
  }
  .card.showPin .pin{
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }
  .pin.off{ color:rgba(255,255,255,.18); filter:grayscale(1); opacity:.35; }
  .card.inactive{ opacity:.35; filter:grayscale(.55); }

  .rightTop{
    padding:12px;
    border-bottom:1px solid var(--line);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .rightTitle{display:flex; gap:10px; align-items:center;}
  .pill{
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    font-size:var(--fs-13);
    font-weight:var(--w-600);
    user-select:none;
  }
  .pill.accent{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  .cartList{flex:1; overflow:auto; padding:10px 10px 6px;}

  .cartRow{
    user-select:none;
    padding:10px 10px;
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    display:grid;
    grid-template-columns: 1fr var(--cart-price-w) var(--cart-qty-w) var(--cart-x-w);
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .cartName{
    font-size:var(--fs-14);
    font-weight:var(--w-500);
    color:rgba(245,247,255,.95);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    letter-spacing:-.1px;
  }
  .cartPrice{
    text-align:right;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.85);
  }
  .qtyBox{display:flex; justify-content:flex-end; align-items:center; gap:8px;}
  .qBtn{
    width:34px;height:32px;
    border-radius:10px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:700;
    font-size:14px;
    display:flex;align-items:center;justify-content:center;
  }
  .qNum{
    width:26px;
    text-align:center;
    font-size:var(--fs-14);
    font-weight:var(--w-600);
    color:rgba(245,247,255,.95);
  }
  .xBtn{
    width:40px;height:32px;
    border-radius:10px;
    border:1px solid rgba(255,59,48,.32);
    background:rgba(255,59,48,.12);
    color:rgba(255,245,245,.95);
    font-weight:700;
  }

  .summary{border-top:1px solid var(--line); padding:10px 12px;}
  .sumTitle{font-size:var(--fs-13); color:rgba(245,247,255,.7); font-weight:var(--w-600);}
  .sumMoney{margin-top:4px; font-size:var(--fs-32); font-weight:700; letter-spacing:-.6px; line-height:1.05;}
  .twoCol{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;}
  .moneyBox{
    border-radius:16px;
    padding:8px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .moneyLabel{font-size:var(--fs-12); color:rgba(245,247,255,.65); font-weight:var(--w-600);}
  .moneyValue{margin-top:3px; font-size:22px; font-weight:800; line-height:1.05;}

  .cashGrid{margin-top:10px; display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
  .cashBtn{
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:var(--w-600);
    font-size:var(--fs-14);
  }
  .cashBtn.reset{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.28);}

  .bottomRow{margin-top:10px; display:grid; grid-template-columns: 1fr 2fr; gap:10px; align-items:stretch;}
  .misuBtn{
    border-radius:16px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    padding:9px 10px;
    text-align:left;
    color:var(--text);
  }
  .misuBtn .t{font-weight:800; font-size:var(--fs-16); color:var(--text); line-height:1.05;}
  .misuBtn .s{margin-top:3px; font-size:var(--fs-12); color:rgba(245,247,255,.65); font-weight:var(--w-600); line-height:1.1;}

  .payBtn{
    border-radius:16px;
    background:var(--accent);
    color:#111;
    font-weight:900;
    font-size:var(--fs-24);
    letter-spacing:-.6px;
    padding:12px 10px;
  }

  .modalBack{
    position:fixed; inset:0;
    background:rgba(0,0,0,.62);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .modal{
    width:min(980px, 96vw);
    max-height:86vh;
    overflow:auto;
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.55);
    padding:14px;
  }
  .modalHead{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 6px 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:12px;
  }
  .modalHead h3{margin:0; font-size:var(--fs-18); font-weight:800;}
  .mClose{
    padding:10px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    border-radius:14px;
    font-weight:800;
  }

  /* ê´€ë¦¬ì íƒ­ */
  .adminTabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;}
  .aTab{
    padding:9px 12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    font-weight:900;
    border-radius:14px;
  }
  .aTab.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  /* ë°ì´í„°ë¶„ì„ ìƒë‹¨ 3ê°œ */
  .kpiRow{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-bottom:12px;
  }
  .kpi{
    border-radius:18px;
    padding:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
  }
  .kpi .label{font-size:12px; color:rgba(245,247,255,.65); font-weight:800;}
  .kpi .val{margin-top:6px; font-size:22px; font-weight:1000; letter-spacing:-.3px;}
  .kpi .sub{margin-top:4px; font-size:12px; color:rgba(245,247,255,.65); font-weight:800;}

  .segRow{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0;}
  .segBtn{
    padding:8px 11px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.92);
    font-weight:900;
    font-size:13px;
  }
  .segBtn.active{
    border-color:rgba(255,159,0,.45);
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
    color:#fff;
  }

  .rankGrid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  .rankBox{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    overflow:hidden;
  }
  .rankTitle{font-weight:1000; font-size:14px; margin:0 0 10px;}
  .rRow{
    display:flex; justify-content:space-between; gap:10px;
    padding:8px 0;
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .rRow:last-child{border-bottom:0}
  .rName{font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .rQty{font-weight:1000; font-size:13px; opacity:.9;}

  /* í’ˆì ˆ/ìƒí’ˆìˆ˜ì • ê³µí†µ */
  .rowBox{
    border:1px solid var(--line);
    background:rgba(255,255,255,.02);
    border-radius:18px;
    padding:12px;
    margin-top:10px;
  }
  .miniTitle{font-weight:1000; font-size:14px; margin:0 0 10px;}
  .aSearch{display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--line); background:rgba(255,255,255,.02); border-radius:16px;}
  .aSearch input{width:100%; border:0; outline:0; background:transparent; color:var(--text); font-size:14px; font-weight:800;}
  .list{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .li{
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.12);
    border-radius:16px;
    padding:10px;
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }
  .li .t{font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .li .s{margin-top:3px; font-size:12px; color:rgba(245,247,255,.65); font-weight:900;}
  .btnMini{
    padding:9px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.03);
    color:rgba(245,247,255,.95);
    font-weight:1000;
    white-space:nowrap;
  }
  .btnMini.good{background:rgba(41,209,126,.12); border-color:rgba(41,209,126,.30);}
  .btnMini.bad{background:rgba(255,59,48,.12); border-color:rgba(255,59,48,.30);}

  /* ìƒí’ˆìˆ˜ì • í¼ */
  .editGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .field{
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.02);
    border-radius:16px;
    padding:10px 12px;
  }
  .field label{display:block; font-size:12px; color:rgba(245,247,255,.65); font-weight:1000;}
  .field input, .field select{
    width:100%;
    margin-top:6px;
    border:0; outline:0;
    background:transparent;
    color:var(--text);
    font-size:14px;
    font-weight:1000;
  }

  .sortBar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    margin-top:10px;
  }
  .sortHint{
    font-size:12px;
    font-weight:900;
    color:rgba(245,247,255,.65);
  }
  .swapPick{
    border-color:rgba(255,159,0,.45) !important;
    box-shadow:0 0 0 2px rgba(255,159,0,.12) inset;
  }

  @media (max-width: 980px){
    .app{ grid-template-columns: 1fr; }
    :root{ --right-w: 100%; }
    .kpiRow{grid-template-columns: 1fr;}
    .rankGrid{grid-template-columns: 1fr;}
    .editGrid{grid-template-columns: 1fr;}
  }
</style>
</head>

<body>
<div class="app">
  <section class="panel left">
    <div class="top">
      <div class="tabsRow">
        <div class="tabs" id="tabs"></div>
        <div class="syncWrap">
          <button class="chipBtn" id="syncBtn">ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨</button>
          <div class="syncInfo" id="syncInfo">ğŸ“… ì˜¤ëŠ˜: - Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -</div>
        </div>
      </div>

      <div class="searchRow">
        <div class="search">
          <span class="muted">ğŸ”</span>
          <input id="q" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±ã„´ã„·)" autocomplete="off" />
        </div>
      </div>

      <div class="chosungRow" id="keys"></div>

      <div class="hint">
        ê²€ìƒ‰=ì „í’ˆëª©(ì´ˆì„± ê°€ëŠ¥) Â· (ì•„ì´íŒ¨ë“œ) ì‚´ì§ ìŠ¤ì¹˜ë©´ ğŸ“Œí‘œì‹œ Â· 1.2ì´ˆ ëˆ„ë¥´ë©´ ê³ ì •/í•´ì œ Â· í´ë¦­=ë‹´ê¸°
      </div>
    </div>

    <div class="gridWrap">
      <div class="pinBarTitle" id="pinTitle">ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rightTop">
      <!-- âœ… ì™¼ìª½ì •ë ¬: ë¯¸ìˆ˜ / ì˜¤ë¥¸ìª½ì •ë ¬: ê´€ë¦¬ì, ë¦¬ì…‹ -->
      <div class="rightTitle">
        <span class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</span>
      </div>
      <div class="rightTitle">
        <span class="pill" id="adminPill">ê´€ë¦¬ì</span>
        <span class="pill" id="cartPill">ë¦¬ì…‹</span>
      </div>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="summary">
      <div class="sumTitle">ì´í•©ê³„(<span id="sumCnt">0</span>ê°œ)</div>
      <div class="sumMoney mono" id="sumMoney">0ì›</div>

      <div class="twoCol">
        <div class="moneyBox">
          <div class="moneyLabel">ë°›ì€ëˆ</div>
          <div class="moneyValue mono" id="paidMoney">0ì›</div>
        </div>
        <div class="moneyBox">
          <div class="moneyLabel">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="moneyValue mono" id="changeMoney">0ì›</div>
        </div>
      </div>

      <div class="cashGrid">
        <button class="cashBtn" data-add="500">500</button>
        <button class="cashBtn" data-add="1000">1ì²œ</button>
        <button class="cashBtn" data-add="5000">5ì²œ</button>
        <button class="cashBtn" data-add="10000">1ë§Œ</button>
        <button class="cashBtn" data-add="50000">5ë§Œ</button>
        <button class="cashBtn reset" id="paidReset">ì´ˆê¸°í™”</button>
      </div>

      <div class="bottomRow">
        <button class="misuBtn" id="saveMisu">
          <div class="t">ë¯¸ìˆ˜</div>
          <div class="s">í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</div>
        </button>

        <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
      </div>
    </div>
  </section>
</div>

<!-- ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ë¯¸ìˆ˜ ëª©ë¡</h3>
      <button class="mClose" id="mClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>
    <div id="misuList"></div>
  </div>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div class="modalBack" id="adminBack">
  <div class="modal">
    <div class="modalHead">
      <h3>ê´€ë¦¬ì</h3>
      <button class="mClose" id="aClose">ê³„ì‚°ìœ¼ë¡œ</button>
    </div>

    <div class="adminTabs" id="adminTabs">
      <button class="aTab active" data-tab="an">ë°ì´í„°ë¶„ì„</button>
      <button class="aTab" data-tab="so">í’ˆì ˆìƒí’ˆ</button>
      <button class="aTab" data-tab="ed">ìƒí’ˆìˆ˜ì •</button>
    </div>

    <!-- ë°ì´í„°ë¶„ì„ -->
    <div id="tab_an">
      <div class="kpiRow">
        <div class="kpi">
          <div class="label">ê²°ì œê±´ìˆ˜(ì˜¤ëŠ˜ ëˆ„ì )</div>
          <div class="val mono" id="kpi_tx">0</div>
          <div class="sub muted">ê²°ì œì™„ë£Œ ê¸°ì¤€</div>
        </div>
        <div class="kpi">
          <div class="label">ê°ë‹¨ê°€</div>
          <div class="val mono" id="kpi_atv">0ì›</div>
          <div class="sub muted">ì´ë§¤ì¶œ/ê²°ì œê±´ìˆ˜</div>
        </div>
        <div class="kpi">
          <div class="label">í”¼í¬ ì‹œê°„ëŒ€ + ë¹„ì¤‘</div>
          <div class="val mono" id="kpi_peak">-</div>
          <div class="sub muted" id="kpi_peak2">-</div>
        </div>
      </div>

      <div class="segRow" id="segRow"></div>
      <div class="segRow" id="catRow"></div>

      <div class="rankGrid">
        <div class="rankBox">
          <div class="rankTitle">ë² ìŠ¤íŠ¸ 15 (ë‚˜ê°„ ìˆ˜ëŸ‰)</div>
          <div id="bestList"></div>
        </div>
        <div class="rankBox">
          <div class="rankTitle">ì›ŒìŠ¤íŠ¸ 15 (ë‚˜ê°„ ìˆ˜ëŸ‰)</div>
          <div id="worstList"></div>
        </div>
      </div>

      <div class="rowBox" style="margin-top:12px;">
        <div class="miniTitle">ì´ë§¤ì¶œ (ê´€ë¦¬ììš©)</div>
        <div class="muted" style="font-weight:1000;">
          ì „ì²´:
          <span class="mono" id="rev_all">0ì›</span>
          Â· ì„ íƒêµ¬ê°„:
          <span class="mono" id="rev_seg">0ì›</span>
        </div>
      </div>
    </div>

    <!-- í’ˆì ˆìƒí’ˆ -->
    <div id="tab_so" class="hide">
      <div class="rowBox">
        <div class="miniTitle">í’ˆì ˆìƒí’ˆ (ìˆ¨ê¹€ ì²˜ë¦¬)</div>
        <div class="aSearch">
          <span class="muted">ğŸ”</span>
          <input id="soQ" placeholder="ì´ˆì„±/ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ã„·ã„±, ë‹¨ê°)" autocomplete="off">
        </div>
        <div class="segRow" id="soCatRow"></div>
        <div class="list" id="soList"></div>
      </div>

      <div class="rowBox">
        <div class="miniTitle">ì˜¤ëŠ˜ í’ˆì ˆ ê¸°ë¡</div>
        <div class="list" id="soLog"></div>
      </div>
    </div>

    <!-- ìƒí’ˆìˆ˜ì • -->
    <div id="tab_ed" class="hide">
      <!-- ìƒˆ ìƒí’ˆì¶”ê°€: ìƒë‹¨ìœ¼ë¡œ ì˜¬ë¦¼ -->
      <div class="rowBox">
        <div class="miniTitle">ìƒˆ ìƒí’ˆì¶”ê°€</div>
        <div class="editGrid">
          <div class="field">
            <label>ì¹´í…Œê³ ë¦¬</label>
            <select id="newCat"></select>
          </div>
          <div class="field">
            <label>ìë™ ID(ë¯¸ë¦¬ë³´ê¸°)</label>
            <input id="newId" readonly value="">
          </div>
          <div class="field">
            <label>ìƒí’ˆëª…</label>
            <input id="newName" placeholder="ì˜ˆ: ë‹¨ê°17ê°œ">
          </div>
          <div class="field">
            <label>ê°€ê²©</label>
            <input id="newPrice" inputmode="numeric" placeholder="ì˜ˆ: 5000">
          </div>
        </div>
        <div class="sortBar">
          <button class="btnMini good" id="btnAddItem">ì¶”ê°€</button>
          <span class="sortHint">â€» ì¶”ê°€í•˜ë©´ ì‹œíŠ¸ê°€ ì•„ë‹ˆë¼ â€œì´ ë¸Œë¼ìš°ì €â€ ìƒí’ˆë§ˆìŠ¤í„°ì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <div class="rowBox">
        <div class="miniTitle">ìƒí’ˆëª©ë¡ìˆ˜ì •</div>

        <div class="aSearch">
          <span class="muted">ğŸ”</span>
          <input id="edQ" placeholder="ì´ˆì„±/ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ã„±ã…ˆ, ê°ì)" autocomplete="off">
        </div>

        <div class="segRow" id="edCatRow"></div>

        <div class="sortBar">
          <button class="btnMini" id="btnSortMode">ì •ë ¬ëª¨ë“œ: OFF</button>
          <span class="sortHint" id="sortHint">ì •ë ¬ëª¨ë“œ ON â†’ (í† ìŠ¤ ë°©ì‹) 1ë²ˆ ì„ íƒ â†’ 2ë²ˆ ì„ íƒ(êµì²´)</span>
        </div>

        <div class="list" id="edList"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ===============================
   ì €ì¥ í‚¤
================================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PINS  = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_PAID  = "umgane_paid_v2";
const LS_MISU  = "umgane_misu_v2";

const LS_LASTSYNC = "umgane_items_lastSync_v1";
const LS_LASTSYNC_UI = "umgane_lastSync_ui_v1";

/* âœ… ë¸Œë¼ìš°ì € ì „ìš© íŒë§¤ ìš”ì•½(ëŠë ¤ì§ ë°©ì§€: ì „ìˆ˜ê³„ì‚° ê¸ˆì§€) */
const LS_SUMMARY = "umgane_sales_summary_v1";  // { [YYYY-MM-DD]: { tx, rev, seg:{}, qty:{}, qtyBySeg:{}, qtyByCatSeg:{}, revBySeg:{}, peak... } }
const LS_STOCKOUT = "umgane_stockout_v1";      // { [YYYY-MM-DD]: { [id]: {atISO, cat, name, soldQty} } }

/* ===============================
   âœ… êµ¬ê¸€ì‹œíŠ¸(CSV) â†’ ìƒí’ˆë§ˆìŠ¤í„° ë™ê¸°í™” (ì„ íƒ)
   - ì´ ë²„ì „ì€ "ë¸Œë¼ìš°ì € ì €ì¥"ì´ ê¸°ë³¸ì´ë¯€ë¡œ,
     ì‹œíŠ¸ë¥¼ ì“°ê³  ì‹¶ìœ¼ë©´ URLë§Œ ìœ ì§€í•˜ë©´ ë¨.
================================= */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSZMLZiCqXn-YKsOwR_RR1nZudB1VqAKI652Aje2p3Ytjqfzx5YhcLtEHyuiCSFKPqZ8e1xvbF3JCU4/pub?output=csv";

/* âœ… CSV íŒŒì„œ */
function parseCSV(text) {
  const rows = [];
  let cur = "", inQ = false;
  let row = [];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      pushCell();
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    } else {
      cur += ch;
    }
  }
  if (cur.length > 0 || row.length > 0) { pushCell(); pushRow(); }
  return rows.filter(r => r.some(c => (c || "").trim() !== ""));
}

function toNumber(v) {
  const s = String(v ?? "").replace(/[^\d.-]/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function toInt(v, def=0){
  const n = parseInt(String(v ?? "").trim(), 10);
  return Number.isFinite(n) ? n : def;
}
function normalizeActive(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "1" || s === "true" || s === "y" || s === "yes" || s === "on") ? 1 : 0;
}
function nowISO(){ return new Date().toISOString(); }
function isSameDay(isoA, isoB){
  try{
    const a = new Date(isoA), b = new Date(isoB);
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }catch{ return false; }
}

function saveItemsToLS(items){
  localStorage.setItem(LS_ITEMS, JSON.stringify(items));
  localStorage.setItem(LS_LASTSYNC, nowISO());
}
function loadItemsFromLS(){
  try {
    const raw = localStorage.getItem(LS_ITEMS);
    return raw ? JSON.parse(raw) : [];
  } catch { return []; }
}

async function syncItemsFromSheet({force=false} = {}) {
  const last = localStorage.getItem(LS_LASTSYNC);
  if (!force && last && isSameDay(last, nowISO())) {
    return { ok:true, skipped:true, count: (loadItemsFromLS()||[]).length };
  }

  const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("CSV ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + res.status);

  const csv = await res.text();
  const rows = parseCSV(csv);

  const header = rows[0].map(h => String(h).trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iId = idx("id");
  const iCat = idx("cat");
  const iName = idx("name");
  const iPrice = idx("price");
  const iActive = idx("active");
  const iOrd = idx("ord");

  if (iId < 0 || iCat < 0 || iName < 0 || iPrice < 0) {
    throw new Error("ì‹œíŠ¸ í—¤ë”ê°€ ë¶€ì¡±í•¨: id/cat/name/price í•„ìˆ˜");
  }

  const items = [];
  for (let r=1; r<rows.length; r++){
    const row = rows[r];
    const id = String(row[iId] ?? "").trim();

    let cat = String(row[iCat] ?? "").trim();
    cat = cat.replace(/\s+/g,"").replace(/\u00A0/g,"");
    if (cat === "ë´‰ì±„ì†Œ") cat = "ë´‰ì§€ì±„ì†Œ";

    const name = String(row[iName] ?? "").trim();
    const price = toNumber(row[iPrice]);

    if (!id || !name) continue;

    const active = (iActive >= 0) ? normalizeActive(row[iActive]) : 1;
    const ord = (iOrd >= 0) ? toInt(row[iOrd], 0) : 0;

    items.push({ id, cat, name, price, active, ord });
  }

  if (items.length < 3) throw new Error("ê°€ì ¸ì˜¨ ìƒí’ˆì´ ë„ˆë¬´ ì ìŒ - ì‹œíŠ¸/ê²Œì‹œ í™•ì¸ í•„ìš”");
  saveItemsToLS(items);
  try { renderAll(); } catch {}
  return { ok:true, skipped:false, count: items.length };
}
window.umganeSyncFromSheet = syncItemsFromSheet;

/* ===============================
   ì¹´í…Œê³ ë¦¬ / ì´ˆì„±
================================= */
const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
const CHO_KEYS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];

function getChosungChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / 588);
  return CHO[idx] || ch;
}
function toChosung(str){ return [...(str||"")].map(getChosungChar).join(""); }
function normalize(str){ return (str||"").toString().trim().toLowerCase(); }

/* ===============================
   ë¡œë“œ/ì„¸ì´ë¸Œ ì•ˆì •í™”
================================= */
function loadRaw(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

function normalizeCart(v){
  if (!v) return {};
  if (Array.isArray(v)){
    const out = {};
    v.forEach(x=>{
      if(!x) return;
      const id = String(x.id ?? x.name ?? "");
      if(!id) return;
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    });
    return out;
  }
  if (typeof v === "object"){
    const out = {};
    for(const k of Object.keys(v)){
      const x = v[k];
      if(!x || Array.isArray(x)) continue;
      const id = String(x.id ?? k);
      out[id] = { id, name:String(x.name||""), price:Number(x.price||0), qty:Number(x.qty||1) };
    }
    return out;
  }
  return {};
}
function normalizePins(v){
  if (!v) return {};
  if (typeof v === "object" && !Array.isArray(v)) return v;
  return {};
}

/* ===============================
   ìƒ˜í”Œ seed
================================= */
function seedItemsIfEmpty(){
  const existing = loadRaw(LS_ITEMS, null);
  if(existing && Array.isArray(existing) && existing.length) return;

  const sample = [
    {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
    {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
    {id:"S03", cat:"ì•¼ì±„", name:"ê°ì", price:3000, active:1, ord:1},
    {id:"S04", cat:"ë´‰ì§€ì±„ì†Œ", name:"ì‹œê¸ˆì¹˜/1ë´‰ì§€", price:2000, active:1, ord:1},
    {id:"S05", cat:"ìƒì„ ", name:"ë™íƒœ/1ë§ˆë¦¬", price:3000, active:1, ord:1},
  ];
  save(LS_ITEMS, sample);
}
seedItemsIfEmpty();

/* ===============================
   ìƒíƒœ
================================= */
let items = loadRaw(LS_ITEMS, []);
let pins  = normalizePins(loadRaw(LS_PINS, {}));
let cart  = normalizeCart(loadRaw(LS_CART, {}));
let paid  = loadRaw(LS_PAID, 0);
let misu  = loadRaw(LS_MISU, []);
let activeCat = "ì „ì²´";
let query = "";
let loadedMisuIndex = null;

/* ===============================
   ì—˜ë¦¬ë¨¼íŠ¸
================================= */
const elTabs = document.getElementById("tabs");
const elKeys = document.getElementById("keys");
const elGrid = document.getElementById("grid");
const elQ = document.getElementById("q");

const elCartList = document.getElementById("cartList");
const elSumCnt = document.getElementById("sumCnt");
const elSumMoney = document.getElementById("sumMoney");
const elPaidMoney = document.getElementById("paidMoney");
const elChangeMoney = document.getElementById("changeMoney");

const elCartPill = document.getElementById("cartPill");
const elMisuPill = document.getElementById("misuPill");
const elAdminPill = document.getElementById("adminPill");

const elPayBtn = document.getElementById("payBtn");
const elPaidReset = document.getElementById("paidReset");
const elSaveMisu = document.getElementById("saveMisu");

const elModalBack = document.getElementById("modalBack");
const elMClose = document.getElementById("mClose");
const elMisuList = document.getElementById("misuList");

const syncBtn = document.getElementById("syncBtn");
const syncInfo = document.getElementById("syncInfo");

/* ê´€ë¦¬ì */
const adminBack = document.getElementById("adminBack");
const aClose = document.getElementById("aClose");
const adminTabs = document.getElementById("adminTabs");
const tab_an = document.getElementById("tab_an");
const tab_so = document.getElementById("tab_so");
const tab_ed = document.getElementById("tab_ed");

/* ë°ì´í„°ë¶„ì„ */
const kpi_tx = document.getElementById("kpi_tx");
const kpi_atv = document.getElementById("kpi_atv");
const kpi_peak = document.getElementById("kpi_peak");
const kpi_peak2 = document.getElementById("kpi_peak2");
const segRow = document.getElementById("segRow");
const catRow = document.getElementById("catRow");
const bestList = document.getElementById("bestList");
const worstList = document.getElementById("worstList");
const rev_all = document.getElementById("rev_all");
const rev_seg = document.getElementById("rev_seg");

/* í’ˆì ˆ */
const soQ = document.getElementById("soQ");
const soList = document.getElementById("soList");
const soLog = document.getElementById("soLog");
const soCatRow = document.getElementById("soCatRow");

/* ìƒí’ˆìˆ˜ì • */
const newCat = document.getElementById("newCat");
const newId = document.getElementById("newId");
const newName = document.getElementById("newName");
const newPrice = document.getElementById("newPrice");
const btnAddItem = document.getElementById("btnAddItem");

const edQ = document.getElementById("edQ");
const edList = document.getElementById("edList");
const edCatRow = document.getElementById("edCatRow");
const btnSortMode = document.getElementById("btnSortMode");
const sortHint = document.getElementById("sortHint");

/* ===============================
   ìœ í‹¸
================================= */
function won(n){ const x = Math.round(Number(n)||0); return x.toLocaleString("ko-KR") + "ì›"; }
function todayKST(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function fmtKST(ts){
  const d = new Date(ts);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function nowHHMM(){
  const d = new Date();
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}

/* ===============================
   ìƒí’ˆ ì •ë ¬/í•„í„°
================================= */
function getSorted(list){
  const pinned = [];
  const normal = [];
  for(const it of list){ (pins[it.id] ? pinned : normal).push(it); }
  const byOrd = (a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko");
  pinned.sort(byOrd); normal.sort(byOrd);
  return [...pinned, ...normal];
}
function matchItem(it, q){
  if(!q) return true;
  const name = normalize(it.name);
  const qn = normalize(q);
  if(name.includes(qn)) return true;
  const nameCho = toChosung(it.name);
  const qCho = qn.replace(/\s+/g,"");
  if(nameCho.includes(qCho)) return true;
  return false;
}

/* âœ… ê²€ìƒ‰/ì´ˆì„±ì€ ì „ì¹´í…Œê³ ë¦¬, ì•„ë‹ ë•Œë§Œ ì¹´í…Œê³ ë¦¬ ì ìš© */
function visibleItems(){
  const q = query.trim();
  let list = items.filter(it => Number(it.active) === 1);
  if(q){
    list = list.filter(it => matchItem(it, q));
  }else{
    if(activeCat !== "ì „ì²´"){
      list = list.filter(it => it.cat === activeCat);
    }
  }
  return getSorted(list);
}

/* ===============================
   íƒ­/í‚¤íŒ¨ë“œ ë Œë”
================================= */
function renderTabs(){
  elTabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (cat===activeCat ? " active":"");
    b.textContent = cat;
    b.onclick = ()=>{
      activeCat = cat;
      // âœ… íƒ­ í´ë¦­ ì‹œ ìƒ‰ìƒ(ì£¼í™© í…Œë‘ë¦¬) ë°˜ë“œì‹œ ì´ë™
      renderTabs();
      renderGrid();
    };
    elTabs.appendChild(b);
  });
}
function renderKeys(){
  elKeys.innerHTML = "";
  CHO_KEYS.forEach(k=>{
    const d = document.createElement("div");
    d.className = "key";
    d.textContent = k;
    d.onclick = ()=>{
      elQ.value += k;
      query = elQ.value;
      renderGrid();
      elQ.focus();
    };
    elKeys.appendChild(d);
  });
  const del = document.createElement("div");
  del.className = "key danger";
  del.textContent = "X";
  del.onclick = ()=>{
    elQ.value = "";
    query = "";
    renderAll();
    elQ.focus();
  };
  elKeys.appendChild(del);
}

/* ===============================
   ê³ ì •
================================= */
function togglePin(id){
  pins[id] = !pins[id];
  save(LS_PINS, pins);
  renderGrid();
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ
================================= */
function persistCart(){
  cart = normalizeCart(cart);
  save(LS_CART, cart);
}
function addToCart(it){
  if(Number(it.active)!==1) return;
  const id = it.id;
  if(!cart[id]){
    cart[id] = {id, name:it.name, price:Number(it.price||0), qty:1};
  }else{
    cart[id].qty += 1;
  }
  persistCart();
  renderCart();
  renderSummary();
}
function setQty(id, qty){
  if(!cart[id]) return;
  cart[id].qty = qty;
  if(cart[id].qty <= 0) delete cart[id];
  persistCart();
  renderCart();
  renderSummary();
}
function removeCart(id){
  delete cart[id];
  persistCart();
  renderCart();
  renderSummary();
}
function resetCartAll(){
  const ok = confirm("ì¥ë°”êµ¬ë‹ˆ/ë°›ì€ëˆì„ ë¦¬ì…‹í• ê¹Œìš”?");
  if(!ok) return;
  cart = {};
  paid = 0;
  loadedMisuIndex = null;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}
function cartEntries(){ return Object.values(normalizeCart(cart)); }
function cartCount(){ return cartEntries().reduce((a,x)=>a+(x.qty||0),0); }
function cartTotal(){ return cartEntries().reduce((a,x)=>a+(x.qty||0)*(x.price||0),0); }

/* ì‚‘ */
let audioCtx=null;
function beep(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="square"; o.frequency.value=880; g.gain.value=0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
}

/* ===============================
   íŒë§¤ ìš”ì•½(ë¸Œë¼ìš°ì € ì „ìš©, ëˆ„ì  ì €ì¥)
   - ëŠë ¤ì§ ë°©ì§€: ê²°ì œì™„ë£Œ ìˆœê°„ì—ë§Œ ì—…ë°ì´íŠ¸
================================= */
const SEGMENTS = [
  {key:"ALL", label:"ì „ì²´"},
  {key:"S0", label:"~12",  from:0,  to:12},
  {key:"S12",label:"12~2", from:12, to:14},
  {key:"S14",label:"2~4",  from:14, to:16},
  {key:"S16",label:"4~6",  from:16, to:18},
  {key:"S18",label:"6~ë§ˆê°", from:18, to:24}, // âœ… 6ì‹œë¶€í„° ë(ë¬´í•œ ëŒ€ì‹  24ë¡œ ì²˜ë¦¬)
];

function getSegKeyByHour(h){
  if(h < 12) return "S0";
  if(h < 14) return "S12";
  if(h < 16) return "S14";
  if(h < 18) return "S16";
  return "S18";
}

function loadSummary(){
  return loadRaw(LS_SUMMARY, {});
}
function saveSummary(all){
  save(LS_SUMMARY, all);
}

function ensureDay(summaryAll, day){
  if(!summaryAll[day]){
    summaryAll[day] = {
      tx:0,
      rev:0,
      segTx:{S0:0,S12:0,S14:0,S16:0,S18:0},
      revBySeg:{S0:0,S12:0,S14:0,S16:0,S18:0},
      qty:{},                    // id -> qty (ì „ì²´)
      qtyBySeg:{},               // seg -> {id->qty}
      qtyByCatSeg:{},            // cat -> seg -> {id->qty}
    };
  }
  return summaryAll[day];
}

function addSaleToSummary({entries, total}){
  const day = todayKST();
  const all = loadSummary();
  const d = ensureDay(all, day);

  const now = new Date();
  const seg = getSegKeyByHour(now.getHours());

  d.tx += 1;
  d.rev += Number(total||0);
  d.segTx[seg] = (d.segTx[seg]||0) + 1;
  d.revBySeg[seg] = (d.revBySeg[seg]||0) + Number(total||0);

  // í’ˆëª©ë³„ ìˆ˜ëŸ‰ ëˆ„ì  (ë‚˜ê°„ ìˆ˜ëŸ‰ ê¸°ì¤€)
  for(const x of (entries||[])){
    const id = String(x.id||"");
    const q = Number(x.qty||0);
    if(!id || q<=0) continue;

    d.qty[id] = (d.qty[id]||0) + q;

    d.qtyBySeg[seg] = d.qtyBySeg[seg] || {};
    d.qtyBySeg[seg][id] = (d.qtyBySeg[seg][id]||0) + q;

    const it = items.find(t=>t.id===id);
    const cat = (it?.cat) ? it.cat : "ê¸°íƒ€";

    d.qtyByCatSeg[cat] = d.qtyByCatSeg[cat] || {};
    d.qtyByCatSeg[cat][seg] = d.qtyByCatSeg[cat][seg] || {};
    d.qtyByCatSeg[cat][seg][id] = (d.qtyByCatSeg[cat][seg][id]||0) + q;
  }

  saveSummary(all);
}

/* ===============================
   ê²°ì œì™„ë£Œ
================================= */
function doPay(){
  const total = cartTotal();
  if(total<=0) return;

  const ok = confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?");
  if(!ok) return;

  // âœ… íŒë§¤ìš”ì•½ ëˆ„ì (ì´ˆê²½ëŸ‰) - ì—¬ê¸°ì„œë§Œ ì €ì¥
  try{
    addSaleToSummary({ entries: cartEntries(), total });
  }catch(e){}

  beep();

  // ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜¨ ìƒíƒœë©´ ê²°ì œì™„ë£Œì‹œ í•´ë‹¹ ë¯¸ìˆ˜ ì œê±°
  if(loadedMisuIndex !== null){
    misu = loadRaw(LS_MISU, misu);
    if(misu[loadedMisuIndex]){
      misu.splice(loadedMisuIndex, 1);
      save(LS_MISU, misu);
    }
    loadedMisuIndex = null;
  }

  cart = {};
  paid = 0;
  save(LS_CART, cart);
  save(LS_PAID, paid);
  renderAll();
}
function addPaid(n){
  paid = Math.max(0, (Number(paid)||0) + Number(n||0));
  save(LS_PAID, paid);
  renderSummary();
}

/* ===============================
   ë¯¸ìˆ˜
================================= */
function openMisu(){
  elModalBack.style.display = "flex";
  renderMisuList();
}
function closeMisu(){ elModalBack.style.display = "none"; }

function saveMisuNow(){
  const entries = cartEntries();
  const amount = cartTotal();
  if(amount<=0 || entries.length===0) return;

  const now = new Date();
  const id = "ë¯¸ìˆ˜ " + (loadRaw(LS_MISU, misu).length + 1);
  const names = entries.map(x=>({name:x.name, qty:x.qty}));

  misu = loadRaw(LS_MISU, misu);
  misu.unshift({ id, at: now.toISOString(), items: names, amount });
  save(LS_MISU, misu);

  cart = {};
  paid = 0;
  loadedMisuIndex = null;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  renderAll();
  openMisu();
}

function restoreMisu(idx){
  const m = misu[idx];
  if(!m) return;

  const next = {};
  for(const it of m.items){
    const found = items.find(x=>x.name===it.name);
    if(found){
      next[found.id] = {id:found.id, name:found.name, price:Number(found.price||0), qty:Number(it.qty||1)};
    }else{
      const tmpId = "TMP_"+it.name;
      next[tmpId] = {id:tmpId, name:it.name, price:0, qty:Number(it.qty||1)};
    }
  }
  cart = next;
  paid = 0;
  loadedMisuIndex = idx;

  save(LS_CART, cart);
  save(LS_PAID, paid);

  closeMisu();
  renderAll();
}

function settleMisu(idx){
  const m = misu[idx];
  if(!m) return;
  const ok = confirm(`${m.id} (${won(m.amount||0)}) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`);
  if(!ok) return;
  beep();
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function deleteMisu(idx){
  const ok = confirm("ì´ ë¯¸ìˆ˜ë¥¼ ì‚­ì œí• ê¹Œìš”?");
  if(!ok) return;
  misu.splice(idx,1);
  save(LS_MISU, misu);

  if(loadedMisuIndex === idx) loadedMisuIndex = null;
  if(loadedMisuIndex !== null && loadedMisuIndex > idx) loadedMisuIndex -= 1;

  renderMisuList();
  renderAll();
}

function renderMisuList(){
  elMisuList.innerHTML = "";
  if(!misu.length){
    elMisuList.innerHTML = `<div class="muted" style="padding:8px 6px;">ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  misu.forEach((m, idx)=>{
    const date = new Date(m.at);
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");

    const all = (m.items||[]).map(x=>`${x.name}x${x.qty}`);
    const itemsText = all.slice(0,4).join(" Â· ") + (all.length>4 ? ` Â· â€¦(+${all.length-4})` : "");

    const wrap = document.createElement("div");
    wrap.className = "li";

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="t"><span>${m.id}</span> <span class="mono" style="opacity:.95;">Â· ${won(m.amount||0)}</span> <span class="muted">(${hh}:${mm})</span></div>
      <div class="s">${itemsText}</div>
    `;

    const right = document.createElement("div");
    right.style.display="flex";
    right.style.gap="8px";

    const bPay = document.createElement("button");
    bPay.className = "btnMini good";
    bPay.textContent = "ê²°ì œì™„ë£Œ";
    bPay.onclick = ()=>settleMisu(idx);

    const bLoad = document.createElement("button");
    bLoad.className = "btnMini";
    bLoad.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    bLoad.onclick = ()=>restoreMisu(idx);

    const bDel = document.createElement("button");
    bDel.className = "btnMini bad";
    bDel.textContent = "ì‚­ì œ";
    bDel.onclick = ()=>deleteMisu(idx);

    right.appendChild(bPay);
    right.appendChild(bLoad);
    right.appendChild(bDel);

    wrap.appendChild(left);
    wrap.appendChild(right);
    elMisuList.appendChild(wrap);
  });
}

/* ===============================
   ìƒí’ˆ ì¹´ë“œ ë Œë”
   - ì•„ì´íŒ¨ë“œ ìš”êµ¬: ì‚´ì§ ìŠ¤ì¹˜ë©´ í•€ ë³´ì´ê³ , 1.2ì´ˆ ëˆ„ë¥´ë©´ ê³ ì •/í•´ì œ
================================= */
function renderGrid(){
  const list = visibleItems();
  elGrid.innerHTML = "";

  list.forEach(it=>{
    const card = document.createElement("div");
    card.className = "card" + (Number(it.active)!==1 ? " inactive":"");

    const n = document.createElement("div");
    n.className = "cardName";
    n.textContent = it.name;

    const p = document.createElement("div");
    p.className = "cardPrice mono";
    p.textContent = won(it.price||0);

    const pin = document.createElement("div");
    pin.className = "pin " + (pins[it.id] ? "" : "off");
    pin.textContent = "ğŸ“Œ";
    pin.title = "ê³ ì •";
    pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

    // PC ìš°í´ë¦­ë„ ìœ ì§€
    card.oncontextmenu = (e)=>{ e.preventDefault(); togglePin(it.id); return false; };
    card.onclick = ()=>addToCart(it);

    // âœ… iPad: ì‚´ì§ ìŠ¤ì¹˜ë©´ showPin
    let pressTimer=null;
    let startX=0, startY=0, moved=false;

    function showPinTemporarily(){
      card.classList.add("showPin");
      // 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€(ì‹¤ìˆ˜ ë°©ì§€)
      setTimeout(()=>{ try{ card.classList.remove("showPin"); }catch(e){} }, 1800);
    }

    card.addEventListener("touchstart", (ev)=>{
      moved=false;
      card.classList.remove("showPin");
      const t = ev.touches?.[0];
      startX = t ? t.clientX : 0;
      startY = t ? t.clientY : 0;

      // âœ… 1.2ì´ˆ ë¡±í”„ë ˆìŠ¤ â†’ ê³ ì •/í•´ì œ
      pressTimer = setTimeout(()=>{
        if(!moved){
          togglePin(it.id);
          showPinTemporarily();
        }
      }, 1200);
    }, {passive:true});

    card.addEventListener("touchmove", (ev)=>{
      const t = ev.touches?.[0];
      if(!t) return;
      const dx = Math.abs(t.clientX - startX);
      const dy = Math.abs(t.clientY - startY);
      if(dx > 8 || dy > 8){
        moved = true;
        if(pressTimer) clearTimeout(pressTimer);
        // âœ… ì‚´ì§ ìŠ¤ì¹˜ë©´ í•€ í‘œì‹œ
        card.classList.add("showPin");
      }
    }, {passive:true});

    card.addEventListener("touchend", ()=>{
      if(pressTimer) clearTimeout(pressTimer);
      // ìŠ¤ì¹˜ê³  ëë‚˜ë©´ í•€ì€ ì ê¹ ë³´ì´ë‹¤ ìˆ¨ê¹€
      if(card.classList.contains("showPin")){
        setTimeout(()=>{ try{ card.classList.remove("showPin"); }catch(e){} }, 800);
      }
    }, {passive:true});

    card.appendChild(n);
    card.appendChild(p);
    card.appendChild(pin);
    elGrid.appendChild(card);
  });
}

/* ===============================
   ì¥ë°”êµ¬ë‹ˆ ë Œë”
================================= */
function renderCart(){
  elCartList.innerHTML = "";
  const entries = cartEntries();
  if(!entries.length){
    elCartList.innerHTML = `<div class="muted" style="padding:10px 8px;">â€”</div>`;
    return;
  }
  const orderMap = new Map(items.map(x=>[x.id, Number(x.ord||0)]));
  entries.sort((a,b)=> (orderMap.get(a.id)||9999)-(orderMap.get(b.id)||9999));

  entries.forEach(x=>{
    const row = document.createElement("div");
    row.className = "cartRow";

    const name = document.createElement("div");
    name.className = "cartName";
    name.textContent = `${x.name} x${x.qty}`;

    const price = document.createElement("div");
    price.className = "cartPrice mono";
    price.textContent = won((x.price||0)*(x.qty||0));

    const qty = document.createElement("div");
    qty.className = "qtyBox";

    const minus = document.createElement("button");
    minus.className = "qBtn";
    minus.textContent = "âˆ’";
    minus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||1)-1); };

    const num = document.createElement("div");
    num.className = "qNum mono";
    num.textContent = String(x.qty||1);

    const plus = document.createElement("button");
    plus.className = "qBtn";
    plus.textContent = "+";
    plus.onclick = (e)=>{ e.stopPropagation(); setQty(x.id, (x.qty||0)+1); };

    qty.appendChild(minus);
    qty.appendChild(num);
    qty.appendChild(plus);

    const del = document.createElement("button");
    del.className = "xBtn";
    del.textContent = "Ã—";
    del.onclick = (e)=>{ e.stopPropagation(); removeCart(x.id); };

    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(qty);
    row.appendChild(del);

    elCartList.appendChild(row);
  });
}

function renderSummary(){
  const cnt = cartCount();
  const total = cartTotal();
  const change = Math.max(0, (Number(paid)||0) - total);

  elSumCnt.textContent = String(cnt);
  elSumMoney.textContent = won(total);
  elPaidMoney.textContent = won(paid||0);
  elChangeMoney.textContent = won(change);

  elMisuPill.textContent = `ë¯¸ìˆ˜(${misu.length})`;
}

/* ===============================
   ë™ê¸°í™” UI
================================= */
let syncing = false;
let lastSyncTryAt = 0;

function setSyncInfo(){
  const t = Number(localStorage.getItem(LS_LASTSYNC_UI) || 0);
  syncInfo.textContent = t
    ? `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: ${fmtKST(t)}`
    : `ğŸ“… ì˜¤ëŠ˜: ${todayKST()} Â· â± ë§ˆì§€ë§‰ ë™ê¸°í™”: -`;
}

async function runSync({force=true, silent=false} = {}){
  if (syncing) return;
  const now = Date.now();
  if (now - lastSyncTryAt < 10_000) {
    if(!silent) alert("âš ï¸ ì ê¹ë§Œìš”. 10ì´ˆ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    return;
  }
  lastSyncTryAt = now;

  syncing = true;
  syncBtn.disabled = true;
  syncBtn.textContent = "â³ ë™ê¸°í™”ì¤‘...";

  try{
    await umganeSyncFromSheet({ force });
    localStorage.setItem(LS_LASTSYNC_UI, String(Date.now()));
    setSyncInfo();
    if(!silent) alert("âœ… ìƒí’ˆ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
  }catch(e){
    if(!silent) alert("âŒ ë™ê¸°í™” ì‹¤íŒ¨ (ì¸í„°ë„·/ì‹œíŠ¸ í™•ì¸)");
  }finally{
    syncing = false;
    syncBtn.disabled = false;
    syncBtn.textContent = "ğŸ“„ ìƒí’ˆ ìƒˆë¡œê³ ì¹¨";
  }
}

/* ===============================
   ê´€ë¦¬ì(íŒ¨ìŠ¤ì›Œë“œ)
================================= */
const ADMIN_PASS = "1234"; // âœ… ì›í•˜ë©´ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨

function openAdmin(){
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if(pw !== ADMIN_PASS) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
  adminBack.style.display = "flex";
  // ê´€ë¦¬ì í™”ë©´ì€ ë“¤ì–´ê°ˆ ë•Œë§Œ ë Œë”(í¬ìŠ¤ ì„±ëŠ¥ ë¶„ë¦¬)
  renderAdminAll();
}
function closeAdmin(){ adminBack.style.display = "none"; }

/* ===============================
   ë°ì´í„°ë¶„ì„(ì´ˆê²½ëŸ‰: ìš”ì•½ë§Œ ì½ê¸°)
================================= */
let anSeg = "ALL";
let anCat = "ì „ì²´";

function renderSegButtons(){
  segRow.innerHTML = "";
  SEGMENTS.forEach(s=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (anSeg===s.key ? " active":"");
    b.textContent = s.label;
    b.onclick = ()=>{
      anSeg = s.key;
      renderSegButtons();
      renderAnalysis();
    };
    segRow.appendChild(b);
  });
}

function renderCatButtons(rowEl, current, onPick){
  rowEl.innerHTML = "";
  const cats = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (current===c ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{ onPick(c); };
    rowEl.appendChild(b);
  });
}

function getTodaySummary(){
  const all = loadSummary();
  const day = todayKST();
  return all[day] || null;
}

function buildRankPairs(qtyMap){
  const pairs = [];
  for(const id of Object.keys(qtyMap||{})){
    const q = Number(qtyMap[id]||0);
    if(q<=0) continue;
    const it = items.find(x=>x.id===id);
    const name = it ? it.name : id;
    pairs.push({id, name, qty:q});
  }
  pairs.sort((a,b)=>b.qty-a.qty);
  return pairs;
}

function renderRankList(el, pairs, take=15, reverse=false){
  el.innerHTML = "";
  if(!pairs.length){
    el.innerHTML = `<div class="muted" style="padding:8px 4px; font-weight:900;">ë°ì´í„° ì—†ìŒ</div>`;
    return;
  }
  const arr = reverse ? [...pairs].reverse() : pairs;
  const list = arr.slice(0, take);
  list.forEach(x=>{
    const r = document.createElement("div");
    r.className = "rRow";
    const n = document.createElement("div");
    n.className = "rName";
    n.textContent = x.name;
    const q = document.createElement("div");
    q.className = "rQty mono";
    q.textContent = x.qty + "ê°œ";
    r.appendChild(n);
    r.appendChild(q);
    el.appendChild(r);
  });
}

function renderAnalysis(){
  const d = getTodaySummary();
  if(!d){
    kpi_tx.textContent = "0";
    kpi_atv.textContent = won(0);
    kpi_peak.textContent = "-";
    kpi_peak2.textContent = "-";
    bestList.innerHTML = `<div class="muted" style="padding:8px 4px; font-weight:900;">ì˜¤ëŠ˜ ê²°ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    worstList.innerHTML = `<div class="muted" style="padding:8px 4px; font-weight:900;">ì˜¤ëŠ˜ ê²°ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    rev_all.textContent = won(0);
    rev_seg.textContent = won(0);
    return;
  }

  // KPI
  const tx = Number(d.tx||0);
  const rev = Number(d.rev||0);
  kpi_tx.textContent = String(tx);
  kpi_atv.textContent = won(tx>0 ? (rev/tx) : 0);

  // í”¼í¬ ì‹œê°„ëŒ€
  let peakKey = "S0";
  let peakVal = -1;
  for(const k of ["S0","S12","S14","S16","S18"]){
    const v = Number(d.segTx?.[k]||0);
    if(v > peakVal){ peakVal=v; peakKey=k; }
  }
  const totalSegTx = ["S0","S12","S14","S16","S18"].reduce((a,k)=>a+Number(d.segTx?.[k]||0),0);
  const peakLabel = SEGMENTS.find(x=>x.key===peakKey)?.label || peakKey;
  const share = totalSegTx>0 ? Math.round((peakVal/totalSegTx)*100) : 0;
  kpi_peak.textContent = `${peakLabel}`;
  kpi_peak2.textContent = `${peakVal}ê±´ Â· ${share}%`;

  // ì´ë§¤ì¶œ í‘œì‹œ(ê´€ë¦¬ììš©)
  rev_all.textContent = won(rev);
  if(anSeg==="ALL") rev_seg.textContent = won(rev);
  else rev_seg.textContent = won(Number(d.revBySeg?.[anSeg]||0));

  // ë­í‚¹ ë°ì´í„° ì„ íƒ
  let qtyMap = {};
  if(anSeg==="ALL" && anCat==="ì „ì²´"){
    qtyMap = d.qty || {};
  }else if(anSeg!=="ALL" && anCat==="ì „ì²´"){
    qtyMap = (d.qtyBySeg && d.qtyBySeg[anSeg]) ? d.qtyBySeg[anSeg] : {};
  }else if(anSeg==="ALL" && anCat!=="ì „ì²´"){
    // ALL+ì¹´í…Œê³ ë¦¬: segë³„ ë§µ í•©ì‚°
    const out = {};
    const catSeg = d.qtyByCatSeg?.[anCat] || {};
    for(const k of ["S0","S12","S14","S16","S18"]){
      const m = catSeg[k] || {};
      for(const id of Object.keys(m)){
        out[id] = (out[id]||0) + Number(m[id]||0);
      }
    }
    qtyMap = out;
  }else{
    // seg+cat
    qtyMap = (d.qtyByCatSeg?.[anCat] && d.qtyByCatSeg[anCat][anSeg]) ? d.qtyByCatSeg[anCat][anSeg] : {};
  }

  const pairs = buildRankPairs(qtyMap);
  renderRankList(bestList, pairs, 15, false);
  // ì›ŒìŠ¤íŠ¸ëŠ” "í•´ë‹¹ ì„ íƒë²”ìœ„ì—ì„œ íŒ”ë¦° ê²ƒ ì¤‘" ìµœí•˜ìœ„ 15
  renderRankList(worstList, pairs, 15, true);
}

function renderAnalysisUI(){
  renderSegButtons();
  renderCatButtons(catRow, anCat, (c)=>{
    anCat = c;
    renderCatButtons(catRow, anCat, ()=>{});
    // ìœ„ ì¤„ ë‹¤ì‹œ ë§Œë“¤ì—ˆìœ¼ë‹ˆ active ìœ ì§€ ìœ„í•´ ì¬ë Œë”
    renderCatButtons(catRow, anCat, (cc)=>{ anCat=cc; renderAnalysisUI(); });
    renderAnalysis();
  });

  // ìœ„ í•¨ìˆ˜ ì¬ê·€ë¡œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬
  catRow.innerHTML = "";
  const cats = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (anCat===c ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{
      anCat = c;
      renderAnalysisUI();
    };
    catRow.appendChild(b);
  });

  renderAnalysis();
}

/* ===============================
   í’ˆì ˆ(ìˆ¨ê¹€ ì²˜ë¦¬ + í’ˆì ˆì‹œê°„ ê¸°ë¡ + íŒ”ë¦°ê°¯ìˆ˜ í‘œì‹œ)
================================= */
let soCat = "ì „ì²´";
function loadStockout(){
  return loadRaw(LS_STOCKOUT, {});
}
function saveStockout(all){
  save(LS_STOCKOUT, all);
}
function getSoldQtyToday(id){
  const d = getTodaySummary();
  if(!d) return 0;
  return Number(d.qty?.[id]||0);
}
function markSoldOut(id){
  const it = items.find(x=>x.id===id);
  if(!it) return;

  const ok = confirm(`"${it.name}" í’ˆì ˆ ì²˜ë¦¬í• ê¹Œìš”? (ìˆ¨ê¹€ì²˜ë¦¬)`);
  if(!ok) return;

  const day = todayKST();
  const all = loadStockout();
  all[day] = all[day] || {};
  all[day][id] = {
    atISO: new Date().toISOString(),
    cat: it.cat,
    name: it.name,
    soldQty: getSoldQtyToday(id),
  };
  saveStockout(all);

  // ìˆ¨ê¹€(=active 0)
  it.active = 0;
  save(LS_ITEMS, items);

  alert("âœ… í’ˆì ˆ ì²˜ë¦¬ ì™„ë£Œ");
  renderAll();
  renderSoldOutTab();
}

function renderSoldOutTab(){
  // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼
  soCatRow.innerHTML = "";
  const cats = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (soCat===c ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{
      soCat = c;
      renderSoldOutTab();
    };
    soCatRow.appendChild(b);
  });

  // ë¦¬ìŠ¤íŠ¸(í˜„ì¬ active=1 ì¤‘ì—ì„œ)
  const q = (soQ.value||"").trim();
  let list = items.filter(it => Number(it.active)===1);
  if(soCat!=="ì „ì²´") list = list.filter(it=>it.cat===soCat);
  if(q) list = list.filter(it=>matchItem(it,q));

  list.sort((a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko"));
  soList.innerHTML = "";
  if(!list.length){
    soList.innerHTML = `<div class="muted" style="padding:8px 6px; font-weight:900;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
  }else{
    list.forEach(it=>{
      const row = document.createElement("div");
      row.className = "li";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="t">${it.name}</div>
        <div class="s">${it.cat} Â· ì˜¤ëŠ˜ íŒë§¤ ${getSoldQtyToday(it.id)}ê°œ</div>
      `;

      const right = document.createElement("div");
      const b = document.createElement("button");
      b.className = "btnMini bad";
      b.textContent = "í’ˆì ˆ";
      b.onclick = ()=>markSoldOut(it.id);
      right.appendChild(b);

      row.appendChild(left);
      row.appendChild(right);
      soList.appendChild(row);
    });
  }

  // ì˜¤ëŠ˜ í’ˆì ˆ ê¸°ë¡
  const day = todayKST();
  const all = loadStockout();
  const map = all[day] || {};
  const keys = Object.keys(map);
  soLog.innerHTML = "";
  if(!keys.length){
    soLog.innerHTML = `<div class="muted" style="padding:8px 6px; font-weight:900;">ì˜¤ëŠ˜ í’ˆì ˆ ê¸°ë¡ ì—†ìŒ</div>`;
  }else{
    keys
      .map(id=>({id, ...map[id]}))
      .sort((a,b)=> new Date(b.atISO)-new Date(a.atISO))
      .forEach(x=>{
        const row = document.createElement("div");
        row.className = "li";
        const t = fmtKST(x.atISO).slice(11,16);
        row.innerHTML = `
          <div>
            <div class="t">${x.name}</div>
            <div class="s">${x.cat} Â· í’ˆì ˆ ${t} Â· ì˜¤ëŠ˜ íŒë§¤ ${Number(x.soldQty||0)}ê°œ</div>
          </div>
          <div></div>
        `;
        soLog.appendChild(row);
      });
  }
}

/* ===============================
   ìƒí’ˆìˆ˜ì •(ê°€ê²©/ì´ë¦„/í™œì„±/ord) + ì •ë ¬ëª¨ë“œ(í† ìŠ¤ ë°©ì‹ êµì²´)
================================= */
let edCat = "ì „ì²´";
let sortMode = false;
let swapPickId = null;

function computeNextIdForCat(cat){
  // S## í˜•ì‹ ì¤‘ ìµœëŒ€ê°’ +1
  const nums = items
    .filter(x=>x.cat===cat)
    .map(x=>String(x.id||""))
    .map(id=>{
      const m = id.match(/(\d+)/);
      return m ? parseInt(m[1],10) : 0;
    })
    .filter(n=>Number.isFinite(n));
  const max = nums.length ? Math.max(...nums) : 0;
  const next = max + 1;
  return "S" + String(next).padStart(2,"0");
}

function renderNewCatOptions(){
  newCat.innerHTML = "";
  ["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"].forEach(c=>{
    const o = document.createElement("option");
    o.value = c; o.textContent = c;
    newCat.appendChild(o);
  });
  const cat = newCat.value || "ê³¼ì¼";
  newId.value = computeNextIdForCat(cat);
}
newCat.addEventListener("change", ()=>{
  newId.value = computeNextIdForCat(newCat.value);
});

function addNewItem(){
  const cat = newCat.value;
  const id = newId.value.trim();
  const name = (newName.value||"").trim();
  const price = toNumber(newPrice.value||0);

  if(!name) return alert("ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
  if(price<=0) return alert("ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”.");

  if(items.some(x=>x.id===id)){
    // í˜¹ì‹œ ì¤‘ë³µì´ë©´ ë‹¤ìŒ ë²ˆí˜¸ë¡œ ë°€ê¸°
    newId.value = computeNextIdForCat(cat);
    return alert("IDê°€ ì¤‘ë³µì…ë‹ˆë‹¤. ìë™ IDê°€ ê°±ì‹ ëìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ê°€ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
  }

  // ordëŠ” í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰+1
  const ordMax = Math.max(0, ...items.filter(x=>x.cat===cat).map(x=>Number(x.ord||0)));
  const newItem = { id, cat, name, price, active:1, ord: ordMax+1 };
  items.push(newItem);
  save(LS_ITEMS, items);

  alert("âœ… ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ");
  newName.value = "";
  newPrice.value = "";
  newId.value = computeNextIdForCat(cat);

  renderAll();
  renderEditTab();
}

function renderEdCatRow(){
  edCatRow.innerHTML = "";
  const cats = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
  cats.forEach(c=>{
    const b = document.createElement("button");
    b.className = "segBtn" + (edCat===c ? " active":"");
    b.textContent = c;
    b.onclick = ()=>{
      edCat = c;
      swapPickId = null;
      renderEdCatRow();
      renderEditTab();
    };
    edCatRow.appendChild(b);
  });
}

function toggleSortMode(){
  sortMode = !sortMode;
  swapPickId = null;
  btnSortMode.textContent = "ì •ë ¬ëª¨ë“œ: " + (sortMode ? "ON" : "OFF");
  btnSortMode.className = "btnMini" + (sortMode ? " good":"");
  sortHint.textContent = sortMode
    ? "ì •ë ¬ëª¨ë“œ ON â†’ (í† ìŠ¤ ë°©ì‹) 1ë²ˆ ì„ íƒ â†’ 2ë²ˆ ì„ íƒ(êµì²´)  â€» ì¹´í…Œê³ ë¦¬ë³„ë¡œë§Œ ì‚¬ìš© ê¶Œì¥"
    : "ì •ë ¬ëª¨ë“œ OFF";
  renderEditTab();
}

function swapOrd(id1, id2){
  const a = items.find(x=>x.id===id1);
  const b = items.find(x=>x.id===id2);
  if(!a || !b) return;
  // ì¹´í…Œê³ ë¦¬ë³„ ì •ë ¬ í•„ìˆ˜
  if(a.cat !== b.cat){
    swapPickId = null;
    return alert("âš ï¸ ì •ë ¬ êµì²´ëŠ” ê°™ì€ ì¹´í…Œê³ ë¦¬ë¼ë¦¬ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  }
  const tmp = a.ord;
  a.ord = b.ord;
  b.ord = tmp;
  save(LS_ITEMS, items);
}

function saveItemEdit(it, patch){
  const before = {name:it.name, price:it.price, cat:it.cat, active:it.active, ord:it.ord};
  const after = {...before, ...patch};
  const ok = confirm(
`ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

- ì´ë¦„: ${before.name} â†’ ${after.name}
- ê°€ê²©: ${won(before.price)} â†’ ${won(after.price)}
- ì¹´í…Œê³ ë¦¬: ${before.cat} â†’ ${after.cat}
- í‘œì‹œ: ${before.active? "ON":"OFF"} â†’ ${after.active? "ON":"OFF"}
- ì •ë ¬: ${before.ord} â†’ ${after.ord}`
  );
  if(!ok) return false;

  Object.assign(it, after);
  save(LS_ITEMS, items);
  return true;
}

function renderEditTab(){
  renderEdCatRow();

  const q = (edQ.value||"").trim();
  let list = items.slice();
  if(edCat !== "ì „ì²´") list = list.filter(it=>it.cat===edCat);
  if(q) list = list.filter(it=>matchItem(it,q));

  list.sort((a,b)=> (Number(a.ord||0)-Number(b.ord||0)) || a.name.localeCompare(b.name,"ko"));

  edList.innerHTML = "";
  if(!list.length){
    edList.innerHTML = `<div class="muted" style="padding:8px 6px; font-weight:900;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
    return;
  }

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "li" + (sortMode && swapPickId===it.id ? " swapPick":"");

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="t">${it.name}</div>
      <div class="s">${it.cat} Â· ${won(it.price)} Â· í‘œì‹œ ${Number(it.active)===1?"ON":"OFF"} Â· ì •ë ¬ ${Number(it.ord||0)}</div>
    `;

    const right = document.createElement("div");
    right.style.display="flex";
    right.style.gap="8px";
    right.style.flexWrap="wrap";
    right.style.justifyContent="flex-end";

    // ì •ë ¬ëª¨ë“œ ONì´ë©´ ë²„íŠ¼ ëŒ€ì‹  "íƒ­(ì„ íƒ/êµì²´)" ë°©ì‹
    if(sortMode){
      row.style.cursor = "pointer";
      row.onclick = ()=>{
        if(!swapPickId){
          swapPickId = it.id;
          renderEditTab();
        }else if(swapPickId === it.id){
          swapPickId = null;
          renderEditTab();
        }else{
          // êµì²´
          swapOrd(swapPickId, it.id);
          swapPickId = null;
          renderAll();
          renderEditTab();
        }
      };
      right.innerHTML = `<button class="btnMini">${swapPickId===it.id ? "ì„ íƒë¨" : "íƒ­ìœ¼ë¡œ ì„ íƒ"}</button>`;
    }else{
      const bEdit = document.createElement("button");
      bEdit.className = "btnMini";
      bEdit.textContent = "ìˆ˜ì •";
      bEdit.onclick = ()=>{
        const newN = prompt("ìƒí’ˆëª…", it.name);
        if(newN===null) return;
        const newP = prompt("ê°€ê²©(ìˆ«ìë§Œ)", String(it.price||0));
        if(newP===null) return;

        const newC = prompt("ì¹´í…Œê³ ë¦¬(ê³¼ì¼/ì•¼ì±„/ë´‰ì§€ì±„ì†Œ/ìƒì„ /ê¸°íƒ€)", it.cat);
        if(newC===null) return;

        const newA = confirm("í‘œì‹œ(ON) ìƒíƒœë¡œ ë‘˜ê¹Œìš”? (ì·¨ì†Œ=ìˆ¨ê¹€/OFF)") ? 1 : 0;
        const newO = prompt("ì •ë ¬(ìˆ«ì, ë‚®ì„ìˆ˜ë¡ ì•)", String(it.ord||0));
        if(newO===null) return;

        const patch = {
          name: String(newN||"").trim() || it.name,
          price: toNumber(newP),
          cat: CATS.includes(String(newC).trim()) ? String(newC).trim() : it.cat,
          active: newA,
          ord: toInt(newO, Number(it.ord||0)),
        };

        const ok = saveItemEdit(it, patch);
        if(ok){
          alert("âœ… ìˆ˜ì • ì™„ë£Œ");
          renderAll();
          renderEditTab();
        }
      };

      const bHide = document.createElement("button");
      bHide.className = "btnMini bad";
      bHide.textContent = "ìˆ¨ê¹€";
      bHide.onclick = ()=>{
        const ok = confirm(`"${it.name}" ìˆ¨ê¹€ ì²˜ë¦¬í• ê¹Œìš”?`);
        if(!ok) return;
        it.active = 0;
        save(LS_ITEMS, items);
        renderAll();
        renderEditTab();
      };

      right.appendChild(bEdit);
      right.appendChild(bHide);
    }

    row.appendChild(left);
    row.appendChild(right);
    edList.appendChild(row);
  });
}

/* ===============================
   ê´€ë¦¬ì íƒ­ ì „í™˜
================================= */
function setAdminTab(key){
  tab_an.classList.add("hide");
  tab_so.classList.add("hide");
  tab_ed.classList.add("hide");
  adminTabs.querySelectorAll(".aTab").forEach(b=>b.classList.remove("active"));
  adminTabs.querySelector(`.aTab[data-tab="${key}"]`)?.classList.add("active");

  if(key==="an"){
    tab_an.classList.remove("hide");
    renderAnalysisUI();
  }else if(key==="so"){
    tab_so.classList.remove("hide");
    renderSoldOutTab();
  }else{
    tab_ed.classList.remove("hide");
    renderNewCatOptions();
    renderEditTab();
  }
}

function renderAdminAll(){
  setAdminTab("an");
}

/* ===============================
   ì „ì²´ ë Œë”
================================= */
function renderAll(){
  seedItemsIfEmpty();

  items = loadRaw(LS_ITEMS, items);
  pins  = normalizePins(loadRaw(LS_PINS, pins));
  cart  = normalizeCart(loadRaw(LS_CART, cart));
  paid  = loadRaw(LS_PAID, paid);
  misu  = loadRaw(LS_MISU, misu);

  save(LS_CART, cart);
  save(LS_PINS, pins);

  renderTabs();
  renderKeys();
  renderGrid();
  renderCart();
  renderSummary();
}

/* ===============================
   ì´ë²¤íŠ¸
================================= */
elQ.addEventListener("input", ()=>{
  query = elQ.value;
  // ê²€ìƒ‰ì¤‘ì—” ì „ì¹´í…Œê³ ë¦¬ì´ë¯€ë¡œ gridë§Œ ê°€ë³ê²Œ ë‹¤ì‹œ ê·¸ë¦¼
  renderGrid();
});

document.querySelectorAll(".cashBtn[data-add]").forEach(b=>{
  b.addEventListener("click", ()=> addPaid(Number(b.dataset.add||0)));
});

elPaidReset.addEventListener("click", ()=>{
  paid = 0;
  save(LS_PAID, paid);
  renderSummary();
});

elPayBtn.addEventListener("click", doPay);

elSaveMisu.addEventListener("click", saveMisuNow);
elMisuPill.addEventListener("click", openMisu);

elCartPill.addEventListener("click", resetCartAll);

elModalBack.addEventListener("click", (e)=>{
  if(e.target === elModalBack) closeMisu();
});
elMClose.addEventListener("click", closeMisu);

/* ë™ê¸°í™” */
syncBtn.addEventListener("click", ()=> runSync({force:true, silent:false}));
setInterval(()=>{
  try{
    const cnt = cartCount();
    if(cnt === 0){
      runSync({force:false, silent:true});
    }
  }catch(e){}
}, 120_000);

/* ê´€ë¦¬ì */
elAdminPill.addEventListener("click", openAdmin);
aClose.addEventListener("click", closeAdmin);
adminBack.addEventListener("click", (e)=>{
  if(e.target === adminBack) closeAdmin();
});
adminTabs.addEventListener("click", (e)=>{
  const b = e.target.closest(".aTab");
  if(!b) return;
  setAdminTab(b.dataset.tab);
});

/* í’ˆì ˆ ê²€ìƒ‰ */
soQ.addEventListener("input", renderSoldOutTab);

/* ìƒí’ˆìˆ˜ì • ê²€ìƒ‰/ì •ë ¬ */
edQ.addEventListener("input", renderEditTab);
btnSortMode.addEventListener("click", toggleSortMode);
btnAddItem.addEventListener("click", addNewItem);

/* ===============================
   ì´ˆê¸° ì‹¤í–‰
================================= */
// í˜ì´ì§€ ì—´ë¦´ ë•Œ 1íšŒ ìë™ ë™ê¸°í™”(ì˜¤ëŠ˜ í–ˆìœ¼ë©´ ìŠ¤í‚µ)
(async () => {
  try { await syncItemsFromSheet({ force:false }); }
  catch (e) { /* ì‹œíŠ¸ ì•ˆ ì¨ë„ ë˜ëŠ” êµ¬ì¡°ë¼ ì¡°ìš©íˆ */ }
})();
setSyncInfo();
renderAll();
</script>
</body>
</html>
