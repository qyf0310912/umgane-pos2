<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS (ì‹¤ë¬´ ìµœì¢…)</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#111319;
    --panel2:#0f1116;
    --line:rgba(255,255,255,.08);
    --text:#f5f7ff;
    --muted:rgba(245,247,255,.65);
    --accent:#ff9f00;
    --good:#29d17e;
    --bad:#ff3b30;
    --shadow:0 12px 40px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  button{border:0;border-radius:14px;cursor:pointer}
  .app{height:100%;display:grid;grid-template-columns: 1.25fr .75fr;gap:12px;padding:12px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--line); border-radius:22px; box-shadow:var(--shadow); overflow:hidden}
  .left{display:flex;flex-direction:column;min-width:0}
  .right{display:flex;flex-direction:column;min-width:0}

  /* Top controls */
  .topbar{padding:12px;display:flex;flex-direction:column;gap:10px;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line)}
  .tab.active{outline:2px solid rgba(255,159,0,.55); background:rgba(255,159,0,.10)}
  .row{display:flex;gap:10px;align-items:center}
  .search{flex:1;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.03);
    border:1px solid var(--line); border-radius:16px; padding:10px 12px; min-width:0}
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:16px;min-width:0}
  .sortBtn{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line)}
  .keys{display:flex;gap:8px;flex-wrap:wrap}
  .kbtn{width:44px;height:38px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:12px}
  .kbtn.clear{background:rgba(255,59,48,.15);border-color:rgba(255,59,48,.25)}
  .hint{color:var(--muted);font-size:12px}

  /* Pinned strip */
  .pinned{padding:10px 12px;border-bottom:1px solid var(--line)}
  .pinnedTitle{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;margin-bottom:8px}
  .pinnedGrid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px}
  .emptyPinned{color:var(--muted);font-size:13px}

  /* Items grid */
  .itemsWrap{flex:1;min-height:0;overflow:auto;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:12px}
  .card{position:relative; background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:18px;
    padding:12px; min-height:88px; display:flex; flex-direction:column; gap:8px}
  .name{font-size:18px;font-weight:900;letter-spacing:-.3px;line-height:1.05}
  .price{font-size:13px;color:var(--muted);font-weight:800}
  .chip{align-self:flex-start;padding:6px 10px;border-radius:999px;font-size:12px;
    background:rgba(255,255,255,.04);border:1px solid var(--line); color:var(--text)}
  .pinIcon{position:absolute; right:10px; bottom:10px; width:34px;height:34px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,159,0,.10); border:1px solid rgba(255,159,0,.20); color:var(--accent); font-weight:900}
  /* âœ… í•€ ì•ˆì“°ëŠ”ê±° ë” íë¦¬ê²Œ */
  .pinIcon.off{opacity:.18; background:rgba(255,255,255,.03); border:1px solid var(--line); color:var(--muted)}
  .card:active{transform:scale(.99)}
  .card.pinnedCard{outline:2px solid rgba(255,159,0,.40)}
  /* âœ… ì‚¬ìš© ë…¸ì¶œ ê¸°ë³¸ OFF (í•„ìš”í•˜ë©´ trueë¡œ ì¼œëŠ” ì˜µì…˜ ìˆìŒ) */
  .meta{display:none; position:absolute; left:10px; bottom:10px; font-size:11px; color:rgba(245,247,255,.45)}

  /* Right panel */
  .rTop{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .rBtns{display:flex;gap:8px;align-items:center}
  .btnMini{padding:10px 12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line)}
  .btnMini.accent{background:rgba(255,159,0,.14);border-color:rgba(255,159,0,.22);color:var(--text)}
  .btnMini.danger{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}

  .cartWrap{flex:1;min-height:0;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  /* âœ… ì¥ë°”êµ¬ë‹ˆ ì¹´ë“œ â€œí´ë¦­ë˜ëŠ” ëŠë‚Œâ€ ì œê±° */
  .cartItem{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:10px 10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px; cursor:default; user-select:none}
  .ciLeft{min-width:0;display:flex;flex-direction:column;gap:4px}
  /* âœ… í•œ ì¤„: í’ˆëª©ëª… ê¸¸ë©´ ... */
  .ciLine{display:flex;align-items:center;gap:10px;min-width:0}
  .ciName{font-weight:900;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
  /* âœ… ê°€ê²© í­ ì •ë ¬ ë§ì¶”ê¸°(ê³ ì •í­) */
  .ciAmt{font-weight:900;font-size:16px;flex:0 0 120px;text-align:right;white-space:nowrap}
  .ciSub{display:none;color:var(--muted);font-size:12px}

  .ciRight{display:flex;align-items:center;gap:8px}
  .qtyBtn{width:42px;height:34px;border-radius:12px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-size:18px}
  /* âœ… - 1 + ê°€ìš´ë° ìˆ«ì */
  .qtyNum{width:34px;text-align:center;font-weight:900;color:var(--text);opacity:.9}
  .delBtn{width:42px;height:34px;border-radius:12px;background:rgba(255,59,48,.16);color:var(--text);border:1px solid rgba(255,59,48,.28);font-size:18px}

  /* âœ… ì´í•©ê³„/ë°›ì€ëˆ/ê±°ìŠ¤ë¦„ëˆ: ì¥ë°”êµ¬ë‹ˆ ì•„ë˜ì— ë°°ì¹˜ */
  .sumRow{padding:12px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:10px}
  .totalBlock{display:flex;flex-direction:column;gap:6px}
  .totalLbl{color:var(--muted);font-size:12px;font-weight:800}
  .totalVal{font-size:38px;font-weight:950;letter-spacing:-.8px}

  .money3{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  /* âœ… ë°›ì€ëˆ | ê±°ìŠ¤ë¦„ëˆ ì™¼ìª½ì •ë ¬ */
  .mBox{display:flex;flex-direction:column;gap:6px}
  .mLbl{color:var(--muted);font-size:12px;font-weight:800}
  .mVal{font-size:28px;font-weight:950;text-align:left}

  .btnGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px}
  .moneyBtn{height:48px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);border-radius:16px;font-size:16px;font-weight:900}
  .moneyBtn.reset{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}

  .bottom{padding:12px;border-top:1px solid var(--line);display:flex;gap:10px}
  .checkout{flex:1;height:62px;border-radius:18px;background:linear-gradient(180deg, rgba(255,159,0,1), rgba(255,159,0,.85));
    color:#101116;font-size:22px;font-weight:950}
  .hold{width:140px;height:62px;border-radius:18px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-size:18px;font-weight:950}
  .hold small{display:block;font-size:12px;color:var(--muted);font-weight:800}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:12px}
  .modal.show{display:flex}
  .sheet{width:min(860px, 100%);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow)}
  .sheetHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
  .sheetHead .title{font-weight:950;font-size:18px}
  .sheetBody{padding:12px;display:flex;flex-direction:column;gap:10px}
  .holdRow{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:10px;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .holdRow .hName{font-weight:950}
  .holdRow .hAmt{color:var(--muted);font-weight:900}
  .holdRow .hBtns{display:flex;gap:8px}
  .hBtn{padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);color:var(--text);border:1px solid var(--line);font-weight:950}
  .hBtn.del{background:rgba(255,59,48,.16);border-color:rgba(255,59,48,.28)}
  .hBtn.ok{background:rgba(41,209,126,.14);border-color:rgba(41,209,126,.22)}

  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(15,17,22,.95);
    border:1px solid var(--line);border-radius:999px;padding:10px 14px;color:var(--text);font-weight:900;display:none}
  .toast.show{display:block}

  /* =========================
     Responsive (íƒœë¸”ë¦¿ ê°€ë¡œ ìµœì )
     - iPad Pro 12.9" ê°€ë¡œ: 1366px
  ========================= */

  @media (min-width: 1401px){
    .app{ grid-template-columns: 1.25fr .75fr; }
    .grid,.pinnedGrid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }

  /* âœ… íƒœë¸”ë¦¿ ê°€ë¡œ(<=1400): 3/1 ê²°ì œì°½ ê°•ì œ + 5ì—´ */
  @media (max-width: 1400px){
    .app{ grid-template-columns: 1.35fr .65fr; } /* 3/1 ëŠë‚Œ */
    .grid,.pinnedGrid{ grid-template-columns: repeat(5, minmax(0,1fr)); }

    .card{ min-height: 82px; padding: 10px; }
    .name{ font-size: 17px; }
    .price{ font-size: 12.5px; }
    .ciName{ font-size: 15px; }
    .ciAmt{ font-size: 15px; flex-basis: 110px; }
    .totalVal{ font-size: 36px; }
    .mVal{ font-size: 26px; }
  }

  @media (max-width: 980px){
    .app{grid-template-columns:1fr;grid-template-rows:1.1fr .9fr}
    .grid,.pinnedGrid{grid-template-columns:repeat(3, minmax(0,1fr))}
  }
  @media (max-width: 520px){
    .grid,.pinnedGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
    .totalVal{font-size:34px}
  }
</style>
</head>
<body>
<div class="app">
  <section class="panel left">
    <div class="topbar">
      <div class="tabs" id="tabs"></div>

      <div class="row">
        <div class="search">
          <span style="opacity:.8">ğŸ”</span>
          <input id="q" placeholder="ì „í’ˆëª© ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã„±)" autocomplete="off" />
        </div>
        <button class="sortBtn" id="sortBtn">ì •ë ¬: ê³ ì • + ord</button>
      </div>

      <div class="keys" id="chosungKeys"></div>
      <div class="hint">â€¢ ìƒí’ˆ í´ë¦­=ë‹´ê¸°  â€¢ ìƒí’ˆ ê¸¸ê²Œ(0.45ì´ˆ)=ê³ ì •/í•´ì œ  â€¢ ê²€ìƒ‰ì€ ì¹´í…Œê³ ë¦¬ ë¬´ê´€(ì „í’ˆëª©)</div>
    </div>

    <div class="pinned" id="pinnedBox">
      <div class="pinnedTitle">
        <span>ê³ ì • Â· ìƒë‹¨</span>
        <span class="hint">ê³ ì •ì€ â€œê¸¸ê²Œ ëˆŒëŸ¬â€ í† ê¸€</span>
      </div>
      <div class="pinnedGrid" id="pinnedGrid"></div>
    </div>

    <div class="itemsWrap">
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <section class="panel right">
    <div class="rTop">
      <button class="btnMini accent" id="holdsBtn">ë¯¸ìˆ˜(0)</button>
      <div class="rBtns">
        <button class="btnMini danger" id="cartResetBtn">ì¥ë°”êµ¬ë‹ˆ ë¦¬ì…‹</button>
      </div>
    </div>

    <div class="cartWrap" id="cartWrap"></div>

    <div class="sumRow">
      <div class="totalBlock">
        <div class="totalLbl" id="totalLbl">ì´í•©ê³„(0ê°œ)</div>
        <div class="totalVal" id="grandTotal">0ì›</div>
      </div>

      <div class="money3">
        <div class="mBox">
          <div class="mLbl">ë°›ì€ëˆ</div>
          <div class="mVal" id="receivedVal">0ì›</div>
        </div>
        <div class="mBox">
          <div class="mLbl">ê±°ìŠ¤ë¦„ëˆ</div>
          <div class="mVal" id="changeVal">0ì›</div>
        </div>
      </div>

      <div class="btnGrid">
        <button class="moneyBtn" data-add="500">+500</button>
        <button class="moneyBtn" data-add="1000">+1ì²œ</button>
        <button class="moneyBtn" data-add="5000">+5ì²œ</button>
        <button class="moneyBtn" data-add="10000">+1ë§Œ</button>
        <button class="moneyBtn" data-add="50000">+5ë§Œ</button>
        <button class="moneyBtn reset" id="receivedReset">ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="bottom">
      <button class="hold" id="holdNow">
        ë¯¸ìˆ˜
        <small>í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</small>
      </button>
      <button class="checkout" id="checkout">ê²°ì œì™„ë£Œ</button>
    </div>
  </section>
</div>

<!-- Holds modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheetHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="hBtn" id="closeModal">ë‹«ê¸°</button>
    </div>
    <div class="sheetBody" id="holdsList"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =============================
   âœ… ì„¤ì • (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
============================= */
const CSV_URL = "https://docs.google.com/spreadsheets/d/1MK7TvyILEJ4_YKw1TmY1Au4Z_ZkGbF7LeRMsi89slbw/export?format=csv&gid=0";
const APP_VER = "umgane_pos_v20251224_fix_3";

/* =============================
   ì €ì¥ í‚¤
============================= */
const LS_VER   = "umgane_app_ver";
const LS_ITEMS = "umgane_items_v1";
const LS_PINS  = "umgane_pins_v1";
const LS_CART  = "umgane_cart_v1";
const LS_REC   = "umgane_received_v1";
const LS_USED  = "umgane_used_v1";
const LS_HOLDS = "umgane_holds_v1";

/* =============================
   ìœ í‹¸
============================= */
const $ = (s)=>document.querySelector(s);
const el = (tag, props={})=>{
  const n=document.createElement(tag);
  Object.assign(n, props);
  return n;
};

function toast(msg){
  const t=$("#toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"), 1100);
}

function krw(n){
  n = Math.max(0, Math.round(Number(n||0)));
  return n.toLocaleString("ko-KR") + "ì›";
}

function parsePrice(v){
  if(v==null) return 0;
  const s = String(v).trim();
  if(!s) return 0;
  const cleaned = s.replace(/[^\d.]/g,"");
  if(!cleaned) return 0;
  const num = Number(cleaned);
  if(!isFinite(num)) return 0;
  return Math.round(num);
}

function normCat(c){
  c = (c||"").trim();
  if(c==="ë´‰ì±„ì†Œ") c="ë´‰ì§€ì±„ì†Œ";
  return c || "ê¸°íƒ€";
}

/* =============================
   ì´ˆì„±
============================= */
const CHO = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChoChar(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return ch;
  const idx = Math.floor((code - 0xAC00) / (21*28));
  return CHO[idx] || ch;
}
function toChosung(str){
  return Array.from(String(str||"")).map(getChoChar).join("");
}
function isChosungQuery(q){
  return /^[ã„±-ã…]+$/.test(q); // âœ… ììŒë§Œì´ë©´ â€œì´ˆì„± í”„ë¦¬í”½ìŠ¤â€ë¡œ ë§¤ì¹­
}

/* =============================
   ë²„ì „ ì •ë¦¬(ê¼¬ì„ ë°©ì§€)
============================= */
(function ensureVersion(){
  const prev = localStorage.getItem(LS_VER);
  if(prev !== APP_VER){
    localStorage.setItem(LS_VER, APP_VER);
    localStorage.removeItem(LS_PINS);
    localStorage.removeItem(LS_CART);
    localStorage.removeItem(LS_REC);
    localStorage.removeItem(LS_USED);
    localStorage.removeItem(LS_HOLDS);
  }
})();

/* =============================
   ìƒíƒœ
============================= */
const CATS = ["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];
let activeCat = "ê³¼ì¼";
let items = [];
let pins = new Set(JSON.parse(localStorage.getItem(LS_PINS)||"[]"));
let cart = JSON.parse(localStorage.getItem(LS_CART)||"{}");
let used = JSON.parse(localStorage.getItem(LS_USED)||"{}");
let received = Number(localStorage.getItem(LS_REC)||"0") || 0;
let holds = JSON.parse(localStorage.getItem(LS_HOLDS)||"[]");

/* =============================
   CSV íŒŒì„œ
============================= */
function parseCSV(text){
  const rows=[];
  let cur="", inQ=false, row=[];
  const pushCell=()=>{ row.push(cur); cur=""; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch === '"'){
      if(inQ && text[i+1] === '"'){ cur+='"'; i++; }
      else inQ=!inQ;
    }else if(ch === ',' && !inQ){
      pushCell();
    }else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && text[i+1] === '\n') i++;
      pushCell(); pushRow();
    }else{
      cur+=ch;
    }
  }
  if(cur.length || row.length){ pushCell(); pushRow(); }
  return rows;
}

/* =============================
   ë¡œë“œ
============================= */
async function loadItems(){
  const cached = localStorage.getItem(LS_ITEMS);
  if(cached){
    try{
      const arr = JSON.parse(cached);
      if(Array.isArray(arr) && arr.length){
        items = arr;
        renderAll();
      }
    }catch(e){}
  }

  try{
    const res = await fetch(CSV_URL + "&_ts=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("CSV ë¡œë“œ ì‹¤íŒ¨");
    const csv = await res.text();
    const rows = parseCSV(csv).filter(r=>r.some(x=>String(x||"").trim()!==""));
    if(rows.length < 2) throw new Error("CSV ë‚´ìš© ì—†ìŒ");

    const header = rows[0].map(h=>String(h||"").trim().toLowerCase());
    const idx = (k)=>header.indexOf(k);
    const iId = idx("id");
    const iCat = idx("cat");
    const iName = idx("name");
    const iPrice = idx("price");
    const iActive = idx("active");
    const iOrd = idx("ord");

    const out=[];
    for(let r=1;r<rows.length;r++){
      const line = rows[r];
      const id = String(line[iId]??"").trim();
      const cat = normCat(String(line[iCat]??"").trim());
      const name = String(line[iName]??"").trim();
      const price = parsePrice(line[iPrice]);
      const active = String(line[iActive]??"1").trim();
      const ordRaw = String(line[iOrd]??"").trim();
      const ordNum = ordRaw==="" ? 1e15 : Number(ordRaw);
      if(!id || !name) continue;
      if(active==="0" || active.toLowerCase()==="false") continue;
      out.push({ id, cat, name, price, ordNum });
    }

    out.forEach(x=>{ if(!CATS.includes(x.cat)) x.cat="ê¸°íƒ€"; });

    items = out;
    localStorage.setItem(LS_ITEMS, JSON.stringify(items));
    renderAll();
    toast("ìƒí’ˆ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  }catch(e){
    if(!items.length) toast("CSV ë¡œë“œ ì‹¤íŒ¨(ì‹œíŠ¸ ê³µìœ /ê²Œì‹œ í™•ì¸)");
  }
}

/* =============================
   ë Œë”
============================= */
function buildTabs(){
  const box = $("#tabs");
  box.innerHTML="";
  CATS.forEach(c=>{
    const b = el("button",{className:"tab"+(c===activeCat?" active":""), textContent:c});
    b.onclick=()=>{ activeCat=c; buildTabs(); renderAll(); };
    box.appendChild(b);
  });
}

function buildChosungKeys(){
  const box = $("#chosungKeys");
  box.innerHTML="";
  CHO.forEach(ch=>{
    const b=el("button",{className:"kbtn", textContent:ch});
    b.onclick=()=>{ $("#q").value += ch; renderAll(); };
    box.appendChild(b);
  });
  const clr=el("button",{className:"kbtn clear", textContent:"X"});
  clr.onclick=()=>{ $("#q").value=""; renderAll(); };
  box.appendChild(clr);
}

/* âœ… ê²€ìƒ‰ ë¡œì§:
   - ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´: íƒ­(cat) ê¸°ì¤€ë§Œ í‘œì‹œ
   - ê²€ìƒ‰ì–´ ìˆìœ¼ë©´: â€œì „í’ˆëª©â€ì—ì„œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ(ì¹´í…Œê³ ë¦¬ ë¬´ê´€)
   - ììŒë§Œ(ì´ˆì„±) ì…ë ¥ì´ë©´: ì´ˆì„± â€œstartsWithâ€ë¡œ ë§¤ì¹­ (ã……ã„± => ì‚¬ê³¼)
*/
function getFiltered(){
  const q = $("#q").value.trim();
  const qLow = q.toLowerCase();
  const qCho = q; // ììŒì¿¼ë¦¬ë©´ ê·¸ëŒ€ë¡œ prefix ë§¤ì¹­

  let list = items.slice();

  if(!q){
    // ê²€ìƒ‰ì–´ ì—†ì„ ë•Œë§Œ íƒ­ í•„í„°
    list = list.filter(x=>x.cat===activeCat);
  }else{
    const onlyCho = isChosungQuery(q);
    list = list.filter(x=>{
      const nameLow = x.name.toLowerCase();
      const choName = toChosung(x.name);
      if(onlyCho){
        return choName.startsWith(qCho); // âœ… í•µì‹¬: includes ë§ê³  startsWith
      }
      // ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” í¬í•¨ê²€ìƒ‰ + ì´ˆì„± í¬í•¨ê²€ìƒ‰
      return nameLow.includes(qLow) || choName.includes(toChosung(q));
    });
  }

  // ì •ë ¬: ê³ ì • -> ord -> ì´ë¦„
  list.sort((a,b)=>{
    const ap = pins.has(a.id) ? 0 : 1;
    const bp = pins.has(b.id) ? 0 : 1;
    if(ap!==bp) return ap-bp;
    if(a.ordNum!==b.ordNum) return a.ordNum-b.ordNum;
    return a.name.localeCompare(b.name,"ko");
  });

  return list;
}

function renderPinned(){
  const box = $("#pinnedGrid");
  box.innerHTML="";
  const pinnedItems = items
    .filter(x=>pins.has(x.id))
    .sort((a,b)=>a.ordNum-b.ordNum || a.name.localeCompare(b.name,"ko"));

  if(!pinnedItems.length){
    box.innerHTML = `<div class="emptyPinned">ê³ ì • ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. (ìƒí’ˆì„ ê¸¸ê²Œ ëˆŒëŸ¬ ê³ ì •)</div>`;
    return;
  }
  pinnedItems.slice(0,12).forEach(x=> box.appendChild(makeCard(x)) );
}

function makeCard(x){
  const c = el("div",{className:"card"+(pins.has(x.id)?" pinnedCard":"")});
  const n = el("div",{className:"name", textContent:x.name});
  const p = el("div",{className:"price", textContent:krw(x.price)});
  const chip = el("div",{className:"chip", textContent:x.cat});
  const pin = el("div",{className:"pinIcon "+(pins.has(x.id)?"":"off"), textContent:"ğŸ“Œ"});
  c.append(n,p,chip,pin);

  c.addEventListener("click", ()=>{
    if(c._longFired) { c._longFired=false; return; }
    addToCart(x.id, 1);
  });

  let tmr=null;
  c.addEventListener("pointerdown", ()=>{
    c._longFired=false;
    tmr=setTimeout(()=>{
      c._longFired=true;
      togglePin(x.id);
    }, 450);
  });
  ["pointerup","pointerleave","pointercancel"].forEach(ev=>{
    c.addEventListener(ev, ()=>{ if(tmr) clearTimeout(tmr); });
  });
  return c;
}

function renderGrid(){
  const grid=$("#grid");
  grid.innerHTML="";
  const list=getFiltered();
  list.forEach(x=>grid.appendChild(makeCard(x)));
}

function savePins(){ localStorage.setItem(LS_PINS, JSON.stringify(Array.from(pins))); }
function togglePin(id){
  if(pins.has(id)) pins.delete(id);
  else pins.add(id);
  savePins();
  renderAll();
  toast(pins.has(id) ? "ê³ ì •ë¨" : "ê³ ì •í•´ì œ");
}

function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }
function saveUsed(){ localStorage.setItem(LS_USED, JSON.stringify(used)); }
function saveReceived(){ localStorage.setItem(LS_REC, String(received)); }
function saveHolds(){ localStorage.setItem(LS_HOLDS, JSON.stringify(holds)); }

function addToCart(id, d){
  cart[id] = (cart[id]||0) + d;
  if(cart[id] <= 0) delete cart[id];
  used[id] = (used[id]||0) + 1;
  saveCart(); saveUsed();
  renderCart();
}
function setQty(id, qty){
  if(qty<=0) delete cart[id];
  else cart[id]=qty;
  saveCart();
  renderCart();
}

function cartStats(){
  let total=0, cnt=0;
  for(const [id,qty] of Object.entries(cart)){
    const it = items.find(x=>x.id===id);
    if(!it) continue;
    total += it.price * qty;
    cnt += qty;
  }
  return {total, cnt};
}

function renderCart(){
  const wrap=$("#cartWrap");
  wrap.innerHTML="";

  const entries = Object.entries(cart);

  entries.sort((a,b)=>{
    const ia = items.find(x=>x.id===a[0]); const ib = items.find(x=>x.id===b[0]);
    if(!ia && !ib) return 0;
    if(!ia) return 1; if(!ib) return -1;
    const ap = pins.has(ia.id)?0:1, bp=pins.has(ib.id)?0:1;
    if(ap!==bp) return ap-bp;
    if(ia.ordNum!==ib.ordNum) return ia.ordNum-ib.ordNum;
    return ia.name.localeCompare(ib.name,"ko");
  });

  entries.forEach(([id,qty])=>{
    const it = items.find(x=>x.id===id);
    if(!it) return;

    const row = el("div",{className:"cartItem"});
    const left = el("div",{className:"ciLeft"});
    const line = el("div",{className:"ciLine"});
    const nm = el("div",{className:"ciName", textContent:it.name}); // âœ… xN ë”°ë¡œ
    const amt = el("div",{className:"ciAmt", textContent:krw(it.price*qty)});
    line.append(nm, amt);
    left.append(line);

    const right = el("div",{className:"ciRight"});
    const minus = el("button",{className:"qtyBtn", textContent:"â€“"});
    const num   = el("div",{className:"qtyNum", textContent:String(qty)});
    const plus  = el("button",{className:"qtyBtn", textContent:"+"});
    const del   = el("button",{className:"delBtn", textContent:"Ã—"});

    // âœ… ë²„íŠ¼ í´ë¦­ë§Œ ë™ì‘, ë‹¤ë¥¸ ê³³ì€ ì•„ë¬´ ë°˜ì‘ ì—†ê²Œ
    [minus,plus,del].forEach(b=>b.addEventListener("click",(e)=>e.stopPropagation()));

    minus.onclick=()=>setQty(id, qty-1);
    plus.onclick =()=>setQty(id, qty+1);
    del.onclick  =()=>setQty(id, 0);

    right.append(minus, num, plus, del);
    row.append(left,right);
    wrap.appendChild(row);
  });

  // ë¹ˆì¤„ ì±„ìš°ê¸°(ìµœì†Œ 7ì¤„)
  const minRows = 7;
  const need = Math.max(0, minRows - entries.length);
  for(let i=0;i<need;i++){
    const dummy = el("div",{className:"cartItem"});
    dummy.style.opacity = .18;
    dummy.innerHTML = `<div class="ciLeft"><div class="ciLine"><div class="ciName"> </div><div class="ciAmt"> </div></div></div>`;
    wrap.appendChild(dummy);
  }

  const {total,cnt}=cartStats();

  $("#totalLbl").textContent = `ì´í•©ê³„(${cnt.toLocaleString("ko-KR")}ê°œ)`;
  $("#grandTotal").textContent = krw(total);
  $("#receivedVal").textContent = krw(received);
  $("#changeVal").textContent = krw(Math.max(0, received - total));

  $("#holdsBtn").textContent = `ë¯¸ìˆ˜(${holds.length})`;
}

function renderAll(){
  buildTabs();
  renderPinned();
  renderGrid();
  renderCart();
}

/* =============================
   ë¯¸ìˆ˜ ê¸°ëŠ¥
============================= */
function holdSummaryText(h){
  // âœ… ë¯¸ìˆ˜ ëª©ë¡ì— â€œìƒí’ˆ ìš”ì•½ â€¦â€ ë§Œë“¤ê¸°
  const names = [];
  for(const [id,qty] of Object.entries(h.cart||{})){
    const it = items.find(x=>x.id===id);
    if(!it) continue;
    names.push(qty>1 ? `${it.name}x${qty}` : it.name);
  }
  const s = names.join(" Â· ");
  if(s.length <= 26) return s;
  return s.slice(0,26) + "â€¦";
}

function pushHold(){
  const {total,cnt} = cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }

  holds.unshift({
    id: "H"+Date.now(),
    ts: Date.now(),
    cart: {...cart},
    total, cnt
  });
  saveHolds();

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  renderCart();
  toast("ë¯¸ìˆ˜ë¡œ ì €ì¥ë¨");
}

function openHolds(){
  $("#modal").classList.add("show");
  renderHoldsList();
}
function closeHolds(){
  $("#modal").classList.remove("show");
}

function renderHoldsList(){
  const box=$("#holdsList");
  box.innerHTML="";
  if(!holds.length){
    box.innerHTML = `<div class="hint">ë¯¸ìˆ˜ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  holds.forEach((h,idx)=>{
    const row = el("div",{className:"holdRow"});
    const left = el("div",{});
    const t = new Date(h.ts);
    const time = `${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`;

    // âœ… ë¯¸ìˆ˜1 ì˜†ì— ê¸ˆì•¡ ë‚˜ì˜¤ê²Œ + ìƒí’ˆ ìš”ì•½ í‘œì‹œ
    left.innerHTML = `
      <div class="hName">ë¯¸ìˆ˜ ${idx+1} <span class="hint">(${time})</span> Â· <span class="hAmt">${krw(h.total)}</span></div>
      <div class="hint">${holdSummaryText(h)}</div>
    `;

    const btns = el("div",{className:"hBtns"});
    const load = el("button",{className:"hBtn", textContent:"ë¶ˆëŸ¬ì˜¤ê¸°"});
    const ok   = el("button",{className:"hBtn ok", textContent:"ë¯¸ìˆ˜ì™„ë£Œ"});
    const del  = el("button",{className:"hBtn del", textContent:"ì‚­ì œ"});

    load.onclick=()=>{
      cart = {...h.cart};
      received = 0;
      saveCart(); saveReceived();
      closeHolds();
      renderCart();
      toast("ë¯¸ìˆ˜ ë¶ˆëŸ¬ì˜´");
    };

    // âœ… ë¯¸ìˆ˜ì™„ë£Œ: ë¶ˆëŸ¬ì™€ì„œ ê²°ì œ ì²˜ë¦¬í•˜ëŠ” íë¦„ì´ ì•„ë‹ˆë¼ â€œëª©ë¡ì—ì„œ ì œê±°â€ (ì‹¤ë¬´ ê¹”ë”)
    ok.onclick=()=>{
      holds = holds.filter(x=>x.id!==h.id);
      saveHolds();
      renderCart();
      renderHoldsList();
      toast("ë¯¸ìˆ˜ì™„ë£Œ ì²˜ë¦¬");
    };

    del.onclick=()=>{
      holds = holds.filter(x=>x.id!==h.id);
      saveHolds();
      renderCart();
      renderHoldsList();
      toast("ì‚­ì œë¨");
    };

    btns.append(load, ok, del);
    row.append(left,btns);
    box.appendChild(row);
  });
}

/* =============================
   ì´ë²¤íŠ¸
============================= */
$("#q").addEventListener("input", ()=>renderAll());

$("#sortBtn").onclick=()=> toast("ì •ë ¬: ê³ ì • + ord (ê³ ì •)");

document.querySelectorAll("[data-add]").forEach(b=>{
  b.onclick=()=>{
    received += Number(b.dataset.add);
    saveReceived();
    renderCart();
  };
});

$("#receivedReset").onclick=()=>{
  received = 0;
  saveReceived();
  renderCart();
  toast("ë°›ì€ëˆë§Œ ì´ˆê¸°í™”");
};

// âœ… ì¥ë°”êµ¬ë‹ˆ ë¦¬ì…‹(ìš”ì²­: F5 ëŒ€ì‹  ë²„íŠ¼ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ)
$("#cartResetBtn").onclick=()=>{
  cart = {};
  received = 0;
  saveCart(); saveReceived();
  renderCart();
  toast("ì¥ë°”êµ¬ë‹ˆ ë¦¬ì…‹");
};

// âœ… ê²°ì œì™„ë£Œ í™•ì¸ì°½ + (ì†Œë¦¬/ì•Œë¦¼ì€ í•„ìš”í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë‹¤ì‹œ ë„£ì„ê²Œ)
$("#checkout").onclick=()=>{
  const {cnt}=cartStats();
  if(cnt<=0){ toast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"); return; }
  if(!confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?")) return;

  cart = {};
  received = 0;
  saveCart(); saveReceived();
  renderCart();
  toast("ê²°ì œì™„ë£Œ");
};

$("#holdNow").onclick=pushHold;
$("#holdsBtn").onclick=openHolds;
$("#closeModal").onclick=closeHolds;
$("#modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeHolds(); });

/* =============================
   ì‹œì‘
============================= */
buildTabs();
buildChosungKeys();
renderAll();
loadItems();
</script>
</body>
</html>
