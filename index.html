<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ì—„ê°€ë„¤ POS</title>

<style>
:root{
  --bg:#0b0c10;
  --panel:#111319;
  --panel2:#0f1116;
  --line:rgba(255,255,255,.08);
  --text:#f5f7ff;
  --muted:rgba(245,247,255,.62);
  --accent:#ff9f00;
  --good:#29d17e;
  --bad:#ff3b30;
  --shadow:0 12px 40px rgba(0,0,0,.35);
  --r:18px;
  --r2:14px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:var(--ui)}
button,input,select,textarea{font-family:inherit}
button{cursor:pointer;border:0;border-radius:12px}
a{color:inherit}

/* layout */
.app{height:100%;padding:12px;display:grid;grid-template-columns:1.35fr .85fr;gap:12px}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius:22px;
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.panel-inner{padding:12px; min-height:0; display:flex; flex-direction:column; gap:10px}

/* top */
.topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  padding:8px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
  letter-spacing:-.2px;
}
.tab.active{
  outline:2px solid rgba(255,159,0,.25);
  border-color: rgba(255,159,0,.6);
  color:#ffe8c2;
}
.right-tools{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.pill{background:rgba(255,255,255,.04);border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-weight:900;font-size:13px}
.pill.accent{border-color:rgba(255,159,0,.55);color:#ffe8c2}
.pill.red{border-color:rgba(255,59,48,.55);color:#ffd7d5;background:rgba(255,59,48,.08)}
.modebtn{
  background:rgba(255,255,255,.04);
  border:1px solid var(--line);
  color:var(--text);
  padding:8px 12px;
  border-radius:999px;
  font-weight:1000;
  font-size:13px;
}
.modebtn.on{
  border-color:rgba(255,159,0,.6);
  outline:2px solid rgba(255,159,0,.22);
  color:#ffe8c2;
}

/* search */
.searchrow{display:flex; gap:10px; align-items:center}
.search{
  flex:1;display:flex;align-items:center;gap:10px;
  padding:10px 12px;background:rgba(0,0,0,.18);
  border:1px solid var(--line);border-radius:14px
}
.search .icon{opacity:.75}
.search input{width:100%;border:0;outline:none;background:transparent;color:var(--text);font-size:14px}
.sortbtn{background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:14px;font-weight:1000;font-size:13px}

/* chosung */
.kb-wrap{display:flex;align-items:center;gap:10px}
.kb{display:flex;flex-wrap:wrap;gap:8px}
.k{min-width:36px;height:30px;padding:0 10px;background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text);border-radius:10px;font-weight:1000;font-size:13px}
.k.clear{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.35);color:#ffd7d5}
.hintline{margin-left:auto;display:flex;align-items:center;gap:10px;color:var(--muted);font-size:12px;white-space:nowrap}
.hintline b{color:#fff}

/* products */
.subline{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:12px}
.scroll{overflow:auto;min-height:0;padding-right:6px}
.grid{display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
@media (min-width:1240px){ .grid{grid-template-columns:repeat(5,minmax(0,1fr))} }
.card{
  position:relative;padding:12px 12px 10px;border-radius:18px;
  background:rgba(255,255,255,.03);border:1px solid var(--line);
  min-height:88px;display:flex;flex-direction:column;gap:6px;user-select:none
}
.card.inactive{opacity:.35;filter:saturate(.5)}
.card .name{font-weight:1000;font-size:18px;letter-spacing:-.4px;line-height:1.05}
.card .price{font-weight:900;font-size:13px;color:rgba(245,247,255,.78)}
.pinbtn{
  position:absolute;right:10px;bottom:10px;width:32px;height:28px;border-radius:10px;
  background:rgba(255,255,255,.04);border:1px solid var(--line);
  display:flex;align-items:center;justify-content:center;font-size:14px
}
.pinbtn.off{opacity:.22}
.pinbtn.on{background:rgba(255,159,0,.10);border-color:rgba(255,159,0,.35)}
.card:hover{border-color:rgba(255,255,255,.12)}
.card:active{transform:translateY(.5px)}

/* right cart/pay */
.cartTop{display:flex;align-items:center;gap:8px}
.cartTop .spacer{margin-left:auto}
.resetBtn{
  background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.35);color:#ffd7d5;
  padding:8px 12px;border-radius:999px;font-weight:1000;font-size:13px
}
.cartList{overflow:auto;min-height:0;padding-right:6px}
.cartRow{
  display:grid;grid-template-columns:1fr 110px 34px 34px 34px 34px;
  align-items:center;gap:8px;padding:10px 10px;border:1px solid var(--line);
  background:rgba(255,255,255,.03);border-radius:16px;margin-bottom:8px;cursor:default
}
.cartRow:hover{border-color:rgba(255,255,255,.10)}
.cartRow .cname{font-weight:1000;font-size:15px;letter-spacing:-.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0}
.cartRow .cprice{font-family:var(--mono);font-weight:900;font-size:13px;color:rgba(245,247,255,.82);text-align:right}
.qbtn{height:30px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text);font-weight:1000}
.qnum{text-align:center;font-weight:1000;font-size:14px;color:rgba(245,247,255,.92)}
.delbtn{height:30px;border-radius:10px;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.35);color:#ffd7d5;font-weight:1000}

/* totals */
.totals{margin-top:auto;border-top:1px solid var(--line);padding-top:10px}
.totalLabel{color:var(--muted);font-size:12px;font-weight:900}
.totalAmt{font-size:40px;font-weight:1100;letter-spacing:-1px;margin:2px 0 10px}
.rcRow{display:grid;grid-template-columns:1fr auto 1fr;align-items:end;gap:10px}
.rcBox .lbl{color:var(--muted);font-size:12px;font-weight:1000}
.rcBox .amt{font-size:24px;font-weight:1100;margin-top:2px}
.rcSep{color:rgba(245,247,255,.35);font-weight:1000;font-size:18px;padding:0 2px}

/* cash */
.cashPad{margin-top:10px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.cashBtn{height:42px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);font-weight:1100}
.cashBtn.reset{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.35);color:#ffd7d5}

/* actions */
.actions{margin-top:10px;display:grid;grid-template-columns:1fr 2fr;gap:10px;align-items:stretch}
.misuBtn{
  background:rgba(255,255,255,.04);border:1px solid var(--line);color:var(--text);
  border-radius:16px;padding:10px 10px;font-weight:1100;display:flex;flex-direction:column;gap:4px;
  justify-content:center;align-items:flex-start
}
.misuBtn small{color:var(--muted);font-weight:900}
.payBtn{
  background:var(--accent);border-radius:18px;font-weight:1200;font-size:26px;letter-spacing:-.6px;
  color:#1b1200;box-shadow:0 18px 40px rgba(255,159,0,.22)
}
.payBtn:active{transform:translateY(1px)}

/* modal */
.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{
  width:min(920px,100%);
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden
}
.modalHead{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line)}
.modalHead .title{font-weight:1200}
.modalBody{padding:14px;max-height:70vh;overflow:auto}
.btn{height:36px;padding:0 12px;border-radius:12px;font-weight:1100;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text)}
.btn.danger{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.35);color:#ffd7d5}
.btn.ok{background:rgba(41,209,126,.12);border-color:rgba(41,209,126,.35);color:#c8ffe4}

/* misu item (compact) */
.misuItem{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:18px;padding:12px;margin-bottom:10px;display:flex;gap:12px;align-items:center}
.misuLeft{min-width:0;flex:1}
.misuTopLine{display:flex;gap:10px;align-items:baseline;font-weight:1100}
.misuTopLine .t{color:var(--muted);font-weight:1000;font-size:12px}
.misuTopLine .amt{margin-left:auto;font-family:var(--mono);font-weight:1200;font-size:13px;color:rgba(245,247,255,.88)}
.misuSummary{margin-top:6px;color:rgba(245,247,255,.85);font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.misuBtns{display:flex;gap:8px;flex-wrap:wrap}

/* ===== ê´€ë¦¬ì ëª¨ë“œ ===== */
.adminWrap{display:none; gap:10px; min-height:0}
.adminTop{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.adminTop .search{max-width:520px}
.adminTop select{
  height:40px;border-radius:14px;border:1px solid var(--line);
  background:rgba(255,255,255,.04);color:var(--text);padding:0 10px;font-weight:1000
}
.adminGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  min-height:0;
}
.adminList{overflow:auto;min-height:0;padding-right:6px}
.adminRow{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
  display:grid;
  grid-template-columns: 110px 1.2fr 140px 120px 90px 90px;
  gap:10px;
  align-items:center;
}
.adminRow .id{font-family:var(--mono);font-weight:1000;color:rgba(245,247,255,.75);font-size:12px}
.adminRow input, .adminRow select{
  height:38px;border-radius:12px;border:1px solid var(--line);
  background:rgba(0,0,0,.18);color:var(--text);
  padding:0 10px;font-weight:1000
}
.adminRow .price{font-family:var(--mono)}
.adminRow .smallbtn{height:38;border-radius:12px;font-weight:1100;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text)}
.adminRow .smallbtn.off{background:rgba(255,59,48,.12);border-color:rgba(255,59,48,.35);color:#ffd7d5}
.adminRow .smallbtn.on{background:rgba(41,209,126,.12);border-color:rgba(41,209,126,.35);color:#c8ffe4}
.adminBox{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
}
.adminBox h3{margin:0 0 8px;font-size:14px;font-weight:1200}
.adminBox .row{display:flex;gap:8px;flex-wrap:wrap}
.adminBox textarea{
  width:100%;
  min-height:120px;
  resize:vertical;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.18);
  color:var(--text);
  padding:10px;
  font-family:var(--mono);
  font-weight:900;
  font-size:12px;
}
.note{color:var(--muted);font-size:12px;font-weight:900}
hr.sep{border:0;border-top:1px solid var(--line);margin:10px 0}

/* scrollbar */
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:999px}
::-webkit-scrollbar-track{background:transparent}

/* responsive: ì‘ì€ í™”ë©´ì€ ê´€ë¦¬ì ê¸°ë³¸ + ë‹¨ì¼ ì»¬ëŸ¼ */
@media (max-width: 980px){
  .app{grid-template-columns:1fr}
}
@media (max-width: 700px){
  .adminRow{
    grid-template-columns: 90px 1fr;
    grid-auto-rows:auto;
  }
}
</style>
</head>

<body>
<div class="app">

  <!-- LEFT: products / admin (ê°™ì€ íŒ¨ë„ ì•ˆì—ì„œ ì „í™˜) -->
  <section class="panel">
    <div class="panel-inner">

      <div class="topbar">
        <div class="tabs" id="tabs"></div>
        <div class="right-tools">
          <button class="modebtn" id="btnPOS">POS</button>
          <button class="modebtn" id="btnADMIN">ê´€ë¦¬ì</button>
          <div class="pill" id="pinInfo">ê³ ì •: 0</div>
        </div>
      </div>

      <!-- ===== POS ì˜ì—­ ===== -->
      <div id="posWrap">
        <div class="searchrow">
          <div class="search">
            <div class="icon">ğŸ”</div>
            <input id="searchInput" placeholder="ì „ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ (ì˜ˆ: ê°ì, ã„±ã…ˆ, ã……ã„±)" autocomplete="off" />
          </div>
          <button class="sortbtn" id="sortBtn">ì •ë ¬: ê³ ì • + ë§ì´ ì°íŒ ìˆœ</button>
        </div>

        <div class="kb-wrap">
          <div class="kb" id="kb"></div>
          <div class="hintline" id="hintline">
            <span>ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ <b>ì „í’ˆëª©</b> / ì´ˆì„±(ã„±ã„´ã„·â€¦) ê°€ëŠ¥</span>
          </div>
        </div>

        <div class="subline">
          <div>ê³ ì •(ì „ì²´) Â· ìƒë‹¨ 1ì¤„</div>
          <div>ê³ ì •ì€ â€œê¸¸ê²Œ ëˆŒëŸ¬â€ í† ê¸€</div>
        </div>

        <div class="scroll" id="productScroll">
          <div class="grid" id="grid"></div>
        </div>
      </div>

      <!-- ===== ê´€ë¦¬ì ì˜ì—­ ===== -->
      <div class="adminWrap" id="adminWrap">
        <div class="adminTop">
          <div class="search">
            <div class="icon">ğŸ› ï¸</div>
            <input id="adminSearch" placeholder="í’ˆëª© ê²€ìƒ‰ (ì´ë¦„/ì´ˆì„± ê°€ëŠ¥)" autocomplete="off" />
          </div>
          <select id="adminCat">
            <option value="ì „ì²´">ì „ì²´</option>
            <option value="ê³¼ì¼">ê³¼ì¼</option>
            <option value="ì•¼ì±„">ì•¼ì±„</option>
            <option value="ë´‰ì§€ì±„ì†Œ">ë´‰ì§€ì±„ì†Œ</option>
            <option value="ìƒì„ ">ìƒì„ </option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <button class="btn" id="btnAddItem">+ í’ˆëª©ì¶”ê°€</button>
          <button class="btn" id="btnExportJson">ë°±ì—…(JSON)</button>
        </div>

        <div class="adminGrid">
          <div class="adminList" id="adminList"></div>

          <div class="adminBox">
            <h3>ëŒ€ëŸ‰ ì—…ë¡œë“œ (CSV ë¶™ì—¬ë„£ê¸°)</h3>
            <div class="note">
              êµ¬ê¸€ì‹œíŠ¸ì—ì„œ <b>id, cat, name, price, active, ord</b> 6ì—´ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ ë¶™ì—¬ë„£ê³  â€œë°˜ì˜â€ ëˆ„ë¥´ì„¸ìš”.<br/>
              priceëŠ” â€œ5000â€ ë˜ëŠ” â€œ5,000â€ ë‘˜ ë‹¤ OK.
            </div>
            <hr class="sep"/>
            <textarea id="csvBox" placeholder="id	cat	name	price	active	ord
S01	ê³¼ì¼	ë‹¨ê°/3ê°œ	5000	1	2"></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn ok" id="btnApplyCSV">CSV ë°˜ì˜</button>
              <button class="btn danger" id="btnClearCSV">ë‚´ìš© ë¹„ìš°ê¸°</button>
            </div>
          </div>

          <div class="adminBox">
            <h3>ë³µì›/ê¸´ê¸‰ ë˜ëŒë¦¬ê¸° (JSON ë¶™ì—¬ë„£ê¸°)</h3>
            <div class="note">ë°±ì—…(JSON) ë²„íŠ¼ìœ¼ë¡œ ë‚˜ì˜¨ ë‚´ìš©ì„ ì €ì¥í•´ë‘ë©´, ì—¬ê¸° ë¶™ì—¬ë„£ê³  â€œë³µì›â€ìœ¼ë¡œ ì¦‰ì‹œ ë˜ëŒë¦´ ìˆ˜ ìˆì–´ìš”.</div>
            <hr class="sep"/>
            <textarea id="jsonBox" placeholder='[{"id":"S01","cat":"ê³¼ì¼","name":"ë°”ë‚˜ë‚˜","price":2500,"active":1,"ord":1}]'></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn ok" id="btnRestoreJson">ë³µì›</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- RIGHT: cart/pay (POSì—ì„œë§Œ í‘œì‹œ) -->
  <section class="panel" id="rightPanel">
    <div class="panel-inner" style="gap:10px">

      <div class="cartTop">
        <div class="pill accent" id="misuPill">ë¯¸ìˆ˜(0)</div>
        <div class="spacer"></div>
        <button class="resetBtn" id="cartResetBtn">ë¦¬ì…‹</button>
      </div>

      <div class="cartList" id="cartList"></div>

      <div class="totals">
        <div class="totalLabel" id="totalLabel">ì´í•©ê³„(0ê°œ)</div>
        <div class="totalAmt" id="totalAmt">0ì›</div>

        <div class="rcRow">
          <div class="rcBox">
            <div class="lbl">ë°›ì€ëˆ</div>
            <div class="amt" id="receivedAmt">0ì›</div>
          </div>
          <div class="rcSep">|</div>
          <div class="rcBox" style="text-align:left">
            <div class="lbl">ê±°ìŠ¤ë¦„ëˆ</div>
            <div class="amt" id="changeAmt">0ì›</div>
          </div>
        </div>

        <div class="cashPad">
          <button class="cashBtn" data-add="500">500</button>
          <button class="cashBtn" data-add="1000">1ì²œ</button>
          <button class="cashBtn" data-add="5000">5ì²œ</button>
          <button class="cashBtn" data-add="10000">1ë§Œ</button>
          <button class="cashBtn" data-add="50000">5ë§Œ</button>
          <button class="cashBtn reset" id="receivedResetBtn">ì´ˆê¸°í™”</button>
        </div>

        <div class="actions">
          <button class="misuBtn" id="saveMisuBtn">
            ë¯¸ìˆ˜
            <small>í˜„ì¬ì¥ë°”êµ¬ë‹ˆ ì €ì¥</small>
          </button>
          <button class="payBtn" id="payBtn">ê²°ì œì™„ë£Œ</button>
        </div>

      </div>
    </div>
  </section>

</div>

<!-- ë¯¸ìˆ˜ ëª¨ë‹¬ -->
<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="modalHead">
      <div class="title">ë¯¸ìˆ˜ ëª©ë¡</div>
      <button class="btn" id="closeModalBtn">ë‹«ê¸°</button>
    </div>
    <div class="modalBody" id="misuList"></div>
  </div>
</div>

<!-- ë°±ì—… ì¶œë ¥ ëª¨ë‹¬ -->
<div class="modalMask" id="backupMask">
  <div class="modal">
    <div class="modalHead">
      <div class="title">ë°±ì—…(JSON) - ë³µì‚¬í•´ì„œ ì €ì¥</div>
      <button class="btn" id="closeBackupBtn">ë‹«ê¸°</button>
    </div>
    <div class="modalBody">
      <textarea id="backupOut" style="width:100%;min-height:260px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);padding:10px;font-family:var(--mono);font-weight:900;font-size:12px"></textarea>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button class="btn ok" id="btnCopyBackup">ë³µì‚¬</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   ì €ì¥í‚¤ / ë°ì´í„°
========================= */
const LS_ITEMS = "umgane_items_v2";
const LS_PIN   = "umgane_pins_v2";
const LS_CART  = "umgane_cart_v2";
const LS_REC   = "umgane_received_v2";
const LS_MISU  = "umgane_misu_v2";
const LS_USAGE = "umgane_usage_v2";

const CATS = ["ì „ì²´","ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"];

const defaultItems = [
  {id:"S01", cat:"ê³¼ì¼", name:"ë°”ë‚˜ë‚˜", price:2500, active:1, ord:1},
  {id:"S02", cat:"ê³¼ì¼", name:"ë‹¨ê°/3ê°œ", price:5000, active:1, ord:2},
  {id:"S03", cat:"ê³¼ì¼", name:"ë‹¨ê°/7ê°œ", price:10000, active:1, ord:3},
  {id:"S10", cat:"ê¸°íƒ€", name:"í‘œê³ ", price:5000, active:1, ord:10},
];

let state = {
  mode: "pos", // pos | admin
  tab: "ì „ì²´",
  q: "",
  items: [],
  pins: new Set(),
  cart: [],
  received: 0,
  misu: [],
  usage: {},
  adminQ: "",
  adminCat: "ì „ì²´",
};

/* =========================
   ìœ í‹¸
========================= */
const fmt = n => (n||0).toLocaleString("ko-KR") + "ì›";
const nowHM = () => {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
};
const uid = () => Math.random().toString(36).slice(2,9);

/* ì´ˆì„± */
const CHO = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function toChoseong(str){
  let out = "";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code >= 0xAC00 && code <= 0xD7A3){
      const idx = Math.floor((code - 0xAC00) / 588);
      out += CHO[idx] || "";
    }else out += ch;
  }
  return out;
}
function normalizeQ(q){ return (q||"").replace(/\s+/g,"").trim(); }
function matchItem(name, q){
  q = normalizeQ(q);
  if(!q) return true;
  const n = normalizeQ(name);
  if(n.includes(q)) return true;
  const c = toChoseong(n);
  if(c.includes(q)) return true;
  const qc = toChoseong(q);
  if(qc !== q && c.includes(qc)) return true;
  return false;
}

/* beep */
function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}

/* =========================
   ì €ì¥/ë¡œë“œ
========================= */
function loadAll(){
  const items = JSON.parse(localStorage.getItem(LS_ITEMS) || "null");
  state.items = Array.isArray(items) && items.length ? items : defaultItems;

  const pins = JSON.parse(localStorage.getItem(LS_PIN) || "[]");
  state.pins = new Set(Array.isArray(pins) ? pins : []);

  const cart = JSON.parse(localStorage.getItem(LS_CART) || "[]");
  state.cart = Array.isArray(cart) ? cart : [];

  const rec = Number(localStorage.getItem(LS_REC) || "0");
  state.received = isFinite(rec) ? rec : 0;

  const misu = JSON.parse(localStorage.getItem(LS_MISU) || "[]");
  state.misu = Array.isArray(misu) ? misu : [];

  const usage = JSON.parse(localStorage.getItem(LS_USAGE) || "{}");
  state.usage = usage && typeof usage === "object" ? usage : {};
}
function saveAll(){
  localStorage.setItem(LS_ITEMS, JSON.stringify(state.items));
  localStorage.setItem(LS_PIN, JSON.stringify([...state.pins]));
  localStorage.setItem(LS_CART, JSON.stringify(state.cart));
  localStorage.setItem(LS_REC, String(state.received||0));
  localStorage.setItem(LS_MISU, JSON.stringify(state.misu));
  localStorage.setItem(LS_USAGE, JSON.stringify(state.usage));
}

/* =========================
   DOM
========================= */
const $tabs = document.getElementById("tabs");
const $grid = document.getElementById("grid");
const $pinInfo = document.getElementById("pinInfo");
const $searchInput = document.getElementById("searchInput");
const $kb = document.getElementById("kb");
const $cartList = document.getElementById("cartList");
const $totalLabel = document.getElementById("totalLabel");
const $totalAmt = document.getElementById("totalAmt");
const $receivedAmt = document.getElementById("receivedAmt");
const $changeAmt = document.getElementById("changeAmt");
const $misuPill = document.getElementById("misuPill");
const $modalMask = document.getElementById("modalMask");
const $misuList = document.getElementById("misuList");
const $posWrap = document.getElementById("posWrap");
const $adminWrap = document.getElementById("adminWrap");
const $rightPanel = document.getElementById("rightPanel");
const $btnPOS = document.getElementById("btnPOS");
const $btnADMIN = document.getElementById("btnADMIN");

const $adminSearch = document.getElementById("adminSearch");
const $adminCat = document.getElementById("adminCat");
const $adminList = document.getElementById("adminList");
const $csvBox = document.getElementById("csvBox");
const $jsonBox = document.getElementById("jsonBox");

const $backupMask = document.getElementById("backupMask");
const $backupOut = document.getElementById("backupOut");

/* =========================
   POS: ê³„ì‚°
========================= */
function cartTotal(){ return state.cart.reduce((s,it)=>s+(it.price*it.qty),0); }
function cartCount(){ return state.cart.reduce((s,it)=>s+it.qty,0); }
function changeMoney(){ return Math.max(0,(state.received||0)-cartTotal()); }

/* =========================
   ë Œë”: ëª¨ë“œ ì „í™˜
========================= */
function setMode(mode){
  state.mode = mode;
  const isAdmin = mode === "admin";

  $posWrap.style.display = isAdmin ? "none" : "block";
  $rightPanel.style.display = isAdmin ? "none" : "flex";
  $adminWrap.style.display = isAdmin ? "flex" : "none";

  $btnPOS.classList.toggle("on", !isAdmin);
  $btnADMIN.classList.toggle("on", isAdmin);

  // ê´€ë¦¬ìì¼ ë•Œ íƒ­ì€ "ì „ì²´" ê³ ì •ìœ¼ë¡œ ë‘¬ë„ ë˜ì§€ë§Œ, ê·¸ëƒ¥ ìœ ì§€
  render();
}

$btnPOS.onclick = ()=> setMode("pos");
$btnADMIN.onclick = ()=> setMode("admin");

/* =========================
   ë Œë”: íƒ­
========================= */
function renderTabs(){
  $tabs.innerHTML = "";
  CATS.forEach(cat=>{
    const b = document.createElement("button");
    b.className = "tab" + (state.tab===cat ? " active": "");
    b.textContent = cat;
    b.onclick = ()=>{ state.tab = cat; render(); };
    $tabs.appendChild(b);
  });
}

/* =========================
   POS: ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
========================= */
function getVisibleItems(){
  let arr = state.items.filter(it=>it.active!==0);
  const q = normalizeQ(state.q);

  // ì¹´í…Œê³ ë¦¬ í•„í„°(ê²€ìƒ‰ ì—†ì„ë•Œë§Œ)
  if(!q && state.tab !== "ì „ì²´"){
    arr = arr.filter(it=>it.cat === state.tab);
  }
  // ê²€ìƒ‰ì€ ì „í’ˆëª©
  if(q){
    arr = state.items.filter(it=>it.active!==0).filter(it=>matchItem(it.name, q));
  }

  arr.sort((a,b)=>{
    const pa = state.pins.has(a.id) ? 0 : 1;
    const pb = state.pins.has(b.id) ? 0 : 1;
    if(pa!==pb) return pa-pb;
    const ua = Number(state.usage[a.id]||0);
    const ub = Number(state.usage[b.id]||0);
    if(ua!==ub) return ub-ua;
    return (a.ord||0)-(b.ord||0);
  });
  return arr;
}

function renderGrid(){
  const items = getVisibleItems();
  $grid.innerHTML = "";
  $pinInfo.textContent = "ê³ ì •: " + [...state.pins].length;

  items.forEach(it=>{
    const c = document.createElement("div");
    c.className = "card" + (it.active===0 ? " inactive":"");

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = it.name;

    const price = document.createElement("div");
    price.className = "price";
    price.textContent = fmt(it.price);

    const pin = document.createElement("button");
    const pinned = state.pins.has(it.id);
    pin.className = "pinbtn " + (pinned ? "on":"off");
    pin.textContent = "ğŸ“Œ";
    pin.onclick = (e)=>{ e.stopPropagation(); togglePin(it.id); };

    let pressTimer = null;
    c.addEventListener("pointerdown", ()=>{ pressTimer = setTimeout(()=>togglePin(it.id), 420); });
    c.addEventListener("pointerup", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });
    c.addEventListener("pointercancel", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; });

    c.onclick = ()=> addToCart(it.id);

    c.appendChild(name);
    c.appendChild(price);
    c.appendChild(pin);
    $grid.appendChild(c);
  });
}

/* =========================
   POS: ì¥ë°”êµ¬ë‹ˆ
========================= */
function renderCart(){
  $cartList.innerHTML = "";
  state.cart.forEach(row=>{
    const el = document.createElement("div");
    el.className = "cartRow";
    el.onclick = ()=>{}; // í´ë¦­ ëŠë‚Œ ì œê±°

    const n = document.createElement("div");
    n.className = "cname";
    n.textContent = row.name;

    const p = document.createElement("div");
    p.className = "cprice";
    p.textContent = (row.price*row.qty).toLocaleString("ko-KR")+"ì›";

    const minus = document.createElement("button");
    minus.className = "qbtn";
    minus.textContent = "âˆ’";
    minus.onclick = ()=> setQty(row.id, row.qty-1);

    const q = document.createElement("div");
    q.className = "qnum";
    q.textContent = row.qty;

    const plus = document.createElement("button");
    plus.className = "qbtn";
    plus.textContent = "+";
    plus.onclick = ()=> setQty(row.id, row.qty+1);

    const del = document.createElement("button");
    del.className = "delbtn";
    del.textContent = "Ã—";
    del.onclick = ()=> removeFromCart(row.id);

    el.appendChild(n);
    el.appendChild(p);
    el.appendChild(minus);
    el.appendChild(q);
    el.appendChild(plus);
    el.appendChild(del);

    $cartList.appendChild(el);
  });

  $totalLabel.textContent = `ì´í•©ê³„(${cartCount()}ê°œ)`;
  $totalAmt.textContent = fmt(cartTotal());
  $receivedAmt.textContent = fmt(state.received||0);
  $changeAmt.textContent = fmt(changeMoney());
  $misuPill.textContent = `ë¯¸ìˆ˜(${state.misu.length})`;
}

function togglePin(id){
  if(state.pins.has(id)) state.pins.delete(id);
  else state.pins.add(id);
  saveAll(); render();
}
function addToCart(id){
  const it = state.items.find(x=>x.id===id);
  if(!it || it.active===0) return;
  state.usage[id] = Number(state.usage[id]||0)+1;
  const found = state.cart.find(x=>x.id===id);
  if(found) found.qty += 1;
  else state.cart.push({id:it.id, name:it.name, price:it.price, qty:1});
  saveAll(); renderCart();
}
function setQty(id, qty){
  const idx = state.cart.findIndex(x=>x.id===id);
  if(idx<0) return;
  if(qty<=0) state.cart.splice(idx,1);
  else state.cart[idx].qty = qty;
  saveAll(); renderCart();
}
function removeFromCart(id){
  state.cart = state.cart.filter(x=>x.id!==id);
  saveAll(); renderCart();
}

/* =========================
   ë¯¸ìˆ˜ ëª¨ë‹¬
========================= */
function openMisuModal(){ $modalMask.style.display = "flex"; renderMisu(); }
function closeMisuModal(){ $modalMask.style.display = "none"; }

function renderMisu(){
  $misuList.innerHTML = "";
  if(state.misu.length===0){
    const empty = document.createElement("div");
    empty.style.color="rgba(245,247,255,.75)";
    empty.style.fontWeight="1000";
    empty.textContent="ë¯¸ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
    $misuList.appendChild(empty);
    return;
  }
  state.misu.forEach((m, idx)=>{
    const row = document.createElement("div");
    row.className = "misuItem";

    const left = document.createElement("div");
    left.className = "misuLeft";

    const top = document.createElement("div");
    top.className = "misuTopLine";
    top.innerHTML = `<span>ë¯¸ìˆ˜ ${idx+1}</span><span class="t">(${m.ts})</span><span class="amt">${fmt(m.total)}</span>`;

    const sum = document.createElement("div");
    sum.className = "misuSummary";
    sum.textContent = m.summary;

    left.appendChild(top);
    left.appendChild(sum);

    const btns = document.createElement("div");
    btns.className = "misuBtns";

    const load = document.createElement("button");
    load.className = "btn";
    load.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
    load.onclick = ()=>{
      state.cart = m.items.map(x=>({...x}));
      state.received = 0;
      saveAll();
      closeMisuModal();
      renderCart();
    };

    const done = document.createElement("button");
    done.className = "btn ok";
    done.textContent = "ê²°ì œì™„ë£Œ";
    done.onclick = ()=>{
      if(!confirm(`ë¯¸ìˆ˜ ${idx+1}ì„(ë¥¼) ê²°ì œì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?`)) return;
      beep();
      state.misu = state.misu.filter(x=>x.id!==m.id);
      saveAll();
      render();
      openMisuModal();
    };

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "ì‚­ì œ";
    del.onclick = ()=>{
      if(!confirm(`ë¯¸ìˆ˜ ${idx+1}ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)) return;
      state.misu = state.misu.filter(x=>x.id!==m.id);
      saveAll();
      render();
      openMisuModal();
    };

    btns.appendChild(load);
    btns.appendChild(done);
    btns.appendChild(del);

    row.appendChild(left);
    row.appendChild(btns);
    $misuList.appendChild(row);
  });
}

document.getElementById("misuPill").onclick = openMisuModal;
document.getElementById("closeModalBtn").onclick = closeMisuModal;
$modalMask.addEventListener("click",(e)=>{ if(e.target===$modalMask) closeMisuModal(); });

/* =========================
   ê²°ì œ/ë¦¬ì…‹/í˜„ê¸ˆ
========================= */
document.getElementById("payBtn").onclick = ()=>{
  if(state.cart.length===0){ alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return; }
  if(!confirm("ê²°ì œì™„ë£Œ í•˜ê² ìŠµë‹ˆê¹Œ?")) return;
  beep();
  state.cart = [];
  state.received = 0;
  saveAll();
  renderCart();
};

document.querySelectorAll(".cashBtn[data-add]").forEach(btn=>{
  btn.onclick = ()=>{
    const v = Number(btn.dataset.add||0);
    state.received = (state.received||0) + v;
    saveAll(); renderCart();
  };
});

document.getElementById("receivedResetBtn").onclick = ()=>{
  state.received = 0;
  saveAll(); renderCart();
};

document.getElementById("cartResetBtn").onclick = ()=>{
  if(!confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ë¦¬ì…‹í• ê¹Œìš”?")) return;
  state.cart = [];
  state.received = 0;
  saveAll(); renderCart();
};

document.getElementById("saveMisuBtn").onclick = ()=>{
  if(state.cart.length===0){ alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return; }
  const total = cartTotal();
  const names = state.cart.map(x=>x.name).join(" Â· ");
  const summary = names.length>40 ? (names.slice(0,40)+"â€¦") : names;

  state.misu.unshift({
    id: uid(),
    ts: nowHM(),
    items: state.cart.map(x=>({...x})),
    total,
    summary
  });
  saveAll();
  renderCart();
  openMisuModal();
};

/* =========================
   ê²€ìƒ‰/ì´ˆì„±í‚¤ë³´ë“œ
========================= */
$searchInput.addEventListener("input", ()=>{
  state.q = $searchInput.value;
  render();
});

const KS = ["ã„±","ã„´","ã„·","ã„¹","ã…","ã…‚","ã……","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function renderKB(){
  $kb.innerHTML = "";
  KS.forEach(ch=>{
    const b = document.createElement("button");
    b.className = "k";
    b.textContent = ch;
    b.onclick = ()=>{
      $searchInput.value = ($searchInput.value || "") + ch;
      state.q = $searchInput.value;
      render();
      $searchInput.focus();
    };
    $kb.appendChild(b);
  });
  const x = document.createElement("button");
  x.className = "k clear";
  x.textContent = "X";
  x.onclick = ()=>{
    $searchInput.value="";
    state.q="";
    render();
    $searchInput.focus();
  };
  $kb.appendChild(x);
}
renderKB();

document.getElementById("sortBtn").onclick = ()=>{
  alert("ì •ë ¬ì€ í˜„ì¬: ê³ ì • â†’ ë§ì´ì°íŒ ìˆœ â†’ ord ì…ë‹ˆë‹¤.");
};

/* =========================
   ê´€ë¦¬ì: ë¦¬ìŠ¤íŠ¸/ìˆ˜ì •
========================= */
function adminVisibleItems(){
  let arr = state.items.slice();
  if(state.adminCat !== "ì „ì²´") arr = arr.filter(it=>it.cat===state.adminCat);
  const q = normalizeQ(state.adminQ);
  if(q) arr = arr.filter(it=>matchItem(it.name, q) || (it.id||"").toLowerCase().includes(q.toLowerCase()));
  arr.sort((a,b)=>(a.ord||0)-(b.ord||0));
  return arr;
}

function renderAdmin(){
  const list = adminVisibleItems();
  $adminList.innerHTML = "";

  list.forEach(it=>{
    const row = document.createElement("div");
    row.className = "adminRow";

    const id = document.createElement("div");
    id.className = "id";
    id.textContent = it.id;

    const name = document.createElement("input");
    name.value = it.name || "";
    name.placeholder = "í’ˆëª©ëª…";
    name.onchange = ()=>{ it.name = name.value.trim(); saveAll(); };

    const price = document.createElement("input");
    price.className = "price";
    price.value = String(it.price ?? 0);
    price.placeholder = "ê°€ê²©";
    price.onchange = ()=>{
      const v = Number(String(price.value).replace(/[^0-9]/g,""));
      it.price = isFinite(v) ? v : 0;
      price.value = String(it.price);
      saveAll();
    };

    const cat = document.createElement("select");
    ["ê³¼ì¼","ì•¼ì±„","ë´‰ì§€ì±„ì†Œ","ìƒì„ ","ê¸°íƒ€"].forEach(c=>{
      const o = document.createElement("option");
      o.value=c; o.textContent=c;
      if(it.cat===c) o.selected=true;
      cat.appendChild(o);
    });
    cat.onchange = ()=>{ it.cat = cat.value; saveAll(); renderAdmin(); };

    const ord = document.createElement("input");
    ord.className = "price";
    ord.value = String(it.ord ?? 0);
    ord.placeholder = "ord";
    ord.onchange = ()=>{
      const v = Number(String(ord.value).replace(/[^0-9]/g,""));
      it.ord = isFinite(v) ? v : 0;
      ord.value = String(it.ord);
      saveAll();
    };

    const act = document.createElement("button");
    act.className = "smallbtn " + (it.active===0 ? "off":"on");
    act.textContent = it.active===0 ? "ë¹„í™œì„±" : "í™œì„±";
    act.onclick = ()=>{
      it.active = (it.active===0) ? 1 : 0;
      act.className = "smallbtn " + (it.active===0 ? "off":"on");
      act.textContent = it.active===0 ? "ë¹„í™œì„±" : "í™œì„±";
      saveAll();
      render(); // POSì—ë„ ë°”ë¡œ ë°˜ì˜
    };

    const del = document.createElement("button");
    del.className = "smallbtn off";
    del.textContent = "ì‚­ì œ";
    del.onclick = ()=>{
      if(!confirm(`${it.name} ì‚­ì œí• ê¹Œìš”?`)) return;
      state.items = state.items.filter(x=>x.id!==it.id);
      state.pins.delete(it.id);
      state.cart = state.cart.filter(x=>x.id!==it.id);
      delete state.usage[it.id];
      saveAll();
      render();
    };

    row.appendChild(id);
    row.appendChild(name);
    row.appendChild(price);
    row.appendChild(cat);
    row.appendChild(ord);
    row.appendChild(act);
    row.appendChild(del);

    // PC ë„“ì„ ë•Œ 7ì¹¸ì´ë¼ ê¹¨ì§ˆ ìˆ˜ ìˆì–´ ì¡°ì •
    row.style.gridTemplateColumns = "90px 1.3fr 140px 120px 90px 90px 90px";

    $adminList.appendChild(row);
  });
}

$adminSearch.addEventListener("input", ()=>{
  state.adminQ = $adminSearch.value;
  renderAdmin();
});
$adminCat.addEventListener("change", ()=>{
  state.adminCat = $adminCat.value;
  renderAdmin();
});

document.getElementById("btnAddItem").onclick = ()=>{
  const nid = "S" + String(Math.floor(100 + Math.random()*900));
  state.items.unshift({id:nid, cat:"ê¸°íƒ€", name:"ìƒˆí’ˆëª©", price:0, active:1, ord:0});
  saveAll();
  render();
  setMode("admin");
};

function parseTSV(text){
  // íƒ­/ì½¤ë§ˆ ì„ì—¬ë„ ì²˜ë¦¬
  const lines = (text||"").trim().split(/\r?\n/).filter(Boolean);
  if(lines.length===0) return [];
  const rows = lines.map(line=>{
    // íƒ­ ìš°ì„ , ì—†ìœ¼ë©´ ì½¤ë§ˆ
    const parts = line.includes("\t") ? line.split("\t") : line.split(",");
    return parts.map(x=>String(x).trim());
  });
  return rows;
}

document.getElementById("btnApplyCSV").onclick = ()=>{
  const raw = $csvBox.value;
  if(!raw.trim()){ alert("ë¶™ì—¬ë„£ê¸° ë‚´ìš©ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return; }
  const rows = parseTSV(raw);
  if(rows.length===0){ alert("ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  // í—¤ë” ê°ì§€
  const head = rows[0].map(x=>x.toLowerCase());
  const hasHeader = head.includes("id") && head.includes("cat") && head.includes("name");
  const data = hasHeader ? rows.slice(1) : rows;

  const next = [];
  for(const r of data){
    if(r.length<3) continue;
    const id = (r[0]||"").trim();
    const cat = (r[1]||"ê¸°íƒ€").trim();
    const name = (r[2]||"").trim();
    const price = Number(String(r[3]||"0").replace(/[^0-9]/g,"")) || 0;
    const active = Number(String(r[4]??"1").replace(/[^0-9]/g,"")) || 1;
    const ord = Number(String(r[5]??"0").replace(/[^0-9]/g,"")) || 0;
    if(!id || !name) continue;
    next.push({id, cat, name, price, active: active?1:0, ord});
  }

  if(next.length===0){ alert("ë°˜ì˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
  if(!confirm(`ì´ ${next.length}ê°œ í’ˆëª©ìœ¼ë¡œ ë®ì–´ì“¸ê¹Œìš”? (ê¸°ì¡´ í’ˆëª© ì „ì²´ êµì²´)`)) return;

  state.items = next;
  // pins/usage ì •ë¦¬(ì—†ëŠ” id ì œê±°)
  const ids = new Set(next.map(x=>x.id));
  state.pins = new Set([...state.pins].filter(id=>ids.has(id)));
  Object.keys(state.usage).forEach(k=>{ if(!ids.has(k)) delete state.usage[k]; });
  state.cart = state.cart.filter(x=>ids.has(x.id));

  saveAll();
  render();
  alert("CSV ë°˜ì˜ ì™„ë£Œ");
};

document.getElementById("btnClearCSV").onclick = ()=>{ $csvBox.value=""; };

function openBackup(){
  $backupMask.style.display="flex";
  $backupOut.value = JSON.stringify(state.items, null, 2);
}
function closeBackup(){ $backupMask.style.display="none"; }
document.getElementById("btnExportJson").onclick = openBackup;
document.getElementById("closeBackupBtn").onclick = closeBackup;
document.getElementById("btnCopyBackup").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($backupOut.value);
    alert("ë³µì‚¬ ì™„ë£Œ");
  }catch(e){
    alert("ë³µì‚¬ ì‹¤íŒ¨: ì§ì ‘ ë“œë˜ê·¸í•´ì„œ ë³µì‚¬í•˜ì„¸ìš”.");
  }
};
$backupMask.addEventListener("click",(e)=>{ if(e.target===$backupMask) closeBackup(); });

document.getElementById("btnRestoreJson").onclick = ()=>{
  const raw = $jsonBox.value.trim();
  if(!raw){ alert("JSONì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return; }
  let arr;
  try{ arr = JSON.parse(raw); }catch(e){ alert("JSON íŒŒì‹± ì‹¤íŒ¨"); return; }
  if(!Array.isArray(arr) || arr.length===0){ alert("ë°°ì—´(JSON) í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤."); return; }
  // ìµœì†Œ í•„ë“œ ì²´í¬
  const next = [];
  for(const it of arr){
    if(!it || typeof it!=="object") continue;
    const id = String(it.id||"").trim();
    const cat = String(it.cat||"ê¸°íƒ€").trim();
    const name = String(it.name||"").trim();
    const price = Number(it.price||0) || 0;
    const active = Number(it.active??1) ? 1 : 0;
    const ord = Number(it.ord||0) || 0;
    if(!id || !name) continue;
    next.push({id,cat,name,price,active,ord});
  }
  if(next.length===0){ alert("ìœ íš¨í•œ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  if(!confirm(`ì´ ${next.length}ê°œë¡œ ë³µì›í• ê¹Œìš”? (ê¸°ì¡´ êµì²´)`)) return;

  state.items = next;
  const ids = new Set(next.map(x=>x.id));
  state.pins = new Set([...state.pins].filter(id=>ids.has(id)));
  Object.keys(state.usage).forEach(k=>{ if(!ids.has(k)) delete state.usage[k]; });
  state.cart = state.cart.filter(x=>ids.has(x.id));
  saveAll();
  render();
  alert("ë³µì› ì™„ë£Œ");
};

/* =========================
   ì „ì²´ ë Œë”
========================= */
function render(){
  renderTabs();

  // ëª¨ë“œë³„
  if(state.mode==="pos"){
    renderGrid();
    renderCart();
  }else{
    // ê´€ë¦¬ì: íƒ­/ê³ ì • ìˆ˜ì¹˜ë§Œ ìœ ì§€, ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
    $pinInfo.textContent = "ê³ ì •: " + [...state.pins].length;
    renderAdmin();
  }
  saveAll();
}

/* =========================
   ì´ˆê¸° ëª¨ë“œ ìë™
   - ì‘ì€ í™”ë©´: ê´€ë¦¬ì ê¸°ë³¸
   - í° í™”ë©´: POS ê¸°ë³¸
========================= */
function autoMode(){
  const w = Math.min(window.innerWidth || 9999, window.screen?.width || 9999);
  if(w <= 700) setMode("admin");
  else setMode("pos");
}

/* =========================
   ì‹œì‘
========================= */
loadAll();
autoMode();
window.addEventListener("resize", ()=>{
  // ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë°”ê¾¼ ê±´ ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸° ë¹„í™œì„±í™”í•˜ë©´ ë¨.
  // ì§€ê¸ˆì€ "ìë™"ì„ ì›í•´ì„œ ìœ ì§€.
  autoMode();
});
</script>
</body>
</html>
